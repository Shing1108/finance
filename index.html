<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据同步演示</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        :root {
            --primary-color: #5D5CDE;
            --text-color: #333333;
            --bg-color: #FFFFFF;
            --card-bg: #F5F5F5;
            --border-color: #E0E0E0;
            --success-color: #4CAF50;
            --error-color: #F44336;
            --warning-color: #FF9800;
            --info-color: #2196F3;
        }
        
        @media (prefers-color-scheme: dark) {
            :root {
                --primary-color: #7B7AE6;
                --text-color: #F0F0F0;
                --bg-color: #181818;
                --card-bg: #252525;
                --border-color: #333333;
                --success-color: #81C784;
                --error-color: #E57373;
                --warning-color: #FFB74D;
                --info-color: #64B5F6;
            }
        }
        
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        h1, h2, h3 {
            color: var(--primary-color);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .card {
            background-color: var(--bg-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
        }
        
        .login-section {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .data-section {
            display: none;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            background-color: var(--card-bg);
            border-radius: 8px;
        }
        
        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
        }
        
        .sync-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .sync-status {
            margin: 15px 0;
            padding: 12px;
            border-radius: 4px;
            background-color: rgba(33, 150, 243, 0.1);
            color: var(--info-color);
            display: none;
        }
        
        .sync-status.success {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--success-color);
        }
        
        .sync-status.error {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--error-color);
        }
        
        .sync-status.warning {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--warning-color);
        }
        
        .data-form {
            margin-top: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 16px;
        }
        
        textarea {
            min-height: 150px;
            font-family: monospace;
        }
        
        .sync-info {
            font-size: 14px;
            margin-top: 5px;
            color: var(--text-color);
            opacity: 0.7;
        }
        
        .file-history {
            margin-top: 30px;
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 10px;
            background-color: var(--bg-color);
        }
        
        .history-info {
            flex-grow: 1;
        }
        
        .history-actions {
            display: flex;
            gap: 8px;
        }
        
        .history-actions button {
            padding: 5px 10px;
            font-size: 14px;
        }
        
        @media (max-width: 600px) {
            .sync-controls {
                flex-direction: column;
            }
            
            .sync-controls button {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .history-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .history-actions {
                margin-top: 10px;
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>数据云同步系统</h1>
        
        <div id="loginSection" class="login-section card">
            <h2>登录以开始同步</h2>
            <p>使用您的Google账户登录，以便将数据保存到Google Drive。</p>
            <div id="g_id_onload"
                 data-client_id="YOUR_GOOGLE_CLIENT_ID"
                 data-context="signin"
                 data-callback="handleCredentialResponse"
                 data-auto_select="true">
            </div>
            <div class="g_id_signin"
                 data-type="standard"
                 data-size="large"
                 data-theme="outline"
                 data-text="signin_with"
                 data-shape="rectangular"
                 data-logo_alignment="left">
            </div>
        </div>
        
        <div id="dataSection" class="data-section">
            <div id="userInfo" class="user-info">
                <img id="userAvatar" src="" alt="用户头像">
                <div>
                    <div id="userName" style="font-weight: bold;"></div>
                    <div id="userEmail" style="font-size: 14px; opacity: 0.8;"></div>
                </div>
            </div>
            
            <div class="card">
                <h2>数据管理</h2>
                <div id="syncStatus" class="sync-status">同步状态将显示在这里</div>
                
                <div class="sync-controls">
                    <button id="syncNowBtn" onclick="manualSync()">立即同步</button>
                    <button id="forceUploadBtn" onclick="forceUpload()">强制上传到云端</button>
                    <button id="forceDownloadBtn" onclick="forceDownload()">强制从云端下载</button>
                    <button id="signOutBtn">退出登录</button>
                </div>
                
                <div class="form-group">
                    <label for="lastSyncInfo">上次同步信息</label>
                    <div id="lastSyncInfo" class="sync-info">尚未同步</div>
                </div>
                
                <div class="data-form">
                    <div class="form-group">
                        <label for="dataTitle">数据标题</label>
                        <input type="text" id="dataTitle" placeholder="输入数据标题">
                    </div>
                    
                    <div class="form-group">
                        <label for="dataContent">数据内容 (JSON)</label>
                        <textarea id="dataContent" placeholder='{"items": []}'>{"items": []}</textarea>
                    </div>
                    
                    <button id="saveLocalBtn" onclick="saveLocalData()">保存到本地</button>
                </div>
            </div>
            
            <div class="card file-history">
                <h2>云端文件历史</h2>
                <div id="fileHistory">
                    <p>加载云端文件历史...</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 监听深色模式变化
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
        
        // 应用程序配置
        const APP_CONFIG = {
            CLIENT_ID: 'YOUR_GOOGLE_CLIENT_ID',
            API_KEY: 'YOUR_API_KEY',
            SCOPES: 'https://www.googleapis.com/auth/drive.appdata',
            DATA_FILE_NAME: 'app_data.json',
            AUTO_SYNC_INTERVAL: 5 * 60 * 1000, // 5分钟自动同步一次
            MAX_HISTORY_ITEMS: 10
        };
        
        // 应用状态
        const APP_STATE = {
            isLoggedIn: false,
            isSyncing: false,
            lastSyncTime: null,
            localData: null,
            hasLocalChanges: false,
            autoSyncTimer: null
        };
        
        // DOM 元素引用
        const DOM = {
            loginSection: document.getElementById('loginSection'),
            dataSection: document.getElementById('dataSection'),
            userAvatar: document.getElementById('userAvatar'),
            userName: document.getElementById('userName'),
            userEmail: document.getElementById('userEmail'),
            syncStatus: document.getElementById('syncStatus'),
            lastSyncInfo: document.getElementById('lastSyncInfo'),
            dataTitle: document.getElementById('dataTitle'),
            dataContent: document.getElementById('dataContent'),
            fileHistory: document.getElementById('fileHistory'),
            signOutBtn: document.getElementById('signOutBtn')
        };
        
        // 处理Google登录响应
        function handleCredentialResponse(response) {
            // 解码JWT令牌
            const responsePayload = parseJwt(response.credential);
            
            // 保存用户信息
            document.getElementById('userName').textContent = responsePayload.name;
            document.getElementById('userEmail').textContent = responsePayload.email;
            document.getElementById('userAvatar').src = responsePayload.picture;
            
            // 存储令牌
            localStorage.setItem('googleToken', response.credential);
            
            // 显示应用界面
            DOM.loginSection.style.display = 'none';
            DOM.dataSection.style.display = 'block';
            
            // 初始化应用程序
            initializeApp();
        }
        
        // 初始化应用程序
        function initializeApp() {
            APP_STATE.isLoggedIn = true;
            
            // 加载本地数据
            loadLocalData();
            
            // 加载Google Drive API
            loadGoogleDriveAPI();
            
            // 设置退出登录按钮
            DOM.signOutBtn.addEventListener('click', signOut);
            
            // 设置数据变更监听器
            DOM.dataTitle.addEventListener('input', markLocalChanges);
            DOM.dataContent.addEventListener('input', markLocalChanges);
            
            // 开始自动同步定时器
            startAutoSync();
        }
        
        // 解析JWT令牌
        function parseJwt(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            
            return JSON.parse(jsonPayload);
        }
        
        // 退出登录
        function signOut() {
            // 清除本地存储
            localStorage.removeItem('googleToken');
            localStorage.removeItem('appData');
            
            // 重置应用状态
            APP_STATE.isLoggedIn = false;
            APP_STATE.lastSyncTime = null;
            APP_STATE.localData = null;
            
            // 清除自动同步定时器
            if (APP_STATE.autoSyncTimer) {
                clearInterval(APP_STATE.autoSyncTimer);
            }
            
            // 重新显示登录界面
            DOM.loginSection.style.display = 'block';
            DOM.dataSection.style.display = 'none';
            
            // 重新加载页面以重置Google登录状态
            window.location.reload();
        }
        
        // 加载Google Drive API
        function loadGoogleDriveAPI() {
            updateSyncStatus('正在加载Google Drive API...', 'info');
            gapi.load('client', initGoogleDriveClient);
        }
        
        // 初始化Google Drive客户端
        function initGoogleDriveClient() {
            gapi.client.init({
                apiKey: APP_CONFIG.API_KEY,
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
            }).then(() => {
                // 设置访问令牌
                const token = localStorage.getItem('googleToken');
                if (token) {
                    const tokenData = parseJwt(token);
                    if (tokenData.exp * 1000 > Date.now()) {
                        // 获取访问令牌并设置认证头
                        gapi.client.setToken({
                            access_token: parseGoogleAccessToken(token)
                        });
                        
                        // 首次同步
                        synchronizeData();
                        
                        // 加载文件历史
                        loadFileHistory();
                    } else {
                        updateSyncStatus('登录会话已过期，请重新登录', 'error');
                        signOut();
                    }
                }
            }).catch(error => {
                updateSyncStatus('Drive API初始化失败: ' + error.message, 'error');
            });
        }
        
        // 从ID令牌解析访问令牌（简化处理，实际生产环境应当使用gapi.auth2的标准流程）
        function parseGoogleAccessToken(idToken) {
            // 注意：在实际应用中，应当使用OAuth 2.0标准流程获取访问令牌
            // 这里为了演示，我们使用ID令牌作为访问令牌，但这不是标准做法
            return idToken.split('.')[1]; // 简化处理
        }
        
        // 同步数据
        function synchronizeData() {
            if (APP_STATE.isSyncing) {
                updateSyncStatus('同步正在进行中，请稍后再试', 'warning');
                return;
            }
            
            APP_STATE.isSyncing = true;
            updateSyncStatus('开始同步数据...', 'info');
            
            // 检查是否有已存在的数据文件
            listFiles().then(files => {
                if (files.length > 0) {
                    // 找到最新的文件
                    const latestFile = files[0];
                    
                    // 如果本地有未保存的更改，则需要处理冲突
                    if (APP_STATE.hasLocalChanges) {
                        // 检查云端文件的修改时间与本地最后同步时间
                        const cloudUpdateTime = new Date(latestFile.modifiedTime).getTime();
                        const lastSyncTime = APP_STATE.lastSyncTime ? APP_STATE.lastSyncTime.getTime() : 0;
                        
                        if (cloudUpdateTime > lastSyncTime) {
                            // 检测到冲突 - 云端文件比上次同步更新
                            handleSyncConflict(latestFile);
                        } else {
                            // 没有冲突，直接上传本地数据
                            uploadLocalData();
                        }
                    } else {
                        // 如果本地没有更改，下载最新数据
                        downloadLatestData(latestFile);
                    }
                } else {
                    // 没有云端文件，上传本地数据
                    uploadLocalData();
                }
            }).catch(error => {
                APP_STATE.isSyncing = false;
                updateSyncStatus('同步失败: ' + error.message, 'error');
            });
        }
        
        // 处理同步冲突
        function handleSyncConflict(cloudFile) {
            updateSyncStatus('检测到数据冲突。云端数据已更新，但本地也有未保存的更改。', 'warning');
            
            // 提示用户选择操作
            if (confirm('检测到数据冲突。点击"确定"下载云端数据（覆盖本地更改），点击"取消"上传本地数据（覆盖云端更改）。')) {
                // 用户选择下载云端数据
                downloadLatestData(cloudFile);
            } else {
                // 用户选择上传本地数据
                uploadLocalData();
            }
        }
        
        // 下载最新数据
        function downloadLatestData(file) {
            updateSyncStatus('正在从云端下载最新数据...', 'info');
            
            downloadFile(file.id).then(content => {
                // 导入数据到应用
                importData(content);
                
                // 更新同步状态
                APP_STATE.lastSyncTime = new Date();
                APP_STATE.hasLocalChanges = false;
                
                // 更新UI
                updateLastSyncInfo();
                updateSyncStatus('数据已从云端下载并导入', 'success');
                APP_STATE.isSyncing = false;
            }).catch(error => {
                updateSyncStatus('下载数据失败: ' + error.message, 'error');
                APP_STATE.isSyncing = false;
            });
        }
        
        // 上传本地数据
        function uploadLocalData() {
            updateSyncStatus('正在上传数据到云端...', 'info');
            
            const dataStr = exportData();
            uploadFile(APP_CONFIG.DATA_FILE_NAME, dataStr).then(() => {
                // 更新同步状态
                APP_STATE.lastSyncTime = new Date();
                APP_STATE.hasLocalChanges = false;
                
                // 更新UI
                updateLastSyncInfo();
                updateSyncStatus('数据已成功上传到云端', 'success');
                
                // 重新加载文件历史
                loadFileHistory();
                
                APP_STATE.isSyncing = false;
            }).catch(error => {
                updateSyncStatus('上传数据失败: ' + error.message, 'error');
                APP_STATE.isSyncing = false;
            });
        }
        
        // 强制从云端下载
        function forceDownload() {
            if (APP_STATE.isSyncing) {
                updateSyncStatus('同步正在进行中，请稍后再试', 'warning');
                return;
            }
            
            if (APP_STATE.hasLocalChanges) {
                if (!confirm('您有未保存的本地更改，下载将覆盖这些更改。是否继续？')) {
                    return;
                }
            }
            
            APP_STATE.isSyncing = true;
            
            listFiles().then(files => {
                if (files.length > 0) {
                    downloadLatestData(files[0]);
                } else {
                    updateSyncStatus('云端没有数据文件', 'warning');
                    APP_STATE.isSyncing = false;
                }
            }).catch(error => {
                updateSyncStatus('加载云端文件失败: ' + error.message, 'error');
                APP_STATE.isSyncing = false;
            });
        }
        
        // 强制上传到云端
        function forceUpload() {
            if (APP_STATE.isSyncing) {
                updateSyncStatus('同步正在进行中，请稍后再试', 'warning');
                return;
            }
            
            if (confirm('此操作将覆盖云端数据。是否继续？')) {
                APP_STATE.isSyncing = true;
                uploadLocalData();
            }
        }
        
        // 手动触发同步
        function manualSync() {
            if (APP_STATE.isSyncing) {
                updateSyncStatus('同步正在进行中，请稍后再试', 'warning');
                return;
            }
            
            synchronizeData();
        }
        
        // 开始自动同步
        function startAutoSync() {
            if (APP_STATE.autoSyncTimer) {
                clearInterval(APP_STATE.autoSyncTimer);
            }
            
            APP_STATE.autoSyncTimer = setInterval(() => {
                if (!APP_STATE.isSyncing && APP_STATE.isLoggedIn) {
                    console.log('自动同步触发...');
                    synchronizeData();
                }
            }, APP_CONFIG.AUTO_SYNC_INTERVAL);
        }
        
        // 更新同步状态UI
        function updateSyncStatus(message, type) {
            const statusEl = DOM.syncStatus;
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            
            // 清除所有类型
            statusEl.classList.remove('success', 'error', 'warning', 'info');
            
            // 添加适当的类型
            if (type) {
                statusEl.classList.add(type);
            }
        }
        
        // 更新上次同步信息
        function updateLastSyncInfo() {
            if (APP_STATE.lastSyncTime) {
                DOM.lastSyncInfo.textContent = `上次同步时间: ${APP_STATE.lastSyncTime.toLocaleString()}`;
            } else {
                DOM.lastSyncInfo.textContent = '尚未同步';
            }
        }
        
        // 标记本地有更改
        function markLocalChanges() {
            APP_STATE.hasLocalChanges = true;
        }
        
        // 保存数据到本地
        function saveLocalData() {
            try {
                // 验证JSON格式
                const contentJson = JSON.parse(DOM.dataContent.value);
                
                // 保存数据
                APP_STATE.localData = {
                    title: DOM.dataTitle.value,
                    content: contentJson,
                    lastModified: new Date()
                };
                
                // 保存到localStorage
                localStorage.setItem('appData', JSON.stringify(APP_STATE.localData));
                
                // 更新状态
                APP_STATE.hasLocalChanges = true;
                
                updateSyncStatus('数据已保存到本地', 'success');
            } catch (e) {
                updateSyncStatus('JSON格式错误: ' + e.message, 'error');
            }
        }
        
        // 加载本地数据
        function loadLocalData() {
            const savedData = localStorage.getItem('appData');
            
            if (savedData) {
                try {
                    APP_STATE.localData = JSON.parse(savedData);
                    
                    // 更新UI
                    DOM.dataTitle.value = APP_STATE.localData.title || '';
                    DOM.dataContent.value = JSON.stringify(APP_STATE.localData.content, null, 2);
                    
                    console.log('已加载本地数据');
                } catch (e) {
                    console.error('本地数据格式错误', e);
                    APP_STATE.localData = {
                        title: '',
                        content: { items: [] },
                        lastModified: new Date()
                    };
                }
            } else {
                // 初始化默认数据
                APP_STATE.localData = {
                    title: '',
                    content: { items: [] },
                    lastModified: new Date()
                };
            }
        }
        
        // 导出数据
        function exportData() {
            if (!APP_STATE.localData) {
                loadLocalData();
            }
            
            // 更新最后修改时间
            APP_STATE.localData.lastModified = new Date();
            
            // 确保保存最新输入
            APP_STATE.localData.title = DOM.dataTitle.value;
            try {
                APP_STATE.localData.content = JSON.parse(DOM.dataContent.value);
            } catch (e) {
                console.error('导出数据时JSON解析错误', e);
                // 使用最后保存的有效内容
            }
            
            return JSON.stringify(APP_STATE.localData);
        }
        
        // 导入数据
        function importData(dataStr) {
            try {
                const data = JSON.parse(dataStr);
                APP_STATE.localData = data;
                
                // 更新UI
                DOM.dataTitle.value = data.title || '';
                DOM.dataContent.value = JSON.stringify(data.content, null, 2);
                
                // 保存到localStorage
                localStorage.setItem('appData', dataStr);
                
                console.log('已导入数据');
                return true;
            } catch (e) {
                console.error('数据导入错误', e);
                updateSyncStatus('数据导入错误: ' + e.message, 'error');
                return false;
            }
        }
        
        // 列出appdata目录中的文件
        function listFiles() {
            return gapi.client.drive.files.list({
                spaces: 'appDataFolder',
                pageSize: APP_CONFIG.MAX_HISTORY_ITEMS,
                fields: 'files(id, name, modifiedTime, size)',
                orderBy: 'modifiedTime desc'
            }).then(response => {
                return response.result.files;
            });
        }
        
        // 下载文件内容
        function downloadFile(fileId) {
            return gapi.client.drive.files.get({
                fileId: fileId,
                alt: 'media'
            }).then(response => {
                return response.body;
            });
        }
        
        // 上传文件到appdata目录
        function uploadFile(fileName, content) {
            return new Promise((resolve, reject) => {
                // 先检查是否已有同名文件
                gapi.client.drive.files.list({
                    spaces: 'appDataFolder',
                    q: `name='${fileName}'`,
                    fields: 'files(id)'
                }).then(response => {
                    const files = response.result.files;
                    if (files && files.length > 0) {
                        // 更新现有文件
                        updateFile(files[0].id, content).then(resolve).catch(reject);
                    } else {
                        // 创建新文件
                        createFile(fileName, content).then(resolve).catch(reject);
                    }
                }).catch(reject);
            });
        }
        
        // 创建新文件
        function createFile(fileName, content) {
            const metadata = {
                name: fileName,
                parents: ['appDataFolder']
            };
            
            const blob = new Blob([content], {type: 'application/json'});
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
            form.append('file', blob);
            
            return fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({
                    'Authorization': 'Bearer ' + gapi.client.getToken().access_token
                }),
                body: form
            }).then(response => {
                if (!response.ok) {
                    throw new Error('创建文件失败: ' + response.statusText);
                }
                return response.json();
            });
        }
        
        // 更新现有文件
        function updateFile(fileId, content) {
            const blob = new Blob([content], {type: 'application/json'});
            
            return fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                method: 'PATCH',
                headers: new Headers({
                    'Authorization': 'Bearer ' + gapi.client.getToken().access_token,
                    'Content-Type': 'application/json'
                }),
                body: blob
            }).then(response => {
                if (!response.ok) {
                    throw new Error('更新文件失败: ' + response.statusText);
                }
                return response.json();
            });
        }
        
        // 加载文件历史
        function loadFileHistory() {
            DOM.fileHistory.innerHTML = '<p>加载云端文件历史...</p>';
            
            listFiles().then(files => {
                if (files.length === 0) {
                    DOM.fileHistory.innerHTML = '<p>暂无云端备份记录</p>';
                    return;
                }
                
                let historyHtml = '';
                files.forEach(file => {
                    const modifiedDate = new Date(file.modifiedTime);
                    const fileSize = formatFileSize(file.size);
                    
                    historyHtml += `
                    <div class="history-item">
                        <div class="history-info">
                            <div><strong>${file.name}</strong></div>
                            <div>修改时间: ${modifiedDate.toLocaleString()}</div>
                            <div>文件大小: ${fileSize}</div>
                        </div>
                        <div class="history-actions">
                            <button onclick="restoreFromHistory('${file.id}')">恢复</button>
                        </div>
                    </div>
                    `;
                });
                
                DOM.fileHistory.innerHTML = historyHtml;
            }).catch(error => {
                DOM.fileHistory.innerHTML = `<p>加载历史记录失败: ${error.message}</p>`;
            });
        }
        
        // 从历史记录恢复
        function restoreFromHistory(fileId) {
            if (APP_STATE.isSyncing) {
                updateSyncStatus('同步正在进行中，请稍后再试', 'warning');
                return;
            }
            
            if (APP_STATE.hasLocalChanges) {
                if (!confirm('您有未保存的本地更改，恢复将覆盖这些更改。是否继续？')) {
                    return;
                }
            }
            
            APP_STATE.isSyncing = true;
            updateSyncStatus('正在恢复历史版本...', 'info');
            
            downloadFile(fileId).then(content => {
                if (importData(content)) {
                    // 更新同步状态
                    APP_STATE.lastSyncTime = new Date();
                    APP_STATE.hasLocalChanges = false;
                    
                    // 更新UI
                    updateLastSyncInfo();
                    updateSyncStatus('已成功恢复历史版本', 'success');
                }
                
                APP_STATE.isSyncing = false;
            }).catch(error => {
                updateSyncStatus('恢复历史版本失败: ' + error.message, 'error');
                APP_STATE.isSyncing = false;
            });
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 检查是否已登录
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('googleToken');
            if (token) {
                try {
                    const userData = parseJwt(token);
                    // 验证令牌是否过期
                    if (userData.exp * 1000 > Date.now()) {
                        // 显示用户信息
                        DOM.userName.textContent = userData.name;
                        DOM.userEmail.textContent = userData.email;
                        DOM.userAvatar.src = userData.picture;
                        
                        // 显示应用界面
                        DOM.loginSection.style.display = 'none';
                        DOM.dataSection.style.display = 'block';
                        
                        // 初始化应用程序
                        initializeApp();
                    } else {
                        // 令牌已过期
                        localStorage.removeItem('googleToken');
                    }
                } catch (e) {
                    console.error("令牌解析错误", e);
                    localStorage.removeItem('googleToken');
                }
            }
        });
    </script>
</body>
</html>
