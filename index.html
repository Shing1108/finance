<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€²éšå€‹äººè²¡å‹™è¿½è¹¤å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.css" rel="stylesheet">
    <!-- Google API å®¢æˆ¶ç«¯åº« -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-dark': '#4645B2',
                        'primary-light': '#7877E6',
                    }
                }
            }
        }
    </script>
    <style>
        .emoji-btn {
            transition: transform 0.2s;
        }
        .emoji-btn:hover {
            transform: scale(1.1);
        }
        .slide-enter {
            animation: slideIn 0.3s ease forwards;
        }
        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        .close {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .dark .bg-white {
            background-color: #222;
            color: #fff;
        }
        .dark .bg-gray-50 {
            background-color: #181818;
            color: #fff;
        }
        .dark .bg-gray-100 {
            background-color: #2a2a2a;
            color: #fff;
        }
        .dark .text-gray-800 {
            color: #eee;
        }
        .dark .text-gray-700 {
            color: #ddd;
        }
        .dark .text-gray-600 {
            color: #ccc;
        }
        .dark .border-gray-200 {
            border-color: #444;
        }
        .dark .modal-content {
            background-color: #222;
            color: #fff;
        }
        .dark select, .dark input, .dark textarea {
            background-color: #333;
            color: #fff;
            border-color: #555;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 300px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            overflow: hidden;
            display: none;
        }
        .dark .notification {
            background-color: #333;
            color: #fff;
        }
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 4px;
            display: none;
        }
        .threshold-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 8px;
        }
        /* è²¡å‹™åˆ†æå¡ç‰‡ */
        .advice-card {
            border-left: 4px solid;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 6px;
            background-color: rgba(93, 92, 222, 0.05);
        }
        .advice-card.saving {
            border-color: #10B981;
        }
        .advice-card.warning {
            border-color: #F59E0B;
        }
        .advice-card.danger {
            border-color: #EF4444;
        }
        .advice-card.info {
            border-color: #3B82F6;
        }
        /* é¡åˆ¥é ç®—è¦–è¦ºåŒ– */
        .category-budget-bar {
            height: 8px;
            border-radius: 4px;
            background-color: #E5E7EB;
            margin-top: 4px;
            overflow: hidden;
        }
        .category-budget-progress {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        #syncReminder {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #EF4444;
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 999;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .dark #syncReminder {
            background-color: #DC2626;
        }
        .currency-label {
            display: inline-block;
            background-color: rgba(93, 92, 222, 0.1);
            color: #5D5CDE;
            padding: 1px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 4px;
            vertical-align: middle;
        }
        .dark .currency-label {
            background-color: rgba(93, 92, 222, 0.3);
        }
        /* è™›æ“¬æ»¾å‹•ç›¸é—œæ¨£å¼ */
        .virtual-scroll-container {
            position: relative;
            overflow: auto;
            height: 100%;
        }
        .virtual-scroll-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
        }
        /* è¼‰å…¥æŒ‡ç¤ºå™¨ */
        .loading-indicator {
            display: none;
            text-align: center;
            padding: 20px;
            color: #5D5CDE;
        }
        .spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(93, 92, 222, 0.3);
            border-radius: 50%;
            border-top-color: #5D5CDE;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Google Drive æ•´åˆæ¨£å¼ */
        .google-signin-button {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            color: #757575;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px 20px;
            font-family: 'Roboto', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .google-signin-button:hover {
            background-color: #f5f5f5;
        }
        .google-icon {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }
        .dark .google-signin-button {
            background-color: #333;
            color: #fff;
            border-color: #555;
        }
        .dark .google-signin-button:hover {
            background-color: #444;
        }
        .sync-status {
            display: flex;
            align-items: center;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.875rem;
            margin-bottom: 10px;
        }
        .sync-status.success {
            background-color: rgba(16, 185, 129, 0.1);
            color: #10B981;
        }
        .sync-status.error {
            background-color: rgba(239, 68, 68, 0.1);
            color: #EF4444;
        }
        .sync-status.pending {
            background-color: rgba(245, 158, 11, 0.1);
            color: #F59E0B;
        }
        .sync-status i {
            margin-right: 8px;
        }
        .dark .sync-status.success {
            background-color: rgba(16, 185, 129, 0.2);
        }
        .dark .sync-status.error {
            background-color: rgba(239, 68, 68, 0.2);
        }
        .dark .sync-status.pending {
            background-color: rgba(245, 158, 11, 0.2);
        }

        /* æ–°å¢é¡åˆ¥ç®¡ç†æ¨£å¼ */
        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 6px;
            background-color: #f8f9fa;
            transition: background-color 0.2s;
        }
        .category-item:hover {
            background-color: #e9ecef;
        }
        .dark .category-item {
            background-color: #333;
        }
        .dark .category-item:hover {
            background-color: #444;
        }
        .category-delete-btn {
            color: #ef4444;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .category-delete-btn:hover {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <header class="mb-6">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-primary">
                    <span class="mr-2">ğŸ’°</span>é€²éšè²¡å‹™è¿½è¹¤å™¨
                    <span id="selectedCurrency" class="text-sm bg-primary bg-opacity-20 text-primary px-2 py-1 rounded-full ml-2">TWD</span>
                </h1>
                <div class="flex space-x-2">
                    <!-- Google Sign-in Status -->
                    <div id="googleAuthStatus" class="bg-gray-100 text-gray-600 px-3 py-2 rounded-md text-sm hidden items-center">
                        <i class="fab fa-google mr-1"></i>
                        <span id="googleUserName">æœªç™»å…¥</span>
                    </div>
                    <!-- Settings Button -->
                    <button id="settingsBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition">
                        <span class="mr-1">âš™ï¸</span>è¨­å®š
                    </button>
                    <!-- New Day Button -->
                    <button id="newDayBtn" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition">
                        <span class="mr-1">ğŸŒ…</span>é–‹å•Ÿæ–°çš„ä¸€å¤©
                    </button>
                    <!-- Import/Export Button -->
                    <button id="importExportBtn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition">
                        <span class="mr-1">ğŸ’¾</span>åŒ¯å…¥/åŒ¯å‡º
                    </button>
                </div>
            </div>
            <!-- Balance Summary -->
            <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-4 rounded-lg shadow slide-enter border-l-4 border-blue-500">
                    <div class="text-gray-600">ç¸½è³‡ç”¢</div>
                    <div class="text-2xl font-bold text-blue-600"><span id="currencySymbol">$</span> <span id="totalBalance">0.00</span></div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow slide-enter border-l-4 border-green-500">
                    <div class="text-gray-600">ä»Šæ—¥æ”¶å…¥</div>
                    <div class="text-2xl font-bold text-green-600"><span id="currencySymbol2">$</span> <span id="todayIncome">0.00</span></div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow slide-enter border-l-4 border-red-500">
                    <div class="text-gray-600">ä»Šæ—¥æ”¯å‡º</div>
                    <div class="text-2xl font-bold text-red-600"><span id="currencySymbol3">$</span> <span id="todayExpense">0.00</span></div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="mb-6 border-b border-gray-200">
            <ul class="flex flex-wrap -mb-px" id="tabsContainer">
                <li class="mr-2">
                    <button data-tab="dashboard" class="tab-btn inline-block py-2 px-4 border-b-2 font-medium text-primary border-primary">
                        <span class="mr-1">ğŸ“Š</span>å„€è¡¨æ¿
                    </button>
                </li>
                <li class="mr-2">
                    <button data-tab="accounts" class="tab-btn inline-block py-2 px-4 border-b-2 font-medium text-gray-500 hover:text-gray-700 border-transparent">
                        <span class="mr-1">ğŸ’³</span>æˆ¶å£ç®¡ç†
                    </button>
                </li>
                <li class="mr-2">
                    <button data-tab="transactions" class="tab-btn inline-block py-2 px-4 border-b-2 font-medium text-gray-500 hover:text-gray-700 border-transparent">
                        <span class="mr-1">ğŸ“</span>è¨˜è³¬
                    </button>
                </li>
                <li class="mr-2">
                    <button data-tab="budget" class="tab-btn inline-block py-2 px-4 border-b-2 font-medium text-gray-500 hover:text-gray-700 border-transparent">
                        <span class="mr-1">âš™ï¸</span>é ç®—è¨­å®š
                    </button>
                </li>
                <li class="mr-2">
                    <button data-tab="categories" class="tab-btn inline-block py-2 px-4 border-b-2 font-medium text-gray-500 hover:text-gray-700 border-transparent">
                        <span class="mr-1">ğŸ·ï¸</span>é¡åˆ¥ç®¡ç†
                    </button>
                </li>
                <li class="mr-2">
                    <button data-tab="stats" class="tab-btn inline-block py-2 px-4 border-b-2 font-medium text-gray-500 hover:text-gray-700 border-transparent">
                        <span class="mr-1">ğŸ“ˆ</span>çµ±è¨ˆåˆ†æ
                    </button>
                </li>
                <li class="mr-2">
                    <button data-tab="advice" class="tab-btn inline-block py-2 px-4 border-b-2 font-medium text-gray-500 hover:text-gray-700 border-transparent">
                        <span class="mr-1">ğŸ’¡</span>è²¡å‹™å»ºè­°
                    </button>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <main>
            <!-- Dashboard -->
            <div id="dashboard" class="tab-content active slide-enter">
                <div class="mb-8">
                    <h2 class="text-xl font-bold mb-4 text-gray-800"><span class="mr-2">ğŸ“…</span>ä»Šæ—¥äº¤æ˜“</h2>
                    <div id="todayTransactionsEmpty" class="bg-white p-4 rounded-lg shadow text-center text-gray-500">
                        ä»Šæ—¥å°šç„¡äº¤æ˜“è¨˜éŒ„
                    </div>
                    <div id="todayTransactionsTable" class="bg-white rounded-lg shadow overflow-hidden" style="display: none;">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é¡å‹</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æˆ¶å£</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é¡åˆ¥</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é‡‘é¡</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å‚™è¨»</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ”¶æ“š</th>
                                </tr>
                            </thead>
                            <tbody id="todayTransactionsList" class="bg-white divide-y divide-gray-200">
                                <!-- Today transactions will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Budget Status -->
                    <div>
                        <h2 class="text-xl font-bold mb-4 text-gray-800"><span class="mr-2">ğŸ“Š</span>é ç®—ç‹€æ…‹</h2>
                        <div id="noBudget" class="bg-white p-6 rounded-lg shadow text-center">
                            <p class="text-gray-500 mb-4">å°šæœªè¨­å®šé ç®—</p>
                            <button id="goBudgetBtn" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-primary-dark transition">
                                è¨­å®šé ç®—
                            </button>
                        </div>
                        <div id="budgetStatus" class="bg-white p-6 rounded-lg shadow" style="display: none;">
                            <div class="mb-2 flex justify-between">
                                <span class="text-gray-600">é ç®—é€±æœŸ:</span>
                                <span id="budgetCycleText"></span>
                            </div>
                            <div class="mb-2 flex justify-between">
                                <span class="text-gray-600">ç¸½é ç®—:</span>
                                <span class="font-medium"><span id="currencySymbol4">$</span><span id="budgetAmount"></span></span>
                            </div>
                            <div class="mb-2 flex justify-between">
                                <span class="text-gray-600">æ·¨æ”¯å‡º:</span>
                                <span class="font-medium"><span id="currencySymbol5">$</span><span id="budgetUsed"></span></span>
                            </div>
                            <div class="mb-2 flex justify-between">
                                <span class="text-gray-600">å‰©é¤˜é ç®—:</span>
                                <span id="budgetRemaining" class="font-medium"></span>
                            </div>
                            <div class="mt-4">
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div id="budgetBar" class="h-2.5 rounded-full bg-primary"></div>
                                </div>
                                <div id="budgetPercentage" class="text-right text-sm mt-1 text-gray-500"></div>
                            </div>
                            
                            <!-- é¡åˆ¥é ç®—ç‹€æ…‹ (å¦‚æœæœ‰) -->
                            <div id="categoryBudgets" class="mt-4 border-t border-gray-200 pt-4">
                                <h3 class="font-medium text-gray-700 mb-2">é¡åˆ¥é ç®—</h3>
                                <div id="categoryBudgetList">
                                    <!-- é¡åˆ¥é ç®—å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Transactions -->
                    <div>
                        <h2 class="text-xl font-bold mb-4 text-gray-800"><span class="mr-2">ğŸ•’</span>è¿‘æœŸäº¤æ˜“</h2>
                        <div id="noTransactions" class="bg-white p-4 rounded-lg shadow text-center text-gray-500">
                            å°šç„¡äº¤æ˜“è¨˜éŒ„
                        </div>
                        <div id="recentTransactions" class="bg-white rounded-lg shadow overflow-hidden" style="display: none;">
                            <ul id="recentTransactionsList" class="divide-y divide-gray-200">
                                <!-- Recent transactions will be inserted here -->
                            </ul>
                            <div class="p-4 border-t border-gray-200">
                                <button id="viewAllTransactionsBtn" class="text-primary hover:text-primary-dark text-sm font-medium flex items-center">
                                    æŸ¥çœ‹å…¨éƒ¨äº¤æ˜“
                                    <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Accounts Management -->
            <div id="accounts" class="tab-content slide-enter">
                <div id="accountsGrid" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <!-- Account cards will be inserted here -->
                </div>
                
                <!-- Transfer Money Between Accounts -->
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-lg font-bold mb-4"><span class="mr-2">ğŸ”„</span>è½‰è³¬</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-gray-700 mb-2">å¾æˆ¶å£</label>
                            <select id="transferFrom" class="w-full p-2 border border-gray-300 rounded-md text-base">
                                <option value="" disabled selected>é¸æ“‡æˆ¶å£</option>
                                <!-- From account options will be inserted here -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">è‡³æˆ¶å£</label>
                            <select id="transferTo" class="w-full p-2 border border-gray-300 rounded-md text-base">
                                <option value="" disabled selected>é¸æ“‡æˆ¶å£</option>
                                <!-- To account options will be inserted here -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">é‡‘é¡</label>
                            <input type="number" id="transferAmount" placeholder="è¼¸å…¥é‡‘é¡" class="w-full p-2 border border-gray-300 rounded-md text-base">
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button id="transferBtn" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-primary-dark transition">
                            ç¢ºèªè½‰è³¬
                        </button>
                    </div>
                </div>
            </div>

            <!-- Transactions (Record Income/Expense) -->
            <div id="transactions" class="tab-content slide-enter">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4"><span class="mr-2">ğŸ“</span>è¨˜éŒ„æ”¶å…¥/æ”¯å‡º</h2>
                    
                    <div class="mb-4">
                        <div class="flex space-x-4">
                            <button id="incomeBtn" class="flex-1 py-2 px-4 rounded-md font-medium bg-gray-200 text-gray-700">
                                <span class="mr-2">ğŸ’¹</span>æ”¶å…¥
                            </button>
                            <button id="expenseBtn" class="flex-1 py-2 px-4 rounded-md font-medium bg-red-500 text-white">
                                <span class="mr-2">ğŸ’¸</span>æ”¯å‡º
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 mb-2">é¸æ“‡æˆ¶å£</label>
                            <select id="transactionAccount" class="w-full p-2 border border-gray-300 rounded-md text-base">
                                <option value="" disabled selected>é¸æ“‡æˆ¶å£</option>
                                <!-- Account options will be inserted here -->
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 mb-2">é¸æ“‡é¡åˆ¥</label>
                            <div class="flex gap-2">
                                <select id="transactionCategory" class="flex-1 p-2 border border-gray-300 rounded-md text-base">
                                    <option value="" disabled selected>é¸æ“‡é¡åˆ¥</option>
                                    <!-- Category options will be inserted here -->
                                </select>
                                <button id="addCategoryBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 p-2 rounded-md">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 mb-2">é‡‘é¡</label>
                            <input type="number" id="transactionAmount" placeholder="è¼¸å…¥é‡‘é¡" class="w-full p-2 border border-gray-300 rounded-md text-base">
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 mb-2">æ—¥æœŸ</label>
                            <input type="date" id="transactionDate" class="w-full p-2 border border-gray-300 rounded-md text-base">
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-gray-700 mb-2">å‚™è¨» (å¯é¸)</label>
                            <textarea id="transactionNote" placeholder="è¼¸å…¥å‚™è¨»" class="w-full p-2 border border-gray-300 rounded-md text-base" rows="2"></textarea>
                        </div>
                        
                        <!-- æ”¶æ“šä¸Šå‚³ -->
                        <div class="md:col-span-2">
                            <div class="flex items-center justify-between mb-2">
                                <label class="block text-gray-700">æ”¶æ“šåœ–ç‰‡ (å¯é¸)</label>
                                <div class="flex items-center">
                                    <input type="checkbox" id="enableReceiptUpload" class="mr-2">
                                    <label for="enableReceiptUpload" class="text-sm text-gray-600">å•Ÿç”¨æ”¶æ“šä¸Šå‚³</label>
                                </div>
                            </div>
                            <div id="receiptUploadContainer" style="display: none;">
                                <input type="file" id="receiptImage" accept="image/*" class="w-full p-2 border border-gray-300 rounded-md text-base">
                                <img id="receiptPreview" class="image-preview" alt="æ”¶æ“šé è¦½">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-end">
                        <button id="saveTransactionBtn" class="bg-primary text-white px-6 py-2 rounded-md hover:bg-primary-dark transition">
                            <span class="mr-2">âœ…</span>ä¿å­˜
                        </button>
                    </div>
                </div>
            </div>

            <!-- Budget Setting -->
            <div id="budget" class="tab-content slide-enter">
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h2 class="text-xl font-bold mb-4"><span class="mr-2">âš™ï¸</span>ç¸½é ç®—è¨­å®š</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
           
<div>
    <label class="block text-gray-700 mb-2">é ç®—é‡‘é¡ (é¡åˆ¥é ç®—ç¸½å’Œ)</label>
    <div class="flex items-center">
        <div id="totalBudgetDisplay" class="p-2 bg-gray-100 border border-gray-300 rounded-md text-base w-full">
            <span id="totalBudgetAmount">0.00</span>
        </div>
        <div class="ml-2 text-sm text-gray-500 italic">è‡ªå‹•è¨ˆç®—</div>
    </div>
</div>
                        
                        <div>
                            <label class="block text-gray-700 mb-2">é‡è¨­é€±æœŸ</label>
                            <select id="budgetCycle" class="w-full p-2 border border-gray-300 rounded-md text-base">
                                <option value="daily">æ¯æ—¥</option>
                                <option value="weekly">æ¯é€±</option>
                                <option value="monthly" selected>æ¯æœˆ</option>
                            </select>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-gray-700 mb-2">é€šçŸ¥é–¾å€¼è¨­å®š</label>
                            <div id="thresholdContainer">
                                <!-- é–¾å€¼é …ç›®å°‡åœ¨é€™è£¡æ·»åŠ  -->
                                <div class="threshold-item">
                                    <input type="number" class="threshold-value p-2 border border-gray-300 rounded-md text-base w-20" min="1" max="100" value="80">
                                    <span class="text-gray-600">% æ™‚é€šçŸ¥</span>
                                    <span class="flex-grow"></span>
                                    <button class="remove-threshold text-red-500 hover:text-red-700">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <button id="addThresholdBtn" class="mt-2 bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-md text-sm">
                                <i class="fas fa-plus mr-1"></i> æ·»åŠ é€šçŸ¥é–¾å€¼
                            </button>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 mb-2">é‡è¨­æ—¥</label>
                            <select id="budgetResetDay" class="w-full p-2 border border-gray-300 rounded-md text-base">
                                <!-- Reset day options will be inserted here -->
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 mb-2">æ–°ä¸€å¤©åˆ†æ</label>
                            <select id="dailySummaryTiming" class="w-full p-2 border border-gray-300 rounded-md text-base">
                                <option value="immediate">é–‹å•Ÿæ–°ä¸€å¤©æ™‚ç«‹å³é¡¯ç¤º</option>
                                <option value="manual">æ‰‹å‹•æŸ¥çœ‹</option>
                                <option value="disabled">ä¸é¡¯ç¤º</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-end">
                        <button id="saveBudgetBtn" class="bg-primary text-white px-6 py-2 rounded-md hover:bg-primary-dark transition">
                            <span class="mr-2">âœ…</span>ä¿å­˜è¨­å®š
                        </button>
                    </div>
                </div>
                
                <!-- é¡åˆ¥é ç®—è¨­å®š -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4"><span class="mr-2">ğŸ“Š</span>é¡åˆ¥é ç®—è¨­å®š</h2>
                    
                    <div class="mb-4 flex gap-2">
                        <select id="categoryForBudget" class="flex-1 p-2 border border-gray-300 rounded-md text-base">
                            <option value="" disabled selected>é¸æ“‡é¡åˆ¥</option>
                            <!-- Categories will be populated here -->
                        </select>
                        <input type="number" id="categoryBudgetAmount" placeholder="é‡‘é¡" class="w-32 p-2 border border-gray-300 rounded-md text-base">
                        <button id="addCategoryBudgetBtn" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-primary-dark transition">
                            æ·»åŠ 
                        </button>
                    </div>
                    
                    <div id="categoryBudgetItems" class="divide-y divide-gray-200">
                        <!-- Category budget items will be inserted here -->
                        <div class="text-center text-gray-500 py-4">å°šæœªè¨­ç½®é¡åˆ¥é ç®—</div>
                    </div>
                </div>
            </div>

            <!-- Categories Management - æ–°å¢é é¢ -->
            <div id="categories" class="tab-content slide-enter">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- æ”¶å…¥é¡åˆ¥ -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4"><span class="mr-2">ğŸ’¹</span>æ”¶å…¥é¡åˆ¥</h2>
                        
                        <div class="mb-4 flex gap-2">
                            <input type="text" id="newIncomeCategoryName" placeholder="æ–°å¢æ”¶å…¥é¡åˆ¥" class="flex-1 p-2 border border-gray-300 rounded-md text-base">
                            <button id="addIncomeCategoryBtn" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition">
                                <i class="fas fa-plus"></i> æ–°å¢
                            </button>
                        </div>
                        
                        <div id="incomeCategoriesList" class="mt-4">
                            <!-- æ”¶å…¥é¡åˆ¥å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                    
                    <!-- æ”¯å‡ºé¡åˆ¥ -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4"><span class="mr-2">ğŸ’¸</span>æ”¯å‡ºé¡åˆ¥</h2>
                        
                        <div class="mb-4 flex gap-2">
                            <input type="text" id="newExpenseCategoryName" placeholder="æ–°å¢æ”¯å‡ºé¡åˆ¥" class="flex-1 p-2 border border-gray-300 rounded-md text-base">
                            <button id="addExpenseCategoryBtn" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition">
                                <i class="fas fa-plus"></i> æ–°å¢
                            </button>
                        </div>
                        
                        <div id="expenseCategoriesList" class="mt-4">
                            <!-- æ”¯å‡ºé¡åˆ¥å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div id="stats" class="tab-content slide-enter">
                <div class="mb-6">
                    <h2 class="text-xl font-bold mb-4"><span class="mr-2">ğŸ”</span>æœå°‹äº¤æ˜“</h2>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-gray-700 mb-2">æ—¥æœŸç¯„åœ</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="date" id="searchStartDate" class="w-full p-2 border border-gray-300 rounded-md text-base">
                                    <input type="date" id="searchEndDate" class="w-full p-2 border border-gray-300 rounded-md text-base">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-2">é¡å‹</label>
                                <select id="searchType" class="w-full p-2 border border-gray-300 rounded-md text-base">
                                    <option value="">å…¨éƒ¨</option>
                                    <option value="income">æ”¶å…¥</option>
                                    <option value="expense">æ”¯å‡º</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-2">é¡åˆ¥</label>
                                <select id="searchCategory" class="w-full p-2 border border-gray-300 rounded-md text-base">
                                    <option value="">å…¨éƒ¨é¡åˆ¥</option>
                                    <!-- All categories will be inserted here -->
                                </select>
                            </div>
                        </div>

                        <!-- æ–°å¢å‚™è¨»æœå°‹æ¬„ä½ -->
                        <div class="mt-4">
                            <label class="block text-gray-700 mb-2">å‚™è¨»é—œéµå­—</label>
                            <input type="text" id="searchNote" placeholder="æœå°‹å‚™è¨»é—œéµå­—" class="w-full p-2 border border-gray-300 rounded-md text-base">
                        </div>
                        
                        <div class="mt-4 flex justify-end">
                            <button id="searchBtn" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-primary-dark transition">
                                <span class="mr-2">ğŸ”</span>æœå°‹
                            </button>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h2 class="text-xl font-bold mb-4"><span class="mr-2">ğŸ“‹</span>äº¤æ˜“è¨˜éŒ„</h2>
                    <div id="noSearchResults" class="bg-white p-4 rounded-lg shadow text-center text-gray-500">
                        ç„¡ç¬¦åˆæ¢ä»¶çš„äº¤æ˜“è¨˜éŒ„
                    </div>
                    
                    <!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
                    <div id="searchLoadingIndicator" class="loading-indicator">
                        <div class="spinner"></div>
                        <p class="mt-2">è¼‰å…¥äº¤æ˜“æ•¸æ“šä¸­...</p>
                    </div>
                    
                    <div id="searchResults" class="bg-white rounded-lg shadow overflow-hidden" style="display: none;">
                        <div class="virtual-scroll-container max-h-96">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0 z-10">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ—¥æœŸ</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é¡å‹</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æˆ¶å£</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é¡åˆ¥</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">é‡‘é¡</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å‚™è¨»</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ”¶æ“š</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="searchResultsList" class="bg-white divide-y divide-gray-200">
                                    <!-- Search results will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="p-4 border-t border-gray-200 text-center text-sm text-gray-500" id="resultsCount">
                            é¡¯ç¤º 0 ç­†äº¤æ˜“è¨˜éŒ„
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Financial Advice -->
            <div id="advice" class="tab-content slide-enter">
                <div class="mb-6">
                    <h2 class="text-xl font-bold mb-4 text-gray-800"><span class="mr-2">ğŸ’¡</span>è²¡å‹™å»ºè­°</h2>
                    
                    <div id="noAdviceData" class="bg-white p-6 rounded-lg shadow text-center">
                        <p class="text-gray-500 mb-4">å°šç„¡è¶³å¤ æ•¸æ“šæä¾›è²¡å‹™å»ºè­°</p>
                        <p class="text-gray-500 text-sm">è‡³å°‘éœ€è¦ 5 ç­†äº¤æ˜“è¨˜éŒ„ä¾†ç”Ÿæˆå»ºè­°</p>
                    </div>
                    
                    <div id="adviceContent" class="bg-white p-6 rounded-lg shadow" style="display:none;">
                        <!-- è²¡å‹™å¥åº·æ¦‚æ³ -->
                        <div class="mb-6">
                            <h3 class="font-bold text-gray-800 mb-3">è²¡å‹™å¥åº·æ¦‚æ³</h3>
                            <div class="flex items-center mb-3">
                                <div id="healthScore" class="text-2xl font-bold mr-3">0</div>
                                <div class="flex-grow h-2 bg-gray-200 rounded-full">
                                    <div id="healthScoreBar" class="h-2 rounded-full bg-green-500" style="width: 0%"></div>
                                </div>
                            </div>
                            <p id="healthSummary" class="text-gray-600"></p>
                        </div>
                        
                        <!-- æ”¯å‡ºåˆ†æ -->
                        <div class="mb-6">
                            <h3 class="font-bold text-gray-800 mb-3">æ”¯å‡ºåˆ†æ</h3>
                            <div id="expenseAnalysis"></div>
                        </div>
                        
                        <!-- å„²è“„å»ºè­° -->
                        <div class="mb-6">
                            <h3 class="font-bold text-gray-800 mb-3">å„²è“„å»ºè­°</h3>
                            <div id="savingsAdvice"></div>
                        </div>
                        
                        <!-- é ç®—å»ºè­° -->
                        <div>
                            <h3 class="font-bold text-gray-800 mb-3">é ç®—å»ºè­°</h3>
                            <div id="budgetAdvice"></div>
                        </div>
                    </div>
                </div>
                
                <!-- æ¯æ—¥æ¶ˆè²»æ‘˜è¦ -->
                <div>
                    <h2 class="text-xl font-bold mb-4 text-gray-800"><span class="mr-2">ğŸ“†</span>æ¯æ—¥æ¶ˆè²»æ‘˜è¦</h2>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2">é¸æ“‡æ—¥æœŸ</label>
                            <div class="flex gap-2">
                                <input type="date" id="summaryDate" class="flex-1 p-2 border border-gray-300 rounded-md text-base" value="">
                                <button id="viewSummaryBtn" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-primary-dark transition">
                                    æŸ¥çœ‹æ‘˜è¦
                                </button>
                            </div>
                        </div>
                        
                        <div id="dailySummaryContainer" class="mt-4 border-t border-gray-200 pt-4" style="display:none;">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <div class="text-sm text-green-600 mb-1">æ”¶å…¥ç¸½è¨ˆ</div>
                                    <div class="text-xl font-bold text-green-700"><span id="summarySymbol1">$</span><span id="summaryIncome">0.00</span></div>
                                </div>
                                <div class="bg-red-50 p-4 rounded-lg">
                                    <div class="text-sm text-red-600 mb-1">æ”¯å‡ºç¸½è¨ˆ</div>
                                    <div class="text-xl font-bold text-red-700"><span id="summarySymbol2">$</span><span id="summaryExpense">0.00</span></div>
                                </div>
                            </div>
                            
                            <h4 class="font-medium text-gray-700 mb-2">æ”¯å‡ºé¡åˆ¥åˆ†ä½ˆ</h4>
                            <div id="summaryCategories" class="mb-4 space-y-2">
                                <!-- é¡åˆ¥åˆ†ä½ˆæœƒåœ¨é€™è£¡é¡¯ç¤º -->
                            </div>
                            
                            <h4 class="font-medium text-gray-700 mb-2">äº¤æ˜“è¨˜éŒ„</h4>
                            <div id="summaryTransactions" class="max-h-60 overflow-y-auto">
                                <!-- äº¤æ˜“è¨˜éŒ„æœƒåœ¨é€™è£¡é¡¯ç¤º -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Modals -->
        <!-- New Account Modal -->
        <div id="newAccountModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3 class="text-xl font-bold mb-4">æ–°å¢æˆ¶å£</h3>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">æˆ¶å£åç¨±</label>
                    <input type="text" id="newAccountName" placeholder="è¼¸å…¥æˆ¶å£åç¨±" class="w-full p-2 border border-gray-300 rounded-md text-base">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">åˆå§‹é¤˜é¡</label>
                    <input type="number" id="newAccountBalance" placeholder="è¼¸å…¥åˆå§‹é¤˜é¡" class="w-full p-2 border border-gray-300 rounded-md text-base">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">é¸æ“‡è²¨å¹£</label>
                    <select id="newAccountCurrency" class="w-full p-2 border border-gray-300 rounded-md text-base">
                        <option value="TWD" selected>æ–°å°å¹£ (TWD)</option>
                        <option value="USD">ç¾å…ƒ (USD)</option>
                        <option value="EUR">æ­å…ƒ (EUR)</option>
                        <option value="JPY">æ—¥å…ƒ (JPY)</option>
                        <option value="CNY">äººæ°‘å¹£ (CNY)</option>
                        <option value="HKD">æ¸¯å¹£ (HKD)</option>
                        <option value="GBP">è‹±éŠ (GBP)</option>
                        <option value="AUD">æ¾³å…ƒ (AUD)</option>
                        <option value="CAD">åŠ æ‹¿å¤§å…ƒ (CAD)</option>
                        <option value="SGD">æ–°åŠ å¡å…ƒ (SGD)</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 mb-2">é¸æ“‡åœ–æ¨™</label>
                    <div id="accountIcons" class="grid grid-cols-5 gap-2">
                        <!-- Account icons will be inserted here -->
                    </div>
                </div>
                <div class="flex justify-end">
                    <button id="addAccountBtn" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-primary-dark transition">
                        æ–°å¢æˆ¶å£
                    </button>
                </div>
            </div>
        </div>

        <!-- New Category Modal -->
        <div id="newCategoryModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3 class="text-xl font-bold mb-4">æ–°å¢é¡åˆ¥</h3>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">é¡åˆ¥åç¨±</label>
                    <input type="text" id="newCategoryName" placeholder="è¼¸å…¥é¡åˆ¥åç¨±" class="w-full p-2 border border-gray-300 rounded-md text-base">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">é¡å‹</label>
                    <div class="flex space-x-4">
                        <button id="newCategoryIncomeBtn" class="flex-1 py-2 px-4 rounded-md font-medium bg-gray-200 text-gray-700">
                            <span class="mr-2">ğŸ’¹</span>æ”¶å…¥
                        </button>
                        <button id="newCategoryExpenseBtn" class="flex-1 py-2 px-4 rounded-md font-medium bg-red-500 text-white">
                            <span class="mr-2">ğŸ’¸</span>æ”¯å‡º
                        </button>
                    </div>
                </div>
                <div class="flex justify-end">
                    <button id="addCategoryConfirmBtn" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-primary-dark transition">
                        æ–°å¢é¡åˆ¥
                    </button>
                </div>
            </div>
        </div>

        <!-- Import/Export Modal -->
        <div id="importExportModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3 class="text-xl font-bold mb-4">æ•¸æ“šåŒ¯å…¥/åŒ¯å‡º</h3>
                
                <!-- Google Drive æ•´åˆ -->
                <div class="mb-6 border-b border-gray-200 pb-4">
                    <h4 class="font-medium mb-3">Google Drive é›²ç«¯åŒæ­¥</h4>
                    <div id="googleAuthSection">
                        <div id="googleSigninStatus" class="sync-status mb-3" style="display: none;">
                            <i class="fas fa-circle-info"></i>
                            <span>å°šæœªç™»å…¥ Google å¸³æˆ¶</span>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row gap-2">
                            <button id="googleSignInBtn" class="google-signin-button flex-1">
                                <svg class="google-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                                    <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                                    <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                                    <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                                    <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                                </svg>
                                ä½¿ç”¨ Google å¸³æˆ¶ç™»å…¥
                            </button>
                            <button id="googleSignOutBtn" class="google-signin-button flex-1" style="display: none;">
                                <i class="fas fa-sign-out-alt mr-2"></i>
                                ç™»å‡º Google å¸³æˆ¶
                            </button>
                        </div>
                    </div>

                    <div id="googleDriveActions" class="mt-3" style="display: none;">
                        <div class="flex flex-col sm:flex-row gap-2">
                            <button id="saveToDriveBtn" class="flex-1 bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition">
                                <i class="fas fa-cloud-upload-alt mr-1"></i> ä¿å­˜åˆ° Google Drive
                            </button>
                            <button id="loadFromDriveBtn" class="flex-1 bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition">
                                <i class="fas fa-cloud-download-alt mr-1"></i> å¾ Google Drive è¼‰å…¥
                            </button>
                        </div>
                        
                        <div class="flex items-center mt-3">
                            <input type="checkbox" id="enableAutoSync" class="mr-2">
                            <label for="enableAutoSync" class="text-gray-700">å•Ÿç”¨è‡ªå‹•åŒæ­¥</label>
                        </div>
                        
                        <div id="autoSyncOptions" class="mt-2 ml-6" style="display: none;">
                            <div class="flex items-center">
                                <input type="radio" id="autoSyncDaily" name="autoSyncFreq" value="daily" class="mr-2">
                                <label for="autoSyncDaily" class="text-gray-700 mr-4">æ¯æ—¥</label>
                                
                                <input type="radio" id="autoSyncWeekly" name="autoSyncFreq" value="weekly" class="mr-2">
                                <label for="autoSyncWeekly" class="text-gray-700 mr-4">æ¯é€±</label>
                                
                                <input type="radio" id="autoSyncMonthly" name="autoSyncFreq" value="monthly" class="mr-2">
                                <label for="autoSyncMonthly" class="text-gray-700">æ¯æœˆ</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <h4 class="font-medium mb-2">åŒ¯å‡ºæ•¸æ“š</h4>
                    <p class="text-sm text-gray-600 mb-2">è¤‡è£½ä¸‹æ–¹æ–‡æœ¬ä»¥å‚™ä»½æ‚¨çš„æ•¸æ“šï¼š</p>
                    <textarea id="exportDataArea" class="w-full h-40 p-2 border border-gray-300 rounded-md bg-gray-50 text-sm" readonly></textarea>
                    <div class="flex gap-2 mt-2">
                        <button id="copyExportBtn" class="flex-1 bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition">
                            <i class="fas fa-copy mr-1"></i> è¤‡è£½åˆ°å‰ªè²¼æ¿
                        </button>
                        <button id="downloadExportBtn" class="flex-1 bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition">
                            <i class="fas fa-download mr-1"></i> ä¸‹è¼‰ç‚ºæ–‡ä»¶
                        </button>
                    </div>
                </div>
                
                <div class="mt-6">
                    <h4 class="font-medium mb-2">åŒ¯å…¥æ•¸æ“š</h4>
                    <div class="flex gap-2 mb-2">
                        <button id="uploadImportBtn" class="flex-1 bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition">
                            <i class="fas fa-upload mr-1"></i> å¾æ–‡ä»¶ä¸Šå‚³
                        </button>
                        <input type="file" id="importFile" accept=".json,.txt" class="hidden">
                    </div>
                    <p class="text-sm text-gray-600 mb-2">æˆ–è²¼ä¸Šä¹‹å‰åŒ¯å‡ºçš„æ•¸æ“šï¼š</p>
                    <textarea id="importDataArea" class="w-full h-40 p-2 border border-gray-300 rounded-md text-sm"></textarea>
                    <button id="importDataBtn" class="w-full bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition mt-2">
                        <i class="fas fa-check mr-1"></i> åŒ¯å…¥æ•¸æ“š
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Settings Modal -->
        <div id="settingsModal" class="modal">
            
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3 class="text-xl font-bold mb-4">ç³»çµ±è¨­å®š</h3>
                
              <div class="mb-4">
    <h4 class="font-medium mb-2">åŒ¯ç‡è¨­å®š</h4>
    <div class="mb-3">
        <label class="block text-gray-700 mb-2">åŸºæº–è²¨å¹£</label>
        <select id="baseCurrencySelect" class="w-full p-2 border border-gray-300 rounded-md text-base">
            <option value="TWD">æ–°å°å¹£ (TWD)</option>
            <option value="USD">ç¾å…ƒ (USD)</option>
            <option value="EUR">æ­å…ƒ (EUR)</option>
            <option value="JPY">æ—¥å…ƒ (JPY)</option>
            <option value="CNY">äººæ°‘å¹£ (CNY)</option>
            <option value="HKD">æ¸¯å¹£ (HKD)</option>
            <option value="GBP">è‹±éŠ (GBP)</option>
            <option value="AUD">æ¾³å…ƒ (AUD)</option>
            <option value="CAD">åŠ æ‹¿å¤§å…ƒ (CAD)</option>
            <option value="SGD">æ–°åŠ å¡å…ƒ (SGD)</option>
        </select>
    </div>
    
    <div class="flex items-center mb-3">
        <span class="text-gray-600">ä¸Šæ¬¡æ›´æ–°: </span>
        <span id="lastRateUpdateText" class="ml-2">æœªæ›´æ–°</span>
    </div>
    
    <button id="updateRatesBtn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition">
        <i class="fas fa-sync-alt mr-1"></i> æ›´æ–°åŒ¯ç‡
    </button>
    
    <div class="mt-3">
        <div class="flex justify-between items-center mb-2">
            <h5 class="font-medium">ç•¶å‰åŒ¯ç‡</h5>
            <button id="toggleRatesBtn" class="text-primary text-sm">
                <i class="fas fa-eye"></i> é¡¯ç¤º/éš±è—
            </button>
        </div>
        <div id="exchangeRatesList" class="bg-gray-50 p-3 rounded-md text-sm hidden">
            <!-- æ±‡ç‡æ•°æ®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
    </div>
</div>
                
                <div class="mb-4">
                    <h4 class="font-medium mb-2">æ€§èƒ½è¨­å®š</h4>
                    <div class="flex items-center mb-2">
                        <input type="checkbox" id="enableVirtualization" class="mr-2" checked>
                        <label for="enableVirtualization" class="text-gray-700">å•Ÿç”¨å¤§é‡æ•¸æ“šå„ªåŒ–</label>
                    </div>
                    <p class="text-sm text-gray-500">å•Ÿç”¨æ­¤åŠŸèƒ½å¯å„ªåŒ–å¤§é‡äº¤æ˜“æ•¸æ“šçš„é¡¯ç¤ºæ€§èƒ½</p>
                    
                    <div class="mt-3">
                        <label class="block text-gray-700 mb-2">æ¯é é¡¯ç¤ºäº¤æ˜“æ•¸</label>
                        <select id="pageSize" class="w-full p-2 border border-gray-300 rounded-md text-base">
                            <option value="50">50ç­†</option>
                            <option value="100">100ç­†</option>
                            <option value="200">200ç­†</option>
                            <option value="500">500ç­†</option>
                            <option value="-1">å…¨éƒ¨é¡¯ç¤º</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-medium mb-2">é€šçŸ¥è¨­å®š</h4>
                    <div class="flex items-center mb-2">
                        <input type="checkbox" id="enableSyncReminders" class="mr-2" checked>
                        <label for="enableSyncReminders" class="text-gray-700">å•Ÿç”¨æ•¸æ“šåŒæ­¥æé†’</label>
                    </div>
                    <p class="text-sm text-gray-500">å®šæœŸæé†’æ‚¨å‚™ä»½æ•¸æ“šï¼Œé˜²æ­¢æ•¸æ“šä¸Ÿå¤±</p>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-medium mb-2">å¤–è§€è¨­å®š</h4>
                    <div class="flex items-center mb-2">
                        <label for="themeSelect" class="text-gray-700 mr-2">ä¸»é¡Œ</label>
                        <select id="themeSelect" class="flex-1 p-2 border border-gray-300 rounded-md text-base">
                            <option value="system">è·Ÿéš¨ç³»çµ±</option>
                            <option value="light">æ·ºè‰²æ¨¡å¼</option>
                            <option value="dark">æ·±è‰²æ¨¡å¼</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-medium mb-2">é€²éšè¨­å®š</h4>
                    <div class="flex items-center mb-2 text-red-600">
                        <button id="resetAppBtn" class="bg-red-100 hover:bg-red-200 text-red-700 px-4 py-2 rounded-md transition">
                            <i class="fas fa-exclamation-triangle mr-1"></i> é‡ç½®æ‡‰ç”¨ç¨‹å¼
                        </button>
                    </div>
                    <p class="text-sm text-red-500">è­¦å‘Šï¼šé€™å°‡åˆªé™¤æ‰€æœ‰æ•¸æ“šä¸¦å°‡æ‡‰ç”¨æ¢å¾©åˆ°åˆå§‹ç‹€æ…‹ï¼</p>
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button id="saveSettingsBtn" class="bg-primary text-white px-6 py-2 rounded-md hover:bg-primary-dark transition">
                        <i class="fas fa-save mr-1"></i> ä¿å­˜è¨­å®š
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Receipt View Modal -->
        <div id="receiptViewModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3 class="text-xl font-bold mb-4">æ”¶æ“šåœ–ç‰‡</h3>
                <div class="flex justify-center items-center">
                    <img id="receiptViewImage" class="max-w-full max-h-[70vh] rounded-lg" src="" alt="æ”¶æ“šåœ–ç‰‡">
                </div>
            </div>
        </div>
        
        <!-- Daily Summary Modal -->
        <div id="dailySummaryModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3 class="text-xl font-bold mb-4">å‰ä¸€å¤©æ¶ˆè²»æ‘˜è¦</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="text-sm text-green-600 mb-1">æ”¶å…¥ç¸½è¨ˆ</div>
                        <div class="text-xl font-bold text-green-700"><span id="summarySymbol3">$</span><span id="modalSummaryIncome">0.00</span></div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg">
                        <div class="text-sm text-red-600 mb-1">æ”¯å‡ºç¸½è¨ˆ</div>
                        <div class="text-xl font-bold text-red-700"><span id="summarySymbol4">$</span><span id="modalSummaryExpense">0.00</span></div>
                    </div>
                </div>
                
                <h4 class="font-medium text-gray-700 mb-2">æ”¯å‡ºé¡åˆ¥åˆ†ä½ˆ</h4>
                <div id="modalSummaryCategories" class="mb-4 space-y-2">
                    <!-- é¡åˆ¥åˆ†ä½ˆæœƒåœ¨é€™è£¡é¡¯ç¤º -->
                </div>
                
                <h4 class="font-medium text-gray-700 mb-2">äº¤æ˜“è¨˜éŒ„</h4>
                <div id="modalSummaryTransactions" class="max-h-60 overflow-y-auto">
                    <!-- äº¤æ˜“è¨˜éŒ„æœƒåœ¨é€™è£¡é¡¯ç¤º -->
                </div>
                
                <div class="mt-4 flex justify-end">
                    <button id="closeSummaryBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition">
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>

        <!-- Notification -->
        <div id="notification" class="notification">
            <div class="p-4">
                <div class="text-center">
                    <div id="notificationIcon" class="text-4xl mb-4"></div>
                    <h3 id="notificationTitle" class="text-lg font-bold mb-2"></h3>
                    <p id="notificationMessage" class="text-gray-600 mb-4"></p>
                </div>
            </div>
        </div>
        
        <!-- Sync Reminder -->
        <div id="syncReminder">
            <div class="flex items-center">
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span>è«‹è¨˜å¾—åŒæ­¥/å‚™ä»½æ‚¨çš„æ•¸æ“šï¼</span>
                <button id="closeSyncReminder" class="ml-3 text-white opacity-80 hover:opacity-100 text-sm">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Google API ç›¸é—œé…ç½®
        const GOOGLE_API_CONFIG = {
            apiKey: 'AIzaSyB6Q_qkp0PowjLYXM2hGPwYGXm7RTOgPBQ', // éœ€è¦æ›¿æ›ç‚ºæ‚¨çš„ Google API Key
            clientId: '75969942287-bkhslov3f4mi6q8lao4ud19bnid9p14e.apps.googleusercontent.com', // éœ€è¦æ›¿æ›ç‚ºæ‚¨çš„ Google Client ID
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
            scopes: 'https://www.googleapis.com/auth/drive.file',
            appFolderName: 'é€²éšè²¡å‹™è¿½è¹¤å™¨',
            dataFileName: 'finance_data.json'
        };

        // Global variables to store data
        let accounts = [];
        let categories = {
            income: [],
            expense: []
        };
        let transactions = [];
        let budget = {
            amount: 0,
            cycle: 'monthly',
            resetDay: 1,
            thresholds: [80],
            lastReset: null
        };
        let categoryBudgets = [];
        let newDayStatus = {
            active: false,
            lastActivated: null
        };
        let appSettings = {
            currency: 'TWD',
            currencySymbol: '$',
            syncRemindersEnabled: true,
            lastSyncReminder: null,
            theme: 'system',
            dailySummaryTiming: 'immediate',
            enableVirtualization: true,
            pageSize: 100,
            
            // Google Drive åŒæ­¥è¨­å®š
            googleSync: {
                enabled: false,
                frequency: 'daily', // daily, weekly, monthly
                lastSync: null,
                fileId: null
            }
            
        };
        // åœ¨å…¨å±€å˜é‡åŒºåŸŸæ·»åŠ ï¼ˆçº¦1950è¡Œå·¦å³ï¼Œåœ¨appSettingsåé¢ï¼‰
let exchangeRates = {}; // å­˜å‚¨æ±‡ç‡æ•°æ®
let baseCurrency = 'TWD'; // åŸºå‡†è´§å¸ï¼Œé»˜è®¤ä¸ºå°å¸
let lastRateUpdate = null; // ä¸Šæ¬¡æ›´æ–°æ±‡ç‡çš„æ—¶é—´
        let dataModified = false; // Track if data has been modified since last sync
        let paginationState = {
            currentPage: 1,
            totalPages: 1,
            pageSize: 100,
            totalItems: 0,
            currentItems: []
        };
        
        // Google Drive API ç‹€æ…‹
        let googleApiInitialized = false;
        let googleUser = null;
        
        // Selected values
        let selectedIcon = 'ğŸ’³';
        let selectedCategoryType = 'expense';
        let transactionType = 'expense';
        
        // Currency symbols
        const currencySymbols = {
            'TWD': '$',
            'USD': '$',
            'EUR': 'â‚¬',
            'JPY': 'Â¥',
            'CNY': 'Â¥',
            'HKD': 'HK$',
            'GBP': 'Â£',
            'AUD': 'A$',
            'CAD': 'C$',
            'SGD': 'S$'
        };
        
        // Check if localStorage is available
        let hasLocalStorage = false;
        try {
            if (typeof localStorage !== 'undefined') {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                hasLocalStorage = true;
            }
        } catch (e) {
            hasLocalStorage = false;
            console.log('localStorage not available:', e);
        }
        
        // DOM Elements
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const newAccountModal = document.getElementById('newAccountModal');
        const newCategoryModal = document.getElementById('newCategoryModal');
        const importExportModal = document.getElementById('importExportModal');
        const settingsModal = document.getElementById('settingsModal');
        const receiptViewModal = document.getElementById('receiptViewModal');
        const dailySummaryModal = document.getElementById('dailySummaryModal');
        const notification = document.getElementById('notification');
        const syncReminder = document.getElementById('syncReminder');
        const searchLoadingIndicator = document.getElementById('searchLoadingIndicator');
        
        // Debounce function for performance optimization
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }
        
        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the app
            initApp();
            
            // Setup event listeners
            setupEventListeners();
            
            // Check for dark mode
            applyTheme();
            
            // Initialize Google API
            initGoogleApi();
        });
        
        // Initialize the app
        function initApp() {
            // Load data from localStorage if available
            loadData();
            
            // Set default transaction date
            document.getElementById('transactionDate').value = getTodayFormatted();
            document.getElementById('summaryDate').value = getTodayFormatted();
            
            // Set default search dates (1 month range)
            const today = new Date();
            const monthAgo = new Date();
            monthAgo.setMonth(today.getMonth() - 1);
            
            document.getElementById('searchStartDate').value = formatDateForInput(monthAgo);
            document.getElementById('searchEndDate').value = formatDateForInput(today);
            
            // Update currency display
            updateCurrencyDisplay();
            
            // Initialize UI elements
            updateUI();
            
            // Setup budget reset day options
            updateBudgetResetDayOptions();
            
            // Initialize account icons
            initAccountIcons();
            
            // Initialize receipt upload listener
            initReceiptUpload();
            
            // Apply virtualization settings
            applyVirtualizationSettings();
            
            // Search transactions with default values
            searchTransactions();
            
            // Generate financial advice
            generateFinancialAdvice();
            
            // Check for budget reset
            checkBudgetReset();
            
            // Check new day status
            checkNewDayStatus();
            
            // Check if sync reminder should be shown
            checkSyncReminder();
            
            // ç¡®ä¿æ€»é¢„ç®—æ˜¯ç±»åˆ«é¢„ç®—çš„æ€»å’Œ
updateTotalBudgetDisplay();
            
            // Setup auto-sync options
            setupAutoSync();
        }
        
        // Initialize Google API - å…¨æ–°ç‰ˆæœ¬
        function initGoogleApi() {
            console.log('é–‹å§‹åˆå§‹åŒ– Google API...');
            
            // é‡ç½®æŒ‰éˆ•ç‹€æ…‹å’Œé¡¯ç¤ºåŠ è¼‰ä¸­
            const googleSignInBtn = document.getElementById('googleSignInBtn');
            googleSignInBtn.disabled = true;
            googleSignInBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> è¼‰å…¥ä¸­...';
            updateGoogleSigninStatus('pending', 'Google API æ­£åœ¨åˆå§‹åŒ–...');
            
            // æ¸…é™¤ä¹‹å‰çš„è¶…æ™‚è¨ˆæ™‚å™¨
            if (window.gapiInitTimeout) {
                clearTimeout(window.gapiInitTimeout);
            }
            
            // æœ€å¤§é‡è©¦æ¬¡æ•¸å’Œç•¶å‰é‡è©¦æ¬¡æ•¸
            const MAX_RETRIES = 2;
            let currentRetry = 0;
            
            // æª¢æŸ¥é…ç½®æ˜¯å¦æœ‰æ•ˆ
            if (!GOOGLE_API_CONFIG.apiKey || GOOGLE_API_CONFIG.apiKey === 'YOUR_API_KEY' || 
                !GOOGLE_API_CONFIG.clientId || GOOGLE_API_CONFIG.clientId === 'YOUR_CLIENT_ID') {
                console.error('Google API é…ç½®ç¼ºå°‘ API Key æˆ– Client ID');
                updateGoogleSigninStatus('error', 'Google API é…ç½®éŒ¯èª¤: éœ€è¦æœ‰æ•ˆçš„ API Key å’Œ Client ID');
                googleSignInBtn.disabled = false;
                googleSignInBtn.innerHTML = '<svg class="google-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg> è¨­å®š API Key';
                return;
            }
            
            // æª¢æŸ¥ gapi æ˜¯å¦å·²è¼‰å…¥
            if (typeof gapi === 'undefined') {
                console.error('Google API (gapi) æœªè¼‰å…¥');
                updateGoogleSigninStatus('error', 'Google API æœªè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥ä¸¦é‡æ–°æ•´ç†é é¢');
                googleSignInBtn.disabled = false;
                googleSignInBtn.innerHTML = '<i class="fas fa-sync mr-2"></i> é‡è©¦è¼‰å…¥';
                return;
            }
            
            // å˜—è©¦åˆå§‹åŒ–çš„å‡½æ•¸
            function attemptInitialization() {
                console.log(`å˜—è©¦ Google API åˆå§‹åŒ–... (å˜—è©¦ ${currentRetry + 1}/${MAX_RETRIES + 1})`);
                
                // è¨­ç½®è¶…æ™‚å®šæ™‚å™¨
                const timeoutId = setTimeout(() => {
                    console.warn(`Google API åˆå§‹åŒ–è¶…æ™‚ (å˜—è©¦ ${currentRetry + 1})`);
                    if (currentRetry < MAX_RETRIES) {
                        currentRetry++;
                        attemptInitialization();
                    } else {
                        updateGoogleSigninStatus('error', 'Google API åˆå§‹åŒ–è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥ä¸¦ç¨å¾Œé‡è©¦');
                        googleSignInBtn.disabled = false;
                        googleSignInBtn.innerHTML = '<i class="fas fa-sync mr-2"></i> é‡è©¦è¼‰å…¥';
                    }
                }, 10000);  // 10ç§’è¶…æ™‚
                
                try {
                    // ä½¿ç”¨ç°¡å–®ç›´æ¥çš„æ–¹æ³•è¼‰å…¥ client åº«
                    gapi.load('client:auth2', () => {
                        console.log('gapi.client:auth2 å·²è¼‰å…¥ï¼Œåˆå§‹åŒ–ä¸­...');
                        
                        // åˆå§‹åŒ–å®¢æˆ¶ç«¯
                        gapi.client.init({
                            apiKey: GOOGLE_API_CONFIG.apiKey,
                            clientId: GOOGLE_API_CONFIG.clientId,
                            scope: GOOGLE_API_CONFIG.scopes || 'https://www.googleapis.com/auth/drive.file'
                        })
                        .then(() => {
                            clearTimeout(timeoutId);
                            console.log('Google API åˆå§‹åŒ–æˆåŠŸ');
                            
                            // æ¨™è¨˜ç‚ºå·²åˆå§‹åŒ–
                            googleApiInitialized = true;
                            
                            // æ›´æ–° UI å’Œç‹€æ…‹
                            googleSignInBtn.disabled = false;
                            googleSignInBtn.innerHTML = '<svg class="google-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg> ä½¿ç”¨ Google å¸³æˆ¶ç™»å…¥';
                            updateGoogleSigninStatus('success', 'Google API å·²æº–å‚™å°±ç·’ï¼Œè«‹ç™»å…¥');
                            
                            try {
                                // è¨­ç½®èªè­‰ç‹€æ…‹ç›£è½
                                const authInstance = gapi.auth2.getAuthInstance();
                                if (authInstance) {
                                    authInstance.isSignedIn.listen(updateSignInStatus);
                                    updateSignInStatus(authInstance.isSignedIn.get());
                                }
                                
                                // æª¢æŸ¥è‡ªå‹•åŒæ­¥
                                checkAutoSync();
                            } catch (err) {
                                console.warn('è¨­ç½®èªè­‰ç›£è½å™¨æ™‚ç™¼ç”Ÿéåš´é‡éŒ¯èª¤:', err);
                                // é€™è£¡ä¸å°‡æ•´å€‹åˆå§‹åŒ–æ¨™è¨˜ç‚ºå¤±æ•—ï¼Œå› ç‚ºä¸»è¦åŠŸèƒ½å·²ç¶“åˆå§‹åŒ–æˆåŠŸ
                            }
                        })
                        .catch(error => {
                            clearTimeout(timeoutId);
                            console.error('Google API åˆå§‹åŒ–éŒ¯èª¤:', error);
                            
                            if (currentRetry < MAX_RETRIES) {
                                // é‡è©¦
                                currentRetry++;
                                console.log(`åˆå§‹åŒ–å¤±æ•—ï¼Œæ­£åœ¨é‡è©¦ (${currentRetry}/${MAX_RETRIES})...`);
                                setTimeout(() => attemptInitialization(), 1000); // å»¶é² 1 ç§’å¾Œé‡è©¦
                            } else {
                                // æ‰€æœ‰é‡è©¦éƒ½å¤±æ•—
                                processInitError(error);
                            }
                        });
                    }, error => {
                        clearTimeout(timeoutId);
                        console.error('ç„¡æ³•è¼‰å…¥ gapi.client:auth2:', error);
                        
                        if (currentRetry < MAX_RETRIES) {
                            // é‡è©¦
                            currentRetry++;
                            console.log(`è¼‰å…¥å¤±æ•—ï¼Œæ­£åœ¨é‡è©¦ (${currentRetry}/${MAX_RETRIES})...`);
                            setTimeout(() => attemptInitialization(), 1000); // å»¶é² 1 ç§’å¾Œé‡è©¦
                        } else {
                            // æ‰€æœ‰é‡è©¦éƒ½å¤±æ•—
                            updateGoogleSigninStatus('error', 'ç„¡æ³•è¼‰å…¥ Google API å®¢æˆ¶ç«¯åº«ï¼Œè«‹ç¨å¾Œé‡è©¦');
                            googleSignInBtn.disabled = false;
                            googleSignInBtn.innerHTML = '<i class="fas fa-sync mr-2"></i> é‡è©¦è¼‰å…¥';
                        }
                    });
                } catch (error) {
                    clearTimeout(timeoutId);
                    console.error('åˆå§‹åŒ–éç¨‹ä¸­ç™¼ç”Ÿåš´é‡éŒ¯èª¤:', error);
                    
                    if (currentRetry < MAX_RETRIES) {
                        // é‡è©¦
                        currentRetry++;
                        console.log(`ç™¼ç”ŸéŒ¯èª¤ï¼Œæ­£åœ¨é‡è©¦ (${currentRetry}/${MAX_RETRIES})...`);
                        setTimeout(() => attemptInitialization(), 1000); // å»¶é² 1 ç§’å¾Œé‡è©¦
                    } else {
                        // æ‰€æœ‰é‡è©¦éƒ½å¤±æ•—
                        processInitError(error);
                    }
                }
            }
            
            // è™•ç†åˆå§‹åŒ–éŒ¯èª¤
            function processInitError(error) {
                let errorMessage = 'åˆå§‹åŒ–å¤±æ•—';
                
                if (error) {
                    if (error.message) {
                        if (error.message.includes('idpiframe_initialization_failed')) {
                            errorMessage = 'ç¬¬ä¸‰æ–¹ Cookie è¢«é˜»æ­¢ï¼Œè«‹åœ¨ç€è¦½å™¨è¨­ç½®ä¸­å…è¨±';
                        } else if (error.message.includes('Missing required parameter')) {
                            errorMessage = 'API åƒæ•¸éŒ¯èª¤ï¼Œè«‹ç¢ºèª API Key å’Œ Client ID';
                        } else if (error.message.includes('Not a valid origin')) {
                            errorMessage = 'ç¶²ç«™ä¾†æºæœªæˆæ¬Šï¼Œè«‹åœ¨ Google Cloud Console æ·»åŠ ';
                        } else if (error.message.includes('disable_third_party_cookies')) {
                            errorMessage = 'ç€è¦½å™¨ç¦æ­¢ç¬¬ä¸‰æ–¹ Cookieï¼Œè«‹åœ¨è¨­ç½®ä¸­å…è¨±';
                        } else if (error.message.includes('network') || error.message.includes('Failed to fetch')) {
                            errorMessage = 'ç¶²çµ¡é€£æ¥éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡';
                        } else if (error.message.includes('The API key or OAuth client is restricted')) {
                            errorMessage = 'API Key ä½¿ç”¨å—é™ï¼Œè«‹ç¢ºèªåŸŸåé™åˆ¶è¨­ç½®';
                        }
                    }
                }
                
                updateGoogleSigninStatus('error', `Google API åˆå§‹åŒ–å¤±æ•—: ${errorMessage}`);
                googleSignInBtn.disabled = false;
                googleSignInBtn.innerHTML = '<i class="fas fa-sync mr-2"></i> é‡è©¦è¼‰å…¥';
                
                // é¡¯ç¤ºæ›´è©³ç´°çš„éŒ¯èª¤é€šçŸ¥ï¼Œä½†ä¿æŒç°¡æ½”
                notify('âŒ', 'åˆå§‹åŒ–å¤±æ•—', `Google API åˆå§‹åŒ–å¤±æ•—: ${errorMessage}`);
            }
            
            // é–‹å§‹ç¬¬ä¸€æ¬¡å˜—è©¦åˆå§‹åŒ–
            attemptInitialization();
        }
        
        // Update sign-in status
        function updateSignInStatus(isSignedIn) {
            if (isSignedIn) {
                const user = gapi.auth2.getAuthInstance().currentUser.get();
                const profile = user.getBasicProfile();
                googleUser = {
                    id: profile.getId(),
                    name: profile.getName(),
                    email: profile.getEmail()
                };
                
                // Update UI
                document.getElementById('googleAuthStatus').style.display = 'flex';
                document.getElementById('googleUserName').textContent = googleUser.name;
                document.getElementById('googleSignInBtn').style.display = 'none';
                document.getElementById('googleSignOutBtn').style.display = 'block';
                document.getElementById('googleDriveActions').style.display = 'block';
                
                updateGoogleSigninStatus('success', `å·²ç™»å…¥ç‚º ${googleUser.name}`);
            } else {
                googleUser = null;
                
                // Update UI
                document.getElementById('googleAuthStatus').style.display = 'none';
                document.getElementById('googleSignInBtn').style.display = 'block';
                document.getElementById('googleSignOutBtn').style.display = 'none';
                document.getElementById('googleDriveActions').style.display = 'none';
                
                updateGoogleSigninStatus('pending', 'å°šæœªç™»å…¥ Google å¸³æˆ¶');
            }
        }
        
        // Sign in to Google
        function signInToGoogle() {
            if (!googleApiInitialized) {
                notify('âŒ', 'Google API å°šæœªåˆå§‹åŒ–', 'è«‹ç¨å¾Œå†è©¦');
                return;
            }
            
            gapi.auth2.getAuthInstance().signIn().catch(error => {
                console.error('Google Sign-in error:', error);
                notify('âŒ', 'ç™»å…¥å¤±æ•—', 'ç„¡æ³•ç™»å…¥åˆ° Google å¸³æˆ¶');
            });
        }
        
        // Sign out from Google
        function signOutFromGoogle() {
            if (!googleApiInitialized) return;
            
            gapi.auth2.getAuthInstance().signOut().then(() => {
                notify('âœ…', 'å·²ç™»å‡º', 'å·²æˆåŠŸç™»å‡º Google å¸³æˆ¶');
            }).catch(error => {
                console.error('Google Sign-out error:', error);
            });
        }
        
        // Update Google signin status in the import/export modal
        function updateGoogleSigninStatus(type, message) {
            const statusElement = document.getElementById('googleSigninStatus');
            statusElement.style.display = 'flex';
            statusElement.className = `sync-status ${type}`;
            
            let icon = 'fa-circle-info';
            if (type === 'success') icon = 'fa-check-circle';
            if (type === 'error') icon = 'fa-times-circle';
            
            statusElement.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
        }
        
        // Save data to Google Drive
        function saveToGoogleDrive() {
            if (!googleUser) {
                notify('âŒ', 'å°šæœªç™»å…¥', 'è«‹å…ˆç™»å…¥ Google å¸³æˆ¶');
                return;
            }
            
            updateGoogleSigninStatus('pending', 'æ­£åœ¨ä¿å­˜åˆ° Google Drive...');
            
            // First, check if our app folder exists
            findOrCreateAppFolder().then(folderId => {
                // Get the data to save
                const data = exportData();
                
                // Check if we already have a file ID
                if (appSettings.googleSync.fileId) {
                    // Update existing file
                    updateDriveFile(appSettings.googleSync.fileId, data).then(() => {
                        appSettings.googleSync.lastSync = new Date().toISOString();
                        saveData('appSettings');
                        updateGoogleSigninStatus('success', 'æ•¸æ“šå·²æˆåŠŸä¿å­˜åˆ° Google Drive');
                        notify('âœ…', 'åŒæ­¥æˆåŠŸ', 'æ•¸æ“šå·²æˆåŠŸä¿å­˜åˆ° Google Drive');
                    }).catch(error => {
                        console.error('Error updating file:', error);
                        updateGoogleSigninStatus('error', 'ä¿å­˜å¤±æ•—ï¼Œæ­£åœ¨å˜—è©¦å‰µå»ºæ–°æ–‡ä»¶...');
                        
                        // Try creating a new file instead
                        createDriveFile(folderId, data);
                    });
                } else {
                    // Create new file
                    createDriveFile(folderId, data);
                }
            }).catch(error => {
                console.error('Error with Google Drive folder:', error);
                updateGoogleSigninStatus('error', 'ç„¡æ³•è¨ªå•æˆ–å‰µå»º Google Drive æ–‡ä»¶å¤¾');
                notify('âŒ', 'åŒæ­¥å¤±æ•—', 'ç„¡æ³•è¨ªå•æˆ–å‰µå»º Google Drive æ–‡ä»¶å¤¾');
            });
        }
        
        // Find or create app folder in Google Drive
        function findOrCreateAppFolder() {
            return new Promise((resolve, reject) => {
                // Search for existing folder
                gapi.client.drive.files.list({
                    q: `name='${GOOGLE_API_CONFIG.appFolderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                    spaces: 'drive',
                    fields: 'files(id, name)'
                }).then(response => {
                    const folders = response.result.files;
                    
                    if (folders && folders.length > 0) {
                        // Folder found
                        resolve(folders[0].id);
                    } else {
                        // Create folder
                        gapi.client.drive.files.create({
                            resource: {
                                name: GOOGLE_API_CONFIG.appFolderName,
                                mimeType: 'application/vnd.google-apps.folder'
                            },
                            fields: 'id'
                        }).then(response => {
                            resolve(response.result.id);
                        }).catch(error => {
                            reject(error);
                        });
                    }
                }).catch(error => {
                    reject(error);
                });
            });
        }
        
        // Create a new file in Google Drive
        function createDriveFile(folderId, data) {
            const file = new Blob([data], {type: 'application/json'});
            const metadata = {
                name: GOOGLE_API_CONFIG.dataFileName,
                mimeType: 'application/json',
                parents: [folderId]
            };
            
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
            form.append('file', file);
            
            fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({
                    'Authorization': 'Bearer ' + gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token
                }),
                body: form
            }).then(response => response.json())
              .then(result => {
                  appSettings.googleSync.fileId = result.id;
                  appSettings.googleSync.lastSync = new Date().toISOString();
                  saveData('appSettings');
                  
                  updateGoogleSigninStatus('success', 'æ•¸æ“šå·²æˆåŠŸä¿å­˜åˆ° Google Drive');
                  notify('âœ…', 'åŒæ­¥æˆåŠŸ', 'æ•¸æ“šå·²æˆåŠŸä¿å­˜åˆ° Google Drive');
              })
              .catch(error => {
                  console.error('Error creating file:', error);
                  updateGoogleSigninStatus('error', 'å‰µå»ºæ–‡ä»¶å¤±æ•—');
                  notify('âŒ', 'åŒæ­¥å¤±æ•—', 'ç„¡æ³•åœ¨ Google Drive ä¸­å‰µå»ºæ–‡ä»¶');
              });
        }
        
        // Update existing file in Google Drive
        function updateDriveFile(fileId, data) {
            return new Promise((resolve, reject) => {
                const file = new Blob([data], {type: 'application/json'});
                
                fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                    method: 'PATCH',
                    headers: new Headers({
                        'Authorization': 'Bearer ' + gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token,
                        'Content-Type': 'application/json'
                    }),
                    body: file
                }).then(response => {
                    if (response.ok) {
                        resolve();
                    } else {
                        reject(new Error('Failed to update file'));
                    }
                }).catch(error => {
                    reject(error);
                });
            });
        }
        
        // Load data from Google Drive
        function loadFromGoogleDrive() {
            if (!googleUser) {
                notify('âŒ', 'å°šæœªç™»å…¥', 'è«‹å…ˆç™»å…¥ Google å¸³æˆ¶');
                return;
            }
            
            updateGoogleSigninStatus('pending', 'æ­£åœ¨å¾ Google Drive è¼‰å…¥æ•¸æ“š...');
            
            // Check if we have a file ID
            if (appSettings.googleSync.fileId) {
                // Get file content
                gapi.client.drive.files.get({
                    fileId: appSettings.googleSync.fileId,
                    alt: 'media'
                }).then(response => {
                    const data = response.body;
                    
                    // Import the data
                    if (importData(data)) {
                        updateGoogleSigninStatus('success', 'æ•¸æ“šå·²æˆåŠŸå¾ Google Drive è¼‰å…¥');
                        notify('âœ…', 'åŒæ­¥æˆåŠŸ', 'æ•¸æ“šå·²æˆåŠŸå¾ Google Drive è¼‰å…¥');
                    } else {
                        updateGoogleSigninStatus('error', 'è¼‰å…¥çš„æ•¸æ“šæ ¼å¼ä¸æ­£ç¢º');
                    }
                }).catch(error => {
                    console.error('Error loading file:', error);
                    updateGoogleSigninStatus('error', 'ç„¡æ³•è¼‰å…¥æ–‡ä»¶ï¼Œå¯èƒ½å·²è¢«åˆªé™¤');
                    
                    // Clear file ID since it's no longer valid
                    appSettings.googleSync.fileId = null;
                    saveData('appSettings');
                    
                    // Try finding the file
                    findFileInDrive();
                });
            } else {
                // Find the file in Drive
                findFileInDrive();
            }
        }
        
        // Find file in Google Drive
        function findFileInDrive() {
            findOrCreateAppFolder().then(folderId => {
                gapi.client.drive.files.list({
                    q: `name='${GOOGLE_API_CONFIG.dataFileName}' and '${folderId}' in parents and trashed=false`,
                    spaces: 'drive',
                    fields: 'files(id, name, modifiedTime)'
                }).then(response => {
                    const files = response.result.files;
                    
                    if (files && files.length > 0) {
                        // Sort files by modified time (newest first)
                        files.sort((a, b) => new Date(b.modifiedTime) - new Date(a.modifiedTime));
                        
                        // Get the most recent file
                        const fileId = files[0].id;
                        appSettings.googleSync.fileId = fileId;
                        saveData('appSettings');
                        
                        // Load the file
                        gapi.client.drive.files.get({
                            fileId: fileId,
                            alt: 'media'
                        }).then(response => {
                            const data = response.body;
                            
                            // Import the data
                            if (importData(data)) {
                                updateGoogleSigninStatus('success', 'æ•¸æ“šå·²æˆåŠŸå¾ Google Drive è¼‰å…¥');
                                notify('âœ…', 'åŒæ­¥æˆåŠŸ', 'æ•¸æ“šå·²æˆåŠŸå¾ Google Drive è¼‰å…¥');
                            } else {
                                updateGoogleSigninStatus('error', 'è¼‰å…¥çš„æ•¸æ“šæ ¼å¼ä¸æ­£ç¢º');
                            }
                        }).catch(error => {
                            console.error('Error loading file:', error);
                            updateGoogleSigninStatus('error', 'ç„¡æ³•è¼‰å…¥æ–‡ä»¶');
                            notify('âŒ', 'åŒæ­¥å¤±æ•—', 'ç„¡æ³•è¼‰å…¥ Google Drive æ–‡ä»¶');
                        });
                    } else {
                        updateGoogleSigninStatus('error', 'åœ¨ Google Drive ä¸­æ‰¾ä¸åˆ°æ•¸æ“šæ–‡ä»¶');
                        notify('â„¹ï¸', 'æ‰¾ä¸åˆ°æ•¸æ“š', 'åœ¨ Google Drive ä¸­æ‰¾ä¸åˆ°æ•¸æ“šæ–‡ä»¶');
                    }
                }).catch(error => {
                    console.error('Error listing files:', error);
                    updateGoogleSigninStatus('error', 'ç„¡æ³•åˆ—å‡º Google Drive æ–‡ä»¶');
                    notify('âŒ', 'åŒæ­¥å¤±æ•—', 'ç„¡æ³•åˆ—å‡º Google Drive æ–‡ä»¶');
                });
            }).catch(error => {
                console.error('Error finding folder:', error);
                updateGoogleSigninStatus('error', 'ç„¡æ³•è¨ªå• Google Drive æ–‡ä»¶å¤¾');
                notify('âŒ', 'åŒæ­¥å¤±æ•—', 'ç„¡æ³•è¨ªå• Google Drive æ–‡ä»¶å¤¾');
            });
        }
        
        // Setup auto-sync
        function setupAutoSync() {
            const enableAutoSync = document.getElementById('enableAutoSync');
            const autoSyncOptions = document.getElementById('autoSyncOptions');
            
            // Set initial state
            enableAutoSync.checked = appSettings.googleSync.enabled;
            autoSyncOptions.style.display = enableAutoSync.checked ? 'block' : 'none';
            
            // Set frequency
            const frequency = appSettings.googleSync.frequency || 'daily';
            document.getElementById(`autoSync${frequency.charAt(0).toUpperCase() + frequency.slice(1)}`).checked = true;
            
            // Add event listeners
            enableAutoSync.addEventListener('change', function() {
                autoSyncOptions.style.display = this.checked ? 'block' : 'none';
                appSettings.googleSync.enabled = this.checked;
                saveData('appSettings');
            });
            
            // Add event listeners for frequency options
            document.querySelectorAll('input[name="autoSyncFreq"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    appSettings.googleSync.frequency = this.value;
                    saveData('appSettings');
                });
            });
        }
        
        // Check for auto-sync
        function checkAutoSync() {
            if (!googleApiInitialized || !googleUser || !appSettings.googleSync.enabled) return;
            
            const now = new Date();
            const lastSync = appSettings.googleSync.lastSync ? new Date(appSettings.googleSync.lastSync) : null;
            
            // If never synced, sync now
            if (!lastSync) {
                saveToGoogleDrive();
                return;
            }
            
            let shouldSync = false;
            const daysDiff = (now - lastSync) / (1000 * 60 * 60 * 24);
            
            switch (appSettings.googleSync.frequency) {
                case 'daily':
                    shouldSync = daysDiff >= 1;
                    break;
                case 'weekly':
                    shouldSync = daysDiff >= 7;
                    break;
                case 'monthly':
                    shouldSync = daysDiff >= 30;
                    break;
            }
            
            if (shouldSync && dataModified) {
                saveToGoogleDrive();
            }
        }
        
        // Apply virtualization settings
        function applyVirtualizationSettings() {
            paginationState.pageSize = parseInt(appSettings.pageSize) || 100;
            document.getElementById('pageSize').value = paginationState.pageSize === -1 ? "-1" : paginationState.pageSize.toString();
            document.getElementById('enableVirtualization').checked = appSettings.enableVirtualization;
        }
        
        // Load data from localStorage or initialize defaults
        function loadData() {
            if (hasLocalStorage) {
                try {
                    const storedAccounts = localStorage.getItem('finance_accounts');
                    accounts = storedAccounts ? JSON.parse(storedAccounts) : [];
                    
                    const storedCategories = localStorage.getItem('finance_categories');
                    categories = storedCategories ? JSON.parse(storedCategories) : { income: [], expense: [] };
                    
                    const storedTransactions = localStorage.getItem('finance_transactions');
                    transactions = storedTransactions ? JSON.parse(storedTransactions) : [];
                    
                    const storedBudget = localStorage.getItem('finance_budget');
                    budget = storedBudget ? JSON.parse(storedBudget) : budget;
                    
                    const storedCategoryBudgets = localStorage.getItem('finance_category_budgets');
                    categoryBudgets = storedCategoryBudgets ? JSON.parse(storedCategoryBudgets) : [];
                    
                    const storedNewDayStatus = localStorage.getItem('finance_new_day_status');
                    newDayStatus = storedNewDayStatus ? JSON.parse(storedNewDayStatus) : newDayStatus;
                    
                    const storedAppSettings = localStorage.getItem('finance_app_settings');
                    if (storedAppSettings) {
                        appSettings = {...appSettings, ...JSON.parse(storedAppSettings)};
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                    initDefaultData();
                }
            } else {
                initDefaultData();
            }
            
            // If no accounts exist, add a default one
            if (accounts.length === 0) {
                accounts.push({
                    id: generateId(),
                    name: 'ç¾é‡‘',
                    balance: 0,
                    icon: 'ğŸ’µ',
                    currency: 'TWD' // Add default currency
                });
                saveData('accounts');
            }
            
            // Add currency property to existing accounts if missing
            let accountsUpdated = false;
            accounts.forEach(account => {
                if (!account.currency) {
                    account.currency = appSettings.currency || 'TWD';
                    accountsUpdated = true;
                }
            });
            
            if (accountsUpdated) {
                saveData('accounts');
            }
            
            // Initialize default categories if empty
            initDefaultCategories();
            
            // Ensure budget.thresholds exists
            if (!budget.thresholds || !Array.isArray(budget.thresholds)) {
                budget.thresholds = [80];
                saveData('budget');
            }
            
            // Ensure proper structures for receipt images
            transactions.forEach(transaction => {
                if (transaction.receipt && typeof transaction.receipt === 'string') {
                    // Convert string receipts to proper receipt object format
                    transaction.receipt = {
                        data: transaction.receipt,
                        type: 'image/jpeg' // Default type
                    };
                }
            });
            saveData('transactions');
            
                // åŠ è½½æ±‡ç‡æ•°æ®
    if (hasLocalStorage) {
        try {
            const storedRates = localStorage.getItem('finance_exchange_rates');
            const storedRateUpdate = localStorage.getItem('finance_rate_update');
            
            if (storedRates) {
                exchangeRates = JSON.parse(storedRates);
                lastRateUpdate = storedRateUpdate;
            } else {
                // è®¾ç½®é»˜è®¤æ±‡ç‡
                setDefaultExchangeRates();
            }
        } catch (error) {
            console.error('Error loading exchange rates:', error);
            setDefaultExchangeRates();
        }
    } else {
        setDefaultExchangeRates();
    }
    
    // è®¾ç½®åŸºå‡†è´§å¸ï¼ˆä½¿ç”¨åº”ç”¨è®¾ç½®ä¸­çš„é»˜è®¤è´§å¸ï¼‰
    baseCurrency = appSettings.currency;
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°æ±‡ç‡ï¼ˆè¶…è¿‡24å°æ—¶ï¼‰
    checkExchangeRatesUpdate();
}

// æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°æ±‡ç‡
function checkExchangeRatesUpdate() {
    if (!lastRateUpdate) {
        // ä»æœªæ›´æ–°è¿‡ï¼Œç«‹å³æ›´æ–°
        fetchExchangeRates();
        return;
    }
    
    const now = new Date();
    const lastUpdate = new Date(lastRateUpdate);
    const hoursDiff = (now - lastUpdate) / (1000 * 60 * 60);
    
    // å¦‚æœè¶…è¿‡24å°æ—¶ï¼Œæ›´æ–°æ±‡ç‡
    if (hoursDiff >= 24) {
        fetchExchangeRates();
    }
        }
        
        // Save data to localStorage
        function saveData(dataType) {
            if (!hasLocalStorage) return;
            
            try {
                switch (dataType) {
                    case 'accounts':
                        localStorage.setItem('finance_accounts', JSON.stringify(accounts));
                        break;
                    case 'categories':
                        localStorage.setItem('finance_categories', JSON.stringify(categories));
                        break;
                    case 'transactions':
                        localStorage.setItem('finance_transactions', JSON.stringify(transactions));
                        break;
                    case 'budget':
                        localStorage.setItem('finance_budget', JSON.stringify(budget));
                        break;
                    case 'categoryBudgets':
                        localStorage.setItem('finance_category_budgets', JSON.stringify(categoryBudgets));
                        break;
                    case 'newDayStatus':
                        localStorage.setItem('finance_new_day_status', JSON.stringify(newDayStatus));
                        break;
                    case 'appSettings':
                        localStorage.setItem('finance_app_settings', JSON.stringify(appSettings));
                        break;
                    default:
                        // Save all
                        localStorage.setItem('finance_accounts', JSON.stringify(accounts));
                        localStorage.setItem('finance_categories', JSON.stringify(categories));
                        localStorage.setItem('finance_transactions', JSON.stringify(transactions));
                        localStorage.setItem('finance_budget', JSON.stringify(budget));
                        localStorage.setItem('finance_category_budgets', JSON.stringify(categoryBudgets));
                        localStorage.setItem('finance_new_day_status', JSON.stringify(newDayStatus));
                        localStorage.setItem('finance_app_settings', JSON.stringify(appSettings));
                }
                
                // Mark data as modified
                dataModified = true;
                
                // Auto-sync if enabled
                if (appSettings.googleSync.enabled && googleApiInitialized && googleUser) {
                    // Debounced sync to avoid too many API calls
                    if (window.autoSyncTimeout) clearTimeout(window.autoSyncTimeout);
                    window.autoSyncTimeout = setTimeout(() => {
                        saveToGoogleDrive();
                    }, 5000); // Sync after 5 seconds of inactivity
                }
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }
        
        // Initialize default data
        function initDefaultData() {
            // Reset to defaults
            accounts = [{
                id: generateId(),
                name: 'ç¾é‡‘',
                balance: 0,
                icon: 'ğŸ’µ',
                currency: 'TWD'
            }];
            
            categories = {
                income: ['è–ªè³‡', 'çé‡‘', 'æŠ•è³‡æ”¶ç›Š', 'ç¦®é‡‘', 'å…¶ä»–æ”¶å…¥'],
                expense: ['é£²é£Ÿ', 'å¨›æ¨‚', 'è»Šè³‡', 'æ—¥ç”¨', 'å„²éŒ¢', 'é›»ä¿¡', 'å®¶ç”¨', 'æ‡‰æ€¥', 'å¤§é™¸', 'é‚„æ¬¾']
            };
            
            transactions = [];
            
            budget = {
                amount: 0,
                cycle: 'monthly',
                resetDay: 1,
                thresholds: [80],
                lastReset: null
            };
            
            categoryBudgets = [];
            
            newDayStatus = {
                active: false,
                lastActivated: null
            };
            
            appSettings = {
                currency: 'TWD',
                currencySymbol: '$',
                syncRemindersEnabled: true,
                lastSyncReminder: null,
                theme: 'system',
                dailySummaryTiming: 'immediate',
                enableVirtualization: true,
                pageSize: 100,
                googleSync: {
                    enabled: false,
                    frequency: 'daily',
                    lastSync: null,
                    fileId: null
                }
            };
        }
        
        // Initialize default categories
        function initDefaultCategories() {
            if (!categories.income || categories.income.length === 0) {
                categories.income = ['è–ªè³‡', 'çé‡‘', 'æŠ•è³‡æ”¶ç›Š', 'ç¦®é‡‘', 'å…¶ä»–æ”¶å…¥'];
            }
            
            if (!categories.expense || categories.expense.length === 0) {
                categories.expense = ['é£²é£Ÿ', 'å¨›æ¨‚', 'è»Šè³‡', 'æ—¥ç”¨', 'å„²éŒ¢', 'é›»ä¿¡', 'å®¶ç”¨', 'æ‡‰æ€¥', 'å¤§é™¸', 'é‚„æ¬¾'];
            }
            
            saveData('categories');
        }
        
        // Export data to JSON string
        function exportData() {
            const exportData = {
                accounts: accounts,
                categories: categories,
                transactions: transactions,
                budget: budget,
                categoryBudgets: categoryBudgets,
                newDayStatus: newDayStatus,
                appSettings: appSettings,
                exportDate: new Date().toISOString(),
                version: '2.1.0'
            };
            
            // Mark data as synced
            dataModified = false;
            appSettings.lastSyncReminder = new Date().toISOString();
            saveData('appSettings');
            
            return JSON.stringify(exportData, null, 2);
        }
        
        // Import data from JSON string
        function importData(jsonString) {
            try {
                const importedData = JSON.parse(jsonString);
                
                // Validate required data structures
                if (!importedData.accounts || !Array.isArray(importedData.accounts) ||
                    !importedData.categories || !importedData.categories.income || !importedData.categories.expense ||
                    !importedData.transactions || !Array.isArray(importedData.transactions)) {
                    throw new Error('åŒ¯å…¥çš„æ•¸æ“šæ ¼å¼ä¸æ­£ç¢º');
                }
                
                // Import data
                accounts = importedData.accounts;
                categories = importedData.categories;
                transactions = importedData.transactions;
                budget = importedData.budget || budget;
                categoryBudgets = importedData.categoryBudgets || [];
                newDayStatus = importedData.newDayStatus || newDayStatus;
                
                // Merge appSettings to maintain current settings like theme
                if (importedData.appSettings) {
                    // Preserve Google Drive settings
                    const googleSync = appSettings.googleSync;
                    appSettings = {...appSettings, ...importedData.appSettings};
                    appSettings.googleSync = googleSync;
                }
                
                // Add currency to accounts if missing
                accounts.forEach(account => {
                    if (!account.currency) {
                        account.currency = appSettings.currency || 'TWD';
                    }
                });
                
                // Ensure proper structures for receipt images
                transactions.forEach(transaction => {
                    if (transaction.receipt && typeof transaction.receipt === 'string') {
                        transaction.receipt = {
                            data: transaction.receipt,
                            type: 'image/jpeg'
                        };
                    }
                });
                
                // Save all data
                saveData();
                
                // Update currency display
                updateCurrencyDisplay();
                
                // Apply virtualization settings
                applyVirtualizationSettings();
                
                // Update UI
                updateUI();
                searchTransactions();
                generateFinancialAdvice();
                
                // Mark data as synced
                dataModified = false;
                appSettings.lastSyncReminder = new Date().toISOString();
                saveData('appSettings');
                
                return true;
            } catch (error) {
                console.error('Import error:', error);
                notify('âŒ', 'åŒ¯å…¥å¤±æ•—', 'åŒ¯å…¥çš„æ•¸æ“šæ ¼å¼ä¸æ­£ç¢º');
                return false;
            }
        }
        
        // Check if budget needs to be reset
        function checkBudgetReset() {
            if (!budget.lastReset || !budget.amount) return;
            
            const now = new Date();
            const lastReset = new Date(budget.lastReset);
            let shouldReset = false;
            
            switch (budget.cycle) {
                case 'daily':
                    // Reset if it's a new day
                    shouldReset = now.getDate() !== lastReset.getDate() || 
                                now.getMonth() !== lastReset.getMonth() || 
                                now.getFullYear() !== lastReset.getFullYear();
                    break;
                case 'weekly':
                    // Reset if it's the reset day of the week and a week has passed
                    const dayIndex = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'].indexOf(budget.resetDay);
                    if (dayIndex === now.getDay()) {
                        const dayDiff = (now - lastReset) / (1000 * 60 * 60 * 24);
                        shouldReset = dayDiff >= 7;
                    }
                    break;
                case 'monthly':
                    // Reset if it's the reset day of the month
                    shouldReset = now.getDate() === parseInt(budget.resetDay) && 
                                (now.getMonth() !== lastReset.getMonth() || now.getFullYear() !== lastReset.getFullYear());
                    break;
            }
            
            if (shouldReset) {
                budget.lastReset = now.toISOString();
                saveData('budget');
                notify('ğŸ”„', 'é ç®—å·²é‡è¨­', 'æ‚¨çš„é ç®—å·²æ ¹æ“šè¨­å®šçš„é€±æœŸé‡è¨­ã€‚');
            }
        }
        
        // Check new day status
        function checkNewDayStatus() {
            if (!newDayStatus.lastActivated) return;
            
            const now = new Date();
            const lastActivated = new Date(newDayStatus.lastActivated);
            
            // If it's a new calendar day, reset the new day status
            if (now.getDate() !== lastActivated.getDate() || 
                now.getMonth() !== lastActivated.getMonth() || 
                now.getFullYear() !== lastActivated.getFullYear()) {
                newDayStatus.active = false;
                saveData('newDayStatus');
            }
        }
        
        // Start a new day
        function startNewDay() {
            // Get yesterday's date
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayFormatted = formatDateForInput(yesterday);
            
            // Set new day status
            newDayStatus.active = true;
            newDayStatus.lastActivated = new Date().toISOString();
            saveData('newDayStatus');
            
            notify('ğŸŒ…', 'æ–°çš„ä¸€å¤©å·²é–‹å§‹', 'å¾ç¾åœ¨é–‹å§‹ï¼Œæ‰€æœ‰äº¤æ˜“å°‡è¨˜éŒ„ç‚ºä»Šå¤©çš„æ—¥æœŸã€‚');
            
            // Check if we should show daily summary
            if (appSettings.dailySummaryTiming === 'immediate') {
                showDailySummary(yesterdayFormatted);
            }
        }
        
        // Check if sync reminder should be shown
        function checkSyncReminder() {
            if (!appSettings.syncRemindersEnabled) {
                syncReminder.style.display = 'none';
                return;
            }
            
            // Show reminder if data modified and last reminder was more than 3 days ago
            const now = new Date();
            const lastReminder = appSettings.lastSyncReminder ? new Date(appSettings.lastSyncReminder) : null;
            
            if (dataModified && (!lastReminder || ((now - lastReminder) / (1000 * 60 * 60 * 24) >= 3))) {
                syncReminder.style.display = 'block';
            } else {
                syncReminder.style.display = 'none';
            }
        }
        
        // Update currency display
        function updateCurrencyDisplay() {
            // Update currency symbol in header
            document.getElementById('selectedCurrency').textContent = appSettings.currency;
            
            // Update all currency symbols in the UI
            const currencyElements = document.querySelectorAll('[id^="currencySymbol"]');
            currencyElements.forEach(element => {
                element.textContent = appSettings.currencySymbol;
            });
            
            // Update currency symbols in summary modal
            const summarySymbols = document.querySelectorAll('[id^="summarySymbol"]');
            summarySymbols.forEach(element => {
                element.textContent = appSettings.currencySymbol;
            });
        }
        
        // Initialize receipt upload
        function initReceiptUpload() {
            const enableReceiptUpload = document.getElementById('enableReceiptUpload');
            const receiptUploadContainer = document.getElementById('receiptUploadContainer');
            const receiptImage = document.getElementById('receiptImage');
            const receiptPreview = document.getElementById('receiptPreview');
            
            // Toggle receipt upload container
            enableReceiptUpload.addEventListener('change', function() {
                receiptUploadContainer.style.display = this.checked ? 'block' : 'none';
                if (!this.checked) {
                    receiptImage.value = '';
                    receiptPreview.style.display = 'none';
                }
            });
            
            // Preview uploaded image
            receiptImage.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) {
                    receiptPreview.style.display = 'none';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    receiptPreview.src = event.target.result;
                    receiptPreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            });
        }
        
        // Update the UI with current data
        function updateUI() {
            // Update dashboard
            updateDashboard();
            
            // Update accounts tab
            updateAccountsTab();
            
            // Update transaction categories
            updateTransactionCategories();
            
            // Update category budget dropdown
            updateCategoryBudgetDropdown();
            
            // Update category budget items
            updateCategoryBudgetItems();
            
            // Update statistics categories
            updateStatisticsCategories();
            
            // Update account dropdowns
            updateAccountDropdowns();
            
            // Update budget status
            updateBudgetStatus();
            
            // æ›´æ–°æ€»é¢„ç®—æ˜¾ç¤º
updateTotalBudgetDisplay();
            
            // Update budget thresholds
            updateBudgetThresholds();
            
            // Update categories management
            updateCategoriesManagement();
            
            // Update daily summary timing select
            document.getElementById('dailySummaryTiming').value = appSettings.dailySummaryTiming;
            
            // Update settings modal
            updateSettingsModal();
        }
        
        // Update dashboard with current data
        function updateDashboard() {
            
            // æ›´æ–°æ€»ä½™é¢ï¼Œæ˜¾ç¤ºåŸºå‡†è´§å¸ç¬¦å·
    const currencySymbol = currencySymbols[baseCurrency] || appSettings.currencySymbol;
    document.getElementById('totalBalance').textContent = formatNumber(getTotalBalance());
    document.getElementById('selectedCurrency').textContent = baseCurrency;
    
    // æ˜¾ç¤ºä»Šæ—¥æ”¶å…¥/æ”¯å‡ºï¼ˆå·²ç»æŒ‰è´¦æˆ·è´§å¸æ˜¾ç¤ºï¼Œæ— éœ€ä¿®æ”¹ï¼‰
    document.getElementById('todayIncome').textContent = formatNumber(getTodayIncome());
    document.getElementById('todayExpense').textContent = formatNumber(getTodayExpense());
            
            // Update total balance
            document.getElementById('totalBalance').textContent = formatNumber(getTotalBalance());
            
            // Update today income/expense
            document.getElementById('todayIncome').textContent = formatNumber(getTodayIncome());
            document.getElementById('todayExpense').textContent = formatNumber(getTodayExpense());
            
            // Update today transactions
            updateTodayTransactions();
            
            // Update recent transactions
            updateRecentTransactions();
            
            // Update category budgets on dashboard
            updateCategoryBudgetsOnDashboard();
        }
        
        // Update today's transactions on dashboard
        function updateTodayTransactions() {
            const todayTransactions = getTodayTransactions();
            const todayTransactionsEmpty = document.getElementById('todayTransactionsEmpty');
            const todayTransactionsTable = document.getElementById('todayTransactionsTable');
            const todayTransactionsList = document.getElementById('todayTransactionsList');
            
            if (todayTransactions.length === 0) {
                todayTransactionsEmpty.style.display = 'block';
                todayTransactionsTable.style.display = 'none';
                return;
            }
            
            todayTransactionsEmpty.style.display = 'none';
            todayTransactionsTable.style.display = 'block';
            
            // Clear previous content
            todayTransactionsList.innerHTML = '';
            
            // Add each transaction
            todayTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                
                // Type
                const typeCell = document.createElement('td');
                typeCell.className = 'px-6 py-4 whitespace-nowrap';
                typeCell.textContent = transaction.type === 'income' ? 'ğŸ“ˆ æ”¶å…¥' : 'ğŸ“‰ æ”¯å‡º';
                row.appendChild(typeCell);
                
                // Account
                const accountCell = document.createElement('td');
                accountCell.className = 'px-6 py-4 whitespace-nowrap';
                
                const account = getAccount(transaction.account);
                const accountName = account ? account.name : 'æœªçŸ¥æˆ¶å£';
                const currencyCode = account ? account.currency : appSettings.currency;
                
                accountCell.innerHTML = `${accountName} <span class="currency-label">${currencyCode}</span>`;
                row.appendChild(accountCell);
                
                // Category
                const categoryCell = document.createElement('td');
                categoryCell.className = 'px-6 py-4 whitespace-nowrap';
                categoryCell.textContent = transaction.category;
                row.appendChild(categoryCell);
                
                // Amount
                const amountCell = document.createElement('td');
                amountCell.className = 'px-6 py-4 whitespace-nowrap';
                
                // Get currency symbol based on account
                const currencySymbol = getAccountCurrencySymbol(transaction.account);
                
                if (transaction.type === 'income') {
                    amountCell.classList.add('text-green-600');
                    amountCell.classList.add('font-medium');
                } else {
                    amountCell.classList.add('text-red-600');
                    amountCell.classList.add('font-medium');
                }
                amountCell.textContent = currencySymbol + formatNumber(transaction.amount);
                row.appendChild(amountCell);
                
                // Note
                const noteCell = document.createElement('td');
                noteCell.className = 'px-6 py-4 whitespace-nowrap text-gray-500';
                noteCell.textContent = transaction.note || '-';
                row.appendChild(noteCell);
                
                // Receipt
                const receiptCell = document.createElement('td');
                receiptCell.className = 'px-6 py-4 whitespace-nowrap text-center';
                if (transaction.receipt) {
                    const viewBtn = document.createElement('button');
                    viewBtn.className = 'text-primary hover:text-primary-dark';
                    viewBtn.innerHTML = '<i class="fas fa-image"></i>';
                    viewBtn.addEventListener('click', () => {
                        showReceiptImage(transaction.receipt);
                    });
                    receiptCell.appendChild(viewBtn);
                } else {
                    receiptCell.textContent = '-';
                }
                row.appendChild(receiptCell);
                
                todayTransactionsList.appendChild(row);
            });
        }
        
        // Update recent transactions on dashboard
        function updateRecentTransactions() {
            const recentTransactions = getRecentTransactions(5);
            const noTransactions = document.getElementById('noTransactions');
            const recentTransactionsEl = document.getElementById('recentTransactions');
            const recentTransactionsList = document.getElementById('recentTransactionsList');
            
            if (recentTransactions.length === 0) {
                noTransactions.style.display = 'block';
                recentTransactionsEl.style.display = 'none';
                return;
            }
            
            noTransactions.style.display = 'none';
            recentTransactionsEl.style.display = 'block';
            
            // Clear previous content
            recentTransactionsList.innerHTML = '';
            
            // Add each transaction
            recentTransactions.forEach(transaction => {
                const li = document.createElement('li');
                li.className = 'px-4 py-3 hover:bg-gray-50 flex justify-between items-center';
                
                const leftDiv = document.createElement('div');
                
                const emojiSpan = document.createElement('span');
                emojiSpan.className = 'mr-2';
                emojiSpan.textContent = transaction.type === 'income' ? 'ğŸ’¹' : 'ğŸ’¸';
                leftDiv.appendChild(emojiSpan);
                
                const categorySpan = document.createElement('span');
                categorySpan.textContent = transaction.category;
                
                // Add account currency label
                const account = getAccount(transaction.account);
                if (account) {
                    const currencyLabel = document.createElement('span');
                    currencyLabel.className = 'currency-label ml-1';
                    currencyLabel.textContent = account.currency;
                    categorySpan.appendChild(currencyLabel);
                }
                
                leftDiv.appendChild(categorySpan);
                
                const dateDiv = document.createElement('div');
                dateDiv.className = 'text-sm text-gray-500';
                dateDiv.textContent = formatDate(transaction.date);
                leftDiv.appendChild(dateDiv);
                
                const amountDiv = document.createElement('div');
                // Get currency symbol based on account
                const currencySymbol = getAccountCurrencySymbol(transaction.account);
                
                if (transaction.type === 'income') {
                    amountDiv.classList.add('text-green-600');
                    amountDiv.classList.add('font-medium');
                } else {
                    amountDiv.classList.add('text-red-600');
                    amountDiv.classList.add('font-medium');
                }
                amountDiv.textContent = currencySymbol + formatNumber(transaction.amount);
                
                li.appendChild(leftDiv);
                li.appendChild(amountDiv);
                
                recentTransactionsList.appendChild(li);
            });
        }
        
        // Update accounts tab
        function updateAccountsTab() {
            const accountsGrid = document.getElementById('accountsGrid');
            
            // Clear previous content
            accountsGrid.innerHTML = '';
            
            // Add each account
            accounts.forEach(account => {
                const accountCard = document.createElement('div');
                accountCard.className = 'bg-white p-6 rounded-lg shadow relative';
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'absolute top-2 right-2 flex space-x-1';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-500 hover:text-red-700';
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                deleteBtn.addEventListener('click', () => deleteAccount(account.id));
                actionsDiv.appendChild(deleteBtn);
                
                const iconDiv = document.createElement('div');
                iconDiv.className = 'text-3xl mb-2 emoji-btn';
                iconDiv.textContent = account.icon || 'ğŸ’³';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'flex items-center mb-1';
                
                const nameHeading = document.createElement('h3');
                nameHeading.className = 'text-lg font-bold';
                nameHeading.textContent = account.name;
                
                const currencyBadge = document.createElement('span');
                currencyBadge.className = 'currency-label ml-2';
                currencyBadge.textContent = account.currency || appSettings.currency;
                
                nameDiv.appendChild(nameHeading);
                nameDiv.appendChild(currencyBadge);
                
                const balanceDiv = document.createElement('div');
                balanceDiv.className = 'text-2xl font-bold';
                
                // Get currency symbol for this account
                const currencySymbol = account.currency ? 
                    (currencySymbols[account.currency] || appSettings.currencySymbol) : 
                    appSettings.currencySymbol;
                
                balanceDiv.textContent = currencySymbol + formatNumber(account.balance);
                
                accountCard.appendChild(actionsDiv);
                accountCard.appendChild(iconDiv);
                accountCard.appendChild(nameDiv);
                accountCard.appendChild(balanceDiv);
                
                accountsGrid.appendChild(accountCard);
            });
            
            // Add the "Add New Account" card
            const addNewCard = document.createElement('div');
            addNewCard.className = 'bg-gray-100 p-6 rounded-lg shadow border-2 border-dashed border-gray-300 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-200 transition';
            addNewCard.innerHTML = `
                <div class="text-3xl mb-2">â•</div>
                <h3 class="text-lg font-medium text-gray-600">æ–°å¢æˆ¶å£</h3>
            `;
            addNewCard.addEventListener('click', () => {
                document.getElementById('newAccountName').value = '';
                document.getElementById('newAccountBalance').value = '';
                document.getElementById('newAccountCurrency').value = appSettings.currency || 'TWD';
                selectedIcon = 'ğŸ’³';
                updateSelectedAccountIcon();
                openModal('newAccountModal');
            });
            
            accountsGrid.appendChild(addNewCard);
        }
        
        // Update account dropdowns in various forms
        function updateAccountDropdowns() {
            const transferFrom = document.getElementById('transferFrom');
            const transferTo = document.getElementById('transferTo');
            const transactionAccount = document.getElementById('transactionAccount');
            
            // Clear previous options
            transferFrom.innerHTML = '<option value="" disabled selected>é¸æ“‡æˆ¶å£</option>';
            transferTo.innerHTML = '<option value="" disabled selected>é¸æ“‡æˆ¶å£</option>';
            transactionAccount.innerHTML = '<option value="" disabled selected>é¸æ“‡æˆ¶å£</option>';
            
            // Add account options
            accounts.forEach(account => {
                const currencyCode = account.currency || appSettings.currency;
                const displayName = `${account.name} (${currencyCode})`;
                
                const option1 = document.createElement('option');
                option1.value = account.id;
                option1.textContent = displayName;
                
                const option2 = document.createElement('option');
                option2.value = account.id;
                option2.textContent = displayName;
                
                const option3 = document.createElement('option');
                option3.value = account.id;
                option3.textContent = displayName;
                
                transferFrom.appendChild(option1);
                transferTo.appendChild(option2);
                transactionAccount.appendChild(option3);
            });
        }
        
        // Update transaction categories dropdown based on selected type
        function updateTransactionCategories() {
            const transactionCategory = document.getElementById('transactionCategory');
            
            // Clear previous options
            transactionCategory.innerHTML = '<option value="" disabled selected>é¸æ“‡é¡åˆ¥</option>';
            
            // Add category options based on current transaction type
            const categoriesList = categories[transactionType] || [];
            categoriesList.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                transactionCategory.appendChild(option);
            });
        }
        
        function updateCategoryBudgetDropdown() {
    const categoryForBudget = document.getElementById('categoryForBudget');
    
    // æ¸…é™¤ä¹‹å‰çš„é¸é …
    categoryForBudget.innerHTML = '<option value="" disabled selected>é¸æ“‡é¡åˆ¥</option>';
    
    // æ·»åŠ æ‰€æœ‰é¡åˆ¥ï¼ˆåŒ…æ‹¬æ”¶å…¥å’Œæ”¯å‡ºé¡åˆ¥ï¼‰
    const allCategories = [...categories.income, ...categories.expense];
    const uniqueCategories = [...new Set(allCategories)]; // ç§»é™¤é‡è¤‡é …
    
    uniqueCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categoryForBudget.appendChild(option);
    });
    }
        
        // Update category budget items
        function updateCategoryBudgetItems() {
            const categoryBudgetItems = document.getElementById('categoryBudgetItems');
            
            // Clear previous content
            categoryBudgetItems.innerHTML = '';
            
            if (categoryBudgets.length === 0) {
                categoryBudgetItems.innerHTML = '<div class="text-center text-gray-500 py-4">å°šæœªè¨­ç½®é¡åˆ¥é ç®—</div>';
                return;
            }
            
            // Add each category budget
            categoryBudgets.forEach(catBudget => {
                const item = document.createElement('div');
                item.className = 'py-4 flex items-center justify-between';
                
                const leftPart = document.createElement('div');
                leftPart.className = 'flex-1';
                
                const categoryName = document.createElement('div');
                categoryName.className = 'font-medium';
                categoryName.textContent = catBudget.category;
                
                const budgetAmount = document.createElement('div');
                budgetAmount.className = 'text-gray-600';
                budgetAmount.textContent = `é ç®—: ${appSettings.currencySymbol}${formatNumber(catBudget.amount)}`;
                
                leftPart.appendChild(categoryName);
                leftPart.appendChild(budgetAmount);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-500 hover:text-red-700 ml-4';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.addEventListener('click', () => {
                    categoryBudgets = categoryBudgets.filter(b => b.category !== catBudget.category);
                    saveData('categoryBudgets');
                    updateCategoryBudgetItems();
                    updateCategoryBudgetsOnDashboard();
                    updateTotalBudgetDisplay();
                });
                
                item.appendChild(leftPart);
                item.appendChild(deleteBtn);
                
                categoryBudgetItems.appendChild(item);
            });
        }
        
        function updateCategoryBudgetsOnDashboard() {
    const categoryBudgetList = document.getElementById('categoryBudgetList');
    const categoryBudgetsContainer = document.getElementById('categoryBudgets');
    
    // æ¸…é™¤ä¹‹å‰çš„å…§å®¹
    categoryBudgetList.innerHTML = '';
    
    if (categoryBudgets.length === 0) {
        categoryBudgetsContainer.style.display = 'none';
        return;
    }
    
    categoryBudgetsContainer.style.display = 'block';
    
    // ç²å–ç•¶å‰æœˆä»½çš„é–‹å§‹æ—¥æœŸç”¨æ–¼é ç®—è¨ˆç®—
    const now = new Date();
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    
    // æ·»åŠ æ¯å€‹é¡åˆ¥é ç®—
    categoryBudgets.forEach(catBudget => {
        // è®¡ç®—æ”¯å‡º - å‡å°‘é¢„ç®—
        const expenses = transactions
            .filter(t => (t.category === catBudget.category) && 
                       (t.type === 'expense') && 
                       new Date(t.date) >= monthStart)
            .reduce((sum, t) => sum + parseFloat(t.amount), 0);
        
        // è®¡ç®—æ”¶å…¥ - å¢åŠ é¢„ç®—
        const income = transactions
            .filter(t => (t.category === catBudget.category) && 
                       (t.type === 'income') && 
                       new Date(t.date) >= monthStart)
            .reduce((sum, t) => sum + parseFloat(t.amount), 0);
        
        // æ”¯å‡ºå‡å»æ”¶å…¥ = å‡€æ”¯å‡º
        const netSpent = expenses - income;
        
        // å¦‚æœå‡€æ”¯å‡ºä¸ºè´Ÿï¼ˆå³æ”¶å…¥å¤§äºæ”¯å‡ºï¼‰ï¼Œåˆ™è§†ä¸º0
        const effectiveSpent = Math.max(0, netSpent);
        
        const percentage = catBudget.amount > 0 ? Math.min(100, (effectiveSpent / catBudget.amount) * 100) : 0;
        
        const item = document.createElement('div');
        item.className = 'mb-3';
        
        const header = document.createElement('div');
        header.className = 'flex justify-between mb-1';
        
        const categoryName = document.createElement('div');
        categoryName.className = 'text-sm font-medium';
        categoryName.textContent = catBudget.category;
        
        const amountText = document.createElement('div');
        amountText.className = 'text-sm';
        
        // æ˜¾ç¤ºå‡€æ”¯å‡ºå’Œé¢„ç®—
        const remainingBudget = Math.max(0, catBudget.amount - effectiveSpent);
        amountText.textContent = `${appSettings.currencySymbol}${formatNumber(effectiveSpent)} / ${appSettings.currencySymbol}${formatNumber(catBudget.amount)}`;
        
        // æ·»åŠ å‡€ä½™é¢æ˜¾ç¤º
        const balanceText = document.createElement('div');
        balanceText.className = 'text-xs text-gray-500';
        balanceText.textContent = `å‰©é¤˜: ${appSettings.currencySymbol}${formatNumber(remainingBudget)}`;
        
        const progressBar = document.createElement('div');
        progressBar.className = 'category-budget-bar';
        
        const progressFill = document.createElement('div');
        progressFill.className = 'category-budget-progress';
        progressFill.style.width = `${percentage}%`;
        
        // æ ¹æ“šç™¾åˆ†æ¯”ç¢ºå®šé¡è‰²
        if (percentage < 50) {
            progressFill.classList.add('bg-green-500');
        } else if (percentage < 80) {
            progressFill.classList.add('bg-yellow-500');
        } else {
            progressFill.classList.add('bg-red-500');
        }
        
        header.appendChild(categoryName);
        header.appendChild(amountText);
        progressBar.appendChild(progressFill);
        
        item.appendChild(header);
        item.appendChild(balanceText); // æ·»åŠ ä½™é¢æ˜¾ç¤º
        item.appendChild(progressBar);
        
        categoryBudgetList.appendChild(item);
    });
}
        
        // Update statistics categories dropdown
        function updateStatisticsCategories() {
            const searchCategory = document.getElementById('searchCategory');
            
            // Clear previous options
            searchCategory.innerHTML = '<option value="">å…¨éƒ¨é¡åˆ¥</option>';
            
            // Add all categories
            const allCategories = [...categories.income, ...categories.expense];
            const uniqueCategories = [...new Set(allCategories)]; // Remove duplicates
            
            uniqueCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                searchCategory.appendChild(option);
            });
        }
        
        // Update categories management tab
        function updateCategoriesManagement() {
            const incomeCategoriesList = document.getElementById('incomeCategoriesList');
            const expenseCategoriesList = document.getElementById('expenseCategoriesList');
            
            // Clear previous content
            incomeCategoriesList.innerHTML = '';
            expenseCategoriesList.innerHTML = '';
            
            // Add income categories
            if (categories.income.length === 0) {
                incomeCategoriesList.innerHTML = '<div class="text-center text-gray-500 py-4">å°šç„¡æ”¶å…¥é¡åˆ¥</div>';
            } else {
                categories.income.forEach(category => {
                    const item = document.createElement('div');
                    item.className = 'category-item';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = category;
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'category-delete-btn';
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteBtn.addEventListener('click', () => {
                        deleteCategory('income', category);
                    });
                    
                    item.appendChild(nameSpan);
                    item.appendChild(deleteBtn);
                    
                    incomeCategoriesList.appendChild(item);
                });
            }
            
            // Add expense categories
            if (categories.expense.length === 0) {
                expenseCategoriesList.innerHTML = '<div class="text-center text-gray-500 py-4">å°šç„¡æ”¯å‡ºé¡åˆ¥</div>';
            } else {
                categories.expense.forEach(category => {
                    const item = document.createElement('div');
                    item.className = 'category-item';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = category;
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'category-delete-btn';
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteBtn.addEventListener('click', () => {
                        deleteCategory('expense', category);
                    });
                    
                    item.appendChild(nameSpan);
                    item.appendChild(deleteBtn);
                    
                    expenseCategoriesList.appendChild(item);
                });
            }
        }
        
        // Update budget status on dashboard
        function updateBudgetStatus() {
            const noBudget = document.getElementById('noBudget');
            const budgetStatus = document.getElementById('budgetStatus');
            
            if (!budget.amount) {
                noBudget.style.display = 'block';
                budgetStatus.style.display = 'none';
                return;
            }
            
            noBudget.style.display = 'none';
            budgetStatus.style.display = 'block';
            
            // Update budget info
            document.getElementById('budgetCycleText').textContent = getBudgetCycleText();
            document.getElementById('budgetAmount').textContent = formatNumber(budget.amount);
            document.getElementById('budgetUsed').textContent = formatNumber(getBudgetUsed());
            
            const remaining = getBudgetRemaining();
            const remainingEl = document.getElementById('budgetRemaining');
            remainingEl.textContent = appSettings.currencySymbol + formatNumber(remaining);
            
            if (remaining < 0) {
                remainingEl.classList.add('text-red-600');
                remainingEl.classList.remove('text-green-600');
            } else {
                remainingEl.classList.add('text-green-600');
                remainingEl.classList.remove('text-red-600');
            }
            
            // Update budget bar
            const percentage = getBudgetPercentage();
            const budgetBar = document.getElementById('budgetBar');
            budgetBar.style.width = Math.min(percentage, 100) + '%';
            
            if (percentage > 100) {
                budgetBar.classList.add('bg-red-600');
                budgetBar.classList.remove('bg-primary');
            } else {
                budgetBar.classList.add('bg-primary');
                budgetBar.classList.remove('bg-red-600');
            }
            
            document.getElementById('budgetPercentage').textContent = percentage + '% å·²ä½¿ç”¨';
            
            // Update budget form
            
            document.getElementById('budgetCycle').value = budget.cycle;
            if (budget.resetDay) {
                document.getElementById('budgetResetDay').value = budget.resetDay;
            }
        }
        
        // Update budget thresholds
        function updateBudgetThresholds() {
            const thresholdContainer = document.getElementById('thresholdContainer');
            
            // Clear previous content
            thresholdContainer.innerHTML = '';
            
            // Add each threshold
            budget.thresholds.forEach((threshold, index) => {
                const thresholdItem = document.createElement('div');
                thresholdItem.className = 'threshold-item';
                
                const thresholdInput = document.createElement('input');
                thresholdInput.type = 'number';
                thresholdInput.className = 'threshold-value p-2 border border-gray-300 rounded-md text-base w-20';
                thresholdInput.min = 1;
                thresholdInput.max = 100;
                thresholdInput.value = threshold;
                thresholdInput.addEventListener('change', function() {
                    budget.thresholds[index] = parseInt(this.value);
                    // Sort thresholds in descending order
                    budget.thresholds.sort((a, b) => b - a);
                    saveData('budget');
                    updateBudgetThresholds();
                });
                
                const percentText = document.createElement('span');
                percentText.className = 'text-gray-600';
                percentText.textContent = '% æ™‚é€šçŸ¥';
                
                const spacer = document.createElement('span');
                spacer.className = 'flex-grow';
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-threshold text-red-500 hover:text-red-700';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.addEventListener('click', function() {
                    budget.thresholds.splice(index, 1);
                    if (budget.thresholds.length === 0) {
                        budget.thresholds = [80]; // Always have at least one threshold
                    }
                    saveData('budget');
                    updateBudgetThresholds();
                });
                
                thresholdItem.appendChild(thresholdInput);
                thresholdItem.appendChild(percentText);
                thresholdItem.appendChild(spacer);
                thresholdItem.appendChild(removeBtn);
                
                thresholdContainer.appendChild(thresholdItem);
            });
        }
        
        // Update settings modal
        function updateSettingsModal() {
            document.getElementById('currencySelect').value = appSettings.currency;
            document.getElementById('currencySymbolInput').value = appSettings.currencySymbol;
            document.getElementById('enableSyncReminders').checked = appSettings.syncRemindersEnabled;
            document.getElementById('themeSelect').value = appSettings.theme;
            document.getElementById('enableVirtualization').checked = appSettings.enableVirtualization;
            document.getElementById('pageSize').value = appSettings.pageSize === -1 ? "-1" : appSettings.pageSize.toString();
        }
        
        // Update budget reset day options based on selected cycle
        function updateBudgetResetDayOptions() {
            const budgetCycle = document.getElementById('budgetCycle').value;
            const budgetResetDay = document.getElementById('budgetResetDay');
            
            // Clear previous options
            budgetResetDay.innerHTML = '';
            
            // Add options based on cycle
            if (budgetCycle === 'daily') {
                budgetResetDay.disabled = true;
                const option = document.createElement('option');
                option.value = '1';
                option.textContent = 'æ¯æ—¥è‡ªå‹•é‡è¨­';
                budgetResetDay.appendChild(option);
            } else if (budgetCycle === 'weekly') {
                budgetResetDay.disabled = false;
                const days = ['é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­', 'é€±æ—¥'];
                days.forEach(day => {
                    const option = document.createElement('option');
                    option.value = day;
                    option.textContent = day;
                    budgetResetDay.appendChild(option);
                });
            } else if (budgetCycle === 'monthly') {
                budgetResetDay.disabled = false;
                for (let i = 1; i <= 31; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i + 'æ—¥';
                    budgetResetDay.appendChild(option);
                }
            }
            
            // Set default value
            if (budget.resetDay) {
                // Try to find the value in the options
                const options = Array.from(budgetResetDay.options);
                const matchingOption = options.find(option => option.value == budget.resetDay);
                
                if (matchingOption) {
                    budgetResetDay.value = budget.resetDay;
                } else {
                    // If not found (e.g. when switching from monthly to weekly), set the first option
                    budgetResetDay.selectedIndex = 0;
                    budget.resetDay = budgetResetDay.value;
                }
            } else {
                // Set default reset day if not specified
                budgetResetDay.selectedIndex = 0;
                budget.resetDay = budgetResetDay.value;
            }
            document.getElementById('baseCurrencySelect').value = baseCurrency;
    
    // æ˜¾ç¤ºä¸Šæ¬¡æ›´æ–°æ—¶é—´
    const lastUpdateEl = document.getElementById('lastRateUpdateText');
    if (lastRateUpdate) {
        const updateDate = new Date(lastRateUpdate);
        lastUpdateEl.textContent = updateDate.toLocaleString();
    } else {
        lastUpdateEl.textContent = 'æœªæ›´æ–°';
    }
    
    // æ›´æ–°æ±‡ç‡åˆ—è¡¨æ˜¾ç¤º
    updateExchangeRatesList();
}

// æ›´æ–°æ±‡ç‡åˆ—è¡¨æ˜¾ç¤º
function updateExchangeRatesList() {
    const ratesList = document.getElementById('exchangeRatesList');
    ratesList.innerHTML = '';
    
    if (Object.keys(exchangeRates).length === 0) {
        ratesList.innerHTML = '<div class="text-gray-500">ç„¡åŒ¯ç‡æ•¸æ“š</div>';
        return;
    }
    
    // åˆ›å»ºæ±‡ç‡åˆ—è¡¨
    const table = document.createElement('table');
    table.className = 'w-full';
    
    const header = document.createElement('tr');
    header.innerHTML = `
        <th class="text-left pb-2">è²¨å¹£</th>
        <th class="text-right pb-2">åŒ¯ç‡ (ç›¸å°æ–¼ ${baseCurrency})</th>
    `;
    table.appendChild(header);
    
    Object.entries(exchangeRates).forEach(([currency, rate]) => {
        if (currency === baseCurrency) return; // è·³è¿‡åŸºå‡†è´§å¸
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="py-1">${currency}</td>
            <td class="text-right">${formatNumber(rate)}</td>
        `;
        table.appendChild(row);
    });
    
    ratesList.appendChild(table);
        }
        
        // Initialize account icons
        function initAccountIcons() {
            const accountIcons = document.getElementById('accountIcons');
            
            // Clear previous icons
            accountIcons.innerHTML = '';
            
            // Add account icons
            ['ğŸ’³', 'ğŸ’°', 'ğŸ¦', 'ğŸ’´', 'ğŸ’µ', 'ğŸ’¶', 'ğŸ’·', 'ğŸª™', 'ğŸ’¸', 'ğŸ’¹'].forEach(icon => {
                const button = document.createElement('button');
                button.className = 'p-2 rounded-md text-xl emoji-btn';
                if (selectedIcon === icon) {
                    button.classList.add('bg-primary');
                    button.classList.add('text-white');
                } else {
                    button.classList.add('bg-gray-100');
                }
                button.textContent = icon;
                button.addEventListener('click', () => {
                    selectedIcon = icon;
                    updateSelectedAccountIcon();
                });
                
                accountIcons.appendChild(button);
            });
        }
        
        // Update selected account icon
        function updateSelectedAccountIcon() {
            const buttons = document.querySelectorAll('#accountIcons button');
            buttons.forEach(button => {
                if (button.textContent === selectedIcon) {
                    button.classList.remove('bg-gray-100');
                    button.classList.add('bg-primary', 'text-white');
                } else {
                    button.classList.remove('bg-primary', 'text-white');
                    button.classList.add('bg-gray-100');
                }
            });
        }
        
        // Show receipt image in modal
        function showReceiptImage(receipt) {
            if (!receipt) return;
            
            const receiptViewImage = document.getElementById('receiptViewImage');
            receiptViewImage.src = receipt.data;
            
            openModal('receiptViewModal');
        }
        
        // Show daily summary for a specific date
        function showDailySummary(date) {
            // Get transactions for this date
            const dayTransactions = transactions.filter(t => t.date === date);
            
            if (dayTransactions.length === 0) {
                notify('â„¹ï¸', 'æ²’æœ‰äº¤æ˜“è¨˜éŒ„', `${formatDate(date)} æ²’æœ‰äº¤æ˜“è¨˜éŒ„`);
                return;
            }
            
            // Calculate totals
            const income = dayTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
                
            const expense = dayTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            // Get expense categories breakdown
            const expenseCategories = {};
            dayTransactions.filter(t => t.type === 'expense').forEach(t => {
                expenseCategories[t.category] = (expenseCategories[t.category] || 0) + parseFloat(t.amount);
            });
            
            // Update modal content
            document.getElementById('modalSummaryIncome').textContent = formatNumber(income);
            document.getElementById('modalSummaryExpense').textContent = formatNumber(expense);
            
            // Update categories breakdown
            const categoriesContainer = document.getElementById('modalSummaryCategories');
            categoriesContainer.innerHTML = '';
            
            if (Object.keys(expenseCategories).length === 0) {
                categoriesContainer.innerHTML = '<div class="text-gray-500 text-center">ç„¡æ”¯å‡ºé¡åˆ¥</div>';
            } else {
                Object.entries(expenseCategories)
                    .sort((a, b) => b[1] - a[1]) // Sort by amount descending
                    .forEach(([category, amount]) => {
                        const percentage = expense > 0 ? Math.round((amount / expense) * 100) : 0;
                        
                        const item = document.createElement('div');
                        
                        const header = document.createElement('div');
                        header.className = 'flex justify-between text-sm';
                        
                        const categoryText = document.createElement('span');
                        categoryText.textContent = category;
                        
                        const amountText = document.createElement('span');
                        amountText.textContent = `${appSettings.currencySymbol}${formatNumber(amount)} (${percentage}%)`;
                        
                        const bar = document.createElement('div');
                        bar.className = 'h-2 bg-gray-200 rounded-full mt-1';
                        
                        const progress = document.createElement('div');
                        progress.className = 'h-2 bg-primary rounded-full';
                        progress.style.width = `${percentage}%`;
                        
                        header.appendChild(categoryText);
                        header.appendChild(amountText);
                        bar.appendChild(progress);
                        
                        item.appendChild(header);
                        item.appendChild(bar);
                        
                        categoriesContainer.appendChild(item);
                    });
            }
            
            // Update transactions list
            const transactionsContainer = document.getElementById('modalSummaryTransactions');
            transactionsContainer.innerHTML = '';
            
            if (dayTransactions.length === 0) {
                transactionsContainer.innerHTML = '<div class="text-gray-500 text-center">ç„¡äº¤æ˜“è¨˜éŒ„</div>';
            } else {
                dayTransactions.sort((a, b) => b.amount - a.amount).forEach(transaction => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center py-2 border-b border-gray-200';
                    
                    const leftPart = document.createElement('div');
                    
                    const title = document.createElement('div');
                    title.className = 'font-medium';
                    
                    const account = getAccount(transaction.account);
                    const accountName = account ? account.name : 'æœªçŸ¥æˆ¶å£';
                    const currencyCode = account ? account.currency : appSettings.currency;
                    
                    title.innerHTML = `${transaction.category} (${accountName} <span class="currency-label">${currencyCode}</span>)`;
                    
                    const note = document.createElement('div');
                    note.className = 'text-sm text-gray-500';
                    note.textContent = transaction.note || 'ç„¡å‚™è¨»';
                    
                    const amount = document.createElement('div');
                    // Get currency symbol for this account
                    const currencySymbol = getAccountCurrencySymbol(transaction.account);
                    
                    if (transaction.type === 'income') {
                        amount.className = 'text-green-600 font-medium';
                        amount.textContent = `+${currencySymbol}${formatNumber(transaction.amount)}`;
                    } else {
                        amount.className = 'text-red-600 font-medium';
                        amount.textContent = `-${currencySymbol}${formatNumber(transaction.amount)}`;
                    }
                    
                    leftPart.appendChild(title);
                    leftPart.appendChild(note);
                    
                    item.appendChild(leftPart);
                    item.appendChild(amount);
                    
                    transactionsContainer.appendChild(item);
                });
            }
            
            // Show the modal
            openModal('dailySummaryModal');
        }
        
        // Generate financial advice based on transaction data
        function generateFinancialAdvice() {
            const adviceContent = document.getElementById('adviceContent');
            const noAdviceData = document.getElementById('noAdviceData');
            
            // Need at least 5 transactions to provide meaningful advice
            if (transactions.length < 5) {
                adviceContent.style.display = 'none';
                noAdviceData.style.display = 'block';
                return;
            }
            
            // Show advice content
            adviceContent.style.display = 'block';
            noAdviceData.style.display = 'none';
            
            // Calculate financial health score (0-100)
            let healthScore = 50; // Start with neutral score
            
            // Get total income and expenses for the last 30 days
            const lastMonth = new Date();
            lastMonth.setDate(lastMonth.getDate() - 30);
            const lastMonthFormatted = formatDateForInput(lastMonth);
            
            const recentTransactions = transactions.filter(t => t.date >= lastMonthFormatted);
            const monthlyIncome = recentTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const monthlyExpenses = recentTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            // Add points if income > expenses
            if (monthlyIncome > monthlyExpenses) {
                healthScore += 20;
            } else if (monthlyIncome > 0 && monthlyExpenses > monthlyIncome) {
                healthScore -= 20;
            }
            
            // Add points for regular income
            const incomeCount = recentTransactions.filter(t => t.type === 'income').length;
            if (incomeCount >= 2) {
                healthScore += 10;
            }
            
            // Add points for budget usage
            if (budget.amount > 0) {
                healthScore += 10;
                
                // Check if expenses are within budget
                if (monthlyExpenses <= budget.amount) {
                    healthScore += 10;
                } else {
                    healthScore -= 10;
                }
            }
            
            // Add points for using category budgets
            if (categoryBudgets.length > 0) {
                healthScore += 5;
            }
            
            // Add points for using Google Drive sync
            if (appSettings.googleSync.enabled && appSettings.googleSync.lastSync) {
                healthScore += 5;
            }
            
            // Ensure score is between 0-100
            healthScore = Math.max(0, Math.min(100, healthScore));
            
            // Update health score in UI
            document.getElementById('healthScore').textContent = healthScore;
            const healthScoreBar = document.getElementById('healthScoreBar');
            healthScoreBar.style.width = `${healthScore}%`;
            
            // Set color based on score
            if (healthScore < 40) {
                healthScoreBar.classList.remove('bg-green-500', 'bg-yellow-500');
                healthScoreBar.classList.add('bg-red-500');
            } else if (healthScore < 70) {
                healthScoreBar.classList.remove('bg-green-500', 'bg-red-500');
                healthScoreBar.classList.add('bg-yellow-500');
            } else {
                healthScoreBar.classList.remove('bg-yellow-500', 'bg-red-500');
                healthScoreBar.classList.add('bg-green-500');
            }
            
            // Generate health summary text
            let healthSummary = '';
            if (healthScore < 40) {
                healthSummary = 'æ‚¨çš„è²¡å‹™ç‹€æ³éœ€è¦é—œæ³¨ã€‚æ”¯å‡ºä¼¼ä¹è¶…éäº†æ”¶å…¥ï¼Œå¯èƒ½éœ€è¦èª¿æ•´é ç®—æˆ–å¢åŠ æ”¶å…¥ä¾†æºã€‚';
            } else if (healthScore < 70) {
                healthSummary = 'æ‚¨çš„è²¡å‹™ç‹€æ³è™•æ–¼ä¸­ç­‰æ°´å¹³ã€‚æœ‰æ”¹å–„ç©ºé–“ï¼Œå»ºè­°æ›´å¯†åˆ‡åœ°ç›£æ§æ”¯å‡ºä¸¦åˆ¶å®šæ›´è©³ç´°çš„é ç®—è¨ˆåŠƒã€‚';
            } else {
                healthSummary = 'æ‚¨çš„è²¡å‹™ç‹€æ³è‰¯å¥½ã€‚æ‚¨æ­£åœ¨æœ‰æ•ˆåœ°ç®¡ç†æ”¶å…¥å’Œæ”¯å‡ºï¼Œä¸¦éµå¾ªé ç®—è¨ˆåŠƒã€‚';
            }
            document.getElementById('healthSummary').textContent = healthSummary;
            
            // Expense Analysis
            const expenseAnalysis = document.getElementById('expenseAnalysis');
            expenseAnalysis.innerHTML = '';
            
            // Get expense categories breakdown
            const expenseCategories = {};
            transactions
                .filter(t => t.type === 'expense')
                .forEach(t => {
                    expenseCategories[t.category] = (expenseCategories[t.category] || 0) + parseFloat(t.amount);
                });
            
            // Find top expense categories
            const topCategories = Object.entries(expenseCategories)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3);
            
            // Create expense analysis cards
            if (topCategories.length > 0) {
                const topExpenseCard = document.createElement('div');
                topExpenseCard.className = 'advice-card info mb-3';
                
                const title = document.createElement('h4');
                title.className = 'font-medium mb-1';
                title.textContent = 'ä¸»è¦æ”¯å‡ºé¡åˆ¥';
                
                const list = document.createElement('ul');
                list.className = 'text-sm space-y-1';
                
                topCategories.forEach(([category, amount], index) => {
                    const item = document.createElement('li');
                    item.className = 'flex justify-between';
                    item.innerHTML = `
                        <span>${index + 1}. ${category}</span>
                        <span>${appSettings.currencySymbol}${formatNumber(amount)}</span>
                    `;
                    list.appendChild(item);
                });
                
                topExpenseCard.appendChild(title);
                topExpenseCard.appendChild(list);
                expenseAnalysis.appendChild(topExpenseCard);
                
                // Add insight about top category
                if (topCategories.length > 0) {
                    const [topCategory, topAmount] = topCategories[0];
                    const percentage = Math.round((topAmount / Object.values(expenseCategories).reduce((a, b) => a + b, 0)) * 100);
                    
                    const insightCard = document.createElement('div');
                    insightCard.className = percentage > 40 ? 'advice-card warning' : 'advice-card info';
                    
                    const insightText = document.createElement('p');
                    insightText.className = 'text-sm';
                    
                    if (percentage > 40) {
                        insightText.textContent = `${topCategory} ä½”ç¸½æ”¯å‡ºçš„ ${percentage}%ã€‚è€ƒæ…®æª¢è¦–é€™å€‹é¡åˆ¥æ˜¯å¦æœ‰å¯ä»¥ç¯€çœçš„ç©ºé–“ã€‚`;
                    } else {
                        insightText.textContent = `${topCategory} æ˜¯æ‚¨æœ€å¤§çš„æ”¯å‡ºé¡åˆ¥ï¼Œä½”ç¸½æ”¯å‡ºçš„ ${percentage}%ã€‚`;
                    }
                    
                    insightCard.appendChild(insightText);
                    expenseAnalysis.appendChild(insightCard);
                }
            } else {
                expenseAnalysis.innerHTML = '<p class="text-gray-500 text-center">å°šç„¡è¶³å¤ æ”¯å‡ºæ•¸æ“šé€²è¡Œåˆ†æ</p>';
            }
            
            // Savings Advice
            const savingsAdvice = document.getElementById('savingsAdvice');
            savingsAdvice.innerHTML = '';
            
            if (monthlyIncome > 0 && monthlyExpenses > 0) {
                const savingsRate = Math.round(((monthlyIncome - monthlyExpenses) / monthlyIncome) * 100);
                
                const savingsCard = document.createElement('div');
                
                if (savingsRate < 0) {
                    savingsCard.className = 'advice-card danger';
                    savingsCard.innerHTML = `
                        <h4 class="font-medium mb-1">ç•¶å‰æ”¯å‡ºè¶…éæ”¶å…¥</h4>
                        <p class="text-sm">éå» 30 å¤©æ‚¨çš„æ”¯å‡ºè¶…éæ”¶å…¥ ${Math.abs(savingsRate)}%ã€‚å»ºè­°æª¢è¦–æ‚¨çš„å¿…è¦èˆ‡éå¿…è¦æ”¯å‡ºï¼Œä¸¦è€ƒæ…®å¢åŠ æ”¶å…¥ä¾†æºã€‚</p>
                    `;
                } else if (savingsRate < 15) {
                    savingsCard.className = 'advice-card warning';
                    savingsCard.innerHTML = `
                        <h4 class="font-medium mb-1">å„²è“„ç‡åä½</h4>
                        <p class="text-sm">æ‚¨ç›®å‰çš„å„²è“„ç‡ç‚º ${savingsRate}%ã€‚å»ºè­°ç›®æ¨™ç‚ºè‡³å°‘ 20%ã€‚å˜—è©¦æ¸›å°‘éå¿…è¦æ”¯å‡ºä¾†å¢åŠ å„²è“„ç‡ã€‚</p>
                    `;
                } else {
                    savingsCard.className = 'advice-card saving';
                    savingsCard.innerHTML = `
                        <h4 class="font-medium mb-1">è‰¯å¥½çš„å„²è“„ç¿’æ…£</h4>
                        <p class="text-sm">æ‚¨ç›®å‰çš„å„²è“„ç‡ç‚º ${savingsRate}%ï¼Œé€™æ˜¯ä¸€å€‹å¥åº·çš„å„²è“„æ¯”ä¾‹ã€‚è€ƒæ…®å°‡éƒ¨åˆ†å„²è“„ç”¨æ–¼æŠ•è³‡ä»¥ç²å¾—æ›´å¥½çš„é•·æœŸå›å ±ã€‚</p>
                    `;
                }
                
                savingsAdvice.appendChild(savingsCard);
                
                // Add additional savings tip
                const tipCard = document.createElement('div');
                tipCard.className = 'advice-card info mt-2';
                
                // Select a random savings tip
                const savingsTips = [
                    "å»ºç«‹ç·Šæ€¥åŸºé‡‘ï¼Œç†æƒ³æƒ…æ³ä¸‹æ‡‰åŒ…å«3-6å€‹æœˆçš„ç”Ÿæ´»è²»ç”¨ã€‚",
                    "è€ƒæ…®è‡ªå‹•è½‰è³¬å°‡æ”¶å…¥çš„ä¸€éƒ¨åˆ†ç›´æ¥å­˜å…¥å„²è“„è³¬æˆ¶ã€‚",
                    "åˆ¶å®šã€Œå…ˆå„²è“„å¾Œæ¶ˆè²»ã€çš„ç¿’æ…£ï¼Œè€Œä¸æ˜¯ã€Œå…ˆæ¶ˆè²»å¾Œå„²è“„ã€ã€‚",
                    "ç‚ºå¤§ç­†æ”¯å‡ºï¼ˆå¦‚å‡æœŸæˆ–å¤§å‹è³¼ç‰©ï¼‰è¨­ç«‹å°ˆé …å„²è“„ç›®æ¨™ã€‚",
                    "å˜—è©¦éµå¾ª50/30/20æ³•å‰‡ï¼š50%ç”¨æ–¼å¿…éœ€å“ã€30%ç”¨æ–¼å€‹äººæ”¯å‡ºã€20%ç”¨æ–¼å„²è“„ã€‚"
                ];
                
                const randomTip = savingsTips[Math.floor(Math.random() * savingsTips.length)];
                tipCard.innerHTML = `<p class="text-sm"><strong>å„²è“„å°è²¼å£«ï¼š</strong> ${randomTip}</p>`;
                
                savingsAdvice.appendChild(tipCard);
                
                // Add data backup tip if not using Google Drive
                if (!appSettings.googleSync.enabled) {
                    const backupCard = document.createElement('div');
                    backupCard.className = 'advice-card info mt-2';
                    backupCard.innerHTML = `
                        <h4 class="font-medium mb-1">æ•¸æ“šä¿è­·å»ºè­°</h4>
                        <p class="text-sm">è€ƒæ…®å•Ÿç”¨ Google Drive åŒæ­¥ä»¥è‡ªå‹•å‚™ä»½æ‚¨çš„è²¡å‹™æ•¸æ“šï¼Œé¿å…å› ç€è¦½å™¨æ•¸æ“šæ¸…é™¤è€Œä¸Ÿå¤±é‡è¦è¨˜éŒ„ã€‚</p>
                        <button id="enableGoogleSyncBtn" class="mt-2 bg-primary text-white px-3 py-1 rounded-md text-sm hover:bg-primary-dark transition">
                            è¨­å®š Google Drive åŒæ­¥
                        </button>
                    `;
                    savingsAdvice.appendChild(backupCard);
                    
                    // Add event listener after the element is added to the DOM
                    setTimeout(() => {
                        const syncBtn = document.getElementById('enableGoogleSyncBtn');
                        if (syncBtn) {
                            syncBtn.addEventListener('click', () => {
                                openModal('importExportModal');
                            });
                        }
                    }, 0);
                }
            } else {
                savingsAdvice.innerHTML = '<p class="text-gray-500 text-center">å°šç„¡è¶³å¤ æ•¸æ“šæä¾›å„²è“„å»ºè­°</p>';
            }
            
            // Budget Advice
            const budgetAdvice = document.getElementById('budgetAdvice');
            budgetAdvice.innerHTML = '';
            
            if (budget.amount > 0) {
                const budgetCard = document.createElement('div');
                
                const budgetUsed = getBudgetUsed();
                const budgetRemaining = budget.amount - budgetUsed;
                const daysInPeriod = getBudgetDaysInPeriod();
                const daysRemaining = getBudgetDaysRemaining();
                
                if (daysRemaining <= 0) {
                    budgetCard.className = 'advice-card info';
                    budgetCard.innerHTML = `
                        <h4 class="font-medium mb-1">é ç®—æœŸå·²çµæŸ</h4>
                        <p class="text-sm">æœ¬æœŸé ç®—å·²çµæŸã€‚æ–°çš„é ç®—é€±æœŸå³å°‡é–‹å§‹ã€‚</p>
                    `;
                } else {
                    // Calculate ideal daily spending rate
                    const idealDailyBudget = budget.amount / daysInPeriod;
                    const actualDailySpending = budgetUsed / (daysInPeriod - daysRemaining);
                    const remainingDailyBudget = budgetRemaining / daysRemaining;
                    
                    if (budgetRemaining < 0) {
                        budgetCard.className = 'advice-card danger';
                        budgetCard.innerHTML = `
                            <h4 class="font-medium mb-1">é ç®—å·²è¶…æ”¯</h4>
                            <p class="text-sm">æ‚¨å·²è¶…å‡ºæœ¬æœŸé ç®— ${appSettings.currencySymbol}${formatNumber(Math.abs(budgetRemaining))}ã€‚
                            è€ƒæ…®èª¿æ•´æ”¯å‡ºç›´åˆ°ä¸‹å€‹é ç®—é€±æœŸã€‚</p>
                        `;
                    } else if (remainingDailyBudget < 0.5 * idealDailyBudget) {
                        budgetCard.className = 'advice-card warning';
                        budgetCard.innerHTML = `
                            <h4 class="font-medium mb-1">é ç®—ç·Šå¼µ</h4>
                            <p class="text-sm">æ‚¨çš„å‰©é¤˜æ—¥å‡é ç®—ç‚º ${appSettings.currencySymbol}${formatNumber(remainingDailyBudget)}ï¼Œ
                            é¡¯è‘—ä½æ–¼ç†æƒ³æ—¥å‡ ${appSettings.currencySymbol}${formatNumber(idealDailyBudget)}ã€‚å‰©é¤˜ ${daysRemaining} å¤©å…§éœ€è¬¹æ…æ”¯å‡ºã€‚</p>
                        `;
                    } else if (actualDailySpending > 1.2 * idealDailyBudget) {
                        budgetCard.className = 'advice-card warning';
                        budgetCard.innerHTML = `
                            <h4 class="font-medium mb-1">æ”¯å‡ºé€Ÿåº¦éå¿«</h4>
                            <p class="text-sm">æ‚¨ç•¶å‰çš„æ—¥å‡æ”¯å‡º ${appSettings.currencySymbol}${formatNumber(actualDailySpending)} é«˜æ–¼ç†æƒ³æ—¥å‡
                            ${appSettings.currencySymbol}${formatNumber(idealDailyBudget)}ã€‚ä»¥æ­¤é€Ÿåº¦ï¼Œé ç®—å¯èƒ½åœ¨æœŸé™å‰è€—ç›¡ã€‚</p>
                        `;
                    } else {
                        budgetCard.className = 'advice-card saving';
                        budgetCard.innerHTML = `
                            <h4 class="font-medium mb-1">é ç®—åŸ·è¡Œè‰¯å¥½</h4>
                            <p class="text-sm">æ‚¨çš„é ç®—åŸ·è¡Œæƒ…æ³è‰¯å¥½ã€‚å‰©é¤˜ ${daysRemaining} å¤©ï¼Œæ—¥å‡å¯ç”¨ 
                            ${appSettings.currencySymbol}${formatNumber(remainingDailyBudget)}ã€‚</p>
                        `;
                    }
                }
                // æ·»åŠ é ç®—èªªæ˜è¨»é‡‹
const budgetNote = document.createElement('div');
budgetNote.className = 'text-xs text-gray-500 mt-2';
budgetNote.innerHTML = 'æ³¨æ„ï¼šæ‚¨çš„é ç®—è¨ˆç®—åŒ…å«æ‰€æœ‰æ”¶å…¥èˆ‡æ”¯å‡ºäº¤æ˜“ã€‚';
budgetCard.appendChild(budgetNote);
                
                budgetAdvice.appendChild(budgetCard);
                
                // If no category budgets, suggest setting them up
                if (categoryBudgets.length === 0) {
                    const categoryBudgetCard = document.createElement('div');
                    categoryBudgetCard.className = 'advice-card info mt-2';
                    categoryBudgetCard.innerHTML = `
                        <h4 class="font-medium mb-1">è¨­å®šé¡åˆ¥é ç®—</h4>
                        <p class="text-sm">è€ƒæ…®ç‚ºæ‚¨çš„ä¸»è¦æ”¯å‡ºé¡åˆ¥è¨­å®šå…·é«”é ç®—ï¼Œé€™å¯ä»¥å¹«åŠ©æ‚¨æ›´å¥½åœ°æ§åˆ¶ç‰¹å®šé ˜åŸŸçš„æ”¯å‡ºã€‚</p>
                    `;
                    budgetAdvice.appendChild(categoryBudgetCard);
                }
            } else {
                // Suggest setting up a budget
                const budgetCard = document.createElement('div');
                budgetCard.className = 'advice-card info';
                budgetCard.innerHTML = `
                    <h4 class="font-medium mb-1">è¨­å®šé ç®—</h4>
                    <p class="text-sm">æ‚¨å°šæœªè¨­å®šé ç®—ã€‚è¨­å®šé ç®—æ˜¯ç®¡ç†è²¡å‹™çš„é‡è¦æ­¥é©Ÿï¼Œå¯ä»¥å¹«åŠ©æ‚¨æ§åˆ¶æ”¯å‡ºä¸¦å¯¦ç¾å„²è“„ç›®æ¨™ã€‚</p>
                    <button id="goBudgetBtnAdvice" class="mt-2 bg-primary text-white px-3 py-1 rounded-md text-sm hover:bg-primary-dark transition">
                        è¨­å®šé ç®—
                    </button>
                `;
                budgetAdvice.appendChild(budgetCard);
                
                // Add event listener after the element is added to the DOM
                setTimeout(() => {
                    const budgetBtn = document.getElementById('goBudgetBtnAdvice');
                    if (budgetBtn) {
                        budgetBtn.addEventListener('click', () => switchTab('budget'));
                    }
                }, 0);
                
                // If we have enough transaction data, suggest a budget amount
                if (monthlyExpenses > 0) {
                    const suggestedBudget = Math.ceil(monthlyExpenses * 0.9 / 100) * 100; // Round up to nearest 100
                    
                    const suggestionCard = document.createElement('div');
                    suggestionCard.className = 'advice-card info mt-2';
                    suggestionCard.innerHTML = `
                        <h4 class="font-medium mb-1">é ç®—å»ºè­°</h4>
                        <p class="text-sm">æ ¹æ“šæ‚¨éå»çš„æ”¯å‡ºè¨˜éŒ„ï¼Œæ¯æœˆé ç®—å»ºè­°ç‚º ${appSettings.currencySymbol}${formatNumber(suggestedBudget)}ã€‚
                        é€™æ¯”æ‚¨ç•¶å‰å¹³å‡æ”¯å‡ºç•¥ä½ï¼Œå¯ä»¥å¹«åŠ©æ‚¨å»ºç«‹å„²è“„ç¿’æ…£ã€‚</p>
                    `;
                    budgetAdvice.appendChild(suggestionCard);
                }
            }
        }
        
        // Show daily summary in the page (not in modal)
        function showDailySummaryInPage(date) {
            // Get transactions for this date
            const dayTransactions = transactions.filter(t => t.date === date);
            
            const dailySummaryContainer = document.getElementById('dailySummaryContainer');
            
            if (dayTransactions.length === 0) {
                notify('â„¹ï¸', 'æ²’æœ‰äº¤æ˜“è¨˜éŒ„', `${formatDate(date)} æ²’æœ‰äº¤æ˜“è¨˜éŒ„`);
                dailySummaryContainer.style.display = 'none';
                return;
            }
            
            // Calculate totals
            const income = dayTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
                
            const expense = dayTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            // Update summary in page
            document.getElementById('summaryIncome').textContent = formatNumber(income);
            document.getElementById('summaryExpense').textContent = formatNumber(expense);
            
            // Get expense categories breakdown
            const expenseCategories = {};
            dayTransactions.filter(t => t.type === 'expense').forEach(t => {
                expenseCategories[t.category] = (expenseCategories[t.category] || 0) + parseFloat(t.amount);
            });
            
            // Update categories breakdown
            const categoriesContainer = document.getElementById('summaryCategories');
            categoriesContainer.innerHTML = '';
            
            if (Object.keys(expenseCategories).length === 0) {
                categoriesContainer.innerHTML = '<div class="text-gray-500 text-center">ç„¡æ”¯å‡ºé¡åˆ¥</div>';
            } else {
                Object.entries(expenseCategories)
                    .sort((a, b) => b[1] - a[1]) // Sort by amount descending
                    .forEach(([category, amount]) => {
                        const percentage = expense > 0 ? Math.round((amount / expense) * 100) : 0;
                        
                        const item = document.createElement('div');
                        
                        const header = document.createElement('div');
                        header.className = 'flex justify-between text-sm';
                        
                        const categoryText = document.createElement('span');
                        categoryText.textContent = category;
                        
                        const amountText = document.createElement('span');
                        amountText.textContent = `${appSettings.currencySymbol}${formatNumber(amount)} (${percentage}%)`;
                        
                        const bar = document.createElement('div');
                        bar.className = 'h-2 bg-gray-200 rounded-full mt-1';
                        
                        const progress = document.createElement('div');
                        progress.className = 'h-2 bg-primary rounded-full';
                        progress.style.width = `${percentage}%`;
                        
                        header.appendChild(categoryText);
                        header.appendChild(amountText);
                        bar.appendChild(progress);
                        
                        item.appendChild(header);
                        item.appendChild(bar);
                        
                        categoriesContainer.appendChild(item);
                    });
            }
            
            // Update transactions list
            const transactionsContainer = document.getElementById('summaryTransactions');
            transactionsContainer.innerHTML = '';
            
            if (dayTransactions.length === 0) {
                transactionsContainer.innerHTML = '<div class="text-gray-500 text-center">ç„¡äº¤æ˜“è¨˜éŒ„</div>';
            } else {
                dayTransactions.sort((a, b) => b.amount - a.amount).forEach(transaction => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center py-2 border-b border-gray-200';
                    
                    const leftPart = document.createElement('div');
                    
                    const title = document.createElement('div');
                    title.className = 'font-medium';
                    
                    const account = getAccount(transaction.account);
                    const accountName = account ? account.name : 'æœªçŸ¥æˆ¶å£';
                    const currencyCode = account ? account.currency : appSettings.currency;
                    const currencySymbol = getAccountCurrencySymbol(transaction.account);
                    
                    title.innerHTML = `${transaction.category} (${accountName} <span class="currency-label">${currencyCode}</span>)`;
                    
                    const note = document.createElement('div');
                    note.className = 'text-sm text-gray-500';
                    note.textContent = transaction.note || 'ç„¡å‚™è¨»';
                    
                    const amount = document.createElement('div');
                    
                    if (transaction.type === 'income') {
                        amount.className = 'text-green-600 font-medium';
                        amount.textContent = `+${currencySymbol}${formatNumber(transaction.amount)}`;
                    } else {
                        amount.className = 'text-red-600 font-medium';
                        amount.textContent = `-${currencySymbol}${formatNumber(transaction.amount)}`;
                    }
                    
                    leftPart.appendChild(title);
                    leftPart.appendChild(note);
                    
                    item.appendChild(leftPart);
                    item.appendChild(amount);
                    
                    transactionsContainer.appendChild(item);
                });
            }
            
            // Show the container
            dailySummaryContainer.style.display = 'block';
        }
        // è·å–æœ€æ–°æ±‡ç‡ï¼ˆæ·»åŠ åœ¨APIç›¸å…³å‡½æ•°é™„è¿‘ï¼Œçº¦3800è¡Œå·¦å³ï¼‰
async function fetchExchangeRates() {
    try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        notify('ğŸ”„', 'æ›´æ–°åŒ¯ç‡', 'æ­£åœ¨å¾ç¶²çµ¡ç²å–æœ€æ–°åŒ¯ç‡...');
        
        // ä½¿ç”¨å¼€æ”¾çš„æ±‡ç‡API - å¯èƒ½éœ€è¦æ›¿æ¢ä¸ºæ‚¨æœ‰æƒé™çš„API
        const response = await fetch(`https://open.er-api.com/v6/latest/${baseCurrency}`);
        const data = await response.json();
        
        if (data && data.rates) {
            exchangeRates = data.rates;
            lastRateUpdate = new Date().toISOString();
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            if (hasLocalStorage) {
                localStorage.setItem('finance_exchange_rates', JSON.stringify(exchangeRates));
                localStorage.setItem('finance_rate_update', lastRateUpdate);
            }
            
            notify('âœ…', 'åŒ¯ç‡å·²æ›´æ–°', 'å·²æˆåŠŸç²å–æœ€æ–°åŒ¯ç‡è³‡æ–™');
            return true;
        } else {
            throw new Error('ç„¡æ³•ç²å–åŒ¯ç‡æ•¸æ“š');
        }
    } catch (error) {
        console.error('Error fetching exchange rates:', error);
        notify('âŒ', 'åŒ¯ç‡æ›´æ–°å¤±æ•—', 'ç„¡æ³•ç²å–æœ€æ–°åŒ¯ç‡ï¼Œä½¿ç”¨ç¾æœ‰åŒ¯ç‡æˆ–é»˜èªå€¼');
        
        // å¦‚æœæ²¡æœ‰æ±‡ç‡æ•°æ®ï¼Œè®¾ç½®ä¸€äº›é»˜è®¤å€¼
        if (Object.keys(exchangeRates).length === 0) {
            setDefaultExchangeRates();
        }
        return false;
    }
}

// è®¾ç½®é»˜è®¤æ±‡ç‡ï¼ˆä½œä¸ºå¤‡ç”¨ï¼‰
function setDefaultExchangeRates() {
    // è®¾ç½®ä¸€äº›å¸¸ç”¨è´§å¸çš„é»˜è®¤æ±‡ç‡ï¼ˆç›¸å¯¹äºTWDï¼‰
    exchangeRates = {
        'TWD': 1,
        'USD': 0.032,  // çº¦31 TWD = 1 USD
        'EUR': 0.029,  // çº¦34 TWD = 1 EUR
        'JPY': 4.44,   // çº¦0.23 TWD = 1 JPY
        'CNY': 0.22,   // çº¦4.5 TWD = 1 CNY
        'HKD': 0.25,   // çº¦4 TWD = 1 HKD
        'GBP': 0.025,  // çº¦40 TWD = 1 GBP
        'AUD': 0.043,  // çº¦23 TWD = 1 AUD
        'CAD': 0.044,  // çº¦23 TWD = 1 CAD
        'SGD': 0.042   // çº¦24 TWD = 1 SGD
    };
}

// å°†è´§å¸è½¬æ¢ä¸ºåŸºå‡†è´§å¸
function convertToBaseCurrency(amount, fromCurrency) {
    if (!fromCurrency || fromCurrency === baseCurrency) {
        return amount;
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰æ±‡ç‡æ•°æ®
    if (!exchangeRates[fromCurrency]) {
        console.warn(`æ‰¾ä¸åˆ° ${fromCurrency} çš„åŒ¯ç‡ï¼Œä½¿ç”¨ 1:1 åŒ¯ç‡`);
        return amount;
    }
    
    // å°†é‡‘é¢è½¬æ¢ä¸ºåŸºå‡†è´§å¸
    return amount / exchangeRates[fromCurrency];
}

// å°†åŸºå‡†è´§å¸è½¬æ¢ä¸ºç›®æ ‡è´§å¸
function convertFromBaseCurrency(amount, toCurrency) {
    if (!toCurrency || toCurrency === baseCurrency) {
        return amount;
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰æ±‡ç‡æ•°æ®
    if (!exchangeRates[toCurrency]) {
        console.warn(`æ‰¾ä¸åˆ° ${toCurrency} çš„åŒ¯ç‡ï¼Œä½¿ç”¨ 1:1 åŒ¯ç‡`);
        return amount;
    }
    
    // å°†åŸºå‡†è´§å¸é‡‘é¢è½¬æ¢ä¸ºç›®æ ‡è´§å¸
    return amount * exchangeRates[toCurrency];
}
        
        // Search transactions with pagination and virtualization
        function searchTransactions() {
            searchLoadingIndicator.style.display = 'block';
            
            // Use setTimeout to allow UI to update before heavy processing
            setTimeout(() => {
                const startDateInput = document.getElementById('searchStartDate');
                const endDateInput = document.getElementById('searchEndDate');
                const typeSelect = document.getElementById('searchType');
                const categorySelect = document.getElementById('searchCategory');
                const noteInput = document.getElementById('searchNote'); // æ–°å¢ï¼šå‚™è¨»æœå°‹æ¬„ä½
                
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                const type = typeSelect.value;
                const category = categorySelect.value;
                const noteKeyword = noteInput.value.trim().toLowerCase(); // æ–°å¢ï¼šå‚™è¨»é—œéµå­—
                
                // Filter transactions
                let filtered = [...transactions];
                
                // Filter by date range
                if (startDate) {
                    filtered = filtered.filter(t => t.date >= startDate);
                }
                
                if (endDate) {
                    // Include the entire end date
                    const endDateObj = new Date(endDate);
                    endDateObj.setHours(23, 59, 59, 999);
                    const formattedEndDate = formatDateForInput(endDateObj);
                    filtered = filtered.filter(t => t.date <= formattedEndDate);
                }
                
                // Filter by type
                if (type) {
                    filtered = filtered.filter(t => t.type === type);
                }
                
                // Filter by category
                if (category) {
                    filtered = filtered.filter(t => t.category === category);
                }
                
                // æ–°å¢ï¼šç¯©é¸å‚™è¨»å…§å®¹
                if (noteKeyword) {
                    filtered = filtered.filter(t => 
                        t.note && t.note.toLowerCase().includes(noteKeyword)
                    );
                }
                
                // Sort by date (newest first)
                filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Update pagination state
                paginationState.totalItems = filtered.length;
                paginationState.totalPages = appSettings.pageSize === -1 ? 1 : Math.ceil(filtered.length / paginationState.pageSize);
                paginationState.currentPage = 1;
                
                // Get current page items
                if (appSettings.pageSize === -1 || !appSettings.enableVirtualization) {
                    paginationState.currentItems = filtered;
                } else {
                    const startIndex = (paginationState.currentPage - 1) * paginationState.pageSize;
                    paginationState.currentItems = filtered.slice(startIndex, startIndex + paginationState.pageSize);
                }
                
                // Update search results
                updateSearchResults(paginationState.currentItems, filtered.length);
                
                // Hide loading indicator
                searchLoadingIndicator.style.display = 'none';
            }, 10);
        }
        
        // Update search results
        function updateSearchResults(results, totalCount) {
            const noResults = document.getElementById('noSearchResults');
            const resultsTable = document.getElementById('searchResults');
            const resultsList = document.getElementById('searchResultsList');
            const resultsCountEl = document.getElementById('resultsCount');
            
            if (results.length === 0) {
                noResults.style.display = 'block';
                resultsTable.style.display = 'none';
                return;
            }
            
            noResults.style.display = 'none';
            resultsTable.style.display = 'block';
            
            // Clear previous results
            resultsList.innerHTML = '';
            
            // Add each result
            results.forEach(transaction => {
                const row = document.createElement('tr');
                
                // Date
                const dateCell = document.createElement('td');
                dateCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                dateCell.textContent = formatDate(transaction.date);
                row.appendChild(dateCell);
                
                // Type
                const typeCell = document.createElement('td');
                typeCell.className = 'px-6 py-4 whitespace-nowrap';
                typeCell.textContent = transaction.type === 'income' ? 'ğŸ“ˆ æ”¶å…¥' : (transaction.type === 'expense' ? 'ğŸ“‰ æ”¯å‡º' : 'ğŸ”„ è½‰è³¬');
                row.appendChild(typeCell);
                
                // Account
                const accountCell = document.createElement('td');
                accountCell.className = 'px-6 py-4 whitespace-nowrap';
                
                const account = getAccount(transaction.account);
                const accountName = account ? account.name : 'æœªçŸ¥æˆ¶å£';
                const currencyCode = account ? account.currency : appSettings.currency;
                
                accountCell.innerHTML = `${accountName} <span class="currency-label">${currencyCode}</span>`;
                row.appendChild(accountCell);
                
                // Category
                const categoryCell = document.createElement('td');
                categoryCell.className = 'px-6 py-4 whitespace-nowrap';
                categoryCell.textContent = transaction.category;
                row.appendChild(categoryCell);
                
                // Amount
                const amountCell = document.createElement('td');
                amountCell.className = 'px-6 py-4 whitespace-nowrap';
                
                // Get currency symbol for this account
                const currencySymbol = getAccountCurrencySymbol(transaction.account);
                
                if (transaction.type === 'income') {
                    amountCell.classList.add('text-green-600');
                    amountCell.classList.add('font-medium');
                } else if (transaction.type === 'expense') {
                    amountCell.classList.add('text-red-600');
                    amountCell.classList.add('font-medium');
                } else {
                    amountCell.classList.add('text-blue-600');
                    amountCell.classList.add('font-medium');
                }
                amountCell.textContent = currencySymbol + formatNumber(transaction.amount);
                row.appendChild(amountCell);
                
                // Note
                const noteCell = document.createElement('td');
                noteCell.className = 'px-6 py-4 whitespace-nowrap text-gray-500';
                noteCell.textContent = transaction.note || '-';
                row.appendChild(noteCell);
                
                // Receipt
                const receiptCell = document.createElement('td');
                receiptCell.className = 'px-6 py-4 whitespace-nowrap text-center';
                if (transaction.receipt) {
                    const viewBtn = document.createElement('button');
                    viewBtn.className = 'text-primary hover:text-primary-dark';
                    viewBtn.innerHTML = '<i class="fas fa-image"></i>';
                    viewBtn.addEventListener('click', () => {
                        showReceiptImage(transaction.receipt);
                    });
                    receiptCell.appendChild(viewBtn);
                } else {
                    receiptCell.textContent = '-';
                }
                row.appendChild(receiptCell);
                
                // Action
                const actionCell = document.createElement('td');
                actionCell.className = 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-600 hover:text-red-900';
                deleteBtn.textContent = 'åˆªé™¤';
                deleteBtn.addEventListener('click', () => deleteTransaction(transaction.id));
                
                actionCell.appendChild(deleteBtn);
                row.appendChild(actionCell);
                
                resultsList.appendChild(row);
            });
            
            // Update results count
            if (appSettings.pageSize !== -1 && appSettings.enableVirtualization) {
                resultsCountEl.textContent = `é¡¯ç¤º ${results.length} ç­†äº¤æ˜“è¨˜éŒ„ï¼ˆå…± ${totalCount} ç­†ï¼‰`;
            } else {
                resultsCountEl.textContent = `é¡¯ç¤º ${results.length} ç­†äº¤æ˜“è¨˜éŒ„`;
            }
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Close modal buttons
            document.querySelectorAll('.close').forEach(closeBtn => {
                closeBtn.addEventListener('click', event => {
                    const modal = event.target.closest('.modal');
                    closeModal(modal.id);
                });
            });
            
            // New day button
            document.getElementById('newDayBtn').addEventListener('click', startNewDay);
            
            // Settings button
            document.getElementById('settingsBtn').addEventListener('click', () => {
                updateSettingsModal();
                openModal('settingsModal');
            });
            
            // Import/Export button
            document.getElementById('importExportBtn').addEventListener('click', () => {
                document.getElementById('exportDataArea').value = exportData();
                document.getElementById('importDataArea').value = '';
                openModal('importExportModal');
            });
            
            // Google Sign-in button
            document.getElementById('googleSignInBtn').addEventListener('click', function() {
                // æª¢æŸ¥ API æ˜¯å¦å·²åˆå§‹åŒ–
                if (!googleApiInitialized) {
                    // å¦‚æœé¡¯ç¤ºçš„æ˜¯é‡è©¦æŒ‰éˆ•ï¼Œå‰‡å˜—è©¦é‡æ–°åˆå§‹åŒ–
                    if (this.innerHTML.includes('é‡è©¦')) {
                        notify('ğŸ”„', 'æ­£åœ¨é‡æ–°åˆå§‹åŒ–', 'Google API æ­£åœ¨é‡æ–°åˆå§‹åŒ–...');
                        initGoogleApi(); // é‡æ–°åˆå§‹åŒ–
                        return;
                    }
                    notify('âŒ', 'Google API å°šæœªåˆå§‹åŒ–', 'è«‹ç¨å¾Œå†è©¦ï¼Œæˆ–é»æ“Šé‡è©¦æŒ‰éˆ•');
                    this.innerHTML = '<i class="fas fa-sync mr-2"></i> é‡è©¦ Google ç™»å…¥';
                    return;
                }
                
                // API å·²åˆå§‹åŒ–ï¼Œå¯ä»¥ç™»å…¥
                signInToGoogle();
            });
            
            // Google Sign-out button
            document.getElementById('googleSignOutBtn').addEventListener('click', signOutFromGoogle);
            
            // Save to Google Drive button
            document.getElementById('saveToDriveBtn').addEventListener('click', saveToGoogleDrive);
            
            // Load from Google Drive button
            document.getElementById('loadFromDriveBtn').addEventListener('click', loadFromGoogleDrive);
            
            // Copy export data button
            document.getElementById('copyExportBtn').addEventListener('click', () => {
                const exportArea = document.getElementById('exportDataArea');
                exportArea.select();
                document.execCommand('copy');
                notify('âœ…', 'å·²è¤‡è£½', 'æ•¸æ“šå·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼æ¿');
            });
            
            // Download export data button
            document.getElementById('downloadExportBtn').addEventListener('click', () => {
                const exportData = document.getElementById('exportDataArea').value;
                const blob = new Blob([exportData], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `finance_data_${formatDateForFilename(new Date())}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                notify('âœ…', 'å·²ä¸‹è¼‰', 'æ•¸æ“šæ–‡ä»¶å·²æˆåŠŸä¸‹è¼‰');
            });
            
            // Upload import file button
            document.getElementById('uploadImportBtn').addEventListener('click', () => {
                document.getElementById('importFile').click();
            });
            
            // Import file change
            document.getElementById('importFile').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('importDataArea').value = event.target.result;
                };
                reader.readAsText(file);
            });
            
            // Import data button
            document.getElementById('importDataBtn').addEventListener('click', () => {
                const importArea = document.getElementById('importDataArea');
                const result = importData(importArea.value);
                if (result) {
                    closeModal('importExportModal');
                    notify('âœ…', 'åŒ¯å…¥æˆåŠŸ', 'æ•¸æ“šå·²æˆåŠŸåŒ¯å…¥');
                }
            });
            
            // åœ¨ä¿å­˜è®¾ç½®æŒ‰é’®çš„å¤„ç†å‡½æ•°ä¸­ï¼ˆçº¦4305è¡Œå·¦å³ï¼‰
document.getElementById('saveSettingsBtn').addEventListener('click', () => {
    const currency = document.getElementById('currencySelect').value;
    const currencySymbol = document.getElementById('currencySymbolInput').value || currencySymbols[currency] || '$';
    const syncRemindersEnabled = document.getElementById('enableSyncReminders').checked;
    const theme = document.getElementById('themeSelect').value;
    const enableVirtualization = document.getElementById('enableVirtualization').checked;
    const pageSize = parseInt(document.getElementById('pageSize').value);
    
    // ä¿®æ”¹åº”ç”¨è®¾ç½®
    appSettings.currency = currency;
    appSettings.currencySymbol = currencySymbol;
    appSettings.syncRemindersEnabled = syncRemindersEnabled;
    appSettings.theme = theme;
    appSettings.enableVirtualization = enableVirtualization;
    appSettings.pageSize = pageSize;
    
    // æ›´æ–°åŸºå‡†è´§å¸ï¼ˆå¦‚æœå‘ç”Ÿå˜åŒ–ï¼‰
    if (baseCurrency !== document.getElementById('baseCurrencySelect').value) {
        baseCurrency = document.getElementById('baseCurrencySelect').value;
        // æ›´æ–°æ±‡ç‡
        fetchExchangeRates();
    }
    
    saveData('appSettings');
    
    // ä¿å­˜æ±‡ç‡æ•°æ®
    if (hasLocalStorage) {
        localStorage.setItem('finance_exchange_rates', JSON.stringify(exchangeRates));
        localStorage.setItem('finance_rate_update', lastRateUpdate);
    }
    
    updateCurrencyDisplay();
    applyTheme();
    applyVirtualizationSettings();
    updateUI();
    
    closeModal('settingsModal');
    notify('âœ…', 'è¨­å®šå·²ä¿å­˜', 'æ‚¨çš„è¨­å®šå·²æˆåŠŸæ›´æ–°');
    
    // åˆ·æ–°æœç´¢ç»“æœ
    searchTransactions();
});
            
            // Reset app button
            document.getElementById('resetAppBtn').addEventListener('click', () => {
                if (confirm('è­¦å‘Šï¼šé€™å°‡åˆªé™¤æ‰€æœ‰æ•¸æ“šï¼æ‚¨ç¢ºå®šè¦é‡ç½®æ‡‰ç”¨ç¨‹å¼å—ï¼Ÿ')) {
                    initDefaultData();
                    saveData();
                    
                    updateCurrencyDisplay();
                    updateUI();
                    searchTransactions();
                    generateFinancialAdvice();
                    
                    closeModal('settingsModal');
                    notify('ğŸ”„', 'æ‡‰ç”¨å·²é‡ç½®', 'æ‡‰ç”¨ç¨‹å¼å·²æ¢å¾©åˆ°åˆå§‹ç‹€æ…‹');
                }
            });
            
            // Close sync reminder
            document.getElementById('closeSyncReminder').addEventListener('click', () => {
                syncReminder.style.display = 'none';
                // Update last reminder time so it doesn't show again too soon
                appSettings.lastSyncReminder = new Date().toISOString();
                saveData('appSettings');
            });
            
            // Close summary modal button
            document.getElementById('closeSummaryBtn').addEventListener('click', () => {
                closeModal('dailySummaryModal');
            });
            
            // Go to budget tab button
            document.getElementById('goBudgetBtn').addEventListener('click', () => switchTab('budget'));
            
            // View all transactions button
            document.getElementById('viewAllTransactionsBtn').addEventListener('click', () => switchTab('stats'));
            
            // View summary button
            document.getElementById('viewSummaryBtn').addEventListener('click', () => {
                const date = document.getElementById('summaryDate').value;
                if (!date) {
                    notify('âŒ', 'è«‹é¸æ“‡æ—¥æœŸ', 'è«‹é¸æ“‡è¦æŸ¥çœ‹æ‘˜è¦çš„æ—¥æœŸ');
                    return;
                }
                
                showDailySummaryInPage(date);
            });
            
            // Transaction type buttons
            document.getElementById('incomeBtn').addEventListener('click', () => {
                transactionType = 'income';
                updateTransactionTypeUI();
                updateTransactionCategories();
            });
            
            document.getElementById('expenseBtn').addEventListener('click', () => {
                transactionType = 'expense';
                updateTransactionTypeUI();
                updateTransactionCategories();
            });
            
            // New category type buttons
            document.getElementById('newCategoryIncomeBtn').addEventListener('click', () => {
                selectedCategoryType = 'income';
                updateNewCategoryTypeUI();
            });
            
            document.getElementById('newCategoryExpenseBtn').addEventListener('click', () => {
                selectedCategoryType = 'expense';
                updateNewCategoryTypeUI();
            });
            
            // Add threshold button
            document.getElementById('addThresholdBtn').addEventListener('click', () => {
                budget.thresholds.push(50); // Default new threshold
                budget.thresholds.sort((a, b) => b - a); // Sort in descending order
                saveData('budget');
                updateBudgetThresholds();
            });
            
            // Add category budget button
            document.getElementById('addCategoryBudgetBtn').addEventListener('click', () => {
                const categorySelect = document.getElementById('categoryForBudget');
                const amountInput = document.getElementById('categoryBudgetAmount');
                
                const category = categorySelect.value;
                const amount = parseFloat(amountInput.value);
                
                if (!category) {
                    notify('âŒ', 'è«‹é¸æ“‡é¡åˆ¥', 'è«‹é¸æ“‡è¦è¨­å®šé ç®—çš„é¡åˆ¥');
                    return;
                }
                
                if (isNaN(amount) || amount <= 0) {
                    notify('âŒ', 'ç„¡æ•ˆé‡‘é¡', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„é ç®—é‡‘é¡');
                    return;
                }
                
                // Check if category budget already exists
                const existingIndex = categoryBudgets.findIndex(b => b.category === category);
                if (existingIndex !== -1) {
                    // Update existing
                    categoryBudgets[existingIndex].amount = amount;
                    notify('âœ…', 'å·²æ›´æ–°', `${category} çš„é ç®—å·²æ›´æ–°ç‚º ${appSettings.currencySymbol}${formatNumber(amount)}`);
                } else {
                    // Add new
                    categoryBudgets.push({ category, amount });
                    notify('âœ…', 'å·²æ·»åŠ ', `å·²ç‚º ${category} è¨­å®šé ç®— ${appSettings.currencySymbol}${formatNumber(amount)}`);
                }
                
                saveData('categoryBudgets');
                updateCategoryBudgetItems();
                updateCategoryBudgetsOnDashboard();
                // æ›´æ–°æ€»é¢„ç®—æ˜¾ç¤º
updateTotalBudgetDisplay();
                
                // Reset inputs
                categorySelect.value = '';
                amountInput.value = '';
            });
            
            // Save daily summary timing
            document.getElementById('dailySummaryTiming').addEventListener('change', function() {
                appSettings.dailySummaryTiming = this.value;
                saveData('appSettings');
            });
            
            // Add account button
            document.getElementById('addAccountBtn').addEventListener('click', addAccount);
            
            // Add category button
            document.getElementById('addCategoryBtn').addEventListener('click', () => {
                document.getElementById('newCategoryName').value = '';
                updateNewCategoryTypeUI();
                openModal('newCategoryModal');
            });
            
            // Add category confirm button
            document.getElementById('addCategoryConfirmBtn').addEventListener('click', addCategory);
            
            // æ–°å¢é¡åˆ¥é é¢çš„äº‹ä»¶ç›£è½å™¨
            document.getElementById('addIncomeCategoryBtn').addEventListener('click', () => {
                const categoryName = document.getElementById('newIncomeCategoryName').value.trim();
                if (categoryName) {
                    addCategoryByType('income', categoryName);
                    document.getElementById('newIncomeCategoryName').value = '';
                } else {
                    notify('âŒ', 'è«‹è¼¸å…¥é¡åˆ¥åç¨±', 'é¡åˆ¥åç¨±ä¸èƒ½ç‚ºç©º');
                }
            });
            
            document.getElementById('addExpenseCategoryBtn').addEventListener('click', () => {
                const categoryName = document.getElementById('newExpenseCategoryName').value.trim();
                if (categoryName) {
                    addCategoryByType('expense', categoryName);
                    document.getElementById('newExpenseCategoryName').value = '';
                } else {
                    notify('âŒ', 'è«‹è¼¸å…¥é¡åˆ¥åç¨±', 'é¡åˆ¥åç¨±ä¸èƒ½ç‚ºç©º');
                }
            });
            
            // Transfer money button
            document.getElementById('transferBtn').addEventListener('click', transferMoney);
            
            // Save transaction button
            document.getElementById('saveTransactionBtn').addEventListener('click', addTransaction);
            
            // Save budget button
            document.getElementById('saveBudgetBtn').addEventListener('click', saveBudget);
            
            // Search button
            document.getElementById('searchBtn').addEventListener('click', debounce(searchTransactions, 300));
            
            // Budget cycle change
            document.getElementById('budgetCycle').addEventListener('change', updateBudgetResetDayOptions);
            
            // Click outside modal to close
            window.addEventListener('click', event => {
                if (event.target.classList.contains('modal')) {
                    closeModal(event.target.id);
                }
            });
            
            // Add scroll event listener for virtual scrolling
            document.querySelector('.virtual-scroll-container').addEventListener('scroll', debounce(() => {
                if (!appSettings.enableVirtualization || appSettings.pageSize === -1) return;
                
                const container = document.querySelector('.virtual-scroll-container');
                if (container.scrollTop + container.clientHeight >= container.scrollHeight - 200) {
                    // Near bottom, load more results if available
                    if (paginationState.currentPage < paginationState.totalPages) {
                        loadMoreResults();
                    }
                }
            }, 200));
            
            document.getElementById('updateRatesBtn').addEventListener('click', fetchExchangeRates);
    
    // æ˜¾ç¤º/éšè—æ±‡ç‡æŒ‰é’®
    document.getElementById('toggleRatesBtn').addEventListener('click', function() {
        const ratesList = document.getElementById('exchangeRatesList');
        ratesList.classList.toggle('hidden');
    });
    
    // åŸºå‡†è´§å¸æ›´æ”¹
    document.getElementById('baseCurrencySelect').addEventListener('change', function() {
        baseCurrency = this.value;
        // æ›´æ–°æ±‡ç‡æ•°æ®
        fetchExchangeRates();
    });
        }
        
        // Add a category by type (from the categories tab)
        function addCategoryByType(type, name) {
    // æª¢æŸ¥é¡åˆ¥æ˜¯å¦å·²å­˜åœ¨
    if (categories[type].includes(name)) {
        notify('âŒ', 'é¡åˆ¥å·²å­˜åœ¨', `ã€Œ${name}ã€é¡åˆ¥å·²ç¶“å­˜åœ¨ã€‚`);
        return;
    }
    
    // æ–°å¢é¡åˆ¥
    categories[type].push(name);
    
    // åªæœ‰å½“æ·»åŠ çš„æ˜¯æ”¯å‡ºç±»åˆ«æ—¶ï¼Œæ‰åŒæ—¶æ·»åŠ åˆ°æ”¶å…¥ç±»åˆ«
    if (type === 'expense' && !categories['income'].includes(name)) {
        categories['income'].push(name);
        notify('â„¹ï¸', 'é¡åˆ¥å·²åŒæ­¥', `ã€Œ${name}ã€é¡åˆ¥å·²åŒæ™‚æ–°å¢è‡³æ”¶å…¥é¡åˆ¥ä¸­ã€‚`);
    }
    
    saveData('categories');
    
    // æ›´æ–° UI
    updateCategoriesManagement();
    updateTransactionCategories();
    updateStatisticsCategories();
    updateCategoryBudgetDropdown();
    
    notify('âœ…', 'é¡åˆ¥å·²æ–°å¢', `å·²æˆåŠŸæ–°å¢ã€Œ${name}ã€é¡åˆ¥ã€‚`);
}
        
        // Delete a category
        function deleteCategory(type, name) {
            // æª¢æŸ¥æ˜¯å¦æœ‰ä½¿ç”¨è©²é¡åˆ¥çš„äº¤æ˜“
            const hasCategoryTransactions = transactions.some(t => t.category === name);
            
            if (hasCategoryTransactions) {
                notify('âŒ', 'ç„¡æ³•åˆªé™¤é¡åˆ¥', `ã€Œ${name}ã€é¡åˆ¥æœ‰ç›¸é—œäº¤æ˜“è¨˜éŒ„ï¼Œç„¡æ³•åˆªé™¤ã€‚`);
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰è©²é¡åˆ¥çš„é ç®—
            const hasCategoryBudget = categoryBudgets.some(b => b.category === name);
            
            if (hasCategoryBudget) {
                notify('âŒ', 'ç„¡æ³•åˆªé™¤é¡åˆ¥', `ã€Œ${name}ã€é¡åˆ¥æœ‰ç›¸é—œé ç®—è¨­å®šï¼Œè«‹å…ˆåˆªé™¤é ç®—è¨­å®šã€‚`);
                return;
            }
            
            // ç§»é™¤é¡åˆ¥
            categories[type] = categories[type].filter(c => c !== name);
            saveData('categories');
            
            // æ›´æ–° UI
            updateCategoriesManagement();
            updateTransactionCategories();
            updateStatisticsCategories();
            updateCategoryBudgetDropdown();
            
            notify('ğŸ—‘ï¸', 'é¡åˆ¥å·²åˆªé™¤', `å·²æˆåŠŸåˆªé™¤ã€Œ${name}ã€é¡åˆ¥ã€‚`);
        }
        
        // Load more search results (for virtualization)
        function loadMoreResults() {
            if (paginationState.currentPage >= paginationState.totalPages) return;
            
            // Show loading indicator
            searchLoadingIndicator.style.display = 'block';
            
            // Use setTimeout to prevent UI blocking
            setTimeout(() => {
                paginationState.currentPage++;
                
                // Filter transactions (same as searchTransactions but using current filters)
                const startDateInput = document.getElementById('searchStartDate');
                const endDateInput = document.getElementById('searchEndDate');
                const typeSelect = document.getElementById('searchType');
                const categorySelect = document.getElementById('searchCategory');
                const noteInput = document.getElementById('searchNote'); // æ–°å¢ï¼šå‚™è¨»æœå°‹æ¬„ä½
                
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                const type = typeSelect.value;
                const category = categorySelect.value;
                const noteKeyword = noteInput.value.trim().toLowerCase(); // æ–°å¢ï¼šå‚™è¨»é—œéµå­—
                
                let filtered = [...transactions];
                
                if (startDate) {
                    filtered = filtered.filter(t => t.date >= startDate);
                }
                
                if (endDate) {
                    const endDateObj = new Date(endDate);
                    endDateObj.setHours(23, 59, 59, 999);
                    const formattedEndDate = formatDateForInput(endDateObj);
                    filtered = filtered.filter(t => t.date <= formattedEndDate);
                }
                
                if (type) {
                    filtered = filtered.filter(t => t.type === type);
                }
                
                if (category) {
                    filtered = filtered.filter(t => t.category === category);
                }
                
                // æ–°å¢ï¼šç¯©é¸å‚™è¨»å…§å®¹
                if (noteKeyword) {
                    filtered = filtered.filter(t => 
                        t.note && t.note.toLowerCase().includes(noteKeyword)
                    );
                }
                
                filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Get next page items
                const startIndex = (paginationState.currentPage - 1) * paginationState.pageSize;
                const newItems = filtered.slice(startIndex, startIndex + paginationState.pageSize);
                
                // Append new items to results list
                appendSearchResults(newItems, filtered.length);
                
                // Hide loading indicator
                searchLoadingIndicator.style.display = 'none';
            }, 10);
        }
        
        // Append more search results without clearing the existing ones
        function appendSearchResults(results, totalCount) {
            if (results.length === 0) return;
            
            const resultsList = document.getElementById('searchResultsList');
            const resultsCountEl = document.getElementById('resultsCount');
            
            // Add each result
            results.forEach(transaction => {
                const row = document.createElement('tr');
                
                // Date
                const dateCell = document.createElement('td');
                dateCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                dateCell.textContent = formatDate(transaction.date);
                row.appendChild(dateCell);
                
                // Type
                const typeCell = document.createElement('td');
                typeCell.className = 'px-6 py-4 whitespace-nowrap';
                typeCell.textContent = transaction.type === 'income' ? 'ğŸ“ˆ æ”¶å…¥' : (transaction.type === 'expense' ? 'ğŸ“‰ æ”¯å‡º' : 'ğŸ”„ è½‰è³¬');
                row.appendChild(typeCell);
                
                // Account
                const accountCell = document.createElement('td');
                accountCell.className = 'px-6 py-4 whitespace-nowrap';
                
                const account = getAccount(transaction.account);
                const accountName = account ? account.name : 'æœªçŸ¥æˆ¶å£';
                const currencyCode = account ? account.currency : appSettings.currency;
                
                accountCell.innerHTML = `${accountName} <span class="currency-label">${currencyCode}</span>`;
                row.appendChild(accountCell);
                
                // Category
                const categoryCell = document.createElement('td');
                categoryCell.className = 'px-6 py-4 whitespace-nowrap';
                categoryCell.textContent = transaction.category;
                row.appendChild(categoryCell);
                
                // Amount
                const amountCell = document.createElement('td');
                amountCell.className = 'px-6 py-4 whitespace-nowrap';
                
                // Get currency symbol for this account
                const currencySymbol = getAccountCurrencySymbol(transaction.account);
                
                if (transaction.type === 'income') {
                    amountCell.classList.add('text-green-600');
                    amountCell.classList.add('font-medium');
                } else if (transaction.type === 'expense') {
                    amountCell.classList.add('text-red-600');
                    amountCell.classList.add('font-medium');
                } else {
                    amountCell.classList.add('text-blue-600');
                    amountCell.classList.add('font-medium');
                }
                amountCell.textContent = currencySymbol + formatNumber(transaction.amount);
                row.appendChild(amountCell);
                
                // Note
                const noteCell = document.createElement('td');
                noteCell.className = 'px-6 py-4 whitespace-nowrap text-gray-500';
                noteCell.textContent = transaction.note || '-';
                row.appendChild(noteCell);
                
                // Receipt
                const receiptCell = document.createElement('td');
                receiptCell.className = 'px-6 py-4 whitespace-nowrap text-center';
                if (transaction.receipt) {
                    const viewBtn = document.createElement('button');
                    viewBtn.className = 'text-primary hover:text-primary-dark';
                    viewBtn.innerHTML = '<i class="fas fa-image"></i>';
                    viewBtn.addEventListener('click', () => {
                        showReceiptImage(transaction.receipt);
                    });
                    receiptCell.appendChild(viewBtn);
                } else {
                    receiptCell.textContent = '-';
                }
                row.appendChild(receiptCell);
                
                // Action
                const actionCell = document.createElement('td');
                actionCell.className = 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-600 hover:text-red-900';
                deleteBtn.textContent = 'åˆªé™¤';
                deleteBtn.addEventListener('click', () => deleteTransaction(transaction.id));
                
                actionCell.appendChild(deleteBtn);
                row.appendChild(actionCell);
                
                resultsList.appendChild(row);
            });
            
            // Update results count
            const currentDisplayedCount = paginationState.currentPage * paginationState.pageSize;
            const displayCount = Math.min(currentDisplayedCount, totalCount);
            
            resultsCountEl.textContent = `é¡¯ç¤º ${displayCount} ç­†äº¤æ˜“è¨˜éŒ„ï¼ˆå…± ${totalCount} ç­†ï¼‰`;
        }
        
        // Switch tabs
        function switchTab(tabId) {
            // Update tab buttons
            tabButtons.forEach(button => {
                const buttonTabId = button.getAttribute('data-tab');
                if (buttonTabId === tabId) {
                    button.classList.add('text-primary', 'border-primary');
                    button.classList.remove('text-gray-500', 'hover:text-gray-700', 'border-transparent');
                } else {
                    button.classList.remove('text-primary', 'border-primary');
                    button.classList.add('text-gray-500', 'hover:text-gray-700', 'border-transparent');
                }
            });
            
            // Update tab contents
            tabContents.forEach(content => {
                if (content.id === tabId) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            
            // Specific actions for certain tabs
            if (tabId === 'transactions') {
                // Reset new transaction form when switching to transactions tab
                document.getElementById('transactionAccount').value = '';
                document.getElementById('transactionCategory').value = '';
                document.getElementById('transactionAmount').value = '';
                document.getElementById('transactionDate').value = getTodayFormatted();
                document.getElementById('transactionNote').value = '';
                document.getElementById('enableReceiptUpload').checked = false;
                document.getElementById('receiptUploadContainer').style.display = 'none';
                document.getElementById('receiptImage').value = '';
                document.getElementById('receiptPreview').style.display = 'none';
                
                // Keep transaction type
                updateTransactionTypeUI();
                updateTransactionCategories();
            } else if (tabId === 'advice') {
                // Regenerate advice when switching to the advice tab
                generateFinancialAdvice();
                
                // Set summary date to today
                document.getElementById('summaryDate').value = getTodayFormatted();
                document.getElementById('dailySummaryContainer').style.display = 'none';
            } else if (tabId === 'stats') {
                // Reset pagination state when switching to stats tab
                paginationState.currentPage = 1;
                searchTransactions();
            }
        }
        
        // Open a modal
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'block';
        }
        
        // Close a modal
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
        }
        
        // Apply theme based on settings
        function applyTheme() {
            const theme = appSettings.theme;
            
            if (theme === 'system') {
                // Follow system preference
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                
                // Listen for changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    if (appSettings.theme === 'system') {
                        if (event.matches) {
                            document.documentElement.classList.add('dark');
                        } else {
                            document.documentElement.classList.remove('dark');
                        }
                    }
                });
            } else if (theme === 'dark') {
                // Force dark mode
                document.documentElement.classList.add('dark');
            } else {
                // Force light mode
                document.documentElement.classList.remove('dark');
            }
        }
        
        // Update transaction type UI
        function updateTransactionTypeUI() {
            const incomeBtn = document.getElementById('incomeBtn');
            const expenseBtn = document.getElementById('expenseBtn');
            
            if (transactionType === 'income') {
                incomeBtn.classList.remove('bg-gray-200', 'text-gray-700');
                incomeBtn.classList.add('bg-green-500', 'text-white');
                expenseBtn.classList.remove('bg-red-500', 'text-white');
                expenseBtn.classList.add('bg-gray-200', 'text-gray-700');
            } else {
                incomeBtn.classList.remove('bg-green-500', 'text-white');
                incomeBtn.classList.add('bg-gray-200', 'text-gray-700');
                expenseBtn.classList.remove('bg-gray-200', 'text-gray-700');
                expenseBtn.classList.add('bg-red-500', 'text-white');
            }
        }
        
        // Update new category type UI
        function updateNewCategoryTypeUI() {
            const incomeBtn = document.getElementById('newCategoryIncomeBtn');
            const expenseBtn = document.getElementById('newCategoryExpenseBtn');
            
            if (selectedCategoryType === 'income') {
                incomeBtn.classList.remove('bg-gray-200', 'text-gray-700');
                incomeBtn.classList.add('bg-green-500', 'text-white');
                expenseBtn.classList.remove('bg-red-500', 'text-white');
                expenseBtn.classList.add('bg-gray-200', 'text-gray-700');
            } else {
                incomeBtn.classList.remove('bg-green-500', 'text-white');
                incomeBtn.classList.add('bg-gray-200', 'text-gray-700');
                expenseBtn.classList.remove('bg-gray-200', 'text-gray-700');
                expenseBtn.classList.add('bg-red-500', 'text-white');
            }
        }
        
        // Add an account
        function addAccount() {
            const nameInput = document.getElementById('newAccountName');
            const balanceInput = document.getElementById('newAccountBalance');
            const currencySelect = document.getElementById('newAccountCurrency');
            
            const name = nameInput.value.trim();
            const balance = parseFloat(balanceInput.value);
            const currency = currencySelect.value;
            
            if (!name || isNaN(balance)) {
                notify('âŒ', 'æ–°å¢æˆ¶å£å¤±æ•—', 'è«‹å¡«å¯«å®Œæ•´çš„æˆ¶å£è³‡æ–™ã€‚');
                return;
            }
            
            const newAccount = {
                id: generateId(),
                name: name,
                balance: balance,
                icon: selectedIcon,
                currency: currency // Add currency to account
            };
            
            accounts.push(newAccount);
            saveData('accounts');
            
            closeModal('newAccountModal');
            updateAccountsTab();
            updateAccountDropdowns();
            updateDashboard();
            
            notify('âœ…', 'æˆ¶å£å·²æ–°å¢', `ã€Œ${name}ã€æˆ¶å£å·²æˆåŠŸæ–°å¢ã€‚`);
        }
        
        // Delete an account
        function deleteAccount(accountId) {
            const accountName = getAccountName(accountId);
            
            // Check if there are transactions using this account
            const hasTransactions = transactions.some(t => t.account === accountId);
            
            if (hasTransactions) {
                notify('âŒ', 'ç„¡æ³•åˆªé™¤æˆ¶å£', `ã€Œ${accountName}ã€æˆ¶å£æœ‰ç›¸é—œäº¤æ˜“è¨˜éŒ„ï¼Œç„¡æ³•åˆªé™¤ã€‚`);
                return;
            }
            
            accounts = accounts.filter(a => a.id !== accountId);
            saveData('accounts');
            
            updateAccountsTab();
            updateAccountDropdowns();
            updateDashboard();
            
            notify('ğŸ—‘ï¸', 'æˆ¶å£å·²åˆªé™¤', `ã€Œ${accountName}ã€æˆ¶å£å·²æˆåŠŸåˆªé™¤ã€‚`);
        }
        
        // Add a category
        function addCategory() {
            const nameInput = document.getElementById('newCategoryName');
            const name = nameInput.value.trim();
            
            if (!name) {
                notify('âŒ', 'æ–°å¢é¡åˆ¥å¤±æ•—', 'è«‹è¼¸å…¥é¡åˆ¥åç¨±ã€‚');
                return;
            }
            
            // Check if category already exists
            if (categories[selectedCategoryType].includes(name)) {
                notify('âŒ', 'é¡åˆ¥å·²å­˜åœ¨', `ã€Œ${name}ã€é¡åˆ¥å·²ç¶“å­˜åœ¨ã€‚`);
                return;
            }
            
            categories[selectedCategoryType].push(name);
            saveData('categories');
            
            closeModal('newCategoryModal');
            updateTransactionCategories();
            updateStatisticsCategories();
            updateCategoryBudgetDropdown();
            updateCategoriesManagement();
            
            // If adding a category while in transaction form, select it
            if (transactionType === selectedCategoryType) {
                const categorySelect = document.getElementById('transactionCategory');
                const newOption = document.createElement('option');
                newOption.value = name;
                newOption.textContent = name;
                categorySelect.appendChild(newOption);
                categorySelect.value = name;
            }
            
            notify('âœ…', 'é¡åˆ¥å·²æ–°å¢', 'æ–°é¡åˆ¥å·²æˆåŠŸæ–°å¢ã€‚');
        }
        
        // Transfer money between accounts
        function transferMoney() {
            const fromSelect = document.getElementById('transferFrom');
            const toSelect = document.getElementById('transferTo');
            const amountInput = document.getElementById('transferAmount');
            
            const fromId = fromSelect.value;
            const toId = toSelect.value;
            const amount = parseFloat(amountInput.value);
            
            if (!fromId || !toId || isNaN(amount) || amount <= 0 || fromId === toId) {
                notify('âŒ', 'è½‰è³¬å¤±æ•—', 'è«‹å¡«å¯«æœ‰æ•ˆçš„è½‰è³¬è³‡æ–™ã€‚');
                return;
            }
            
            // Find accounts
            const fromAccountIndex = accounts.findIndex(a => a.id === fromId);
            const toAccountIndex = accounts.findIndex(a => a.id === toId);
            
            if (fromAccountIndex === -1 || toAccountIndex === -1) {
                notify('âŒ', 'è½‰è³¬å¤±æ•—', 'æ‰¾ä¸åˆ°æŒ‡å®šçš„æˆ¶å£ã€‚');
                return;
            }
            
            // Check if from account has enough balance
            if (accounts[fromAccountIndex].balance < amount) {
                notify('âŒ', 'è½‰è³¬å¤±æ•—', 'é¤˜é¡ä¸è¶³ã€‚');
                return;
            }
            
            // Check if currencies are different (for future currency conversion implementation)
            const fromCurrency = accounts[fromAccountIndex].currency;
            const toCurrency = accounts[toAccountIndex].currency;
            
            if (fromCurrency !== toCurrency) {
                // In future, could implement currency conversion here
                notify('âš ï¸', 'ä¸åŒè²¨å¹£è½‰è³¬', `å¾ ${fromCurrency} è½‰è‡³ ${toCurrency}ï¼Œç„¡åŒ¯ç‡è½‰æ›`);
            }
            
            // Update balances
            accounts[fromAccountIndex].balance -= amount;
            accounts[toAccountIndex].balance += amount;
            
            // Record transaction
            const now = new Date();
            const fromAccountName = accounts[fromAccountIndex].name;
            const toAccountName = accounts[toAccountIndex].name;
            
            transactions.push({
                id: generateId(),
                type: 'transfer',
                account: fromId,
                toAccount: toId,
                amount: amount,
                date: getTransactionDate(now),
                note: `å¾ã€Œ${fromAccountName}ã€è½‰è³¬åˆ°ã€Œ${toAccountName}ã€`,
                category: 'æˆ¶å£è½‰è³¬'
            });
            
            saveData('accounts');
            saveData('transactions');
            
            // Reset form
            fromSelect.value = '';
            toSelect.value = '';
            amountInput.value = '';
            
            updateAccountsTab();
            updateDashboard();
            searchTransactions();
            
            // Get currency symbol for "from" account
            const currencySymbol = fromCurrency ? 
                (currencySymbols[fromCurrency] || appSettings.currencySymbol) : 
                appSettings.currencySymbol;
            
            notify('âœ…', 'è½‰è³¬æˆåŠŸ', `å·²æˆåŠŸå°‡ ${currencySymbol}${amount} å¾ã€Œ${fromAccountName}ã€è½‰è³¬åˆ°ã€Œ${toAccountName}ã€ã€‚`);
        }
        
        // Add a transaction
        function addTransaction() {
            const accountSelect = document.getElementById('transactionAccount');
            const categorySelect = document.getElementById('transactionCategory');
            const amountInput = document.getElementById('transactionAmount');
            const dateInput = document.getElementById('transactionDate');
            const noteInput = document.getElementById('transactionNote');
            const enableReceiptUpload = document.getElementById('enableReceiptUpload');
            const receiptImage = document.getElementById('receiptImage');
            
            const accountId = accountSelect.value;
            const category = categorySelect.value;
            const amount = parseFloat(amountInput.value);
            const date = dateInput.value;
            const note = noteInput.value.trim();
            
            if (!accountId || !category || isNaN(amount) || amount <= 0 || !date) {
                notify('âŒ', 'äº¤æ˜“å¤±æ•—', 'è«‹å¡«å¯«å®Œæ•´çš„äº¤æ˜“è³‡æ–™ã€‚');
                return;
            }
            
            const accountIndex = accounts.findIndex(a => a.id === accountId);
            
            if (accountIndex === -1) {
                notify('âŒ', 'äº¤æ˜“å¤±æ•—', 'æ‰¾ä¸åˆ°æŒ‡å®šçš„æˆ¶å£ã€‚');
                return;
            }
            
            // Handle receipt image
            let receipt = null;
            if (enableReceiptUpload.checked && receiptImage.files && receiptImage.files[0]) {
                const file = receiptImage.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    // Create transaction with receipt
                    createTransaction(accountIndex, category, amount, date, note, {
                        data: e.target.result,
                        type: file.type
                    });
                };
                
                reader.readAsDataURL(file);
            } else {
                // Create transaction without receipt
                createTransaction(accountIndex, category, amount, date, note, null);
            }
        }
        
        // Helper function to create a transaction (with or without receipt)
        function createTransaction(accountIndex, category, amount, date, note, receipt) {
            // Update account balance
            if (transactionType === 'income') {
                accounts[accountIndex].balance += amount;
            } else {
                // Check if account has enough balance for expense
                if (accounts[accountIndex].balance < amount) {
                    notify('âš ï¸', 'é¤˜é¡ä¸è¶³', `ã€Œ${accounts[accountIndex].name}ã€æˆ¶å£é¤˜é¡ä¸è¶³ï¼Œä½†äº¤æ˜“ä»å·²è¨˜éŒ„ã€‚`);
                }
                accounts[accountIndex].balance -= amount;
            }
            
            // Add transaction
            transactions.push({
                id: generateId(),
                type: transactionType,
                account: accounts[accountIndex].id,
                category: category,
                amount: amount,
                date: date,
                note: note,
                receipt: receipt
            });
            
            saveData('accounts');
            saveData('transactions');
            
            // Check if budget alert needed
            checkBudgetAlert();
            
            // Reset form except for type and account
            const currentType = transactionType;
            const currentAccount = accounts[accountIndex].id;
            
            document.getElementById('transactionCategory').value = '';
            document.getElementById('transactionAmount').value = '';
            document.getElementById('transactionNote').value = '';
            
            // Reset receipt upload
            document.getElementById('enableReceiptUpload').checked = false;
            document.getElementById('receiptUploadContainer').style.display = 'none';
            document.getElementById('receiptImage').value = '';
            document.getElementById('receiptPreview').style.display = 'none';
            
            updateAccountsTab();
            updateDashboard();
            searchTransactions();
            generateFinancialAdvice();
            
            // Get currency symbol for this account
            const account = accounts[accountIndex];
            const currencySymbol = account.currency ? 
                (currencySymbols[account.currency] || appSettings.currencySymbol) : 
                appSettings.currencySymbol;
                
            notify('âœ…', 'äº¤æ˜“å·²è¨˜éŒ„', `${transactionType === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'}äº¤æ˜“å·²æˆåŠŸè¨˜éŒ„: ${currencySymbol}${formatNumber(amount)}`);
        }
        
        /// ä¿®æ”¹ä¸º:
function saveBudget() {
    // ä¸å†ä»è¾“å…¥æ¡†è·å–é¢„ç®—é‡‘é¢ï¼Œè€Œæ˜¯è‡ªåŠ¨è®¡ç®—
    const cycleSelect = document.getElementById('budgetCycle');
    const resetDaySelect = document.getElementById('budgetResetDay');
    
    const cycle = cycleSelect.value;
    const resetDay = resetDaySelect.value;
    
    // è®¡ç®—æ‰€æœ‰ç±»åˆ«é¢„ç®—çš„æ€»å’Œä½œä¸ºæ€»é¢„ç®—
    const totalAmount = calculateTotalBudget();
    
    // è·å–é˜ˆå€¼
    const thresholdInputs = document.querySelectorAll('.threshold-value');
    const thresholds = Array.from(thresholdInputs).map(input => parseInt(input.value))
        .filter(val => !isNaN(val) && val > 0 && val <= 100);
    
    if (thresholds.length === 0) {
        thresholds.push(80); // Default threshold if none valid
    }
    
    // Sort thresholds in descending order
    thresholds.sort((a, b) => b - a);
    
    budget.amount = totalAmount;
    budget.cycle = cycle;
    budget.resetDay = resetDay;
    budget.thresholds = thresholds;
    
    // Get daily summary timing
    appSettings.dailySummaryTiming = document.getElementById('dailySummaryTiming').value;
    
    // Set last reset to today if not already set
    if (!budget.lastReset) {
        budget.lastReset = new Date().toISOString();
    }
    
    saveData('budget');
    saveData('appSettings');
    
    updateBudgetStatus();
    generateFinancialAdvice();
    
    notify('âœ…', 'é ç®—å·²è¨­å®š', 'æ‚¨çš„é ç®—è¨­å®šå·²æˆåŠŸä¿å­˜ã€‚');
}
        
        // Delete a transaction
        function deleteTransaction(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            // Update account balance
            const accountIndex = accounts.findIndex(a => a.id === transaction.account);
            if (accountIndex !== -1) {
                if (transaction.type === 'income') {
                    accounts[accountIndex].balance -= transaction.amount;
                } else if (transaction.type === 'expense') {
                    accounts[accountIndex].balance += transaction.amount;
                } else if (transaction.type === 'transfer') {
                    // Revert transfer
                    accounts[accountIndex].balance += transaction.amount;
                    const toAccountIndex = accounts.findIndex(a => a.id === transaction.toAccount);
                    if (toAccountIndex !== -1) {
                        accounts[toAccountIndex].balance -= transaction.amount;
                    }
                }
            }
            
            // Remove transaction
            transactions = transactions.filter(t => t.id !== transactionId);
            
            saveData('accounts');
            saveData('transactions');
            
            updateAccountsTab();
            updateDashboard();
            searchTransactions();
            generateFinancialAdvice();
            
            notify('ğŸ—‘ï¸', 'äº¤æ˜“å·²åˆªé™¤', 'äº¤æ˜“è¨˜éŒ„å·²æˆåŠŸåˆªé™¤ã€‚');
        }
        
        // Check budget thresholds and show alerts if needed
        function checkBudgetAlert() {
            if (!budget.amount || !budget.thresholds || budget.thresholds.length === 0) return;
            
            const budgetUsed = getBudgetUsed();
            const budgetPercentage = (budgetUsed / budget.amount) * 100;
            
            // Find the first threshold that is lower than or equal to the current percentage
            // Since thresholds are sorted in descending order, this finds the highest matching threshold
            const matchingThreshold = budget.thresholds.find(threshold => budgetPercentage >= threshold);
            
            if (matchingThreshold) {
                // Only show alert if we haven't shown one for this threshold in this session
                const sessionKey = `budget_alert_${matchingThreshold}`;
                const alertShown = sessionStorage.getItem(sessionKey);
                
                if (!alertShown) {
                    notify('âš ï¸', 'é ç®—è­¦å‘Š', `æ‚¨å·²ä½¿ç”¨äº† ${Math.round(budgetPercentage)}% çš„é ç®—ï¼Œè¶…éäº† ${matchingThreshold}% çš„é–¾å€¼ã€‚`);
                    sessionStorage.setItem(sessionKey, 'shown');
                }
            }
        }
        
        // Show notification
        function notify(icon, title, message) {
            const notificationEl = document.getElementById('notification');
            document.getElementById('notificationIcon').textContent = icon;
            document.getElementById('notificationTitle').textContent = title;
            document.getElementById('notificationMessage').textContent = message;
            
            notificationEl.style.display = 'block';
            
            // Auto-hide notification after 3 seconds
            setTimeout(() => {
                notificationEl.style.display = 'none';
            }, 3000);
        }
        
        // Helper functions
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }
        
        function getAccount(accountId) {
            return accounts.find(a => a.id === accountId);
        }
        
        function getAccountName(accountId) {
            const account = getAccount(accountId);
            return account ? account.name : 'æœªçŸ¥æˆ¶å£';
        }
        
        function getAccountCurrencySymbol(accountId) {
            const account = getAccount(accountId);
            if (!account) return appSettings.currencySymbol;
            
            const currency = account.currency;
            return currency ? (currencySymbols[currency] || appSettings.currencySymbol) : appSettings.currencySymbol;
        }
        
        function getTodayFormatted() {
            return formatDateForInput(new Date());
        }
        
        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function formatDateForFilename(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}/${month}/${day}`;
        }
        
        function formatNumber(number) {
            return parseFloat(number).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        function getTransactionDate(date) {
            // If new day is active, use today's date
            if (newDayStatus.active) {
                return formatDateForInput(date);
            }
            
            // If not active and it's after midnight but before 4am, use yesterday's date
            const hours = date.getHours();
            if (hours >= 0 && hours < 4) {
                const yesterday = new Date(date);
                yesterday.setDate(yesterday.getDate() - 1);
                return formatDateForInput(yesterday);
            }
            
            // Otherwise use today's date
            return formatDateForInput(date);
        }
        
        // ä¿®æ”¹getTotalBalanceå‡½æ•°ï¼ˆçº¦5898è¡Œå·¦å³ï¼‰
function getTotalBalance() {
    // è½¬æ¢æ¯ä¸ªè´¦æˆ·çš„ä½™é¢ä¸ºåŸºå‡†è´§å¸ï¼Œç„¶åæ±‚å’Œ
    return accounts.reduce((sum, account) => {
        const convertedBalance = convertToBaseCurrency(account.balance, account.currency);
        return sum + convertedBalance;
    }, 0);
}
        
        function getTodayTransactions() {
            const today = getTodayFormatted();
            return transactions.filter(t => t.date === today)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
        }
        
        function getTodayIncome() {
            return getTodayTransactions()
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
        }
        
        function getTodayExpense() {
            return getTodayTransactions()
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
        }
        
        function getRecentTransactions(count) {
            return [...transactions]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, count);
        }
        
        function getBudgetCycleText() {
            switch (budget.cycle) {
                case 'daily':
                    return 'æ¯æ—¥';
                case 'weekly':
                    return `æ¯é€± (${budget.resetDay} é‡è¨­)`;
                case 'monthly':
                    return `æ¯æœˆ (${budget.resetDay}æ—¥ é‡è¨­)`;
                default:
                    return 'æœªè¨­å®š';
            }
        }
        
        function getBudgetUsed() {
    if (!budget.lastReset) return 0;
    
    const lastReset = new Date(budget.lastReset);
    
    // è®¡ç®—æ”¯å‡ºæ€»é¢
    const expenses = transactions
        .filter(t => t.type === 'expense' && new Date(t.date) >= lastReset)
        .reduce((sum, t) => sum + parseFloat(t.amount), 0);
    
    // è®¡ç®—æ”¶å…¥æ€»é¢
    const income = transactions
        .filter(t => t.type === 'income' && new Date(t.date) >= lastReset)
        .reduce((sum, t) => sum + parseFloat(t.amount), 0);
    
    // æ”¯å‡ºå‡å»æ”¶å…¥ = å‡€æ”¯å‡º
    const netExpenses = expenses - income;
    
    // å¦‚æœå‡€æ”¯å‡ºä¸ºè´Ÿï¼ˆå³æ”¶å…¥å¤§äºæ”¯å‡ºï¼‰ï¼Œåˆ™è¿”å›0
    return Math.max(0, netExpenses);
}
        
        function getBudgetRemaining() {
            return budget.amount - getBudgetUsed();
        }
        
        function getBudgetPercentage() {
            if (!budget.amount) return 0;
            return Math.round((getBudgetUsed() / budget.amount) * 100);
        }
        
        function getBudgetDaysInPeriod() {
            if (!budget.lastReset) return 30; // Default to 30 days
            
            const lastReset = new Date(budget.lastReset);
            const now = new Date();
            
            switch (budget.cycle) {
                case 'daily':
                    return 1;
                case 'weekly':
                    return 7;
                case 'monthly':
                    // Get number of days in the month
                    const nextMonthDay = new Date(lastReset.getFullYear(), lastReset.getMonth() + 1, budget.resetDay);
                    const diffTime = nextMonthDay - lastReset;
                    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                default:
                    return 30;
            }
        }
        
        function getBudgetDaysRemaining() {
            if (!budget.lastReset) return 0;
            
            const lastReset = new Date(budget.lastReset);
            const now = new Date();
            const resetDay = parseInt(budget.resetDay);
            
            let nextReset;
            
            switch (budget.cycle) {
                case 'daily':
                    // Next reset is tomorrow
                    nextReset = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                    break;
                case 'weekly':
                    // Find next occurrence of the reset day
                    const dayIndex = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'].indexOf(budget.resetDay);
                    const daysUntilNextDay = (dayIndex + 7 - now.getDay()) % 7;
                    nextReset = new Date(now.getFullYear(), now.getMonth(), now.getDate() + daysUntilNextDay);
                    
                    // If it's the reset day, but we already reset today, add 7 days
                    if (daysUntilNextDay === 0 && lastReset.toDateString() === now.toDateString()) {
                        nextReset.setDate(nextReset.getDate() + 7);
                    }
                    break;
                case 'monthly':
                    // Calculate next reset date
                    let nextMonth = now.getMonth();
                    let nextYear = now.getFullYear();
                    
                    // If current day is past reset day, move to next month
                    if (now.getDate() > resetDay) {
                        nextMonth++;
                    }
                    
                    // Handle year change
                    if (nextMonth > 11) {
                        nextMonth = 0;
                        nextYear++;
                    }
                    
                    // Create next reset date
                    nextReset = new Date(nextYear, nextMonth, resetDay);
                    
                    // Handle months with fewer days
                    if (nextReset.getDate() !== resetDay) {
                        // If the month doesn't have the reset day, use the last day of the month
                        nextReset = new Date(nextYear, nextMonth + 1, 0);
                    }
                    break;
                default:
                    return 0;
            }
            
            // Calculate days remaining
            const diffTime = nextReset - now;
            const daysRemaining = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return Math.max(0, daysRemaining);
        }
        
        // è®¡ç®—æ‰€æœ‰ç±»åˆ«é¢„ç®—çš„æ€»å’Œ
function calculateTotalBudget() {
    return categoryBudgets.reduce((total, budget) => total + budget.amount, 0);
}

// æ›´æ–°æ€»é¢„ç®—æ˜¾ç¤º
function updateTotalBudgetDisplay() {
    const totalAmount = calculateTotalBudget();
    document.getElementById('totalBudgetAmount').textContent = formatNumber(totalAmount);
    // åŒæ—¶æ›´æ–°é¢„ç®—å¯¹è±¡
    budget.amount = totalAmount;
    saveData('budget');
    // æ›´æ–°é¢„ç®—çŠ¶æ€æ˜¾ç¤º
    updateBudgetStatus();
}
        
    </script>
</body>
</html>
