<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÈÄ≤ÈöéÂÄã‰∫∫Ë≤°ÂãôËøΩËπ§Âô®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.css" rel="stylesheet">
    <!-- Google API ÂÆ¢Êà∂Á´ØÂ∫´ -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-dark': '#4645B2',
                        'primary-light': '#7877E6',
                    }
                }
            }
        }
    </script>
    <style>
        .emoji-btn {
            transition: transform 0.2s;
        }
        .emoji-btn:hover {
            transform: scale(1.1);
        }
        .slide-enter {
            animation: slideIn 0.3s ease forwards;
        }
        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        .close {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .dark .bg-white {
            background-color: #222;
            color: #fff;
        }
        .dark .bg-gray-50 {
            background-color: #181818;
            color: #fff;
        }
        .dark .bg-gray-100 {
            background-color: #2a2a2a;
            color: #fff;
        }
        .dark .text-gray-800 {
            color: #eee;
        }
        .dark .text-gray-700 {
            color: #ddd;
        }
        .dark .text-gray-600 {
            color: #ccc;
        }
        .dark .border-gray-200 {
            border-color: #444;
        }
        .dark .modal-content {
            background-color: #222;
            color: #fff;
        }
        .dark select, .dark input, .dark textarea {
            background-color: #333;
            color: #fff;
            border-color: #555;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 300px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            overflow: hidden;
            display: none;
        }
        .dark .notification {
            background-color: #333;
            color: #fff;
        }
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 4px;
            display: none;
        }
        .threshold-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 8px;
        }
        /* Ë≤°ÂãôÂàÜÊûêÂç°Áâá */
        .advice-card {
            border-left: 4px solid;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 6px;
            background-color: rgba(93, 92, 222, 0.05);
        }
        .advice-card.saving {
            border-color: #10B981;
        }
        .advice-card.warning {
            border-color: #F59E0B;
        }
        .advice-card.danger {
            border-color: #EF4444;
        }
        .advice-card.info {
            border-color: #3B82F6;
        }
        /* È°ûÂà•È†êÁÆóË¶ñË¶∫Âåñ */
        .category-budget-bar {
            height: 8px;
            border-radius: 4px;
            background-color: #E5E7EB;
            margin-top: 4px;
            overflow: hidden;
        }
        .category-budget-progress {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        #syncReminder {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #EF4444;
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 999;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .dark #syncReminder {
            background-color: #DC2626;
        }
        .currency-label {
            display: inline-block;
            background-color: rgba(93, 92, 222, 0.1);
            color: #5D5CDE;
            padding: 1px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 4px;
            vertical-align: middle;
        }
        .dark .currency-label {
            background-color: rgba(93, 92, 222, 0.3);
        }
        /* ËôõÊì¨ÊªæÂãïÁõ∏ÈóúÊ®£Âºè */
        .virtual-scroll-container {
            position: relative;
            overflow: auto;
            height: 100%;
        }
        .virtual-scroll-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
        }
        /* ËºâÂÖ•ÊåáÁ§∫Âô® */
        .loading-indicator {
            display: none;
            text-align: center;
            padding: 20px;
            color: #5D5CDE;
        }
        .spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(93, 92, 222, 0.3);
            border-radius: 50%;
            border-top-color: #5D5CDE;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Google Drive Êï¥ÂêàÊ®£Âºè */
        .google-signin-button {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            color: #757575;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px 20px;
            font-family: 'Roboto', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .google-signin-button:hover {
            background-color: #f5f5f5;
        }
        .google-icon {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }
        .dark .google-signin-button {
            background-color: #333;
            color: #fff;
            border-color: #555;
        }
        .dark .google-signin-button:hover {
            background-color: #444;
        }
        .sync-status {
            display: flex;
            align-items: center;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.875rem;
            margin-bottom: 10px;
        }
        .sync-status.success {
            background-color: rgba(16, 185, 129, 0.1);
            color: #10B981;
        }
        .sync-status.error {
            background-color: rgba(239, 68, 68, 0.1);
            color: #EF4444;
        }
        .sync-status.pending {
            background-color: rgba(245, 158, 11, 0.1);
            color: #F59E0B;
        }
        .sync-status i {
            margin-right: 8px;
        }
        .dark .sync-status.success {
            background-color: rgba(16, 185, 129, 0.2);
        }
        .dark .sync-status.error {
            background-color: rgba(239, 68, 68, 0.2);
        }
        .dark .sync-status.pending {
            background-color: rgba(245, 158, 11, 0.2);
        }

        /* Êñ∞Â¢ûÈ°ûÂà•ÁÆ°ÁêÜÊ®£Âºè */
        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 6px;
            background-color: #f8f9fa;
            transition: background-color 0.2s;
        }
        .category-item:hover {
            background-color: #e9ecef;
        }
        .dark .category-item {
            background-color: #333;
        }
        .dark .category-item:hover {
            background-color: #444;
        }
        .category-delete-btn {
            color: #ef4444;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .category-delete-btn:hover {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <header class="mb-6">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-primary">
                    <span class="mr-2">üí∞</span>ÈÄ≤ÈöéË≤°ÂãôËøΩËπ§Âô®
                    <span id="selectedCurrency" class="text-sm bg-primary bg-opacity-20 text-primary px-2 py-1 rounded-full ml-2">TWD</span>
                </h1>
                <div class="flex space-x-2">
                    <!-- Google Sign-in Status -->
                    <div id="googleAuthStatus" class="bg-gray-100 text-gray-600 px-3 py-2 rounded-md text-sm hidden items-center">
                        <i class="fab fa-google mr-1"></i>
                        <span id="googleUserName">Êú™ÁôªÂÖ•</span>
                    </div>
                    <!-- Settings Button -->
                    <button id="settingsBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition">
                        <span class="mr-1">‚öôÔ∏è</span>Ë®≠ÂÆö
                    </button>
                    <!-- New Day Button -->
                    <button id="newDayBtn" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition">
                        <span class="mr-1">üåÖ</span>ÈñãÂïüÊñ∞ÁöÑ‰∏ÄÂ§©
                    </button>
                    <!-- Import/Export Button -->
                    <button id="importExportBtn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition">
                        <span class="mr-1">üíæ</span>ÂåØÂÖ•/ÂåØÂá∫
                    </button>
                </div>
            </div>
            <!-- Balance Summary -->
            <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-4 rounded-lg shadow slide-enter border-l-4 border-blue-500">
                    <div class="text-gray-600">Á∏ΩË≥áÁî¢</div>
                    <div class="text-2xl font-bold text-blue-600"><span id="currencySymbol">$</span> <span id="totalBalance">0.00</span></div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow slide-enter border-l-4 border-green-500">
                    <div class="text-gray-600">‰ªäÊó•Êî∂ÂÖ•</div>
                    <div class="text-2xl font-bold text-green-600"><span id="currencySymbol2">$</span> <span id="todayIncome">0.00</span></div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow slide-enter border-l-4 border-red-500">
                    <div class="text-gray-600">‰ªäÊó•ÊîØÂá∫</div>
                    <div class="text-2xl font-bold text-red-600"><span id="currencySymbol3">$</span> <span id="todayExpense">0.00</span></div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="mb-6 border-b border-gray-200">
            <ul class="flex flex-wrap -mb-px" id="tabsContainer">
                <li class="mr-2">
                    <button data-tab="dashboard" class="tab-btn inline-block py-2 px-4 border-b-2 font-medium text-primary border-primary">
                        <span class="mr-1">üìä</span>ÂÑÄË°®Êùø
                    </button>
                </li>
                <li class="mr-2">
                    <button data-tab="accounts" class="tab-btn inline-block py-2 px-4 border-b-2 font-medium text-gray-500 hover:text-gray-700 border-transparent">
                        <span class="mr-1">üí≥</span>Êà∂Âè£ÁÆ°ÁêÜ
                    </button>
                </li>
                <li class="mr-2">
                    <button data-tab="transactions" class="tab-btn inline-block py-2 px-4 border-b-2 font-medium text-gray-500 hover:text-gray-700 border-transparent">
                        <span class="mr-1">üìù</span>Ë®òË≥¨
                    </button>
                </li>
                <li class="mr-2">
                    <button data-tab="budget" class="tab-btn inline-block py-2 px-4 border-b-2 font-medium text-gray-500 hover:text-gray-700 border-transparent">
                        <span class="mr-1">‚öôÔ∏è</span>È†êÁÆóË®≠ÂÆö
                    </button>
                </li>
                <li class="mr-2">
                    <button data-tab="categories" class="tab-btn inline-block py-2 px-4 border-b-2 font-medium text-gray-500 hover:text-gray-700 border-transparent">
                        <span class="mr-1">üè∑Ô∏è</span>È°ûÂà•ÁÆ°ÁêÜ
                    </button>
                </li>
                <li class="mr-2">
                    <button data-tab="stats" class="tab-btn inline-block py-2 px-4 border-b-2 font-medium text-gray-500 hover:text-gray-700 border-transparent">
                        <span class="mr-1">üìà</span>Áµ±Ë®àÂàÜÊûê
                    </button>
                </li>
                <li class="mr-2">
                    <button data-tab="advice" class="tab-btn inline-block py-2 px-4 border-b-2 font-medium text-gray-500 hover:text-gray-700 border-transparent">
                        <span class="mr-1">üí°</span>Ë≤°ÂãôÂª∫Ë≠∞
                    </button>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <main>
            <!-- Dashboard -->
            <div id="dashboard" class="tab-content active slide-enter">
                <div class="mb-8">
                    <h2 class="text-xl font-bold mb-4 text-gray-800"><span class="mr-2">üìÖ</span>‰ªäÊó•‰∫§Êòì</h2>
                    <div id="todayTransactionsEmpty" class="bg-white p-4 rounded-lg shadow text-center text-gray-500">
                        ‰ªäÊó•Â∞öÁÑ°‰∫§ÊòìË®òÈåÑ
                    </div>
                    <div id="todayTransactionsTable" class="bg-white rounded-lg shadow overflow-hidden" style="display: none;">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">È°ûÂûã</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Êà∂Âè£</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">È°ûÂà•</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÈáëÈ°ç</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÂÇôË®ª</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Êî∂Êìö</th>
                                </tr>
                            </thead>
                            <tbody id="todayTransactionsList" class="bg-white divide-y divide-gray-200">
                                <!-- Today transactions will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Budget Status -->
                    <div>
                        <h2 class="text-xl font-bold mb-4 text-gray-800"><span class="mr-2">üìä</span>È†êÁÆóÁãÄÊÖã</h2>
                        <div id="noBudget" class="bg-white p-6 rounded-lg shadow text-center">
                            <p class="text-gray-500 mb-4">Â∞öÊú™Ë®≠ÂÆöÈ†êÁÆó</p>
                            <button id="goBudgetBtn" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-primary-dark transition">
                                Ë®≠ÂÆöÈ†êÁÆó
                            </button>
                        </div>
                        <div id="budgetStatus" class="bg-white p-6 rounded-lg shadow" style="display: none;">
                            <div class="mb-2 flex justify-between">
                                <span class="text-gray-600">È†êÁÆóÈÄ±Êúü:</span>
                                <span id="budgetCycleText"></span>
                            </div>
                            <div class="mb-2 flex justify-between">
                                <span class="text-gray-600">Á∏ΩÈ†êÁÆó:</span>
                                <span class="font-medium"><span id="currencySymbol4">$</span><span id="budgetAmount"></span></span>
                            </div>
                            <div class="mb-2 flex justify-between">
                                <span class="text-gray-600">Ê∑®ÊîØÂá∫:</span>
                                <span class="font-medium"><span id="currencySymbol5">$</span><span id="budgetUsed"></span></span>
                            </div>
                            <div class="mb-2 flex justify-between">
                                <span class="text-gray-600">Ââ©È§òÈ†êÁÆó:</span>
                                <span id="budgetRemaining" class="font-medium"></span>
                            </div>
                            <div class="mt-4">
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div id="budgetBar" class="h-2.5 rounded-full bg-primary"></div>
                                </div>
                                <div id="budgetPercentage" class="text-right text-sm mt-1 text-gray-500"></div>
                            </div>
                            
                            <!-- È°ûÂà•È†êÁÆóÁãÄÊÖã (Â¶ÇÊûúÊúâ) -->
                            <div id="categoryBudgets" class="mt-4 border-t border-gray-200 pt-4">
                                <h3 class="font-medium text-gray-700 mb-2">È°ûÂà•È†êÁÆó</h3>
                                <div id="categoryBudgetList">
                                    <!-- È°ûÂà•È†êÁÆóÂ∞áÂú®ÈÄôË£°È°ØÁ§∫ -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Transactions -->
                    <div>
                        <h2 class="text-xl font-bold mb-4 text-gray-800"><span class="mr-2">üïí</span>ËøëÊúü‰∫§Êòì</h2>
                        <div id="noTransactions" class="bg-white p-4 rounded-lg shadow text-center text-gray-500">
                            Â∞öÁÑ°‰∫§ÊòìË®òÈåÑ
                        </div>
                        <div id="recentTransactions" class="bg-white rounded-lg shadow overflow-hidden" style="display: none;">
                            <ul id="recentTransactionsList" class="divide-y divide-gray-200">
                                <!-- Recent transactions will be inserted here -->
                            </ul>
                            <div class="p-4 border-t border-gray-200">
                                <button id="viewAllTransactionsBtn" class="text-primary hover:text-primary-dark text-sm font-medium flex items-center">
                                    Êü•ÁúãÂÖ®ÈÉ®‰∫§Êòì
                                    <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Accounts Management -->
            <div id="accounts" class="tab-content slide-enter">
                <div id="accountsGrid" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <!-- Account cards will be inserted here -->
                </div>
                
                <!-- Transfer Money Between Accounts -->
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-lg font-bold mb-4"><span class="mr-2">üîÑ</span>ËΩâË≥¨</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-gray-700 mb-2">ÂæûÊà∂Âè£</label>
                            <select id="transferFrom" class="w-full p-2 border border-gray-300 rounded-md text-base">
                                <option value="" disabled selected>ÈÅ∏ÊìáÊà∂Âè£</option>
                                <!-- From account options will be inserted here -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Ëá≥Êà∂Âè£</label>
                            <select id="transferTo" class="w-full p-2 border border-gray-300 rounded-md text-base">
                                <option value="" disabled selected>ÈÅ∏ÊìáÊà∂Âè£</option>
                                <!-- To account options will be inserted here -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">ÈáëÈ°ç</label>
                            <input type="number" id="transferAmount" placeholder="Ëº∏ÂÖ•ÈáëÈ°ç" class="w-full p-2 border border-gray-300 rounded-md text-base">
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button id="transferBtn" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-primary-dark transition">
                            Á¢∫Ë™çËΩâË≥¨
                        </button>
                    </div>
                </div>
            </div>

            <!-- Transactions (Record Income/Expense) -->
            <div id="transactions" class="tab-content slide-enter">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4"><span class="mr-2">üìù</span>Ë®òÈåÑÊî∂ÂÖ•/ÊîØÂá∫</h2>
                    
                    <div class="mb-4">
                        <div class="flex space-x-4">
                            <button id="incomeBtn" class="flex-1 py-2 px-4 rounded-md font-medium bg-gray-200 text-gray-700">
                                <span class="mr-2">üíπ</span>Êî∂ÂÖ•
                            </button>
                            <button id="expenseBtn" class="flex-1 py-2 px-4 rounded-md font-medium bg-red-500 text-white">
                                <span class="mr-2">üí∏</span>ÊîØÂá∫
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 mb-2">ÈÅ∏ÊìáÊà∂Âè£</label>
                            <select id="transactionAccount" class="w-full p-2 border border-gray-300 rounded-md text-base">
                                <option value="" disabled selected>ÈÅ∏ÊìáÊà∂Âè£</option>
                                <!-- Account options will be inserted here -->
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 mb-2">ÈÅ∏ÊìáÈ°ûÂà•</label>
                            <div class="flex gap-2">
                                <select id="transactionCategory" class="flex-1 p-2 border border-gray-300 rounded-md text-base">
                                    <option value="" disabled selected>ÈÅ∏ÊìáÈ°ûÂà•</option>
                                    <!-- Category options will be inserted here -->
                                </select>
                                <button id="addCategoryBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 p-2 rounded-md">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 mb-2">ÈáëÈ°ç</label>
                            <input type="number" id="transactionAmount" placeholder="Ëº∏ÂÖ•ÈáëÈ°ç" class="w-full p-2 border border-gray-300 rounded-md text-base">
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 mb-2">Êó•Êúü</label>
                            <input type="date" id="transactionDate" class="w-full p-2 border border-gray-300 rounded-md text-base">
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-gray-700 mb-2">ÂÇôË®ª (ÂèØÈÅ∏)</label>
                            <textarea id="transactionNote" placeholder="Ëº∏ÂÖ•ÂÇôË®ª" class="w-full p-2 border border-gray-300 rounded-md text-base" rows="2"></textarea>
                        </div>
                        
                        <!-- Êî∂Êìö‰∏äÂÇ≥ -->
                        <div class="md:col-span-2">
                            <div class="flex items-center justify-between mb-2">
                                <label class="block text-gray-700">Êî∂ÊìöÂúñÁâá (ÂèØÈÅ∏)</label>
                                <div class="flex items-center">
                                    <input type="checkbox" id="enableReceiptUpload" class="mr-2">
                                    <label for="enableReceiptUpload" class="text-sm text-gray-600">ÂïüÁî®Êî∂Êìö‰∏äÂÇ≥</label>
                                </div>
                            </div>
                            <div id="receiptUploadContainer" style="display: none;">
                                <input type="file" id="receiptImage" accept="image/*" class="w-full p-2 border border-gray-300 rounded-md text-base">
                                <img id="receiptPreview" class="image-preview" alt="Êî∂ÊìöÈ†êË¶Ω">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-end">
                        <button id="saveTransactionBtn" class="bg-primary text-white px-6 py-2 rounded-md hover:bg-primary-dark transition">
                            <span class="mr-2">‚úÖ</span>‰øùÂ≠ò
                        </button>
                    </div>
                </div>
            </div>

            <!-- Budget Setting -->
            <div id="budget" class="tab-content slide-enter">
                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h2 class="text-xl font-bold mb-4"><span class="mr-2">‚öôÔ∏è</span>Á∏ΩÈ†êÁÆóË®≠ÂÆö</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
           
<div>
    <label class="block text-gray-700 mb-2">È†êÁÆóÈáëÈ°ç (È°ûÂà•È†êÁÆóÁ∏ΩÂíå)</label>
    <div class="flex items-center">
        <div id="totalBudgetDisplay" class="p-2 bg-gray-100 border border-gray-300 rounded-md text-base w-full">
            <span id="totalBudgetAmount">0.00</span>
        </div>
        <div class="ml-2 text-sm text-gray-500 italic">Ëá™ÂãïË®àÁÆó</div>
    </div>
</div>
                        
                        <div>
                            <label class="block text-gray-700 mb-2">ÈáçË®≠ÈÄ±Êúü</label>
                            <select id="budgetCycle" class="w-full p-2 border border-gray-300 rounded-md text-base">
                                <option value="daily">ÊØèÊó•</option>
                                <option value="weekly">ÊØèÈÄ±</option>
                                <option value="monthly" selected>ÊØèÊúà</option>
                            </select>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-gray-700 mb-2">ÈÄöÁü•ÈñæÂÄºË®≠ÂÆö</label>
                            <div id="thresholdContainer">
                                <!-- ÈñæÂÄºÈ†ÖÁõÆÂ∞áÂú®ÈÄôË£°Ê∑ªÂä† -->
                                <div class="threshold-item">
                                    <input type="number" class="threshold-value p-2 border border-gray-300 rounded-md text-base w-20" min="1" max="100" value="80">
                                    <span class="text-gray-600">% ÊôÇÈÄöÁü•</span>
                                    <span class="flex-grow"></span>
                                    <button class="remove-threshold text-red-500 hover:text-red-700">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <button id="addThresholdBtn" class="mt-2 bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-md text-sm">
                                <i class="fas fa-plus mr-1"></i> Ê∑ªÂä†ÈÄöÁü•ÈñæÂÄº
                            </button>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 mb-2">ÈáçË®≠Êó•</label>
                            <select id="budgetResetDay" class="w-full p-2 border border-gray-300 rounded-md text-base">
                                <!-- Reset day options will be inserted here -->
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 mb-2">Êñ∞‰∏ÄÂ§©ÂàÜÊûê</label>
                            <select id="dailySummaryTiming" class="w-full p-2 border border-gray-300 rounded-md text-base">
                                <option value="immediate">ÈñãÂïüÊñ∞‰∏ÄÂ§©ÊôÇÁ´ãÂç≥È°ØÁ§∫</option>
                                <option value="manual">ÊâãÂãïÊü•Áúã</option>
                                <option value="disabled">‰∏çÈ°ØÁ§∫</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-end">
                        <button id="saveBudgetBtn" class="bg-primary text-white px-6 py-2 rounded-md hover:bg-primary-dark transition">
                            <span class="mr-2">‚úÖ</span>‰øùÂ≠òË®≠ÂÆö
                        </button>
                    </div>
                </div>
                
                <!-- È°ûÂà•È†êÁÆóË®≠ÂÆö -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-4"><span class="mr-2">üìä</span>È°ûÂà•È†êÁÆóË®≠ÂÆö</h2>
                    
                    <div class="mb-4 flex gap-2">
                        <select id="categoryForBudget" class="flex-1 p-2 border border-gray-300 rounded-md text-base">
                            <option value="" disabled selected>ÈÅ∏ÊìáÈ°ûÂà•</option>
                            <!-- Categories will be populated here -->
                        </select>
                        <input type="number" id="categoryBudgetAmount" placeholder="ÈáëÈ°ç" class="w-32 p-2 border border-gray-300 rounded-md text-base">
                        <button id="addCategoryBudgetBtn" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-primary-dark transition">
                            Ê∑ªÂä†
                        </button>
                    </div>
                    
                    <div id="categoryBudgetItems" class="divide-y divide-gray-200">
                        <!-- Category budget items will be inserted here -->
                        <div class="text-center text-gray-500 py-4">Â∞öÊú™Ë®≠ÁΩÆÈ°ûÂà•È†êÁÆó</div>
                    </div>
                </div>
            </div>

            <!-- Categories Management - Êñ∞Â¢ûÈ†ÅÈù¢ -->
            <div id="categories" class="tab-content slide-enter">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Êî∂ÂÖ•È°ûÂà• -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4"><span class="mr-2">üíπ</span>Êî∂ÂÖ•È°ûÂà•</h2>
                        
                        <div class="mb-4 flex gap-2">
                            <input type="text" id="newIncomeCategoryName" placeholder="Êñ∞Â¢ûÊî∂ÂÖ•È°ûÂà•" class="flex-1 p-2 border border-gray-300 rounded-md text-base">
                            <button id="addIncomeCategoryBtn" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition">
                                <i class="fas fa-plus"></i> Êñ∞Â¢û
                            </button>
                        </div>
                        
                        <div id="incomeCategoriesList" class="mt-4">
                            <!-- Êî∂ÂÖ•È°ûÂà•Â∞áÂú®ÈÄôË£°È°ØÁ§∫ -->
                        </div>
                    </div>
                    
                    <!-- ÊîØÂá∫È°ûÂà• -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-bold mb-4"><span class="mr-2">üí∏</span>ÊîØÂá∫È°ûÂà•</h2>
                        
                        <div class="mb-4 flex gap-2">
                            <input type="text" id="newExpenseCategoryName" placeholder="Êñ∞Â¢ûÊîØÂá∫È°ûÂà•" class="flex-1 p-2 border border-gray-300 rounded-md text-base">
                            <button id="addExpenseCategoryBtn" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition">
                                <i class="fas fa-plus"></i> Êñ∞Â¢û
                            </button>
                        </div>
                        
                        <div id="expenseCategoriesList" class="mt-4">
                            <!-- ÊîØÂá∫È°ûÂà•Â∞áÂú®ÈÄôË£°È°ØÁ§∫ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div id="stats" class="tab-content slide-enter">
                <div class="mb-6">
                    <h2 class="text-xl font-bold mb-4"><span class="mr-2">üîç</span>ÊêúÂ∞ã‰∫§Êòì</h2>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-gray-700 mb-2">Êó•ÊúüÁØÑÂúç</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="date" id="searchStartDate" class="w-full p-2 border border-gray-300 rounded-md text-base">
                                    <input type="date" id="searchEndDate" class="w-full p-2 border border-gray-300 rounded-md text-base">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-2">È°ûÂûã</label>
                                <select id="searchType" class="w-full p-2 border border-gray-300 rounded-md text-base">
                                    <option value="">ÂÖ®ÈÉ®</option>
                                    <option value="income">Êî∂ÂÖ•</option>
                                    <option value="expense">ÊîØÂá∫</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-2">È°ûÂà•</label>
                                <select id="searchCategory" class="w-full p-2 border border-gray-300 rounded-md text-base">
                                    <option value="">ÂÖ®ÈÉ®È°ûÂà•</option>
                                    <!-- All categories will be inserted here -->
                                </select>
                            </div>
                        </div>

                        <!-- Êñ∞Â¢ûÂÇôË®ªÊêúÂ∞ãÊ¨Ñ‰Ωç -->
                        <div class="mt-4">
                            <label class="block text-gray-700 mb-2">ÂÇôË®ªÈóúÈçµÂ≠ó</label>
                            <input type="text" id="searchNote" placeholder="ÊêúÂ∞ãÂÇôË®ªÈóúÈçµÂ≠ó" class="w-full p-2 border border-gray-300 rounded-md text-base">
                        </div>
                        
                        <div class="mt-4 flex justify-end">
                            <button id="searchBtn" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-primary-dark transition">
                                <span class="mr-2">üîç</span>ÊêúÂ∞ã
                            </button>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h2 class="text-xl font-bold mb-4"><span class="mr-2">üìã</span>‰∫§ÊòìË®òÈåÑ</h2>
                    <div id="noSearchResults" class="bg-white p-4 rounded-lg shadow text-center text-gray-500">
                        ÁÑ°Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑ‰∫§ÊòìË®òÈåÑ
                    </div>
                    
                    <!-- ËºâÂÖ•ÊåáÁ§∫Âô® -->
                    <div id="searchLoadingIndicator" class="loading-indicator">
                        <div class="spinner"></div>
                        <p class="mt-2">ËºâÂÖ•‰∫§ÊòìÊï∏Êìö‰∏≠...</p>
                    </div>
                    
                    <div id="searchResults" class="bg-white rounded-lg shadow overflow-hidden" style="display: none;">
                        <div class="virtual-scroll-container max-h-96">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0 z-10">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Êó•Êúü</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">È°ûÂûã</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Êà∂Âè£</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">È°ûÂà•</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÈáëÈ°ç</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÂÇôË®ª</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Êî∂Êìö</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Êìç‰Ωú</th>
                                    </tr>
                                </thead>
                                <tbody id="searchResultsList" class="bg-white divide-y divide-gray-200">
                                    <!-- Search results will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="p-4 border-t border-gray-200 text-center text-sm text-gray-500" id="resultsCount">
                            È°ØÁ§∫ 0 Á≠Ü‰∫§ÊòìË®òÈåÑ
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Financial Advice -->
            <div id="advice" class="tab-content slide-enter">
                <div class="mb-6">
                    <h2 class="text-xl font-bold mb-4 text-gray-800"><span class="mr-2">üí°</span>Ë≤°ÂãôÂª∫Ë≠∞</h2>
                    
                    <div id="noAdviceData" class="bg-white p-6 rounded-lg shadow text-center">
                        <p class="text-gray-500 mb-4">Â∞öÁÑ°Ë∂≥Â§†Êï∏ÊìöÊèê‰æõË≤°ÂãôÂª∫Ë≠∞</p>
                        <p class="text-gray-500 text-sm">Ëá≥Â∞ëÈúÄË¶Å 5 Á≠Ü‰∫§ÊòìË®òÈåÑ‰æÜÁîüÊàêÂª∫Ë≠∞</p>
                    </div>
                    
                    <div id="adviceContent" class="bg-white p-6 rounded-lg shadow" style="display:none;">
                        <!-- Ë≤°ÂãôÂÅ•Â∫∑Ê¶ÇÊ≥Å -->
                        <div class="mb-6">
                            <h3 class="font-bold text-gray-800 mb-3">Ë≤°ÂãôÂÅ•Â∫∑Ê¶ÇÊ≥Å</h3>
                            <div class="flex items-center mb-3">
                                <div id="healthScore" class="text-2xl font-bold mr-3">0</div>
                                <div class="flex-grow h-2 bg-gray-200 rounded-full">
                                    <div id="healthScoreBar" class="h-2 rounded-full bg-green-500" style="width: 0%"></div>
                                </div>
                            </div>
                            <p id="healthSummary" class="text-gray-600"></p>
                        </div>
                        
                        <!-- ÊîØÂá∫ÂàÜÊûê -->
                        <div class="mb-6">
                            <h3 class="font-bold text-gray-800 mb-3">ÊîØÂá∫ÂàÜÊûê</h3>
                            <div id="expenseAnalysis"></div>
                        </div>
                        
                        <!-- ÂÑ≤ËìÑÂª∫Ë≠∞ -->
                        <div class="mb-6">
                            <h3 class="font-bold text-gray-800 mb-3">ÂÑ≤ËìÑÂª∫Ë≠∞</h3>
                            <div id="savingsAdvice"></div>
                        </div>
                        
                        <!-- È†êÁÆóÂª∫Ë≠∞ -->
                        <div>
                            <h3 class="font-bold text-gray-800 mb-3">È†êÁÆóÂª∫Ë≠∞</h3>
                            <div id="budgetAdvice"></div>
                        </div>
                    </div>
                </div>
                
                <!-- ÊØèÊó•Ê∂àË≤ªÊëòË¶Å -->
                <div>
                    <h2 class="text-xl font-bold mb-4 text-gray-800"><span class="mr-2">üìÜ</span>ÊØèÊó•Ê∂àË≤ªÊëòË¶Å</h2>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2">ÈÅ∏ÊìáÊó•Êúü</label>
                            <div class="flex gap-2">
                                <input type="date" id="summaryDate" class="flex-1 p-2 border border-gray-300 rounded-md text-base" value="">
                                <button id="viewSummaryBtn" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-primary-dark transition">
                                    Êü•ÁúãÊëòË¶Å
                                </button>
                            </div>
                        </div>
                        
                        <div id="dailySummaryContainer" class="mt-4 border-t border-gray-200 pt-4" style="display:none;">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <div class="text-sm text-green-600 mb-1">Êî∂ÂÖ•Á∏ΩË®à</div>
                                    <div class="text-xl font-bold text-green-700"><span id="summarySymbol1">$</span><span id="summaryIncome">0.00</span></div>
                                </div>
                                <div class="bg-red-50 p-4 rounded-lg">
                                    <div class="text-sm text-red-600 mb-1">ÊîØÂá∫Á∏ΩË®à</div>
                                    <div class="text-xl font-bold text-red-700"><span id="summarySymbol2">$</span><span id="summaryExpense">0.00</span></div>
                                </div>
                            </div>
                            
                            <h4 class="font-medium text-gray-700 mb-2">ÊîØÂá∫È°ûÂà•ÂàÜ‰Ωà</h4>
                            <div id="summaryCategories" class="mb-4 space-y-2">
                                <!-- È°ûÂà•ÂàÜ‰ΩàÊúÉÂú®ÈÄôË£°È°ØÁ§∫ -->
                            </div>
                            
                            <h4 class="font-medium text-gray-700 mb-2">‰∫§ÊòìË®òÈåÑ</h4>
                            <div id="summaryTransactions" class="max-h-60 overflow-y-auto">
                                <!-- ‰∫§ÊòìË®òÈåÑÊúÉÂú®ÈÄôË£°È°ØÁ§∫ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Modals -->
        <!-- New Account Modal -->
        <div id="newAccountModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3 class="text-xl font-bold mb-4">Êñ∞Â¢ûÊà∂Âè£</h3>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Êà∂Âè£ÂêçÁ®±</label>
                    <input type="text" id="newAccountName" placeholder="Ëº∏ÂÖ•Êà∂Âè£ÂêçÁ®±" class="w-full p-2 border border-gray-300 rounded-md text-base">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">ÂàùÂßãÈ§òÈ°ç</label>
                    <input type="number" id="newAccountBalance" placeholder="Ëº∏ÂÖ•ÂàùÂßãÈ§òÈ°ç" class="w-full p-2 border border-gray-300 rounded-md text-base">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">ÈÅ∏ÊìáË≤®Âπ£</label>
                    <select id="newAccountCurrency" class="w-full p-2 border border-gray-300 rounded-md text-base">
                        <option value="TWD" selected>Êñ∞Âè∞Âπ£ (TWD)</option>
                        <option value="USD">ÁæéÂÖÉ (USD)</option>
                        <option value="EUR">Ê≠êÂÖÉ (EUR)</option>
                        <option value="JPY">Êó•ÂÖÉ (JPY)</option>
                        <option value="CNY">‰∫∫Ê∞ëÂπ£ (CNY)</option>
                        <option value="HKD">Ê∏ØÂπ£ (HKD)</option>
                        <option value="GBP">Ëã±Èéä (GBP)</option>
                        <option value="AUD">Êæ≥ÂÖÉ (AUD)</option>
                        <option value="CAD">Âä†ÊãøÂ§ßÂÖÉ (CAD)</option>
                        <option value="SGD">Êñ∞Âä†Âù°ÂÖÉ (SGD)</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 mb-2">ÈÅ∏ÊìáÂúñÊ®ô</label>
                    <div id="accountIcons" class="grid grid-cols-5 gap-2">
                        <!-- Account icons will be inserted here -->
                    </div>
                </div>
                <div class="flex justify-end">
                    <button id="addAccountBtn" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-primary-dark transition">
                        Êñ∞Â¢ûÊà∂Âè£
                    </button>
                </div>
            </div>
        </div>

        <!-- New Category Modal -->
        <div id="newCategoryModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3 class="text-xl font-bold mb-4">Êñ∞Â¢ûÈ°ûÂà•</h3>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">È°ûÂà•ÂêçÁ®±</label>
                    <input type="text" id="newCategoryName" placeholder="Ëº∏ÂÖ•È°ûÂà•ÂêçÁ®±" class="w-full p-2 border border-gray-300 rounded-md text-base">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">È°ûÂûã</label>
                    <div class="flex space-x-4">
                        <button id="newCategoryIncomeBtn" class="flex-1 py-2 px-4 rounded-md font-medium bg-gray-200 text-gray-700">
                            <span class="mr-2">üíπ</span>Êî∂ÂÖ•
                        </button>
                        <button id="newCategoryExpenseBtn" class="flex-1 py-2 px-4 rounded-md font-medium bg-red-500 text-white">
                            <span class="mr-2">üí∏</span>ÊîØÂá∫
                        </button>
                    </div>
                </div>
                <div class="flex justify-end">
                    <button id="addCategoryConfirmBtn" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-primary-dark transition">
                        Êñ∞Â¢ûÈ°ûÂà•
                    </button>
                </div>
            </div>
        </div>

        <!-- Import/Export Modal -->
        <div id="importExportModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3 class="text-xl font-bold mb-4">Êï∏ÊìöÂåØÂÖ•/ÂåØÂá∫</h3>
                
                <!-- Google Drive Êï¥Âêà -->
                <div class="mb-6 border-b border-gray-200 pb-4">
                    <h4 class="font-medium mb-3">Google Drive Èõ≤Á´ØÂêåÊ≠•</h4>
                    <div id="googleAuthSection">
                        <div id="googleSigninStatus" class="sync-status mb-3" style="display: none;">
                            <i class="fas fa-circle-info"></i>
                            <span>Â∞öÊú™ÁôªÂÖ• Google Â∏≥Êà∂</span>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row gap-2">
                            <button id="googleSignInBtn" class="google-signin-button flex-1">
                                <svg class="google-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
                                    <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                                    <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                                    <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                                    <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                                </svg>
                                ‰ΩøÁî® Google Â∏≥Êà∂ÁôªÂÖ•
                            </button>
                            <button id="googleSignOutBtn" class="google-signin-button flex-1" style="display: none;">
                                <i class="fas fa-sign-out-alt mr-2"></i>
                                ÁôªÂá∫ Google Â∏≥Êà∂
                            </button>
                        </div>
                    </div>

                    <div id="googleDriveActions" class="mt-3" style="display: none;">
                        <div class="flex flex-col sm:flex-row gap-2">
                            <button id="saveToDriveBtn" class="flex-1 bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition">
                                <i class="fas fa-cloud-upload-alt mr-1"></i> ‰øùÂ≠òÂà∞ Google Drive
                            </button>
                            <button id="loadFromDriveBtn" class="flex-1 bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition">
                                <i class="fas fa-cloud-download-alt mr-1"></i> Âæû Google Drive ËºâÂÖ•
                            </button>
                        </div>
                        
                        <div class="flex items-center mt-3">
                            <input type="checkbox" id="enableAutoSync" class="mr-2">
                            <label for="enableAutoSync" class="text-gray-700">ÂïüÁî®Ëá™ÂãïÂêåÊ≠•</label>
                        </div>
                        
                        <div id="autoSyncOptions" class="mt-2 ml-6" style="display: none;">
                            <div class="flex items-center">
                                <input type="radio" id="autoSyncDaily" name="autoSyncFreq" value="daily" class="mr-2">
                                <label for="autoSyncDaily" class="text-gray-700 mr-4">ÊØèÊó•</label>
                                
                                <input type="radio" id="autoSyncWeekly" name="autoSyncFreq" value="weekly" class="mr-2">
                                <label for="autoSyncWeekly" class="text-gray-700 mr-4">ÊØèÈÄ±</label>
                                
                                <input type="radio" id="autoSyncMonthly" name="autoSyncFreq" value="monthly" class="mr-2">
                                <label for="autoSyncMonthly" class="text-gray-700">ÊØèÊúà</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <h4 class="font-medium mb-2">ÂåØÂá∫Êï∏Êìö</h4>
                    <p class="text-sm text-gray-600 mb-2">Ë§áË£Ω‰∏ãÊñπÊñáÊú¨‰ª•ÂÇô‰ªΩÊÇ®ÁöÑÊï∏ÊìöÔºö</p>
                    <textarea id="exportDataArea" class="w-full h-40 p-2 border border-gray-300 rounded-md bg-gray-50 text-sm" readonly></textarea>
                    <div class="flex gap-2 mt-2">
                        <button id="copyExportBtn" class="flex-1 bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition">
                            <i class="fas fa-copy mr-1"></i> Ë§áË£ΩÂà∞Ââ™Ë≤ºÊùø
                        </button>
                        <button id="downloadExportBtn" class="flex-1 bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition">
                            <i class="fas fa-download mr-1"></i> ‰∏ãËºâÁÇ∫Êñá‰ª∂
                        </button>
                    </div>
                </div>
                
                <div class="mt-6">
                    <h4 class="font-medium mb-2">ÂåØÂÖ•Êï∏Êìö</h4>
                    <div class="flex gap-2 mb-2">
                        <button id="uploadImportBtn" class="flex-1 bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition">
                            <i class="fas fa-upload mr-1"></i> ÂæûÊñá‰ª∂‰∏äÂÇ≥
                        </button>
                        <input type="file" id="importFile" accept=".json,.txt" class="hidden">
                    </div>
                    <p class="text-sm text-gray-600 mb-2">ÊàñË≤º‰∏ä‰πãÂâçÂåØÂá∫ÁöÑÊï∏ÊìöÔºö</p>
                    <textarea id="importDataArea" class="w-full h-40 p-2 border border-gray-300 rounded-md text-sm"></textarea>
                    <button id="importDataBtn" class="w-full bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition mt-2">
                        <i class="fas fa-check mr-1"></i> ÂåØÂÖ•Êï∏Êìö
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Settings Modal -->
        <div id="settingsModal" class="modal">
            
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3 class="text-xl font-bold mb-4">Á≥ªÁµ±Ë®≠ÂÆö</h3>
                
              <div class="mb-4">
    <h4 class="font-medium mb-2">ÂåØÁéáË®≠ÂÆö</h4>
    <div class="mb-3">
        <label class="block text-gray-700 mb-2">Âü∫Ê∫ñË≤®Âπ£</label>
        <select id="baseCurrencySelect" class="w-full p-2 border border-gray-300 rounded-md text-base">
            <option value="TWD">Êñ∞Âè∞Âπ£ (TWD)</option>
            <option value="USD">ÁæéÂÖÉ (USD)</option>
            <option value="EUR">Ê≠êÂÖÉ (EUR)</option>
            <option value="JPY">Êó•ÂÖÉ (JPY)</option>
            <option value="CNY">‰∫∫Ê∞ëÂπ£ (CNY)</option>
            <option value="HKD">Ê∏ØÂπ£ (HKD)</option>
            <option value="GBP">Ëã±Èéä (GBP)</option>
            <option value="AUD">Êæ≥ÂÖÉ (AUD)</option>
            <option value="CAD">Âä†ÊãøÂ§ßÂÖÉ (CAD)</option>
            <option value="SGD">Êñ∞Âä†Âù°ÂÖÉ (SGD)</option>
        </select>
    </div>
    
    <div class="flex items-center mb-3">
        <span class="text-gray-600">‰∏äÊ¨°Êõ¥Êñ∞: </span>
        <span id="lastRateUpdateText" class="ml-2">Êú™Êõ¥Êñ∞</span>
    </div>
    
    <button id="updateRatesBtn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition">
        <i class="fas fa-sync-alt mr-1"></i> Êõ¥Êñ∞ÂåØÁéá
    </button>
    
    <div class="mt-3">
        <div class="flex justify-between items-center mb-2">
            <h5 class="font-medium">Áï∂ÂâçÂåØÁéá</h5>
            <button id="toggleRatesBtn" class="text-primary text-sm">
                <i class="fas fa-eye"></i> È°ØÁ§∫/Èö±Ëóè
            </button>
        </div>
        <div id="exchangeRatesList" class="bg-gray-50 p-3 rounded-md text-sm hidden">
            <!-- Ê±áÁéáÊï∞ÊçÆÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
        </div>
    </div>
</div>
                
                <div class="mb-4">
                    <h4 class="font-medium mb-2">ÊÄßËÉΩË®≠ÂÆö</h4>
                    <div class="flex items-center mb-2">
                        <input type="checkbox" id="enableVirtualization" class="mr-2" checked>
                        <label for="enableVirtualization" class="text-gray-700">ÂïüÁî®Â§ßÈáèÊï∏ÊìöÂÑ™Âåñ</label>
                    </div>
                    <p class="text-sm text-gray-500">ÂïüÁî®Ê≠§ÂäüËÉΩÂèØÂÑ™ÂåñÂ§ßÈáè‰∫§ÊòìÊï∏ÊìöÁöÑÈ°ØÁ§∫ÊÄßËÉΩ</p>
                    
                    <div class="mt-3">
                        <label class="block text-gray-700 mb-2">ÊØèÈ†ÅÈ°ØÁ§∫‰∫§ÊòìÊï∏</label>
                        <select id="pageSize" class="w-full p-2 border border-gray-300 rounded-md text-base">
                            <option value="50">50Á≠Ü</option>
                            <option value="100">100Á≠Ü</option>
                            <option value="200">200Á≠Ü</option>
                            <option value="500">500Á≠Ü</option>
                            <option value="-1">ÂÖ®ÈÉ®È°ØÁ§∫</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-medium mb-2">ÈÄöÁü•Ë®≠ÂÆö</h4>
                    <div class="flex items-center mb-2">
                        <input type="checkbox" id="enableSyncReminders" class="mr-2" checked>
                        <label for="enableSyncReminders" class="text-gray-700">ÂïüÁî®Êï∏ÊìöÂêåÊ≠•ÊèêÈÜí</label>
                    </div>
                    <p class="text-sm text-gray-500">ÂÆöÊúüÊèêÈÜíÊÇ®ÂÇô‰ªΩÊï∏ÊìöÔºåÈò≤Ê≠¢Êï∏Êìö‰∏üÂ§±</p>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-medium mb-2">Â§ñËßÄË®≠ÂÆö</h4>
                    <div class="flex items-center mb-2">
                        <label for="themeSelect" class="text-gray-700 mr-2">‰∏ªÈ°å</label>
                        <select id="themeSelect" class="flex-1 p-2 border border-gray-300 rounded-md text-base">
                            <option value="system">Ë∑üÈö®Á≥ªÁµ±</option>
                            <option value="light">Ê∑∫Ëâ≤Ê®°Âºè</option>
                            <option value="dark">Ê∑±Ëâ≤Ê®°Âºè</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h4 class="font-medium mb-2">ÈÄ≤ÈöéË®≠ÂÆö</h4>
                    <div class="flex items-center mb-2 text-red-600">
                        <button id="resetAppBtn" class="bg-red-100 hover:bg-red-200 text-red-700 px-4 py-2 rounded-md transition">
                            <i class="fas fa-exclamation-triangle mr-1"></i> ÈáçÁΩÆÊáâÁî®Á®ãÂºè
                        </button>
                    </div>
                    <p class="text-sm text-red-500">Ë≠¶ÂëäÔºöÈÄôÂ∞áÂà™Èô§ÊâÄÊúâÊï∏Êìö‰∏¶Â∞áÊáâÁî®ÊÅ¢Âæ©Âà∞ÂàùÂßãÁãÄÊÖãÔºÅ</p>
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button id="saveSettingsBtn" class="bg-primary text-white px-6 py-2 rounded-md hover:bg-primary-dark transition">
                        <i class="fas fa-save mr-1"></i> ‰øùÂ≠òË®≠ÂÆö
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Receipt View Modal -->
        <div id="receiptViewModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3 class="text-xl font-bold mb-4">Êî∂ÊìöÂúñÁâá</h3>
                <div class="flex justify-center items-center">
                    <img id="receiptViewImage" class="max-w-full max-h-[70vh] rounded-lg" src="" alt="Êî∂ÊìöÂúñÁâá">
                </div>
            </div>
        </div>
        
        <!-- Daily Summary Modal -->
        <div id="dailySummaryModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h3 class="text-xl font-bold mb-4">Ââç‰∏ÄÂ§©Ê∂àË≤ªÊëòË¶Å</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="text-sm text-green-600 mb-1">Êî∂ÂÖ•Á∏ΩË®à</div>
                        <div class="text-xl font-bold text-green-700"><span id="summarySymbol3">$</span><span id="modalSummaryIncome">0.00</span></div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg">
                        <div class="text-sm text-red-600 mb-1">ÊîØÂá∫Á∏ΩË®à</div>
                        <div class="text-xl font-bold text-red-700"><span id="summarySymbol4">$</span><span id="modalSummaryExpense">0.00</span></div>
                    </div>
                </div>
                
                <h4 class="font-medium text-gray-700 mb-2">ÊîØÂá∫È°ûÂà•ÂàÜ‰Ωà</h4>
                <div id="modalSummaryCategories" class="mb-4 space-y-2">
                    <!-- È°ûÂà•ÂàÜ‰ΩàÊúÉÂú®ÈÄôË£°È°ØÁ§∫ -->
                </div>
                
                <h4 class="font-medium text-gray-700 mb-2">‰∫§ÊòìË®òÈåÑ</h4>
                <div id="modalSummaryTransactions" class="max-h-60 overflow-y-auto">
                    <!-- ‰∫§ÊòìË®òÈåÑÊúÉÂú®ÈÄôË£°È°ØÁ§∫ -->
                </div>
                
                <div class="mt-4 flex justify-end">
                    <button id="closeSummaryBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition">
                        ÈóúÈñâ
                    </button>
                </div>
            </div>
        </div>

        <!-- Notification -->
        <div id="notification" class="notification">
            <div class="p-4">
                <div class="text-center">
                    <div id="notificationIcon" class="text-4xl mb-4"></div>
                    <h3 id="notificationTitle" class="text-lg font-bold mb-2"></h3>
                    <p id="notificationMessage" class="text-gray-600 mb-4"></p>
                </div>
            </div>
        </div>
        
        <!-- Sync Reminder -->
        <div id="syncReminder">
            <div class="flex items-center">
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span>Ë´ãË®òÂæóÂêåÊ≠•/ÂÇô‰ªΩÊÇ®ÁöÑÊï∏ÊìöÔºÅ</span>
                <button id="closeSyncReminder" class="ml-3 text-white opacity-80 hover:opacity-100 text-sm">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Google API Áõ∏ÈóúÈÖçÁΩÆ
        const GOOGLE_API_CONFIG = {
            apiKey: 'AIzaSyB6Q_qkp0PowjLYXM2hGPwYGXm7RTOgPBQ', // ÈúÄË¶ÅÊõøÊèõÁÇ∫ÊÇ®ÁöÑ Google API Key
            clientId: '75969942287-bkhslov3f4mi6q8lao4ud19bnid9p14e.apps.googleusercontent.com', // ÈúÄË¶ÅÊõøÊèõÁÇ∫ÊÇ®ÁöÑ Google Client ID
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
            scopes: 'https://www.googleapis.com/auth/drive.file',
            appFolderName: 'ÈÄ≤ÈöéË≤°ÂãôËøΩËπ§Âô®',
            dataFileName: 'finance_data.json'
        };

        // Global variables to store data
        let accounts = [];
        let categories = {
            income: [],
            expense: []
        };
        let transactions = [];
        let budget = {
            amount: 0,
            cycle: 'monthly',
            resetDay: 1,
            thresholds: [80],
            lastReset: null
        };
        let categoryBudgets = [];
        let newDayStatus = {
            active: false,
            lastActivated: null
        };
        let appSettings = {
            currency: 'TWD',
            currencySymbol: '$',
            syncRemindersEnabled: true,
            lastSyncReminder: null,
            theme: 'system',
            dailySummaryTiming: 'immediate',
            enableVirtualization: true,
            pageSize: 100,
            
            // Google Drive ÂêåÊ≠•Ë®≠ÂÆö
            googleSync: {
                enabled: false,
                frequency: 'daily', // daily, weekly, monthly
                lastSync: null,
                fileId: null
            }
            
        };
        // Âú®ÂÖ®Â±ÄÂèòÈáèÂå∫ÂüüÊ∑ªÂä†ÔºàÁ∫¶1950Ë°åÂ∑¶Âè≥ÔºåÂú®appSettingsÂêéÈù¢Ôºâ
let exchangeRates = {}; // Â≠òÂÇ®Ê±áÁéáÊï∞ÊçÆ
let baseCurrency = 'TWD'; // Âü∫ÂáÜË¥ßÂ∏ÅÔºåÈªòËÆ§‰∏∫Âè∞Â∏Å
let lastRateUpdate = null; // ‰∏äÊ¨°Êõ¥Êñ∞Ê±áÁéáÁöÑÊó∂Èó¥
        let dataModified = false; // Track if data has been modified since last sync
        let paginationState = {
            currentPage: 1,
            totalPages: 1,
            pageSize: 100,
            totalItems: 0,
            currentItems: []
        };
        
        // Google Drive API ÁãÄÊÖã
        let googleApiInitialized = false;
        let googleUser = null;
        
        // Selected values
        let selectedIcon = 'üí≥';
        let selectedCategoryType = 'expense';
        let transactionType = 'expense';
        
        // Currency symbols
        const currencySymbols = {
            'TWD': '$',
            'USD': '$',
            'EUR': '‚Ç¨',
            'JPY': '¬•',
            'CNY': '¬•',
            'HKD': 'HK$',
            'GBP': '¬£',
            'AUD': 'A$',
            'CAD': 'C$',
            'SGD': 'S$'
        };
        
        // Check if localStorage is available
        let hasLocalStorage = false;
        try {
            if (typeof localStorage !== 'undefined') {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                hasLocalStorage = true;
            }
        } catch (e) {
            hasLocalStorage = false;
            console.log('localStorage not available:', e);
        }
        
        // DOM Elements
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const newAccountModal = document.getElementById('newAccountModal');
        const newCategoryModal = document.getElementById('newCategoryModal');
        const importExportModal = document.getElementById('importExportModal');
        const settingsModal = document.getElementById('settingsModal');
        const receiptViewModal = document.getElementById('receiptViewModal');
        const dailySummaryModal = document.getElementById('dailySummaryModal');
        const notification = document.getElementById('notification');
        const syncReminder = document.getElementById('syncReminder');
        const searchLoadingIndicator = document.getElementById('searchLoadingIndicator');
        
        // Debounce function for performance optimization
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }
        
        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the app
            initApp();
            
            // Setup event listeners
            setupEventListeners();
            
            // Check for dark mode
            applyTheme();
            
            // Initialize Google API
            initGoogleApi();
        });
        
        // Initialize the app
        function initApp() {
            // Load data from localStorage if available
            loadData();
            
            // Set default transaction date
            document.getElementById('transactionDate').value = getTodayFormatted();
            document.getElementById('summaryDate').value = getTodayFormatted();
            
            // Set default search dates (1 month range)
            const today = new Date();
            const monthAgo = new Date();
            monthAgo.setMonth(today.getMonth() - 1);
            
            document.getElementById('searchStartDate').value = formatDateForInput(monthAgo);
            document.getElementById('searchEndDate').value = formatDateForInput(today);
            
            // Update currency display
            updateCurrencyDisplay();
            
            // Initialize UI elements
            updateUI();
            
            // Setup budget reset day options
            updateBudgetResetDayOptions();
            
            // Initialize account icons
            initAccountIcons();
            
            // Initialize receipt upload listener
            initReceiptUpload();
            
            // Apply virtualization settings
            applyVirtualizationSettings();
            
            // Search transactions with default values
            searchTransactions();
            
            // Generate financial advice
            generateFinancialAdvice();
            
            // Check for budget reset
            checkBudgetReset();
            
            // Check new day status
            checkNewDayStatus();
            
            // Check if sync reminder should be shown
            checkSyncReminder();
            
            // Á°Æ‰øùÊÄªÈ¢ÑÁÆóÊòØÁ±ªÂà´È¢ÑÁÆóÁöÑÊÄªÂíå
updateTotalBudgetDisplay();
            
            // Setup auto-sync options
            setupAutoSync();
        }
        
        // Initialize Google API - ÂÖ®Êñ∞ÁâàÊú¨
        function initGoogleApi() {
            console.log('ÈñãÂßãÂàùÂßãÂåñ Google API...');
            
            // ÈáçÁΩÆÊåâÈàïÁãÄÊÖãÂíåÈ°ØÁ§∫Âä†Ëºâ‰∏≠
            const googleSignInBtn = document.getElementById('googleSignInBtn');
            googleSignInBtn.disabled = true;
            googleSignInBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> ËºâÂÖ•‰∏≠...';
            updateGoogleSigninStatus('pending', 'Google API Ê≠£Âú®ÂàùÂßãÂåñ...');
            
            // Ê∏ÖÈô§‰πãÂâçÁöÑË∂ÖÊôÇË®àÊôÇÂô®
            if (window.gapiInitTimeout) {
                clearTimeout(window.gapiInitTimeout);
            }
            
            // ÊúÄÂ§ßÈáçË©¶Ê¨°Êï∏ÂíåÁï∂ÂâçÈáçË©¶Ê¨°Êï∏
            const MAX_RETRIES = 2;
            let currentRetry = 0;
            
            // Ê™¢Êü•ÈÖçÁΩÆÊòØÂê¶ÊúâÊïà
            if (!GOOGLE_API_CONFIG.apiKey || GOOGLE_API_CONFIG.apiKey === 'YOUR_API_KEY' || 
                !GOOGLE_API_CONFIG.clientId || GOOGLE_API_CONFIG.clientId === 'YOUR_CLIENT_ID') {
                console.error('Google API ÈÖçÁΩÆÁº∫Â∞ë API Key Êàñ Client ID');
                updateGoogleSigninStatus('error', 'Google API ÈÖçÁΩÆÈåØË™§: ÈúÄË¶ÅÊúâÊïàÁöÑ API Key Âíå Client ID');
                googleSignInBtn.disabled = false;
                googleSignInBtn.innerHTML = '<svg class="google-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg> Ë®≠ÂÆö API Key';
                return;
            }
            
            // Ê™¢Êü• gapi ÊòØÂê¶Â∑≤ËºâÂÖ•
            if (typeof gapi === 'undefined') {
                console.error('Google API (gapi) Êú™ËºâÂÖ•');
                updateGoogleSigninStatus('error', 'Google API Êú™ËºâÂÖ•ÔºåË´ãÊ™¢Êü•Á∂≤Áµ°ÈÄ£Êé•‰∏¶ÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢');
                googleSignInBtn.disabled = false;
                googleSignInBtn.innerHTML = '<i class="fas fa-sync mr-2"></i> ÈáçË©¶ËºâÂÖ•';
                return;
            }
            
            // ÂòóË©¶ÂàùÂßãÂåñÁöÑÂáΩÊï∏
            function attemptInitialization() {
                console.log(`ÂòóË©¶ Google API ÂàùÂßãÂåñ... (ÂòóË©¶ ${currentRetry + 1}/${MAX_RETRIES + 1})`);
                
                // Ë®≠ÁΩÆË∂ÖÊôÇÂÆöÊôÇÂô®
                const timeoutId = setTimeout(() => {
                    console.warn(`Google API ÂàùÂßãÂåñË∂ÖÊôÇ (ÂòóË©¶ ${currentRetry + 1})`);
                    if (currentRetry < MAX_RETRIES) {
                        currentRetry++;
                        attemptInitialization();
                    } else {
                        updateGoogleSigninStatus('error', 'Google API ÂàùÂßãÂåñË∂ÖÊôÇÔºåË´ãÊ™¢Êü•Á∂≤Áµ°ÈÄ£Êé•‰∏¶Á®çÂæåÈáçË©¶');
                        googleSignInBtn.disabled = false;
                        googleSignInBtn.innerHTML = '<i class="fas fa-sync mr-2"></i> ÈáçË©¶ËºâÂÖ•';
                    }
                }, 10000);  // 10ÁßíË∂ÖÊôÇ
                
                try {
                    // ‰ΩøÁî®Á∞°ÂñÆÁõ¥Êé•ÁöÑÊñπÊ≥ïËºâÂÖ• client Â∫´
                    gapi.load('client:auth2', () => {
                        console.log('gapi.client:auth2 Â∑≤ËºâÂÖ•ÔºåÂàùÂßãÂåñ‰∏≠...');
                        
                        // ÂàùÂßãÂåñÂÆ¢Êà∂Á´Ø
                        gapi.client.init({
                            apiKey: GOOGLE_API_CONFIG.apiKey,
                            clientId: GOOGLE_API_CONFIG.clientId,
                            scope: GOOGLE_API_CONFIG.scopes || 'https://www.googleapis.com/auth/drive.file'
                        })
                        .then(() => {
                            clearTimeout(timeoutId);
                            console.log('Google API ÂàùÂßãÂåñÊàêÂäü');
                            
                            // Ê®ôË®òÁÇ∫Â∑≤ÂàùÂßãÂåñ
                            googleApiInitialized = true;
                            
                            // Êõ¥Êñ∞ UI ÂíåÁãÄÊÖã
                            googleSignInBtn.disabled = false;
                            googleSignInBtn.innerHTML = '<svg class="google-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg> ‰ΩøÁî® Google Â∏≥Êà∂ÁôªÂÖ•';
                            updateGoogleSigninStatus('success', 'Google API Â∑≤Ê∫ñÂÇôÂ∞±Á∑íÔºåË´ãÁôªÂÖ•');
                            
                            try {
                                // Ë®≠ÁΩÆË™çË≠âÁãÄÊÖãÁõ£ËÅΩ
                                const authInstance = gapi.auth2.getAuthInstance();
                                if (authInstance) {
                                    authInstance.isSignedIn.listen(updateSignInStatus);
                                    updateSignInStatus(authInstance.isSignedIn.get());
                                }
                                
                                // Ê™¢Êü•Ëá™ÂãïÂêåÊ≠•
                                checkAutoSync();
                            } catch (err) {
                                console.warn('Ë®≠ÁΩÆË™çË≠âÁõ£ËÅΩÂô®ÊôÇÁôºÁîüÈùûÂö¥ÈáçÈåØË™§:', err);
                                // ÈÄôË£°‰∏çÂ∞áÊï¥ÂÄãÂàùÂßãÂåñÊ®ôË®òÁÇ∫Â§±ÊïóÔºåÂõ†ÁÇ∫‰∏ªË¶ÅÂäüËÉΩÂ∑≤Á∂ìÂàùÂßãÂåñÊàêÂäü
                            }
                        })
                        .catch(error => {
                            clearTimeout(timeoutId);
                            console.error('Google API ÂàùÂßãÂåñÈåØË™§:', error);
                            
                            if (currentRetry < MAX_RETRIES) {
                                // ÈáçË©¶
                                currentRetry++;
                                console.log(`ÂàùÂßãÂåñÂ§±ÊïóÔºåÊ≠£Âú®ÈáçË©¶ (${currentRetry}/${MAX_RETRIES})...`);
                                setTimeout(() => attemptInitialization(), 1000); // Âª∂ÈÅ≤ 1 ÁßíÂæåÈáçË©¶
                            } else {
                                // ÊâÄÊúâÈáçË©¶ÈÉΩÂ§±Êïó
                                processInitError(error);
                            }
                        });
                    }, error => {
                        clearTimeout(timeoutId);
                        console.error('ÁÑ°Ê≥ïËºâÂÖ• gapi.client:auth2:', error);
                        
                        if (currentRetry < MAX_RETRIES) {
                            // ÈáçË©¶
                            currentRetry++;
                            console.log(`ËºâÂÖ•Â§±ÊïóÔºåÊ≠£Âú®ÈáçË©¶ (${currentRetry}/${MAX_RETRIES})...`);
                            setTimeout(() => attemptInitialization(), 1000); // Âª∂ÈÅ≤ 1 ÁßíÂæåÈáçË©¶
                        } else {
                            // ÊâÄÊúâÈáçË©¶ÈÉΩÂ§±Êïó
                            updateGoogleSigninStatus('error', 'ÁÑ°Ê≥ïËºâÂÖ• Google API ÂÆ¢Êà∂Á´ØÂ∫´ÔºåË´ãÁ®çÂæåÈáçË©¶');
                            googleSignInBtn.disabled = false;
                            googleSignInBtn.innerHTML = '<i class="fas fa-sync mr-2"></i> ÈáçË©¶ËºâÂÖ•';
                        }
                    });
                } catch (error) {
                    clearTimeout(timeoutId);
                    console.error('ÂàùÂßãÂåñÈÅéÁ®ã‰∏≠ÁôºÁîüÂö¥ÈáçÈåØË™§:', error);
                    
                    if (currentRetry < MAX_RETRIES) {
                        // ÈáçË©¶
                        currentRetry++;
                        console.log(`ÁôºÁîüÈåØË™§ÔºåÊ≠£Âú®ÈáçË©¶ (${currentRetry}/${MAX_RETRIES})...`);
                        setTimeout(() => attemptInitialization(), 1000); // Âª∂ÈÅ≤ 1 ÁßíÂæåÈáçË©¶
                    } else {
                        // ÊâÄÊúâÈáçË©¶ÈÉΩÂ§±Êïó
                        processInitError(error);
                    }
                }
            }
            
            // ËôïÁêÜÂàùÂßãÂåñÈåØË™§
            function processInitError(error) {
                let errorMessage = 'ÂàùÂßãÂåñÂ§±Êïó';
                
                if (error) {
                    if (error.message) {
                        if (error.message.includes('idpiframe_initialization_failed')) {
                            errorMessage = 'Á¨¨‰∏âÊñπ Cookie Ë¢´ÈòªÊ≠¢ÔºåË´ãÂú®ÁÄèË¶ΩÂô®Ë®≠ÁΩÆ‰∏≠ÂÖÅË®±';
                        } else if (error.message.includes('Missing required parameter')) {
                            errorMessage = 'API ÂèÉÊï∏ÈåØË™§ÔºåË´ãÁ¢∫Ë™ç API Key Âíå Client ID';
                        } else if (error.message.includes('Not a valid origin')) {
                            errorMessage = 'Á∂≤Á´ô‰æÜÊ∫êÊú™ÊéàÊ¨äÔºåË´ãÂú® Google Cloud Console Ê∑ªÂä†';
                        } else if (error.message.includes('disable_third_party_cookies')) {
                            errorMessage = 'ÁÄèË¶ΩÂô®Á¶ÅÊ≠¢Á¨¨‰∏âÊñπ CookieÔºåË´ãÂú®Ë®≠ÁΩÆ‰∏≠ÂÖÅË®±';
                        } else if (error.message.includes('network') || error.message.includes('Failed to fetch')) {
                            errorMessage = 'Á∂≤Áµ°ÈÄ£Êé•ÈåØË™§ÔºåË´ãÊ™¢Êü•Á∂≤Áµ°';
                        } else if (error.message.includes('The API key or OAuth client is restricted')) {
                            errorMessage = 'API Key ‰ΩøÁî®ÂèóÈôêÔºåË´ãÁ¢∫Ë™çÂüüÂêçÈôêÂà∂Ë®≠ÁΩÆ';
                        }
                    }
                }
                
                updateGoogleSigninStatus('error', `Google API ÂàùÂßãÂåñÂ§±Êïó: ${errorMessage}`);
                googleSignInBtn.disabled = false;
                googleSignInBtn.innerHTML = '<i class="fas fa-sync mr-2"></i> ÈáçË©¶ËºâÂÖ•';
                
                // È°ØÁ§∫Êõ¥Ë©≥Á¥∞ÁöÑÈåØË™§ÈÄöÁü•Ôºå‰ΩÜ‰øùÊåÅÁ∞°ÊΩî
                notify('‚ùå', 'ÂàùÂßãÂåñÂ§±Êïó', `Google API ÂàùÂßãÂåñÂ§±Êïó: ${errorMessage}`);
            }
            
            // ÈñãÂßãÁ¨¨‰∏ÄÊ¨°ÂòóË©¶ÂàùÂßãÂåñ
            attemptInitialization();
        }
        
        // Update sign-in status
        function updateSignInStatus(isSignedIn) {
            if (isSignedIn) {
                const user = gapi.auth2.getAuthInstance().currentUser.get();
                const profile = user.getBasicProfile();
                googleUser = {
                    id: profile.getId(),
                    name: profile.getName(),
                    email: profile.getEmail()
                };
                
                // Update UI
                document.getElementById('googleAuthStatus').style.display = 'flex';
                document.getElementById('googleUserName').textContent = googleUser.name;
                document.getElementById('googleSignInBtn').style.display = 'none';
                document.getElementById('googleSignOutBtn').style.display = 'block';
                document.getElementById('googleDriveActions').style.display = 'block';
                
                updateGoogleSigninStatus('success', `Â∑≤ÁôªÂÖ•ÁÇ∫ ${googleUser.name}`);
            } else {
                googleUser = null;
                
                // Update UI
                document.getElementById('googleAuthStatus').style.display = 'none';
                document.getElementById('googleSignInBtn').style.display = 'block';
                document.getElementById('googleSignOutBtn').style.display = 'none';
                document.getElementById('googleDriveActions').style.display = 'none';
                
                updateGoogleSigninStatus('pending', 'Â∞öÊú™ÁôªÂÖ• Google Â∏≥Êà∂');
            }
        }
        
        // Sign in to Google
        function signInToGoogle() {
            if (!googleApiInitialized) {
                notify('‚ùå', 'Google API Â∞öÊú™ÂàùÂßãÂåñ', 'Ë´ãÁ®çÂæåÂÜçË©¶');
                return;
            }
            
            gapi.auth2.getAuthInstance().signIn().catch(error => {
                console.error('Google Sign-in error:', error);
                notify('‚ùå', 'ÁôªÂÖ•Â§±Êïó', 'ÁÑ°Ê≥ïÁôªÂÖ•Âà∞ Google Â∏≥Êà∂');
            });
        }
        
        // Sign out from Google
        function signOutFromGoogle() {
            if (!googleApiInitialized) return;
            
            gapi.auth2.getAuthInstance().signOut().then(() => {
                notify('‚úÖ', 'Â∑≤ÁôªÂá∫', 'Â∑≤ÊàêÂäüÁôªÂá∫ Google Â∏≥Êà∂');
            }).catch(error => {
                console.error('Google Sign-out error:', error);
            });
        }
        
        // Update Google signin status in the import/export modal
        function updateGoogleSigninStatus(type, message) {
            const statusElement = document.getElementById('googleSigninStatus');
            statusElement.style.display = 'flex';
            statusElement.className = `sync-status ${type}`;
            
            let icon = 'fa-circle-info';
            if (type === 'success') icon = 'fa-check-circle';
            if (type === 'error') icon = 'fa-times-circle';
            
            statusElement.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
        }
        
        // Save data to Google Drive
        function saveToGoogleDrive() {
            if (!googleUser) {
                notify('‚ùå', 'Â∞öÊú™ÁôªÂÖ•', 'Ë´ãÂÖàÁôªÂÖ• Google Â∏≥Êà∂');
                return;
            }
            
            updateGoogleSigninStatus('pending', 'Ê≠£Âú®‰øùÂ≠òÂà∞ Google Drive...');
            
            // First, check if our app folder exists
            findOrCreateAppFolder().then(folderId => {
                // Get the data to save
                const data = exportData();
                
                // Check if we already have a file ID
                if (appSettings.googleSync.fileId) {
                    // Update existing file
                    updateDriveFile(appSettings.googleSync.fileId, data).then(() => {
                        appSettings.googleSync.lastSync = new Date().toISOString();
                        saveData('appSettings');
                        updateGoogleSigninStatus('success', 'Êï∏ÊìöÂ∑≤ÊàêÂäü‰øùÂ≠òÂà∞ Google Drive');
                        notify('‚úÖ', 'ÂêåÊ≠•ÊàêÂäü', 'Êï∏ÊìöÂ∑≤ÊàêÂäü‰øùÂ≠òÂà∞ Google Drive');
                    }).catch(error => {
                        console.error('Error updating file:', error);
                        updateGoogleSigninStatus('error', '‰øùÂ≠òÂ§±ÊïóÔºåÊ≠£Âú®ÂòóË©¶ÂâµÂª∫Êñ∞Êñá‰ª∂...');
                        
                        // Try creating a new file instead
                        createDriveFile(folderId, data);
                    });
                } else {
                    // Create new file
                    createDriveFile(folderId, data);
                }
            }).catch(error => {
                console.error('Error with Google Drive folder:', error);
                updateGoogleSigninStatus('error', 'ÁÑ°Ê≥ïË®™ÂïèÊàñÂâµÂª∫ Google Drive Êñá‰ª∂Â§æ');
                notify('‚ùå', 'ÂêåÊ≠•Â§±Êïó', 'ÁÑ°Ê≥ïË®™ÂïèÊàñÂâµÂª∫ Google Drive Êñá‰ª∂Â§æ');
            });
        }
        
        // Find or create app folder in Google Drive
        function findOrCreateAppFolder() {
            return new Promise((resolve, reject) => {
                // Search for existing folder
                gapi.client.drive.files.list({
                    q: `name='${GOOGLE_API_CONFIG.appFolderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                    spaces: 'drive',
                    fields: 'files(id, name)'
                }).then(response => {
                    const folders = response.result.files;
                    
                    if (folders && folders.length > 0) {
                        // Folder found
                        resolve(folders[0].id);
                    } else {
                        // Create folder
                        gapi.client.drive.files.create({
                            resource: {
                                name: GOOGLE_API_CONFIG.appFolderName,
                                mimeType: 'application/vnd.google-apps.folder'
                            },
                            fields: 'id'
                        }).then(response => {
                            resolve(response.result.id);
                        }).catch(error => {
                            reject(error);
                        });
                    }
                }).catch(error => {
                    reject(error);
                });
            });
        }
        
        // Create a new file in Google Drive
        function createDriveFile(folderId, data) {
            const file = new Blob([data], {type: 'application/json'});
            const metadata = {
                name: GOOGLE_API_CONFIG.dataFileName,
                mimeType: 'application/json',
                parents: [folderId]
            };
            
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
            form.append('file', file);
            
            fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({
                    'Authorization': 'Bearer ' + gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token
                }),
                body: form
            }).then(response => response.json())
              .then(result => {
                  appSettings.googleSync.fileId = result.id;
                  appSettings.googleSync.lastSync = new Date().toISOString();
                  saveData('appSettings');
                  
                  updateGoogleSigninStatus('success', 'Êï∏ÊìöÂ∑≤ÊàêÂäü‰øùÂ≠òÂà∞ Google Drive');
                  notify('‚úÖ', 'ÂêåÊ≠•ÊàêÂäü', 'Êï∏ÊìöÂ∑≤ÊàêÂäü‰øùÂ≠òÂà∞ Google Drive');
              })
              .catch(error => {
                  console.error('Error creating file:', error);
                  updateGoogleSigninStatus('error', 'ÂâµÂª∫Êñá‰ª∂Â§±Êïó');
                  notify('‚ùå', 'ÂêåÊ≠•Â§±Êïó', 'ÁÑ°Ê≥ïÂú® Google Drive ‰∏≠ÂâµÂª∫Êñá‰ª∂');
              });
        }
        
        // Update existing file in Google Drive
        function updateDriveFile(fileId, data) {
            return new Promise((resolve, reject) => {
                const file = new Blob([data], {type: 'application/json'});
                
                fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                    method: 'PATCH',
                    headers: new Headers({
                        'Authorization': 'Bearer ' + gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token,
                        'Content-Type': 'application/json'
                    }),
                    body: file
                }).then(response => {
                    if (response.ok) {
                        resolve();
                    } else {
                        reject(new Error('Failed to update file'));
                    }
                }).catch(error => {
                    reject(error);
                });
            });
        }
        
        // Load data from Google Drive
        function loadFromGoogleDrive() {
            if (!googleUser) {
                notify('‚ùå', 'Â∞öÊú™ÁôªÂÖ•', 'Ë´ãÂÖàÁôªÂÖ• Google Â∏≥Êà∂');
                return;
            }
            
            updateGoogleSigninStatus('pending', 'Ê≠£Âú®Âæû Google Drive ËºâÂÖ•Êï∏Êìö...');
            
            // Check if we have a file ID
            if (appSettings.googleSync.fileId) {
                // Get file content
                gapi.client.drive.files.get({
                    fileId: appSettings.googleSync.fileId,
                    alt: 'media'
                }).then(response => {
                    const data = response.body;
                    
                    // Import the data
                    if (importData(data)) {
                        updateGoogleSigninStatus('success', 'Êï∏ÊìöÂ∑≤ÊàêÂäüÂæû Google Drive ËºâÂÖ•');
                        notify('‚úÖ', 'ÂêåÊ≠•ÊàêÂäü', 'Êï∏ÊìöÂ∑≤ÊàêÂäüÂæû Google Drive ËºâÂÖ•');
                    } else {
                        updateGoogleSigninStatus('error', 'ËºâÂÖ•ÁöÑÊï∏ÊìöÊ†ºÂºè‰∏çÊ≠£Á¢∫');
                    }
                }).catch(error => {
                    console.error('Error loading file:', error);
                    updateGoogleSigninStatus('error', 'ÁÑ°Ê≥ïËºâÂÖ•Êñá‰ª∂ÔºåÂèØËÉΩÂ∑≤Ë¢´Âà™Èô§');
                    
                    // Clear file ID since it's no longer valid
                    appSettings.googleSync.fileId = null;
                    saveData('appSettings');
                    
                    // Try finding the file
                    findFileInDrive();
                });
            } else {
                // Find the file in Drive
                findFileInDrive();
            }
        }
        
        // Find file in Google Drive
        function findFileInDrive() {
            findOrCreateAppFolder().then(folderId => {
                gapi.client.drive.files.list({
                    q: `name='${GOOGLE_API_CONFIG.dataFileName}' and '${folderId}' in parents and trashed=false`,
                    spaces: 'drive',
                    fields: 'files(id, name, modifiedTime)'
                }).then(response => {
                    const files = response.result.files;
                    
                    if (files && files.length > 0) {
                        // Sort files by modified time (newest first)
                        files.sort((a, b) => new Date(b.modifiedTime) - new Date(a.modifiedTime));
                        
                        // Get the most recent file
                        const fileId = files[0].id;
                        appSettings.googleSync.fileId = fileId;
                        saveData('appSettings');
                        
                        // Load the file
                        gapi.client.drive.files.get({
                            fileId: fileId,
                            alt: 'media'
                        }).then(response => {
                            const data = response.body;
                            
                            // Import the data
                            if (importData(data)) {
                                updateGoogleSigninStatus('success', 'Êï∏ÊìöÂ∑≤ÊàêÂäüÂæû Google Drive ËºâÂÖ•');
                                notify('‚úÖ', 'ÂêåÊ≠•ÊàêÂäü', 'Êï∏ÊìöÂ∑≤ÊàêÂäüÂæû Google Drive ËºâÂÖ•');
                            } else {
                                updateGoogleSigninStatus('error', 'ËºâÂÖ•ÁöÑÊï∏ÊìöÊ†ºÂºè‰∏çÊ≠£Á¢∫');
                            }
                        }).catch(error => {
                            console.error('Error loading file:', error);
                            updateGoogleSigninStatus('error', 'ÁÑ°Ê≥ïËºâÂÖ•Êñá‰ª∂');
                            notify('‚ùå', 'ÂêåÊ≠•Â§±Êïó', 'ÁÑ°Ê≥ïËºâÂÖ• Google Drive Êñá‰ª∂');
                        });
                    } else {
                        updateGoogleSigninStatus('error', 'Âú® Google Drive ‰∏≠Êâæ‰∏çÂà∞Êï∏ÊìöÊñá‰ª∂');
                        notify('‚ÑπÔ∏è', 'Êâæ‰∏çÂà∞Êï∏Êìö', 'Âú® Google Drive ‰∏≠Êâæ‰∏çÂà∞Êï∏ÊìöÊñá‰ª∂');
                    }
                }).catch(error => {
                    console.error('Error listing files:', error);
                    updateGoogleSigninStatus('error', 'ÁÑ°Ê≥ïÂàóÂá∫ Google Drive Êñá‰ª∂');
                    notify('‚ùå', 'ÂêåÊ≠•Â§±Êïó', 'ÁÑ°Ê≥ïÂàóÂá∫ Google Drive Êñá‰ª∂');
                });
            }).catch(error => {
                console.error('Error finding folder:', error);
                updateGoogleSigninStatus('error', 'ÁÑ°Ê≥ïË®™Âïè Google Drive Êñá‰ª∂Â§æ');
                notify('‚ùå', 'ÂêåÊ≠•Â§±Êïó', 'ÁÑ°Ê≥ïË®™Âïè Google Drive Êñá‰ª∂Â§æ');
            });
        }
        
        // Setup auto-sync
        function setupAutoSync() {
            const enableAutoSync = document.getElementById('enableAutoSync');
            const autoSyncOptions = document.getElementById('autoSyncOptions');
            
            // Set initial state
            enableAutoSync.checked = appSettings.googleSync.enabled;
            autoSyncOptions.style.display = enableAutoSync.checked ? 'block' : 'none';
            
            // Set frequency
            const frequency = appSettings.googleSync.frequency || 'daily';
            document.getElementById(`autoSync${frequency.charAt(0).toUpperCase() + frequency.slice(1)}`).checked = true;
            
            // Add event listeners
            enableAutoSync.addEventListener('change', function() {
                autoSyncOptions.style.display = this.checked ? 'block' : 'none';
                appSettings.googleSync.enabled = this.checked;
                saveData('appSettings');
            });
            
            // Add event listeners for frequency options
            document.querySelectorAll('input[name="autoSyncFreq"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    appSettings.googleSync.frequency = this.value;
                    saveData('appSettings');
                });
            });
        }
        
        // Check for auto-sync
        function checkAutoSync() {
            if (!googleApiInitialized || !googleUser || !appSettings.googleSync.enabled) return;
            
            const now = new Date();
            const lastSync = appSettings.googleSync.lastSync ? new Date(appSettings.googleSync.lastSync) : null;
            
            // If never synced, sync now
            if (!lastSync) {
                saveToGoogleDrive();
                return;
            }
            
            let shouldSync = false;
            const daysDiff = (now - lastSync) / (1000 * 60 * 60 * 24);
            
            switch (appSettings.googleSync.frequency) {
                case 'daily':
                    shouldSync = daysDiff >= 1;
                    break;
                case 'weekly':
                    shouldSync = daysDiff >= 7;
                    break;
                case 'monthly':
                    shouldSync = daysDiff >= 30;
                    break;
            }
            
            if (shouldSync && dataModified) {
                saveToGoogleDrive();
            }
        }
        
        // Apply virtualization settings
        function applyVirtualizationSettings() {
            paginationState.pageSize = parseInt(appSettings.pageSize) || 100;
            document.getElementById('pageSize').value = paginationState.pageSize === -1 ? "-1" : paginationState.pageSize.toString();
            document.getElementById('enableVirtualization').checked = appSettings.enableVirtualization;
        }
        
        // Load data from localStorage or initialize defaults
        function loadData() {
            if (hasLocalStorage) {
                try {
                    const storedAccounts = localStorage.getItem('finance_accounts');
                    accounts = storedAccounts ? JSON.parse(storedAccounts) : [];
                    
                    const storedCategories = localStorage.getItem('finance_categories');
                    categories = storedCategories ? JSON.parse(storedCategories) : { income: [], expense: [] };
                    
                    const storedTransactions = localStorage.getItem('finance_transactions');
                    transactions = storedTransactions ? JSON.parse(storedTransactions) : [];
                    
                    const storedBudget = localStorage.getItem('finance_budget');
                    budget = storedBudget ? JSON.parse(storedBudget) : budget;
                    
                    const storedCategoryBudgets = localStorage.getItem('finance_category_budgets');
                    categoryBudgets = storedCategoryBudgets ? JSON.parse(storedCategoryBudgets) : [];
                    
                    const storedNewDayStatus = localStorage.getItem('finance_new_day_status');
                    newDayStatus = storedNewDayStatus ? JSON.parse(storedNewDayStatus) : newDayStatus;
                    
                    const storedAppSettings = localStorage.getItem('finance_app_settings');
                    if (storedAppSettings) {
                        appSettings = {...appSettings, ...JSON.parse(storedAppSettings)};
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                    initDefaultData();
                }
            } else {
                initDefaultData();
            }
            
            // If no accounts exist, add a default one
            if (accounts.length === 0) {
                accounts.push({
                    id: generateId(),
                    name: 'ÁèæÈáë',
                    balance: 0,
                    icon: 'üíµ',
                    currency: 'TWD' // Add default currency
                });
                saveData('accounts');
            }
            
            // Add currency property to existing accounts if missing
            let accountsUpdated = false;
            accounts.forEach(account => {
                if (!account.currency) {
                    account.currency = appSettings.currency || 'TWD';
                    accountsUpdated = true;
                }
            });
            
            if (accountsUpdated) {
                saveData('accounts');
            }
            
            // Initialize default categories if empty
            initDefaultCategories();
            
            // Ensure budget.thresholds exists
            if (!budget.thresholds || !Array.isArray(budget.thresholds)) {
                budget.thresholds = [80];
                saveData('budget');
            }
            
            // Ensure proper structures for receipt images
            transactions.forEach(transaction => {
                if (transaction.receipt && typeof transaction.receipt === 'string') {
                    // Convert string receipts to proper receipt object format
                    transaction.receipt = {
                        data: transaction.receipt,
                        type: 'image/jpeg' // Default type
                    };
                }
            });
            saveData('transactions');
            
                // Âä†ËΩΩÊ±áÁéáÊï∞ÊçÆ
    if (hasLocalStorage) {
        try {
            const storedRates = localStorage.getItem('finance_exchange_rates');
            const storedRateUpdate = localStorage.getItem('finance_rate_update');
            
            if (storedRates) {
                exchangeRates = JSON.parse(storedRates);
                lastRateUpdate = storedRateUpdate;
            } else {
                // ËÆæÁΩÆÈªòËÆ§Ê±áÁéá
                setDefaultExchangeRates();
            }
        } catch (error) {
            console.error('Error loading exchange rates:', error);
            setDefaultExchangeRates();
        }
    } else {
        setDefaultExchangeRates();
    }
    
    // ËÆæÁΩÆÂü∫ÂáÜË¥ßÂ∏ÅÔºà‰ΩøÁî®Â∫îÁî®ËÆæÁΩÆ‰∏≠ÁöÑÈªòËÆ§Ë¥ßÂ∏ÅÔºâ
    baseCurrency = appSettings.currency;
    
    // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞Ê±áÁéáÔºàË∂ÖËøá24Â∞èÊó∂Ôºâ
    checkExchangeRatesUpdate();
}

// Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞Ê±áÁéá
function checkExchangeRatesUpdate() {
    if (!lastRateUpdate) {
        // ‰ªéÊú™Êõ¥Êñ∞ËøáÔºåÁ´ãÂç≥Êõ¥Êñ∞
        fetchExchangeRates();
        return;
    }
    
    const now = new Date();
    const lastUpdate = new Date(lastRateUpdate);
    const hoursDiff = (now - lastUpdate) / (1000 * 60 * 60);
    
    // Â¶ÇÊûúË∂ÖËøá24Â∞èÊó∂ÔºåÊõ¥Êñ∞Ê±áÁéá
    if (hoursDiff >= 24) {
        fetchExchangeRates();
    }
        }
        
        // Save data to localStorage
        function saveData(dataType) {
            if (!hasLocalStorage) return;
            
            try {
                switch (dataType) {
                    case 'accounts':
                        localStorage.setItem('finance_accounts', JSON.stringify(accounts));
                        break;
                    case 'categories':
                        localStorage.setItem('finance_categories', JSON.stringify(categories));
                        break;
                    case 'transactions':
                        localStorage.setItem('finance_transactions', JSON.stringify(transactions));
                        break;
                    case 'budget':
                        localStorage.setItem('finance_budget', JSON.stringify(budget));
                        break;
                    case 'categoryBudgets':
                        localStorage.setItem('finance_category_budgets', JSON.stringify(categoryBudgets));
                        break;
                    case 'newDayStatus':
                        localStorage.setItem('finance_new_day_status', JSON.stringify(newDayStatus));
                        break;
                    case 'appSettings':
                        localStorage.setItem('finance_app_settings', JSON.stringify(appSettings));
                        break;
                    default:
                        // Save all
                        localStorage.setItem('finance_accounts', JSON.stringify(accounts));
                        localStorage.setItem('finance_categories', JSON.stringify(categories));
                        localStorage.setItem('finance_transactions', JSON.stringify(transactions));
                        localStorage.setItem('finance_budget', JSON.stringify(budget));
                        localStorage.setItem('finance_category_budgets', JSON.stringify(categoryBudgets));
                        localStorage.setItem('finance_new_day_status', JSON.stringify(newDayStatus));
                        localStorage.setItem('finance_app_settings', JSON.stringify(appSettings));
                }
                
                // Mark data as modified
                dataModified = true;
                
                // Auto-sync if enabled
                if (appSettings.googleSync.enabled && googleApiInitialized && googleUser) {
                    // Debounced sync to avoid too many API calls
                    if (window.autoSyncTimeout) clearTimeout(window.autoSyncTimeout);
                    window.autoSyncTimeout = setTimeout(() => {
                        saveToGoogleDrive();
                    }, 5000); // Sync after 5 seconds of inactivity
                }
            } catch (error) {
                console.error('Error saving data:', error);
            }
        }
        
        // Initialize default data
        function initDefaultData() {
            // Reset to defaults
            accounts = [{
                id: generateId(),
                name: 'ÁèæÈáë',
                balance: 0,
                icon: 'üíµ',
                currency: 'TWD'
            }];
            
            categories = {
                income: ['Ëñ™Ë≥á', 'ÁçéÈáë', 'ÊäïË≥áÊî∂Áõä', 'Á¶ÆÈáë', 'ÂÖ∂‰ªñÊî∂ÂÖ•'],
                expense: ['È£≤È£ü', 'Â®õÊ®Ç', 'ËªäË≥á', 'Êó•Áî®', 'ÂÑ≤Èå¢', 'Èõª‰ø°', 'ÂÆ∂Áî®', 'ÊáâÊÄ•', 'Â§ßÈô∏', 'ÈÇÑÊ¨æ']
            };
            
            transactions = [];
            
            budget = {
                amount: 0,
                cycle: 'monthly',
                resetDay: 1,
                thresholds: [80],
                lastReset: null
            };
            
            categoryBudgets = [];
            
            newDayStatus = {
                active: false,
                lastActivated: null
            };
            
            appSettings = {
                currency: 'TWD',
                currencySymbol: '$',
                syncRemindersEnabled: true,
                lastSyncReminder: null,
                theme: 'system',
                dailySummaryTiming: 'immediate',
                enableVirtualization: true,
                pageSize: 100,
                googleSync: {
                    enabled: false,
                    frequency: 'daily',
                    lastSync: null,
                    fileId: null
                }
            };
        }
        
        // Initialize default categories
        function initDefaultCategories() {
            if (!categories.income || categories.income.length === 0) {
                categories.income = ['Ëñ™Ë≥á', 'ÁçéÈáë', 'ÊäïË≥áÊî∂Áõä', 'Á¶ÆÈáë', 'ÂÖ∂‰ªñÊî∂ÂÖ•'];
            }
            
            if (!categories.expense || categories.expense.length === 0) {
                categories.expense = ['È£≤È£ü', 'Â®õÊ®Ç', 'ËªäË≥á', 'Êó•Áî®', 'ÂÑ≤Èå¢', 'Èõª‰ø°', 'ÂÆ∂Áî®', 'ÊáâÊÄ•', 'Â§ßÈô∏', 'ÈÇÑÊ¨æ'];
            }
            
            saveData('categories');
        }
        
        // Export data to JSON string
        function exportData() {
            const exportData = {
                accounts: accounts,
                categories: categories,
                transactions: transactions,
                budget: budget,
                categoryBudgets: categoryBudgets,
                newDayStatus: newDayStatus,
                appSettings: appSettings,
                exportDate: new Date().toISOString(),
                version: '2.1.0'
            };
            
            // Mark data as synced
            dataModified = false;
            appSettings.lastSyncReminder = new Date().toISOString();
            saveData('appSettings');
            
            return JSON.stringify(exportData, null, 2);
        }
        
        // Import data from JSON string
        function importData(jsonString) {
            try {
                const importedData = JSON.parse(jsonString);
                
                // Validate required data structures
                if (!importedData.accounts || !Array.isArray(importedData.accounts) ||
                    !importedData.categories || !importedData.categories.income || !importedData.categories.expense ||
                    !importedData.transactions || !Array.isArray(importedData.transactions)) {
                    throw new Error('ÂåØÂÖ•ÁöÑÊï∏ÊìöÊ†ºÂºè‰∏çÊ≠£Á¢∫');
                }
                
                // Import data
                accounts = importedData.accounts;
                categories = importedData.categories;
                transactions = importedData.transactions;
                budget = importedData.budget || budget;
                categoryBudgets = importedData.categoryBudgets || [];
                newDayStatus = importedData.newDayStatus || newDayStatus;
                
                // Merge appSettings to maintain current settings like theme
                if (importedData.appSettings) {
                    // Preserve Google Drive settings
                    const googleSync = appSettings.googleSync;
                    appSettings = {...appSettings, ...importedData.appSettings};
                    appSettings.googleSync = googleSync;
                }
                
                // Add currency to accounts if missing
                accounts.forEach(account => {
                    if (!account.currency) {
                        account.currency = appSettings.currency || 'TWD';
                    }
                });
                
                // Ensure proper structures for receipt images
                transactions.forEach(transaction => {
                    if (transaction.receipt && typeof transaction.receipt === 'string') {
                        transaction.receipt = {
                            data: transaction.receipt,
                            type: 'image/jpeg'
                        };
                    }
                });
                
                // Save all data
                saveData();
                
                // Update currency display
                updateCurrencyDisplay();
                
                // Apply virtualization settings
                applyVirtualizationSettings();
                
                // Update UI
                updateUI();
                searchTransactions();
                generateFinancialAdvice();
                
                // Mark data as synced
                dataModified = false;
                appSettings.lastSyncReminder = new Date().toISOString();
                saveData('appSettings');
                
                return true;
            } catch (error) {
                console.error('Import error:', error);
                notify('‚ùå', 'ÂåØÂÖ•Â§±Êïó', 'ÂåØÂÖ•ÁöÑÊï∏ÊìöÊ†ºÂºè‰∏çÊ≠£Á¢∫');
                return false;
            }
        }
        
        // Check if budget needs to be reset
        function checkBudgetReset() {
            if (!budget.lastReset || !budget.amount) return;
            
            const now = new Date();
            const lastReset = new Date(budget.lastReset);
            let shouldReset = false;
            
            switch (budget.cycle) {
                case 'daily':
                    // Reset if it's a new day
                    shouldReset = now.getDate() !== lastReset.getDate() || 
                                now.getMonth() !== lastReset.getMonth() || 
                                now.getFullYear() !== lastReset.getFullYear();
                    break;
                case 'weekly':
                    // Reset if it's the reset day of the week and a week has passed
                    const dayIndex = ['ÈÄ±Êó•', 'ÈÄ±‰∏Ä', 'ÈÄ±‰∫å', 'ÈÄ±‰∏â', 'ÈÄ±Âõõ', 'ÈÄ±‰∫î', 'ÈÄ±ÂÖ≠'].indexOf(budget.resetDay);
                    if (dayIndex === now.getDay()) {
                        const dayDiff = (now - lastReset) / (1000 * 60 * 60 * 24);
                        shouldReset = dayDiff >= 7;
                    }
                    break;
                case 'monthly':
                    // Reset if it's the reset day of the month
                    shouldReset = now.getDate() === parseInt(budget.resetDay) && 
                                (now.getMonth() !== lastReset.getMonth() || now.getFullYear() !== lastReset.getFullYear());
                    break;
            }
            
            if (shouldReset) {
                budget.lastReset = now.toISOString();
                saveData('budget');
                notify('üîÑ', 'È†êÁÆóÂ∑≤ÈáçË®≠', 'ÊÇ®ÁöÑÈ†êÁÆóÂ∑≤Ê†πÊìöË®≠ÂÆöÁöÑÈÄ±ÊúüÈáçË®≠„ÄÇ');
            }
        }
        
        // Check new day status
        function checkNewDayStatus() {
            if (!newDayStatus.lastActivated) return;
            
            const now = new Date();
            const lastActivated = new Date(newDayStatus.lastActivated);
            
            // If it's a new calendar day, reset the new day status
            if (now.getDate() !== lastActivated.getDate() || 
                now.getMonth() !== lastActivated.getMonth() || 
                now.getFullYear() !== lastActivated.getFullYear()) {
                newDayStatus.active = false;
                saveData('newDayStatus');
            }
        }
        
        // Start a new day
        function startNewDay() {
            // Get yesterday's date
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayFormatted = formatDateForInput(yesterday);
            
            // Set new day status
            newDayStatus.active = true;
            newDayStatus.lastActivated = new Date().toISOString();
            saveData('newDayStatus');
            
            notify('üåÖ', 'Êñ∞ÁöÑ‰∏ÄÂ§©Â∑≤ÈñãÂßã', 'ÂæûÁèæÂú®ÈñãÂßãÔºåÊâÄÊúâ‰∫§ÊòìÂ∞áË®òÈåÑÁÇ∫‰ªäÂ§©ÁöÑÊó•Êúü„ÄÇ');
            
            // Check if we should show daily summary
            if (appSettings.dailySummaryTiming === 'immediate') {
                showDailySummary(yesterdayFormatted);
            }
        }
        
        // Check if sync reminder should be shown
        function checkSyncReminder() {
            if (!appSettings.syncRemindersEnabled) {
                syncReminder.style.display = 'none';
                return;
            }
            
            // Show reminder if data modified and last reminder was more than 3 days ago
            const now = new Date();
            const lastReminder = appSettings.lastSyncReminder ? new Date(appSettings.lastSyncReminder) : null;
            
            if (dataModified && (!lastReminder || ((now - lastReminder) / (1000 * 60 * 60 * 24) >= 3))) {
                syncReminder.style.display = 'block';
            } else {
                syncReminder.style.display = 'none';
            }
        }
        
        // Update currency display
        function updateCurrencyDisplay() {
            // Update currency symbol in header
            document.getElementById('selectedCurrency').textContent = appSettings.currency;
            
            // Update all currency symbols in the UI
            const currencyElements = document.querySelectorAll('[id^="currencySymbol"]');
            currencyElements.forEach(element => {
                element.textContent = appSettings.currencySymbol;
            });
            
            // Update currency symbols in summary modal
            const summarySymbols = document.querySelectorAll('[id^="summarySymbol"]');
            summarySymbols.forEach(element => {
                element.textContent = appSettings.currencySymbol;
            });
        }
        
        // Initialize receipt upload
        function initReceiptUpload() {
            const enableReceiptUpload = document.getElementById('enableReceiptUpload');
            const receiptUploadContainer = document.getElementById('receiptUploadContainer');
            const receiptImage = document.getElementById('receiptImage');
            const receiptPreview = document.getElementById('receiptPreview');
            
            // Toggle receipt upload container
            enableReceiptUpload.addEventListener('change', function() {
                receiptUploadContainer.style.display = this.checked ? 'block' : 'none';
                if (!this.checked) {
                    receiptImage.value = '';
                    receiptPreview.style.display = 'none';
                }
            });
            
            // Preview uploaded image
            receiptImage.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) {
                    receiptPreview.style.display = 'none';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    receiptPreview.src = event.target.result;
                    receiptPreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            });
        }
        
        // Update the UI with current data
        function updateUI() {
            // Update dashboard
            updateDashboard();
            
            // Update accounts tab
            updateAccountsTab();
            
            // Update transaction categories
            updateTransactionCategories();
            
            // Update category budget dropdown
            updateCategoryBudgetDropdown();
            
            // Update category budget items
            updateCategoryBudgetItems();
            
            // Update statistics categories
            updateStatisticsCategories();
            
            // Update account dropdowns
            updateAccountDropdowns();
            
            // Update budget status
            updateBudgetStatus();
            
            // Êõ¥Êñ∞ÊÄªÈ¢ÑÁÆóÊòæÁ§∫
updateTotalBudgetDisplay();
            
            // Update budget thresholds
            updateBudgetThresholds();
            
            // Update categories management
            updateCategoriesManagement();
            
            // Update daily summary timing select
            document.getElementById('dailySummaryTiming').value = appSettings.dailySummaryTiming;
            
            // Update settings modal
            updateSettingsModal();
        }
        
        // Update dashboard with current data
        function updateDashboard() {
            
            // Êõ¥Êñ∞ÊÄª‰ΩôÈ¢ùÔºåÊòæÁ§∫Âü∫ÂáÜË¥ßÂ∏ÅÁ¨¶Âè∑
    const currencySymbol = currencySymbols[baseCurrency] || appSettings.currencySymbol;
    document.getElementById('totalBalance').textContent = formatNumber(getTotalBalance());
    document.getElementById('selectedCurrency').textContent = baseCurrency;
    
    // ÊòæÁ§∫‰ªäÊó•Êî∂ÂÖ•/ÊîØÂá∫ÔºàÂ∑≤ÁªèÊåâË¥¶Êà∑Ë¥ßÂ∏ÅÊòæÁ§∫ÔºåÊó†ÈúÄ‰øÆÊîπÔºâ
    document.getElementById('todayIncome').textContent = formatNumber(getTodayIncome());
    document.getElementById('todayExpense').textContent = formatNumber(getTodayExpense());
            
            // Update total balance
            document.getElementById('totalBalance').textContent = formatNumber(getTotalBalance());
            
            // Update today income/expense
            document.getElementById('todayIncome').textContent = formatNumber(getTodayIncome());
            document.getElementById('todayExpense').textContent = formatNumber(getTodayExpense());
            
            // Update today transactions
            updateTodayTransactions();
            
            // Update recent transactions
            updateRecentTransactions();
            
            // Update category budgets on dashboard
            updateCategoryBudgetsOnDashboard();
        }
        
        // Update today's transactions on dashboard
        function updateTodayTransactions() {
            const todayTransactions = getTodayTransactions();
            const todayTransactionsEmpty = document.getElementById('todayTransactionsEmpty');
            const todayTransactionsTable = document.getElementById('todayTransactionsTable');
            const todayTransactionsList = document.getElementById('todayTransactionsList');
            
            if (todayTransactions.length === 0) {
                todayTransactionsEmpty.style.display = 'block';
                todayTransactionsTable.style.display = 'none';
                return;
            }
            
            todayTransactionsEmpty.style.display = 'none';
            todayTransactionsTable.style.display = 'block';
            
            // Clear previous content
            todayTransactionsList.innerHTML = '';
            
            // Add each transaction
            todayTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                
                // Type
                const typeCell = document.createElement('td');
                typeCell.className = 'px-6 py-4 whitespace-nowrap';
                typeCell.textContent = transaction.type === 'income' ? 'üìà Êî∂ÂÖ•' : 'üìâ ÊîØÂá∫';
                row.appendChild(typeCell);
                
                // Account
                const accountCell = document.createElement('td');
                accountCell.className = 'px-6 py-4 whitespace-nowrap';
                
                const account = getAccount(transaction.account);
                const accountName = account ? account.name : 'Êú™Áü•Êà∂Âè£';
                const currencyCode = account ? account.currency : appSettings.currency;
                
                accountCell.innerHTML = `${accountName} <span class="currency-label">${currencyCode}</span>`;
                row.appendChild(accountCell);
                
                // Category
                const categoryCell = document.createElement('td');
                categoryCell.className = 'px-6 py-4 whitespace-nowrap';
                categoryCell.textContent = transaction.category;
                row.appendChild(categoryCell);
                
                // Amount
                const amountCell = document.createElement('td');
                amountCell.className = 'px-6 py-4 whitespace-nowrap';
                
                // Get currency symbol based on account
                const currencySymbol = getAccountCurrencySymbol(transaction.account);
                
                if (transaction.type === 'income') {
                    amountCell.classList.add('text-green-600');
                    amountCell.classList.add('font-medium');
                } else {
                    amountCell.classList.add('text-red-600');
                    amountCell.classList.add('font-medium');
                }
                amountCell.textContent = currencySymbol + formatNumber(transaction.amount);
                row.appendChild(amountCell);
                
                // Note
                const noteCell = document.createElement('td');
                noteCell.className = 'px-6 py-4 whitespace-nowrap text-gray-500';
                noteCell.textContent = transaction.note || '-';
                row.appendChild(noteCell);
                
                // Receipt
                const receiptCell = document.createElement('td');
                receiptCell.className = 'px-6 py-4 whitespace-nowrap text-center';
                if (transaction.receipt) {
                    const viewBtn = document.createElement('button');
                    viewBtn.className = 'text-primary hover:text-primary-dark';
                    viewBtn.innerHTML = '<i class="fas fa-image"></i>';
                    viewBtn.addEventListener('click', () => {
                        showReceiptImage(transaction.receipt);
                    });
                    receiptCell.appendChild(viewBtn);
                } else {
                    receiptCell.textContent = '-';
                }
                row.appendChild(receiptCell);
                
                todayTransactionsList.appendChild(row);
            });
        }
        
        // Update recent transactions on dashboard
        function updateRecentTransactions() {
            const recentTransactions = getRecentTransactions(5);
            const noTransactions = document.getElementById('noTransactions');
            const recentTransactionsEl = document.getElementById('recentTransactions');
            const recentTransactionsList = document.getElementById('recentTransactionsList');
            
            if (recentTransactions.length === 0) {
                noTransactions.style.display = 'block';
                recentTransactionsEl.style.display = 'none';
                return;
            }
            
            noTransactions.style.display = 'none';
            recentTransactionsEl.style.display = 'block';
            
            // Clear previous content
            recentTransactionsList.innerHTML = '';
            
            // Add each transaction
            recentTransactions.forEach(transaction => {
                const li = document.createElement('li');
                li.className = 'px-4 py-3 hover:bg-gray-50 flex justify-between items-center';
                
                const leftDiv = document.createElement('div');
                
                const emojiSpan = document.createElement('span');
                emojiSpan.className = 'mr-2';
                emojiSpan.textContent = transaction.type === 'income' ? 'üíπ' : 'üí∏';
                leftDiv.appendChild(emojiSpan);
                
                const categorySpan = document.createElement('span');
                categorySpan.textContent = transaction.category;
                
                // Add account currency label
                const account = getAccount(transaction.account);
                if (account) {
                    const currencyLabel = document.createElement('span');
                    currencyLabel.className = 'currency-label ml-1';
                    currencyLabel.textContent = account.currency;
                    categorySpan.appendChild(currencyLabel);
                }
                
                leftDiv.appendChild(categorySpan);
                
                const dateDiv = document.createElement('div');
                dateDiv.className = 'text-sm text-gray-500';
                dateDiv.textContent = formatDate(transaction.date);
                leftDiv.appendChild(dateDiv);
                
                const amountDiv = document.createElement('div');
                // Get currency symbol based on account
                const currencySymbol = getAccountCurrencySymbol(transaction.account);
                
                if (transaction.type === 'income') {
                    amountDiv.classList.add('text-green-600');
                    amountDiv.classList.add('font-medium');
                } else {
                    amountDiv.classList.add('text-red-600');
                    amountDiv.classList.add('font-medium');
                }
                amountDiv.textContent = currencySymbol + formatNumber(transaction.amount);
                
                li.appendChild(leftDiv);
                li.appendChild(amountDiv);
                
                recentTransactionsList.appendChild(li);
            });
        }
        
        // Update accounts tab
        function updateAccountsTab() {
            const accountsGrid = document.getElementById('accountsGrid');
            
            // Clear previous content
            accountsGrid.innerHTML = '';
            
            // Add each account
            accounts.forEach(account => {
                const accountCard = document.createElement('div');
                accountCard.className = 'bg-white p-6 rounded-lg shadow relative';
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'absolute top-2 right-2 flex space-x-1';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-500 hover:text-red-700';
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                deleteBtn.addEventListener('click', () => deleteAccount(account.id));
                actionsDiv.appendChild(deleteBtn);
                
                const iconDiv = document.createElement('div');
                iconDiv.className = 'text-3xl mb-2 emoji-btn';
                iconDiv.textContent = account.icon || 'üí≥';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'flex items-center mb-1';
                
                const nameHeading = document.createElement('h3');
                nameHeading.className = 'text-lg font-bold';
                nameHeading.textContent = account.name;
                
                const currencyBadge = document.createElement('span');
                currencyBadge.className = 'currency-label ml-2';
                currencyBadge.textContent = account.currency || appSettings.currency;
                
                nameDiv.appendChild(nameHeading);
                nameDiv.appendChild(currencyBadge);
                
                const balanceDiv = document.createElement('div');
                balanceDiv.className = 'text-2xl font-bold';
                
                // Get currency symbol for this account
                const currencySymbol = account.currency ? 
                    (currencySymbols[account.currency] || appSettings.currencySymbol) : 
                    appSettings.currencySymbol;
                
                balanceDiv.textContent = currencySymbol + formatNumber(account.balance);
                
                accountCard.appendChild(actionsDiv);
                accountCard.appendChild(iconDiv);
                accountCard.appendChild(nameDiv);
                accountCard.appendChild(balanceDiv);
                
                accountsGrid.appendChild(accountCard);
            });
            
            // Add the "Add New Account" card
            const addNewCard = document.createElement('div');
            addNewCard.className = 'bg-gray-100 p-6 rounded-lg shadow border-2 border-dashed border-gray-300 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-200 transition';
            addNewCard.innerHTML = `
                <div class="text-3xl mb-2">‚ûï</div>
                <h3 class="text-lg font-medium text-gray-600">Êñ∞Â¢ûÊà∂Âè£</h3>
            `;
            addNewCard.addEventListener('click', () => {
                document.getElementById('newAccountName').value = '';
                document.getElementById('newAccountBalance').value = '';
                document.getElementById('newAccountCurrency').value = appSettings.currency || 'TWD';
                selectedIcon = 'üí≥';
                updateSelectedAccountIcon();
                openModal('newAccountModal');
            });
            
            accountsGrid.appendChild(addNewCard);
        }
        
        // Update account dropdowns in various forms
        function updateAccountDropdowns() {
            const transferFrom = document.getElementById('transferFrom');
            const transferTo = document.getElementById('transferTo');
            const transactionAccount = document.getElementById('transactionAccount');
            
            // Clear previous options
            transferFrom.innerHTML = '<option value="" disabled selected>ÈÅ∏ÊìáÊà∂Âè£</option>';
            transferTo.innerHTML = '<option value="" disabled selected>ÈÅ∏ÊìáÊà∂Âè£</option>';
            transactionAccount.innerHTML = '<option value="" disabled selected>ÈÅ∏ÊìáÊà∂Âè£</option>';
            
            // Add account options
            accounts.forEach(account => {
                const currencyCode = account.currency || appSettings.currency;
                const displayName = `${account.name} (${currencyCode})`;
                
                const option1 = document.createElement('option');
                option1.value = account.id;
                option1.textContent = displayName;
                
                const option2 = document.createElement('option');
                option2.value = account.id;
                option2.textContent = displayName;
                
                const option3 = document.createElement('option');
                option3.value = account.id;
                option3.textContent = displayName;
                
                transferFrom.appendChild(option1);
                transferTo.appendChild(option2);
                transactionAccount.appendChild(option3);
            });
        }
        
        // Update transaction categories dropdown based on selected type
        function updateTransactionCategories() {
            const transactionCategory = document.getElementById('transactionCategory');
            
            // Clear previous options
            transactionCategory.innerHTML = '<option value="" disabled selected>ÈÅ∏ÊìáÈ°ûÂà•</option>';
            
            // Add category options based on current transaction type
            const categoriesList = categories[transactionType] || [];
            categoriesList.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                transactionCategory.appendChild(option);
            });
        }
        
        function updateCategoryBudgetDropdown() {
    const categoryForBudget = document.getElementById('categoryForBudget');
    
    // Ê∏ÖÈô§‰πãÂâçÁöÑÈÅ∏È†Ö
    categoryForBudget.innerHTML = '<option value="" disabled selected>ÈÅ∏ÊìáÈ°ûÂà•</option>';
    
    // Ê∑ªÂä†ÊâÄÊúâÈ°ûÂà•ÔºàÂåÖÊã¨Êî∂ÂÖ•ÂíåÊîØÂá∫È°ûÂà•Ôºâ
    const allCategories = [...categories.income, ...categories.expense];
    const uniqueCategories = [...new Set(allCategories)]; // ÁßªÈô§ÈáçË§áÈ†Ö
    
    uniqueCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categoryForBudget.appendChild(option);
    });
    }
        
        // Update category budget items
        function updateCategoryBudgetItems() {
            const categoryBudgetItems = document.getElementById('categoryBudgetItems');
            
            // Clear previous content
            categoryBudgetItems.innerHTML = '';
            
            if (categoryBudgets.length === 0) {
                categoryBudgetItems.innerHTML = '<div class="text-center text-gray-500 py-4">Â∞öÊú™Ë®≠ÁΩÆÈ°ûÂà•È†êÁÆó</div>';
                return;
            }
            
            // Add each category budget
            categoryBudgets.forEach(catBudget => {
                const item = document.createElement('div');
                item.className = 'py-4 flex items-center justify-between';
                
                const leftPart = document.createElement('div');
                leftPart.className = 'flex-1';
                
                const categoryName = document.createElement('div');
                categoryName.className = 'font-medium';
                categoryName.textContent = catBudget.category;
                
                const budgetAmount = document.createElement('div');
                budgetAmount.className = 'text-gray-600';
                budgetAmount.textContent = `È†êÁÆó: ${appSettings.currencySymbol}${formatNumber(catBudget.amount)}`;
                
                leftPart.appendChild(categoryName);
                leftPart.appendChild(budgetAmount);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-500 hover:text-red-700 ml-4';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.addEventListener('click', () => {
                    categoryBudgets = categoryBudgets.filter(b => b.category !== catBudget.category);
                    saveData('categoryBudgets');
                    updateCategoryBudgetItems();
                    updateCategoryBudgetsOnDashboard();
                    updateTotalBudgetDisplay();
                });
                
                item.appendChild(leftPart);
                item.appendChild(deleteBtn);
                
                categoryBudgetItems.appendChild(item);
            });
        }
        
        function updateCategoryBudgetsOnDashboard() {
    const categoryBudgetList = document.getElementById('categoryBudgetList');
    const categoryBudgetsContainer = document.getElementById('categoryBudgets');
    
    // Ê∏ÖÈô§‰πãÂâçÁöÑÂÖßÂÆπ
    categoryBudgetList.innerHTML = '';
    
    if (categoryBudgets.length === 0) {
        categoryBudgetsContainer.style.display = 'none';
        return;
    }
    
    categoryBudgetsContainer.style.display = 'block';
    
    // Áç≤ÂèñÁï∂ÂâçÊúà‰ªΩÁöÑÈñãÂßãÊó•ÊúüÁî®ÊñºÈ†êÁÆóË®àÁÆó
    const now = new Date();
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    
    // Ê∑ªÂä†ÊØèÂÄãÈ°ûÂà•È†êÁÆó
    categoryBudgets.forEach(catBudget => {
        // ËÆ°ÁÆóÊîØÂá∫ - ÂáèÂ∞ëÈ¢ÑÁÆó
        const expenses = transactions
            .filter(t => (t.category === catBudget.category) && 
                       (t.type === 'expense') && 
                       new Date(t.date) >= monthStart)
            .reduce((sum, t) => sum + parseFloat(t.amount), 0);
        
        // ËÆ°ÁÆóÊî∂ÂÖ• - Â¢ûÂä†È¢ÑÁÆó
        const income = transactions
            .filter(t => (t.category === catBudget.category) && 
                       (t.type === 'income') && 
                       new Date(t.date) >= monthStart)
            .reduce((sum, t) => sum + parseFloat(t.amount), 0);
        
        // ÊîØÂá∫ÂáèÂéªÊî∂ÂÖ• = ÂáÄÊîØÂá∫
        const netSpent = expenses - income;
        
        // Â¶ÇÊûúÂáÄÊîØÂá∫‰∏∫Ë¥üÔºàÂç≥Êî∂ÂÖ•Â§ß‰∫éÊîØÂá∫ÔºâÔºåÂàôËßÜ‰∏∫0
        const effectiveSpent = Math.max(0, netSpent);
        
        const percentage = catBudget.amount > 0 ? Math.min(100, (effectiveSpent / catBudget.amount) * 100) : 0;
        
        const item = document.createElement('div');
        item.className = 'mb-3';
        
        const header = document.createElement('div');
        header.className = 'flex justify-between mb-1';
        
        const categoryName = document.createElement('div');
        categoryName.className = 'text-sm font-medium';
        categoryName.textContent = catBudget.category;
        
        const amountText = document.createElement('div');
        amountText.className = 'text-sm';
        
        // ÊòæÁ§∫ÂáÄÊîØÂá∫ÂíåÈ¢ÑÁÆó
        const remainingBudget = Math.max(0, catBudget.amount - effectiveSpent);
        amountText.textContent = `${appSettings.currencySymbol}${formatNumber(effectiveSpent)} / ${appSettings.currencySymbol}${formatNumber(catBudget.amount)}`;
        
        // Ê∑ªÂä†ÂáÄ‰ΩôÈ¢ùÊòæÁ§∫
        const balanceText = document.createElement('div');
        balanceText.className = 'text-xs text-gray-500';
        balanceText.textContent = `Ââ©È§ò: ${appSettings.currencySymbol}${formatNumber(remainingBudget)}`;
        
        const progressBar = document.createElement('div');
        progressBar.className = 'category-budget-bar';
        
        const progressFill = document.createElement('div');
        progressFill.className = 'category-budget-progress';
        progressFill.style.width = `${percentage}%`;
        
        // Ê†πÊìöÁôæÂàÜÊØîÁ¢∫ÂÆöÈ°èËâ≤
        if (percentage < 50) {
            progressFill.classList.add('bg-green-500');
        } else if (percentage < 80) {
            progressFill.classList.add('bg-yellow-500');
        } else {
            progressFill.classList.add('bg-red-500');
        }
        
        header.appendChild(categoryName);
        header.appendChild(amountText);
        progressBar.appendChild(progressFill);
        
        item.appendChild(header);
        item.appendChild(balanceText); // Ê∑ªÂä†‰ΩôÈ¢ùÊòæÁ§∫
        item.appendChild(progressBar);
        
        categoryBudgetList.appendChild(item);
    });
}
        
        // Update statistics categories dropdown
        function updateStatisticsCategories() {
            const searchCategory = document.getElementById('searchCategory');
            
            // Clear previous options
            searchCategory.innerHTML = '<option value="">ÂÖ®ÈÉ®È°ûÂà•</option>';
            
            // Add all categories
            const allCategories = [...categories.income, ...categories.expense];
            const uniqueCategories = [...new Set(allCategories)]; // Remove duplicates
            
            uniqueCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                searchCategory.appendChild(option);
            });
        }
        
        // Update categories management tab
        function updateCategoriesManagement() {
            const incomeCategoriesList = document.getElementById('incomeCategoriesList');
            const expenseCategoriesList = document.getElementById('expenseCategoriesList');
            
            // Clear previous content
            incomeCategoriesList.innerHTML = '';
            expenseCategoriesList.innerHTML = '';
            
            // Add income categories
            if (categories.income.length === 0) {
                incomeCategoriesList.innerHTML = '<div class="text-center text-gray-500 py-4">Â∞öÁÑ°Êî∂ÂÖ•È°ûÂà•</div>';
            } else {
                categories.income.forEach(category => {
                    const item = document.createElement('div');
                    item.className = 'category-item';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = category;
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'category-delete-btn';
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteBtn.addEventListener('click', () => {
                        deleteCategory('income', category);
                    });
                    
                    item.appendChild(nameSpan);
                    item.appendChild(deleteBtn);
                    
                    incomeCategoriesList.appendChild(item);
                });
            }
            
            // Add expense categories
            if (categories.expense.length === 0) {
                expenseCategoriesList.innerHTML = '<div class="text-center text-gray-500 py-4">Â∞öÁÑ°ÊîØÂá∫È°ûÂà•</div>';
            } else {
                categories.expense.forEach(category => {
                    const item = document.createElement('div');
                    item.className = 'category-item';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = category;
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'category-delete-btn';
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteBtn.addEventListener('click', () => {
                        deleteCategory('expense', category);
                    });
                    
                    item.appendChild(nameSpan);
                    item.appendChild(deleteBtn);
                    
                    expenseCategoriesList.appendChild(item);
                });
            }
        }
        
        // Update budget status on dashboard
        function updateBudgetStatus() {
            const noBudget = document.getElementById('noBudget');
            const budgetStatus = document.getElementById('budgetStatus');
            
            if (!budget.amount) {
                noBudget.style.display = 'block';
                budgetStatus.style.display = 'none';
                return;
            }
            
            noBudget.style.display = 'none';
            budgetStatus.style.display = 'block';
            
            // Update budget info
            document.getElementById('budgetCycleText').textContent = getBudgetCycleText();
            document.getElementById('budgetAmount').textContent = formatNumber(budget.amount);
            document.getElementById('budgetUsed').textContent = formatNumber(getBudgetUsed());
            
            const remaining = getBudgetRemaining();
            const remainingEl = document.getElementById('budgetRemaining');
            remainingEl.textContent = appSettings.currencySymbol + formatNumber(remaining);
            
            if (remaining < 0) {
                remainingEl.classList.add('text-red-600');
                remainingEl.classList.remove('text-green-600');
            } else {
                remainingEl.classList.add('text-green-600');
                remainingEl.classList.remove('text-red-600');
            }
            
            // Update budget bar
            const percentage = getBudgetPercentage();
            const budgetBar = document.getElementById('budgetBar');
            budgetBar.style.width = Math.min(percentage, 100) + '%';
            
            if (percentage > 100) {
                budgetBar.classList.add('bg-red-600');
                budgetBar.classList.remove('bg-primary');
            } else {
                budgetBar.classList.add('bg-primary');
                budgetBar.classList.remove('bg-red-600');
            }
            
            document.getElementById('budgetPercentage').textContent = percentage + '% Â∑≤‰ΩøÁî®';
            
            // Update budget form
            
            document.getElementById('budgetCycle').value = budget.cycle;
            if (budget.resetDay) {
                document.getElementById('budgetResetDay').value = budget.resetDay;
            }
        }
        
        // Update budget thresholds
        function updateBudgetThresholds() {
            const thresholdContainer = document.getElementById('thresholdContainer');
            
            // Clear previous content
            thresholdContainer.innerHTML = '';
            
            // Add each threshold
            budget.thresholds.forEach((threshold, index) => {
                const thresholdItem = document.createElement('div');
                thresholdItem.className = 'threshold-item';
                
                const thresholdInput = document.createElement('input');
                thresholdInput.type = 'number';
                thresholdInput.className = 'threshold-value p-2 border border-gray-300 rounded-md text-base w-20';
                thresholdInput.min = 1;
                thresholdInput.max = 100;
                thresholdInput.value = threshold;
                thresholdInput.addEventListener('change', function() {
                    budget.thresholds[index] = parseInt(this.value);
                    // Sort thresholds in descending order
                    budget.thresholds.sort((a, b) => b - a);
                    saveData('budget');
                    updateBudgetThresholds();
                });
                
                const percentText = document.createElement('span');
                percentText.className = 'text-gray-600';
                percentText.textContent = '% ÊôÇÈÄöÁü•';
                
                const spacer = document.createElement('span');
                spacer.className = 'flex-grow';
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-threshold text-red-500 hover:text-red-700';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.addEventListener('click', function() {
                    budget.thresholds.splice(index, 1);
                    if (budget.thresholds.length === 0) {
                        budget.thresholds = [80]; // Always have at least one threshold
                    }
                    saveData('budget');
                    updateBudgetThresholds();
                });
                
                thresholdItem.appendChild(thresholdInput);
                thresholdItem.appendChild(percentText);
                thresholdItem.appendChild(spacer);
                thresholdItem.appendChild(removeBtn);
                
                thresholdContainer.appendChild(thresholdItem);
            });
        }
        
        // Update settings modal
        function updateSettingsModal() {
            document.getElementById('currencySelect').value = appSettings.currency;
            document.getElementById('currencySymbolInput').value = appSettings.currencySymbol;
            document.getElementById('enableSyncReminders').checked = appSettings.syncRemindersEnabled;
            document.getElementById('themeSelect').value = appSettings.theme;
            document.getElementById('enableVirtualization').checked = appSettings.enableVirtualization;
            document.getElementById('pageSize').value = appSettings.pageSize === -1 ? "-1" : appSettings.pageSize.toString();
        }
        
        // Update budget reset day options based on selected cycle
        function updateBudgetResetDayOptions() {
            const budgetCycle = document.getElementById('budgetCycle').value;
            const budgetResetDay = document.getElementById('budgetResetDay');
            
            // Clear previous options
            budgetResetDay.innerHTML = '';
            
            // Add options based on cycle
            if (budgetCycle === 'daily') {
                budgetResetDay.disabled = true;
                const option = document.createElement('option');
                option.value = '1';
                option.textContent = 'ÊØèÊó•Ëá™ÂãïÈáçË®≠';
                budgetResetDay.appendChild(option);
            } else if (budgetCycle === 'weekly') {
                budgetResetDay.disabled = false;
                const days = ['ÈÄ±‰∏Ä', 'ÈÄ±‰∫å', 'ÈÄ±‰∏â', 'ÈÄ±Âõõ', 'ÈÄ±‰∫î', 'ÈÄ±ÂÖ≠', 'ÈÄ±Êó•'];
                days.forEach(day => {
                    const option = document.createElement('option');
                    option.value = day;
                    option.textContent = day;
                    budgetResetDay.appendChild(option);
                });
            } else if (budgetCycle === 'monthly') {
                budgetResetDay.disabled = false;
                for (let i = 1; i <= 31; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i + 'Êó•';
                    budgetResetDay.appendChild(option);
                }
            }
            
            // Set default value
            if (budget.resetDay) {
                // Try to find the value in the options
                const options = Array.from(budgetResetDay.options);
                const matchingOption = options.find(option => option.value == budget.resetDay);
                
                if (matchingOption) {
                    budgetResetDay.value = budget.resetDay;
                } else {
                    // If not found (e.g. when switching from monthly to weekly), set the first option
                    budgetResetDay.selectedIndex = 0;
                    budget.resetDay = budgetResetDay.value;
                }
            } else {
                // Set default reset day if not specified
                budgetResetDay.selectedIndex = 0;
                budget.resetDay = budgetResetDay.value;
            }
            document.getElementById('baseCurrencySelect').value = baseCurrency;
    
    // ÊòæÁ§∫‰∏äÊ¨°Êõ¥Êñ∞Êó∂Èó¥
    const lastUpdateEl = document.getElementById('lastRateUpdateText');
    if (lastRateUpdate) {
        const updateDate = new Date(lastRateUpdate);
        lastUpdateEl.textContent = updateDate.toLocaleString();
    } else {
        lastUpdateEl.textContent = 'Êú™Êõ¥Êñ∞';
    }
    
    // Êõ¥Êñ∞Ê±áÁéáÂàóË°®ÊòæÁ§∫
    updateExchangeRatesList();
}

// Êõ¥Êñ∞Ê±áÁéáÂàóË°®ÊòæÁ§∫
function updateExchangeRatesList() {
    const ratesList = document.getElementById('exchangeRatesList');
    ratesList.innerHTML = '';
    
    if (Object.keys(exchangeRates).length === 0) {
        ratesList.innerHTML = '<div class="text-gray-500">ÁÑ°ÂåØÁéáÊï∏Êìö</div>';
        return;
    }
    
    // ÂàõÂª∫Ê±áÁéáÂàóË°®
    const table = document.createElement('table');
    table.className = 'w-full';
    
    const header = document.createElement('tr');
    header.innerHTML = `
        <th class="text-left pb-2">Ë≤®Âπ£</th>
        <th class="text-right pb-2">ÂåØÁéá (Áõ∏Â∞çÊñº ${baseCurrency})</th>
    `;
    table.appendChild(header);
    
    Object.entries(exchangeRates).forEach(([currency, rate]) => {
        if (currency === baseCurrency) return; // Ë∑≥ËøáÂü∫ÂáÜË¥ßÂ∏Å
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td class="py-1">${currency}</td>
            <td class="text-right">${formatNumber(rate)}</td>
        `;
        table.appendChild(row);
    });
    
    ratesList.appendChild(table);
        }
        
        // Initialize account icons
        function initAccountIcons() {
            const accountIcons = document.getElementById('accountIcons');
            
            // Clear previous icons
            accountIcons.innerHTML = '';
            
            // Add account icons
            ['üí≥', 'üí∞', 'üè¶', 'üí¥', 'üíµ', 'üí∂', 'üí∑', 'ü™ô', 'üí∏', 'üíπ'].forEach(icon => {
                const button = document.createElement('button');
                button.className = 'p-2 rounded-md text-xl emoji-btn';
                if (selectedIcon === icon) {
                    button.classList.add('bg-primary');
                    button.classList.add('text-white');
                } else {
                    button.classList.add('bg-gray-100');
                }
                button.textContent = icon;
                button.addEventListener('click', () => {
                    selectedIcon = icon;
                    updateSelectedAccountIcon();
                });
                
                accountIcons.appendChild(button);
            });
        }
        
        // Update selected account icon
        function updateSelectedAccountIcon() {
            const buttons = document.querySelectorAll('#accountIcons button');
            buttons.forEach(button => {
                if (button.textContent === selectedIcon) {
                    button.classList.remove('bg-gray-100');
                    button.classList.add('bg-primary', 'text-white');
                } else {
                    button.classList.remove('bg-primary', 'text-white');
                    button.classList.add('bg-gray-100');
                }
            });
        }
        
        // Show receipt image in modal
        function showReceiptImage(receipt) {
            if (!receipt) return;
            
            const receiptViewImage = document.getElementById('receiptViewImage');
            receiptViewImage.src = receipt.data;
            
            openModal('receiptViewModal');
        }
        
        // Show daily summary for a specific date
        function showDailySummary(date) {
            // Get transactions for this date
            const dayTransactions = transactions.filter(t => t.date === date);
            
            if (dayTransactions.length === 0) {
                notify('‚ÑπÔ∏è', 'Ê≤íÊúâ‰∫§ÊòìË®òÈåÑ', `${formatDate(date)} Ê≤íÊúâ‰∫§ÊòìË®òÈåÑ`);
                return;
            }
            
            // Calculate totals
            const income = dayTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
                
            const expense = dayTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            // Get expense categories breakdown
            const expenseCategories = {};
            dayTransactions.filter(t => t.type === 'expense').forEach(t => {
                expenseCategories[t.category] = (expenseCategories[t.category] || 0) + parseFloat(t.amount);
            });
            
            // Update modal content
            document.getElementById('modalSummaryIncome').textContent = formatNumber(income);
            document.getElementById('modalSummaryExpense').textContent = formatNumber(expense);
            
            // Update categories breakdown
            const categoriesContainer = document.getElementById('modalSummaryCategories');
            categoriesContainer.innerHTML = '';
            
            if (Object.keys(expenseCategories).length === 0) {
                categoriesContainer.innerHTML = '<div class="text-gray-500 text-center">ÁÑ°ÊîØÂá∫È°ûÂà•</div>';
            } else {
                Object.entries(expenseCategories)
                    .sort((a, b) => b[1] - a[1]) // Sort by amount descending
                    .forEach(([category, amount]) => {
                        const percentage = expense > 0 ? Math.round((amount / expense) * 100) : 0;
                        
                        const item = document.createElement('div');
                        
                        const header = document.createElement('div');
                        header.className = 'flex justify-between text-sm';
                        
                        const categoryText = document.createElement('span');
                        categoryText.textContent = category;
                        
                        const amountText = document.createElement('span');
                        amountText.textContent = `${appSettings.currencySymbol}${formatNumber(amount)} (${percentage}%)`;
                        
                        const bar = document.createElement('div');
                        bar.className = 'h-2 bg-gray-200 rounded-full mt-1';
                        
                        const progress = document.createElement('div');
                        progress.className = 'h-2 bg-primary rounded-full';
                        progress.style.width = `${percentage}%`;
                        
                        header.appendChild(categoryText);
                        header.appendChild(amountText);
                        bar.appendChild(progress);
                        
                        item.appendChild(header);
                        item.appendChild(bar);
                        
                        categoriesContainer.appendChild(item);
                    });
            }
            
            // Update transactions list
            const transactionsContainer = document.getElementById('modalSummaryTransactions');
            transactionsContainer.innerHTML = '';
            
            if (dayTransactions.length === 0) {
                transactionsContainer.innerHTML = '<div class="text-gray-500 text-center">ÁÑ°‰∫§ÊòìË®òÈåÑ</div>';
            } else {
                dayTransactions.sort((a, b) => b.amount - a.amount).forEach(transaction => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center py-2 border-b border-gray-200';
                    
                    const leftPart = document.createElement('div');
                    
                    const title = document.createElement('div');
                    title.className = 'font-medium';
                    
                    const account = getAccount(transaction.account);
                    const accountName = account ? account.name : 'Êú™Áü•Êà∂Âè£';
                    const currencyCode = account ? account.currency : appSettings.currency;
                    
                    title.innerHTML = `${transaction.category} (${accountName} <span class="currency-label">${currencyCode}</span>)`;
                    
                    const note = document.createElement('div');
                    note.className = 'text-sm text-gray-500';
                    note.textContent = transaction.note || 'ÁÑ°ÂÇôË®ª';
                    
                    const amount = document.createElement('div');
                    // Get currency symbol for this account
                    const currencySymbol = getAccountCurrencySymbol(transaction.account);
                    
                    if (transaction.type === 'income') {
                        amount.className = 'text-green-600 font-medium';
                        amount.textContent = `+${currencySymbol}${formatNumber(transaction.amount)}`;
                    } else {
                        amount.className = 'text-red-600 font-medium';
                        amount.textContent = `-${currencySymbol}${formatNumber(transaction.amount)}`;
                    }
                    
                    leftPart.appendChild(title);
                    leftPart.appendChild(note);
                    
                    item.appendChild(leftPart);
                    item.appendChild(amount);
                    
                    transactionsContainer.appendChild(item);
                });
            }
            
            // Show the modal
            openModal('dailySummaryModal');
        }
        
        // Generate financial advice based on transaction data
        function generateFinancialAdvice() {
            const adviceContent = document.getElementById('adviceContent');
            const noAdviceData = document.getElementById('noAdviceData');
            
            // Need at least 5 transactions to provide meaningful advice
            if (transactions.length < 5) {
                adviceContent.style.display = 'none';
                noAdviceData.style.display = 'block';
                return;
            }
            
            // Show advice content
            adviceContent.style.display = 'block';
            noAdviceData.style.display = 'none';
            
            // Calculate financial health score (0-100)
            let healthScore = 50; // Start with neutral score
            
            // Get total income and expenses for the last 30 days
            const lastMonth = new Date();
            lastMonth.setDate(lastMonth.getDate() - 30);
            const lastMonthFormatted = formatDateForInput(lastMonth);
            
            const recentTransactions = transactions.filter(t => t.date >= lastMonthFormatted);
            const monthlyIncome = recentTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const monthlyExpenses = recentTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            // Add points if income > expenses
            if (monthlyIncome > monthlyExpenses) {
                healthScore += 20;
            } else if (monthlyIncome > 0 && monthlyExpenses > monthlyIncome) {
                healthScore -= 20;
            }
            
            // Add points for regular income
            const incomeCount = recentTransactions.filter(t => t.type === 'income').length;
            if (incomeCount >= 2) {
                healthScore += 10;
            }
            
            // Add points for budget usage
            if (budget.amount > 0) {
                healthScore += 10;
                
                // Check if expenses are within budget
                if (monthlyExpenses <= budget.amount) {
                    healthScore += 10;
                } else {
                    healthScore -= 10;
                }
            }
            
            // Add points for using category budgets
            if (categoryBudgets.length > 0) {
                healthScore += 5;
            }
            
            // Add points for using Google Drive sync
            if (appSettings.googleSync.enabled && appSettings.googleSync.lastSync) {
                healthScore += 5;
            }
            
            // Ensure score is between 0-100
            healthScore = Math.max(0, Math.min(100, healthScore));
            
            // Update health score in UI
            document.getElementById('healthScore').textContent = healthScore;
            const healthScoreBar = document.getElementById('healthScoreBar');
            healthScoreBar.style.width = `${healthScore}%`;
            
            // Set color based on score
            if (healthScore < 40) {
                healthScoreBar.classList.remove('bg-green-500', 'bg-yellow-500');
                healthScoreBar.classList.add('bg-red-500');
            } else if (healthScore < 70) {
                healthScoreBar.classList.remove('bg-green-500', 'bg-red-500');
                healthScoreBar.classList.add('bg-yellow-500');
            } else {
                healthScoreBar.classList.remove('bg-yellow-500', 'bg-red-500');
                healthScoreBar.classList.add('bg-green-500');
            }
            
            // Generate health summary text
            let healthSummary = '';
            if (healthScore < 40) {
                healthSummary = 'ÊÇ®ÁöÑË≤°ÂãôÁãÄÊ≥ÅÈúÄË¶ÅÈóúÊ≥®„ÄÇÊîØÂá∫‰ºº‰πéË∂ÖÈÅé‰∫ÜÊî∂ÂÖ•ÔºåÂèØËÉΩÈúÄË¶ÅË™øÊï¥È†êÁÆóÊàñÂ¢ûÂä†Êî∂ÂÖ•‰æÜÊ∫ê„ÄÇ';
            } else if (healthScore < 70) {
                healthSummary = 'ÊÇ®ÁöÑË≤°ÂãôÁãÄÊ≥ÅËôïÊñº‰∏≠Á≠âÊ∞¥Âπ≥„ÄÇÊúâÊîπÂñÑÁ©∫ÈñìÔºåÂª∫Ë≠∞Êõ¥ÂØÜÂàáÂú∞Áõ£ÊéßÊîØÂá∫‰∏¶Âà∂ÂÆöÊõ¥Ë©≥Á¥∞ÁöÑÈ†êÁÆóË®àÂäÉ„ÄÇ';
            } else {
                healthSummary = 'ÊÇ®ÁöÑË≤°ÂãôÁãÄÊ≥ÅËâØÂ•Ω„ÄÇÊÇ®Ê≠£Âú®ÊúâÊïàÂú∞ÁÆ°ÁêÜÊî∂ÂÖ•ÂíåÊîØÂá∫Ôºå‰∏¶ÈÅµÂæ™È†êÁÆóË®àÂäÉ„ÄÇ';
            }
            document.getElementById('healthSummary').textContent = healthSummary;
            
            // Expense Analysis
            const expenseAnalysis = document.getElementById('expenseAnalysis');
            expenseAnalysis.innerHTML = '';
            
            // Get expense categories breakdown
            const expenseCategories = {};
            transactions
                .filter(t => t.type === 'expense')
                .forEach(t => {
                    expenseCategories[t.category] = (expenseCategories[t.category] || 0) + parseFloat(t.amount);
                });
            
            // Find top expense categories
            const topCategories = Object.entries(expenseCategories)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3);
            
            // Create expense analysis cards
            if (topCategories.length > 0) {
                const topExpenseCard = document.createElement('div');
                topExpenseCard.className = 'advice-card info mb-3';
                
                const title = document.createElement('h4');
                title.className = 'font-medium mb-1';
                title.textContent = '‰∏ªË¶ÅÊîØÂá∫È°ûÂà•';
                
                const list = document.createElement('ul');
                list.className = 'text-sm space-y-1';
                
                topCategories.forEach(([category, amount], index) => {
                    const item = document.createElement('li');
                    item.className = 'flex justify-between';
                    item.innerHTML = `
                        <span>${index + 1}. ${category}</span>
                        <span>${appSettings.currencySymbol}${formatNumber(amount)}</span>
                    `;
                    list.appendChild(item);
                });
                
                topExpenseCard.appendChild(title);
                topExpenseCard.appendChild(list);
                expenseAnalysis.appendChild(topExpenseCard);
                
                // Add insight about top category
                if (topCategories.length > 0) {
                    const [topCategory, topAmount] = topCategories[0];
                    const percentage = Math.round((topAmount / Object.values(expenseCategories).reduce((a, b) => a + b, 0)) * 100);
                    
                    const insightCard = document.createElement('div');
                    insightCard.className = percentage > 40 ? 'advice-card warning' : 'advice-card info';
                    
                    const insightText = document.createElement('p');
                    insightText.className = 'text-sm';
                    
                    if (percentage > 40) {
                        insightText.textContent = `${topCategory} ‰ΩîÁ∏ΩÊîØÂá∫ÁöÑ ${percentage}%„ÄÇËÄÉÊÖÆÊ™¢Ë¶ñÈÄôÂÄãÈ°ûÂà•ÊòØÂê¶ÊúâÂèØ‰ª•ÁØÄÁúÅÁöÑÁ©∫Èñì„ÄÇ`;
                    } else {
                        insightText.textContent = `${topCategory} ÊòØÊÇ®ÊúÄÂ§ßÁöÑÊîØÂá∫È°ûÂà•Ôºå‰ΩîÁ∏ΩÊîØÂá∫ÁöÑ ${percentage}%„ÄÇ`;
                    }
                    
                    insightCard.appendChild(insightText);
                    expenseAnalysis.appendChild(insightCard);
                }
            } else {
                expenseAnalysis.innerHTML = '<p class="text-gray-500 text-center">Â∞öÁÑ°Ë∂≥Â§†ÊîØÂá∫Êï∏ÊìöÈÄ≤Ë°åÂàÜÊûê</p>';
            }
            
            // Savings Advice
            const savingsAdvice = document.getElementById('savingsAdvice');
            savingsAdvice.innerHTML = '';
            
            if (monthlyIncome > 0 && monthlyExpenses > 0) {
                const savingsRate = Math.round(((monthlyIncome - monthlyExpenses) / monthlyIncome) * 100);
                
                const savingsCard = document.createElement('div');
                
                if (savingsRate < 0) {
                    savingsCard.className = 'advice-card danger';
                    savingsCard.innerHTML = `
                        <h4 class="font-medium mb-1">Áï∂ÂâçÊîØÂá∫Ë∂ÖÈÅéÊî∂ÂÖ•</h4>
                        <p class="text-sm">ÈÅéÂéª 30 Â§©ÊÇ®ÁöÑÊîØÂá∫Ë∂ÖÈÅéÊî∂ÂÖ• ${Math.abs(savingsRate)}%„ÄÇÂª∫Ë≠∞Ê™¢Ë¶ñÊÇ®ÁöÑÂøÖË¶ÅËàáÈùûÂøÖË¶ÅÊîØÂá∫Ôºå‰∏¶ËÄÉÊÖÆÂ¢ûÂä†Êî∂ÂÖ•‰æÜÊ∫ê„ÄÇ</p>
                    `;
                } else if (savingsRate < 15) {
                    savingsCard.className = 'advice-card warning';
                    savingsCard.innerHTML = `
                        <h4 class="font-medium mb-1">ÂÑ≤ËìÑÁéáÂÅè‰Ωé</h4>
                        <p class="text-sm">ÊÇ®ÁõÆÂâçÁöÑÂÑ≤ËìÑÁéáÁÇ∫ ${savingsRate}%„ÄÇÂª∫Ë≠∞ÁõÆÊ®ôÁÇ∫Ëá≥Â∞ë 20%„ÄÇÂòóË©¶Ê∏õÂ∞ëÈùûÂøÖË¶ÅÊîØÂá∫‰æÜÂ¢ûÂä†ÂÑ≤ËìÑÁéá„ÄÇ</p>
                    `;
                } else {
                    savingsCard.className = 'advice-card saving';
                    savingsCard.innerHTML = `
                        <h4 class="font-medium mb-1">ËâØÂ•ΩÁöÑÂÑ≤ËìÑÁøíÊÖ£</h4>
                        <p class="text-sm">ÊÇ®ÁõÆÂâçÁöÑÂÑ≤ËìÑÁéáÁÇ∫ ${savingsRate}%ÔºåÈÄôÊòØ‰∏ÄÂÄãÂÅ•Â∫∑ÁöÑÂÑ≤ËìÑÊØî‰æã„ÄÇËÄÉÊÖÆÂ∞áÈÉ®ÂàÜÂÑ≤ËìÑÁî®ÊñºÊäïË≥á‰ª•Áç≤ÂæóÊõ¥Â•ΩÁöÑÈï∑ÊúüÂõûÂ†±„ÄÇ</p>
                    `;
                }
                
                savingsAdvice.appendChild(savingsCard);
                
                // Add additional savings tip
                const tipCard = document.createElement('div');
                tipCard.className = 'advice-card info mt-2';
                
                // Select a random savings tip
                const savingsTips = [
                    "Âª∫Á´ãÁ∑äÊÄ•Âü∫ÈáëÔºåÁêÜÊÉ≥ÊÉÖÊ≥Å‰∏ãÊáâÂåÖÂê´3-6ÂÄãÊúàÁöÑÁîüÊ¥ªË≤ªÁî®„ÄÇ",
                    "ËÄÉÊÖÆËá™ÂãïËΩâË≥¨Â∞áÊî∂ÂÖ•ÁöÑ‰∏ÄÈÉ®ÂàÜÁõ¥Êé•Â≠òÂÖ•ÂÑ≤ËìÑË≥¨Êà∂„ÄÇ",
                    "Âà∂ÂÆö„ÄåÂÖàÂÑ≤ËìÑÂæåÊ∂àË≤ª„ÄçÁöÑÁøíÊÖ£ÔºåËÄå‰∏çÊòØ„ÄåÂÖàÊ∂àË≤ªÂæåÂÑ≤ËìÑ„Äç„ÄÇ",
                    "ÁÇ∫Â§ßÁ≠ÜÊîØÂá∫ÔºàÂ¶ÇÂÅáÊúüÊàñÂ§ßÂûãË≥ºÁâ©ÔºâË®≠Á´ãÂ∞àÈ†ÖÂÑ≤ËìÑÁõÆÊ®ô„ÄÇ",
                    "ÂòóË©¶ÈÅµÂæ™50/30/20Ê≥ïÂâáÔºö50%Áî®ÊñºÂøÖÈúÄÂìÅ„ÄÅ30%Áî®ÊñºÂÄã‰∫∫ÊîØÂá∫„ÄÅ20%Áî®ÊñºÂÑ≤ËìÑ„ÄÇ"
                ];
                
                const randomTip = savingsTips[Math.floor(Math.random() * savingsTips.length)];
                tipCard.innerHTML = `<p class="text-sm"><strong>ÂÑ≤ËìÑÂ∞èË≤ºÂ£´Ôºö</strong> ${randomTip}</p>`;
                
                savingsAdvice.appendChild(tipCard);
                
                // Add data backup tip if not using Google Drive
                if (!appSettings.googleSync.enabled) {
                    const backupCard = document.createElement('div');
                    backupCard.className = 'advice-card info mt-2';
                    backupCard.innerHTML = `
                        <h4 class="font-medium mb-1">Êï∏Êìö‰øùË≠∑Âª∫Ë≠∞</h4>
                        <p class="text-sm">ËÄÉÊÖÆÂïüÁî® Google Drive ÂêåÊ≠•‰ª•Ëá™ÂãïÂÇô‰ªΩÊÇ®ÁöÑË≤°ÂãôÊï∏ÊìöÔºåÈÅøÂÖçÂõ†ÁÄèË¶ΩÂô®Êï∏ÊìöÊ∏ÖÈô§ËÄå‰∏üÂ§±ÈáçË¶ÅË®òÈåÑ„ÄÇ</p>
                        <button id="enableGoogleSyncBtn" class="mt-2 bg-primary text-white px-3 py-1 rounded-md text-sm hover:bg-primary-dark transition">
                            Ë®≠ÂÆö Google Drive ÂêåÊ≠•
                        </button>
                    `;
                    savingsAdvice.appendChild(backupCard);
                    
                    // Add event listener after the element is added to the DOM
                    setTimeout(() => {
                        const syncBtn = document.getElementById('enableGoogleSyncBtn');
                        if (syncBtn) {
                            syncBtn.addEventListener('click', () => {
                                openModal('importExportModal');
                            });
                        }
                    }, 0);
                }
            } else {
                savingsAdvice.innerHTML = '<p class="text-gray-500 text-center">Â∞öÁÑ°Ë∂≥Â§†Êï∏ÊìöÊèê‰æõÂÑ≤ËìÑÂª∫Ë≠∞</p>';
            }
            
            // Budget Advice
            const budgetAdvice = document.getElementById('budgetAdvice');
            budgetAdvice.innerHTML = '';
            
            if (budget.amount > 0) {
                const budgetCard = document.createElement('div');
                
                const budgetUsed = getBudgetUsed();
                const budgetRemaining = budget.amount - budgetUsed;
                const daysInPeriod = getBudgetDaysInPeriod();
                const daysRemaining = getBudgetDaysRemaining();
                
                if (daysRemaining <= 0) {
                    budgetCard.className = 'advice-card info';
                    budgetCard.innerHTML = `
                        <h4 class="font-medium mb-1">È†êÁÆóÊúüÂ∑≤ÁµêÊùü</h4>
                        <p class="text-sm">Êú¨ÊúüÈ†êÁÆóÂ∑≤ÁµêÊùü„ÄÇÊñ∞ÁöÑÈ†êÁÆóÈÄ±ÊúüÂç≥Â∞áÈñãÂßã„ÄÇ</p>
                    `;
                } else {
                    // Calculate ideal daily spending rate
                    const idealDailyBudget = budget.amount / daysInPeriod;
                    const actualDailySpending = budgetUsed / (daysInPeriod - daysRemaining);
                    const remainingDailyBudget = budgetRemaining / daysRemaining;
                    
                    if (budgetRemaining < 0) {
                        budgetCard.className = 'advice-card danger';
                        budgetCard.innerHTML = `
                            <h4 class="font-medium mb-1">È†êÁÆóÂ∑≤Ë∂ÖÊîØ</h4>
                            <p class="text-sm">ÊÇ®Â∑≤Ë∂ÖÂá∫Êú¨ÊúüÈ†êÁÆó ${appSettings.currencySymbol}${formatNumber(Math.abs(budgetRemaining))}„ÄÇ
                            ËÄÉÊÖÆË™øÊï¥ÊîØÂá∫Áõ¥Âà∞‰∏ãÂÄãÈ†êÁÆóÈÄ±Êúü„ÄÇ</p>
                        `;
                    } else if (remainingDailyBudget < 0.5 * idealDailyBudget) {
                        budgetCard.className = 'advice-card warning';
                        budgetCard.innerHTML = `
                            <h4 class="font-medium mb-1">È†êÁÆóÁ∑äÂºµ</h4>
                            <p class="text-sm">ÊÇ®ÁöÑÂâ©È§òÊó•ÂùáÈ†êÁÆóÁÇ∫ ${appSettings.currencySymbol}${formatNumber(remainingDailyBudget)}Ôºå
                            È°ØËëó‰ΩéÊñºÁêÜÊÉ≥Êó•Âùá ${appSettings.currencySymbol}${formatNumber(idealDailyBudget)}„ÄÇÂâ©È§ò ${daysRemaining} Â§©ÂÖßÈúÄË¨πÊÖéÊîØÂá∫„ÄÇ</p>
                        `;
                    } else if (actualDailySpending > 1.2 * idealDailyBudget) {
                        budgetCard.className = 'advice-card warning';
                        budgetCard.innerHTML = `
                            <h4 class="font-medium mb-1">ÊîØÂá∫ÈÄüÂ∫¶ÈÅéÂø´</h4>
                            <p class="text-sm">ÊÇ®Áï∂ÂâçÁöÑÊó•ÂùáÊîØÂá∫ ${appSettings.currencySymbol}${formatNumber(actualDailySpending)} È´òÊñºÁêÜÊÉ≥Êó•Âùá
                            ${appSettings.currencySymbol}${formatNumber(idealDailyBudget)}„ÄÇ‰ª•Ê≠§ÈÄüÂ∫¶ÔºåÈ†êÁÆóÂèØËÉΩÂú®ÊúüÈôêÂâçËÄóÁõ°„ÄÇ</p>
                        `;
                    } else {
                        budgetCard.className = 'advice-card saving';
                        budgetCard.innerHTML = `
                            <h4 class="font-medium mb-1">È†êÁÆóÂü∑Ë°åËâØÂ•Ω</h4>
                            <p class="text-sm">ÊÇ®ÁöÑÈ†êÁÆóÂü∑Ë°åÊÉÖÊ≥ÅËâØÂ•Ω„ÄÇÂâ©È§ò ${daysRemaining} Â§©ÔºåÊó•ÂùáÂèØÁî® 
                            ${appSettings.currencySymbol}${formatNumber(remainingDailyBudget)}„ÄÇ</p>
                        `;
                    }
                }
                // Ê∑ªÂä†È†êÁÆóË™™ÊòéË®ªÈáã
const budgetNote = document.createElement('div');
budgetNote.className = 'text-xs text-gray-500 mt-2';
budgetNote.innerHTML = 'Ê≥®ÊÑèÔºöÊÇ®ÁöÑÈ†êÁÆóË®àÁÆóÂåÖÂê´ÊâÄÊúâÊî∂ÂÖ•ËàáÊîØÂá∫‰∫§Êòì„ÄÇ';
budgetCard.appendChild(budgetNote);
                
                budgetAdvice.appendChild(budgetCard);
                
                // If no category budgets, suggest setting them up
                if (categoryBudgets.length === 0) {
                    const categoryBudgetCard = document.createElement('div');
                    categoryBudgetCard.className = 'advice-card info mt-2';
                    categoryBudgetCard.innerHTML = `
                        <h4 class="font-medium mb-1">Ë®≠ÂÆöÈ°ûÂà•È†êÁÆó</h4>
                        <p class="text-sm">ËÄÉÊÖÆÁÇ∫ÊÇ®ÁöÑ‰∏ªË¶ÅÊîØÂá∫È°ûÂà•Ë®≠ÂÆöÂÖ∑È´îÈ†êÁÆóÔºåÈÄôÂèØ‰ª•Âπ´Âä©ÊÇ®Êõ¥Â•ΩÂú∞ÊéßÂà∂ÁâπÂÆöÈ†òÂüüÁöÑÊîØÂá∫„ÄÇ</p>
                    `;
                    budgetAdvice.appendChild(categoryBudgetCard);
                }
            } else {
                // Suggest setting up a budget
                const budgetCard = document.createElement('div');
                budgetCard.className = 'advice-card info';
                budgetCard.innerHTML = `
                    <h4 class="font-medium mb-1">Ë®≠ÂÆöÈ†êÁÆó</h4>
                    <p class="text-sm">ÊÇ®Â∞öÊú™Ë®≠ÂÆöÈ†êÁÆó„ÄÇË®≠ÂÆöÈ†êÁÆóÊòØÁÆ°ÁêÜË≤°ÂãôÁöÑÈáçË¶ÅÊ≠•È©üÔºåÂèØ‰ª•Âπ´Âä©ÊÇ®ÊéßÂà∂ÊîØÂá∫‰∏¶ÂØ¶ÁèæÂÑ≤ËìÑÁõÆÊ®ô„ÄÇ</p>
                    <button id="goBudgetBtnAdvice" class="mt-2 bg-primary text-white px-3 py-1 rounded-md text-sm hover:bg-primary-dark transition">
                        Ë®≠ÂÆöÈ†êÁÆó
                    </button>
                `;
                budgetAdvice.appendChild(budgetCard);
                
                // Add event listener after the element is added to the DOM
                setTimeout(() => {
                    const budgetBtn = document.getElementById('goBudgetBtnAdvice');
                    if (budgetBtn) {
                        budgetBtn.addEventListener('click', () => switchTab('budget'));
                    }
                }, 0);
                
                // If we have enough transaction data, suggest a budget amount
                if (monthlyExpenses > 0) {
                    const suggestedBudget = Math.ceil(monthlyExpenses * 0.9 / 100) * 100; // Round up to nearest 100
                    
                    const suggestionCard = document.createElement('div');
                    suggestionCard.className = 'advice-card info mt-2';
                    suggestionCard.innerHTML = `
                        <h4 class="font-medium mb-1">È†êÁÆóÂª∫Ë≠∞</h4>
                        <p class="text-sm">Ê†πÊìöÊÇ®ÈÅéÂéªÁöÑÊîØÂá∫Ë®òÈåÑÔºåÊØèÊúàÈ†êÁÆóÂª∫Ë≠∞ÁÇ∫ ${appSettings.currencySymbol}${formatNumber(suggestedBudget)}„ÄÇ
                        ÈÄôÊØîÊÇ®Áï∂ÂâçÂπ≥ÂùáÊîØÂá∫Áï•‰ΩéÔºåÂèØ‰ª•Âπ´Âä©ÊÇ®Âª∫Á´ãÂÑ≤ËìÑÁøíÊÖ£„ÄÇ</p>
                    `;
                    budgetAdvice.appendChild(suggestionCard);
                }
            }
        }
        
        // Show daily summary in the page (not in modal)
        function showDailySummaryInPage(date) {
            // Get transactions for this date
            const dayTransactions = transactions.filter(t => t.date === date);
            
            const dailySummaryContainer = document.getElementById('dailySummaryContainer');
            
            if (dayTransactions.length === 0) {
                notify('‚ÑπÔ∏è', 'Ê≤íÊúâ‰∫§ÊòìË®òÈåÑ', `${formatDate(date)} Ê≤íÊúâ‰∫§ÊòìË®òÈåÑ`);
                dailySummaryContainer.style.display = 'none';
                return;
            }
            
            // Calculate totals
            const income = dayTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
                
            const expense = dayTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            // Update summary in page
            document.getElementById('summaryIncome').textContent = formatNumber(income);
            document.getElementById('summaryExpense').textContent = formatNumber(expense);
            
            // Get expense categories breakdown
            const expenseCategories = {};
            dayTransactions.filter(t => t.type === 'expense').forEach(t => {
                expenseCategories[t.category] = (expenseCategories[t.category] || 0) + parseFloat(t.amount);
            });
            
            // Update categories breakdown
            const categoriesContainer = document.getElementById('summaryCategories');
            categoriesContainer.innerHTML = '';
            
            if (Object.keys(expenseCategories).length === 0) {
                categoriesContainer.innerHTML = '<div class="text-gray-500 text-center">ÁÑ°ÊîØÂá∫È°ûÂà•</div>';
            } else {
                Object.entries(expenseCategories)
                    .sort((a, b) => b[1] - a[1]) // Sort by amount descending
                    .forEach(([category, amount]) => {
                        const percentage = expense > 0 ? Math.round((amount / expense) * 100) : 0;
                        
                        const item = document.createElement('div');
                        
                        const header = document.createElement('div');
                        header.className = 'flex justify-between text-sm';
                        
                        const categoryText = document.createElement('span');
                        categoryText.textContent = category;
                        
                        const amountText = document.createElement('span');
                        amountText.textContent = `${appSettings.currencySymbol}${formatNumber(amount)} (${percentage}%)`;
                        
                        const bar = document.createElement('div');
                        bar.className = 'h-2 bg-gray-200 rounded-full mt-1';
                        
                        const progress = document.createElement('div');
                        progress.className = 'h-2 bg-primary rounded-full';
                        progress.style.width = `${percentage}%`;
                        
                        header.appendChild(categoryText);
                        header.appendChild(amountText);
                        bar.appendChild(progress);
                        
                        item.appendChild(header);
                        item.appendChild(bar);
                        
                        categoriesContainer.appendChild(item);
                    });
            }
            
            // Update transactions list
            const transactionsContainer = document.getElementById('summaryTransactions');
            transactionsContainer.innerHTML = '';
            
            if (dayTransactions.length === 0) {
                transactionsContainer.innerHTML = '<div class="text-gray-500 text-center">ÁÑ°‰∫§ÊòìË®òÈåÑ</div>';
            } else {
                dayTransactions.sort((a, b) => b.amount - a.amount).forEach(transaction => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center py-2 border-b border-gray-200';
                    
                    const leftPart = document.createElement('div');
                    
                    const title = document.createElement('div');
                    title.className = 'font-medium';
                    
                    const account = getAccount(transaction.account);
                    const accountName = account ? account.name : 'Êú™Áü•Êà∂Âè£';
                    const currencyCode = account ? account.currency : appSettings.currency;
                    const currencySymbol = getAccountCurrencySymbol(transaction.account);
                    
                    title.innerHTML = `${transaction.category} (${accountName} <span class="currency-label">${currencyCode}</span>)`;
                    
                    const note = document.createElement('div');
                    note.className = 'text-sm text-gray-500';
                    note.textContent = transaction.note || 'ÁÑ°ÂÇôË®ª';
                    
                    const amount = document.createElement('div');
                    
                    if (transaction.type === 'income') {
                        amount.className = 'text-green-600 font-medium';
                        amount.textContent = `+${currencySymbol}${formatNumber(transaction.amount)}`;
                    } else {
                        amount.className = 'text-red-600 font-medium';
                        amount.textContent = `-${currencySymbol}${formatNumber(transaction.amount)}`;
                    }
                    
                    leftPart.appendChild(title);
                    leftPart.appendChild(note);
                    
                    item.appendChild(leftPart);
                    item.appendChild(amount);
                    
                    transactionsContainer.appendChild(item);
                });
            }
            
            // Show the container
            dailySummaryContainer.style.display = 'block';
        }
        // Ëé∑ÂèñÊúÄÊñ∞Ê±áÁéáÔºàÊ∑ªÂä†Âú®APIÁõ∏ÂÖ≥ÂáΩÊï∞ÈôÑËøëÔºåÁ∫¶3800Ë°åÂ∑¶Âè≥Ôºâ
async function fetchExchangeRates() {
    try {
        // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
        notify('üîÑ', 'Êõ¥Êñ∞ÂåØÁéá', 'Ê≠£Âú®ÂæûÁ∂≤Áµ°Áç≤ÂèñÊúÄÊñ∞ÂåØÁéá...');
        
        // ‰ΩøÁî®ÂºÄÊîæÁöÑÊ±áÁéáAPI - ÂèØËÉΩÈúÄË¶ÅÊõøÊç¢‰∏∫ÊÇ®ÊúâÊùÉÈôêÁöÑAPI
        const response = await fetch(`https://open.er-api.com/v6/latest/${baseCurrency}`);
        const data = await response.json();
        
        if (data && data.rates) {
            exchangeRates = data.rates;
            lastRateUpdate = new Date().toISOString();
            
            // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
            if (hasLocalStorage) {
                localStorage.setItem('finance_exchange_rates', JSON.stringify(exchangeRates));
                localStorage.setItem('finance_rate_update', lastRateUpdate);
            }
            
            notify('‚úÖ', 'ÂåØÁéáÂ∑≤Êõ¥Êñ∞', 'Â∑≤ÊàêÂäüÁç≤ÂèñÊúÄÊñ∞ÂåØÁéáË≥áÊñô');
            return true;
        } else {
            throw new Error('ÁÑ°Ê≥ïÁç≤ÂèñÂåØÁéáÊï∏Êìö');
        }
    } catch (error) {
        console.error('Error fetching exchange rates:', error);
        notify('‚ùå', 'ÂåØÁéáÊõ¥Êñ∞Â§±Êïó', 'ÁÑ°Ê≥ïÁç≤ÂèñÊúÄÊñ∞ÂåØÁéáÔºå‰ΩøÁî®ÁèæÊúâÂåØÁéáÊàñÈªòË™çÂÄº');
        
        // Â¶ÇÊûúÊ≤°ÊúâÊ±áÁéáÊï∞ÊçÆÔºåËÆæÁΩÆ‰∏Ä‰∫õÈªòËÆ§ÂÄº
        if (Object.keys(exchangeRates).length === 0) {
            setDefaultExchangeRates();
        }
        return false;
    }
}

// ËÆæÁΩÆÈªòËÆ§Ê±áÁéáÔºà‰Ωú‰∏∫Â§áÁî®Ôºâ
function setDefaultExchangeRates() {
    // ËÆæÁΩÆ‰∏Ä‰∫õÂ∏∏Áî®Ë¥ßÂ∏ÅÁöÑÈªòËÆ§Ê±áÁéáÔºàÁõ∏ÂØπ‰∫éTWDÔºâ
    exchangeRates = {
        'TWD': 1,
        'USD': 0.032,  // Á∫¶31 TWD = 1 USD
        'EUR': 0.029,  // Á∫¶34 TWD = 1 EUR
        'JPY': 4.44,   // Á∫¶0.23 TWD = 1 JPY
        'CNY': 0.22,   // Á∫¶4.5 TWD = 1 CNY
        'HKD': 0.25,   // Á∫¶4 TWD = 1 HKD
        'GBP': 0.025,  // Á∫¶40 TWD = 1 GBP
        'AUD': 0.043,  // Á∫¶23 TWD = 1 AUD
        'CAD': 0.044,  // Á∫¶23 TWD = 1 CAD
        'SGD': 0.042   // Á∫¶24 TWD = 1 SGD
    };
}

// Â∞ÜË¥ßÂ∏ÅËΩ¨Êç¢‰∏∫Âü∫ÂáÜË¥ßÂ∏Å
function convertToBaseCurrency(amount, fromCurrency) {
    if (!fromCurrency || fromCurrency === baseCurrency) {
        return amount;
    }
    
    // Ê£ÄÊü•ÊòØÂê¶ÊúâÊ±áÁéáÊï∞ÊçÆ
    if (!exchangeRates[fromCurrency]) {
        console.warn(`Êâæ‰∏çÂà∞ ${fromCurrency} ÁöÑÂåØÁéáÔºå‰ΩøÁî® 1:1 ÂåØÁéá`);
        return amount;
    }
    
    // Â∞ÜÈáëÈ¢ùËΩ¨Êç¢‰∏∫Âü∫ÂáÜË¥ßÂ∏Å
    return amount / exchangeRates[fromCurrency];
}

// Â∞ÜÂü∫ÂáÜË¥ßÂ∏ÅËΩ¨Êç¢‰∏∫ÁõÆÊ†áË¥ßÂ∏Å
function convertFromBaseCurrency(amount, toCurrency) {
    if (!toCurrency || toCurrency === baseCurrency) {
        return amount;
    }
    
    // Ê£ÄÊü•ÊòØÂê¶ÊúâÊ±áÁéáÊï∞ÊçÆ
    if (!exchangeRates[toCurrency]) {
        console.warn(`Êâæ‰∏çÂà∞ ${toCurrency} ÁöÑÂåØÁéáÔºå‰ΩøÁî® 1:1 ÂåØÁéá`);
        return amount;
    }
    
    // Â∞ÜÂü∫ÂáÜË¥ßÂ∏ÅÈáëÈ¢ùËΩ¨Êç¢‰∏∫ÁõÆÊ†áË¥ßÂ∏Å
    return amount * exchangeRates[toCurrency];
}
        
        // Search transactions with pagination and virtualization
        function searchTransactions() {
            searchLoadingIndicator.style.display = 'block';
            
            // Use setTimeout to allow UI to update before heavy processing
            setTimeout(() => {
                const startDateInput = document.getElementById('searchStartDate');
                const endDateInput = document.getElementById('searchEndDate');
                const typeSelect = document.getElementById('searchType');
                const categorySelect = document.getElementById('searchCategory');
                const noteInput = document.getElementById('searchNote'); // Êñ∞Â¢ûÔºöÂÇôË®ªÊêúÂ∞ãÊ¨Ñ‰Ωç
                
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                const type = typeSelect.value;
                const category = categorySelect.value;
                const noteKeyword = noteInput.value.trim().toLowerCase(); // Êñ∞Â¢ûÔºöÂÇôË®ªÈóúÈçµÂ≠ó
                
                // Filter transactions
                let filtered = [...transactions];
                
                // Filter by date range
                if (startDate) {
                    filtered = filtered.filter(t => t.date >= startDate);
                }
                
                if (endDate) {
                    // Include the entire end date
                    const endDateObj = new Date(endDate);
                    endDateObj.setHours(23, 59, 59, 999);
                    const formattedEndDate = formatDateForInput(endDateObj);
                    filtered = filtered.filter(t => t.date <= formattedEndDate);
                }
                
                // Filter by type
                if (type) {
                    filtered = filtered.filter(t => t.type === type);
                }
                
                // Filter by category
                if (category) {
                    filtered = filtered.filter(t => t.category === category);
                }
                
                // Êñ∞Â¢ûÔºöÁØ©ÈÅ∏ÂÇôË®ªÂÖßÂÆπ
                if (noteKeyword) {
                    filtered = filtered.filter(t => 
                        t.note && t.note.toLowerCase().includes(noteKeyword)
                    );
                }
                
                // Sort by date (newest first)
                filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Update pagination state
                paginationState.totalItems = filtered.length;
                paginationState.totalPages = appSettings.pageSize === -1 ? 1 : Math.ceil(filtered.length / paginationState.pageSize);
                paginationState.currentPage = 1;
                
                // Get current page items
                if (appSettings.pageSize === -1 || !appSettings.enableVirtualization) {
                    paginationState.currentItems = filtered;
                } else {
                    const startIndex = (paginationState.currentPage - 1) * paginationState.pageSize;
                    paginationState.currentItems = filtered.slice(startIndex, startIndex + paginationState.pageSize);
                }
                
                // Update search results
                updateSearchResults(paginationState.currentItems, filtered.length);
                
                // Hide loading indicator
                searchLoadingIndicator.style.display = 'none';
            }, 10);
        }
        
        // Update search results
        function updateSearchResults(results, totalCount) {
            const noResults = document.getElementById('noSearchResults');
            const resultsTable = document.getElementById('searchResults');
            const resultsList = document.getElementById('searchResultsList');
            const resultsCountEl = document.getElementById('resultsCount');
            
            if (results.length === 0) {
                noResults.style.display = 'block';
                resultsTable.style.display = 'none';
                return;
            }
            
            noResults.style.display = 'none';
            resultsTable.style.display = 'block';
            
            // Clear previous results
            resultsList.innerHTML = '';
            
            // Add each result
            results.forEach(transaction => {
                const row = document.createElement('tr');
                
                // Date
                const dateCell = document.createElement('td');
                dateCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                dateCell.textContent = formatDate(transaction.date);
                row.appendChild(dateCell);
                
                // Type
                const typeCell = document.createElement('td');
                typeCell.className = 'px-6 py-4 whitespace-nowrap';
                typeCell.textContent = transaction.type === 'income' ? 'üìà Êî∂ÂÖ•' : (transaction.type === 'expense' ? 'üìâ ÊîØÂá∫' : 'üîÑ ËΩâË≥¨');
                row.appendChild(typeCell);
                
                // Account
                const accountCell = document.createElement('td');
                accountCell.className = 'px-6 py-4 whitespace-nowrap';
                
                const account = getAccount(transaction.account);
                const accountName = account ? account.name : 'Êú™Áü•Êà∂Âè£';
                const currencyCode = account ? account.currency : appSettings.currency;
                
                accountCell.innerHTML = `${accountName} <span class="currency-label">${currencyCode}</span>`;
                row.appendChild(accountCell);
                
                // Category
                const categoryCell = document.createElement('td');
                categoryCell.className = 'px-6 py-4 whitespace-nowrap';
                categoryCell.textContent = transaction.category;
                row.appendChild(categoryCell);
                
                // Amount
                const amountCell = document.createElement('td');
                amountCell.className = 'px-6 py-4 whitespace-nowrap';
                
                // Get currency symbol for this account
                const currencySymbol = getAccountCurrencySymbol(transaction.account);
                
                if (transaction.type === 'income') {
                    amountCell.classList.add('text-green-600');
                    amountCell.classList.add('font-medium');
                } else if (transaction.type === 'expense') {
                    amountCell.classList.add('text-red-600');
                    amountCell.classList.add('font-medium');
                } else {
                    amountCell.classList.add('text-blue-600');
                    amountCell.classList.add('font-medium');
                }
                amountCell.textContent = currencySymbol + formatNumber(transaction.amount);
                row.appendChild(amountCell);
                
                // Note
                const noteCell = document.createElement('td');
                noteCell.className = 'px-6 py-4 whitespace-nowrap text-gray-500';
                noteCell.textContent = transaction.note || '-';
                row.appendChild(noteCell);
                
                // Receipt
                const receiptCell = document.createElement('td');
                receiptCell.className = 'px-6 py-4 whitespace-nowrap text-center';
                if (transaction.receipt) {
                    const viewBtn = document.createElement('button');
                    viewBtn.className = 'text-primary hover:text-primary-dark';
                    viewBtn.innerHTML = '<i class="fas fa-image"></i>';
                    viewBtn.addEventListener('click', () => {
                        showReceiptImage(transaction.receipt);
                    });
                    receiptCell.appendChild(viewBtn);
                } else {
                    receiptCell.textContent = '-';
                }
                row.appendChild(receiptCell);
                
                // Action
                const actionCell = document.createElement('td');
                actionCell.className = 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-600 hover:text-red-900';
                deleteBtn.textContent = 'Âà™Èô§';
                deleteBtn.addEventListener('click', () => deleteTransaction(transaction.id));
                
                actionCell.appendChild(deleteBtn);
                row.appendChild(actionCell);
                
                resultsList.appendChild(row);
            });
            
            // Update results count
            if (appSettings.pageSize !== -1 && appSettings.enableVirtualization) {
                resultsCountEl.textContent = `È°ØÁ§∫ ${results.length} Á≠Ü‰∫§ÊòìË®òÈåÑÔºàÂÖ± ${totalCount} Á≠ÜÔºâ`;
            } else {
                resultsCountEl.textContent = `È°ØÁ§∫ ${results.length} Á≠Ü‰∫§ÊòìË®òÈåÑ`;
            }
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Close modal buttons
            document.querySelectorAll('.close').forEach(closeBtn => {
                closeBtn.addEventListener('click', event => {
                    const modal = event.target.closest('.modal');
                    closeModal(modal.id);
                });
            });
            
            // New day button
            document.getElementById('newDayBtn').addEventListener('click', startNewDay);
            
            // Settings button
            document.getElementById('settingsBtn').addEventListener('click', () => {
                updateSettingsModal();
                openModal('settingsModal');
            });
            
            // Import/Export button
            document.getElementById('importExportBtn').addEventListener('click', () => {
                document.getElementById('exportDataArea').value = exportData();
                document.getElementById('importDataArea').value = '';
                openModal('importExportModal');
            });
            
            // Google Sign-in button
            document.getElementById('googleSignInBtn').addEventListener('click', function() {
                // Ê™¢Êü• API ÊòØÂê¶Â∑≤ÂàùÂßãÂåñ
                if (!googleApiInitialized) {
                    // Â¶ÇÊûúÈ°ØÁ§∫ÁöÑÊòØÈáçË©¶ÊåâÈàïÔºåÂâáÂòóË©¶ÈáçÊñ∞ÂàùÂßãÂåñ
                    if (this.innerHTML.includes('ÈáçË©¶')) {
                        notify('üîÑ', 'Ê≠£Âú®ÈáçÊñ∞ÂàùÂßãÂåñ', 'Google API Ê≠£Âú®ÈáçÊñ∞ÂàùÂßãÂåñ...');
                        initGoogleApi(); // ÈáçÊñ∞ÂàùÂßãÂåñ
                        return;
                    }
                    notify('‚ùå', 'Google API Â∞öÊú™ÂàùÂßãÂåñ', 'Ë´ãÁ®çÂæåÂÜçË©¶ÔºåÊàñÈªûÊìäÈáçË©¶ÊåâÈàï');
                    this.innerHTML = '<i class="fas fa-sync mr-2"></i> ÈáçË©¶ Google ÁôªÂÖ•';
                    return;
                }
                
                // API Â∑≤ÂàùÂßãÂåñÔºåÂèØ‰ª•ÁôªÂÖ•
                signInToGoogle();
            });
            
            // Google Sign-out button
            document.getElementById('googleSignOutBtn').addEventListener('click', signOutFromGoogle);
            
            // Save to Google Drive button
            document.getElementById('saveToDriveBtn').addEventListener('click', saveToGoogleDrive);
            
            // Load from Google Drive button
            document.getElementById('loadFromDriveBtn').addEventListener('click', loadFromGoogleDrive);
            
            // Copy export data button
            document.getElementById('copyExportBtn').addEventListener('click', () => {
                const exportArea = document.getElementById('exportDataArea');
                exportArea.select();
                document.execCommand('copy');
                notify('‚úÖ', 'Â∑≤Ë§áË£Ω', 'Êï∏ÊìöÂ∑≤ÊàêÂäüË§áË£ΩÂà∞Ââ™Ë≤ºÊùø');
            });
            
            // Download export data button
            document.getElementById('downloadExportBtn').addEventListener('click', () => {
                const exportData = document.getElementById('exportDataArea').value;
                const blob = new Blob([exportData], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `finance_data_${formatDateForFilename(new Date())}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                notify('‚úÖ', 'Â∑≤‰∏ãËºâ', 'Êï∏ÊìöÊñá‰ª∂Â∑≤ÊàêÂäü‰∏ãËºâ');
            });
            
            // Upload import file button
            document.getElementById('uploadImportBtn').addEventListener('click', () => {
                document.getElementById('importFile').click();
            });
            
            // Import file change
            document.getElementById('importFile').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('importDataArea').value = event.target.result;
                };
                reader.readAsText(file);
            });
            
            // Import data button
            document.getElementById('importDataBtn').addEventListener('click', () => {
                const importArea = document.getElementById('importDataArea');
                const result = importData(importArea.value);
                if (result) {
                    closeModal('importExportModal');
                    notify('‚úÖ', 'ÂåØÂÖ•ÊàêÂäü', 'Êï∏ÊìöÂ∑≤ÊàêÂäüÂåØÂÖ•');
                }
            });
            
            // Âú®‰øùÂ≠òËÆæÁΩÆÊåâÈíÆÁöÑÂ§ÑÁêÜÂáΩÊï∞‰∏≠ÔºàÁ∫¶4305Ë°åÂ∑¶Âè≥Ôºâ
document.getElementById('saveSettingsBtn').addEventListener('click', () => {
    const currency = document.getElementById('currencySelect').value;
    const currencySymbol = document.getElementById('currencySymbolInput').value || currencySymbols[currency] || '$';
    const syncRemindersEnabled = document.getElementById('enableSyncReminders').checked;
    const theme = document.getElementById('themeSelect').value;
    const enableVirtualization = document.getElementById('enableVirtualization').checked;
    const pageSize = parseInt(document.getElementById('pageSize').value);
    
    // ‰øÆÊîπÂ∫îÁî®ËÆæÁΩÆ
    appSettings.currency = currency;
    appSettings.currencySymbol = currencySymbol;
    appSettings.syncRemindersEnabled = syncRemindersEnabled;
    appSettings.theme = theme;
    appSettings.enableVirtualization = enableVirtualization;
    appSettings.pageSize = pageSize;
    
    // Êõ¥Êñ∞Âü∫ÂáÜË¥ßÂ∏ÅÔºàÂ¶ÇÊûúÂèëÁîüÂèòÂåñÔºâ
    if (baseCurrency !== document.getElementById('baseCurrencySelect').value) {
        baseCurrency = document.getElementById('baseCurrencySelect').value;
        // Êõ¥Êñ∞Ê±áÁéá
        fetchExchangeRates();
    }
    
    saveData('appSettings');
    
    // ‰øùÂ≠òÊ±áÁéáÊï∞ÊçÆ
    if (hasLocalStorage) {
        localStorage.setItem('finance_exchange_rates', JSON.stringify(exchangeRates));
        localStorage.setItem('finance_rate_update', lastRateUpdate);
    }
    
    updateCurrencyDisplay();
    applyTheme();
    applyVirtualizationSettings();
    updateUI();
    
    closeModal('settingsModal');
    notify('‚úÖ', 'Ë®≠ÂÆöÂ∑≤‰øùÂ≠ò', 'ÊÇ®ÁöÑË®≠ÂÆöÂ∑≤ÊàêÂäüÊõ¥Êñ∞');
    
    // Âà∑Êñ∞ÊêúÁ¥¢ÁªìÊûú
    searchTransactions();
});
            
            // Reset app button
            document.getElementById('resetAppBtn').addEventListener('click', () => {
                if (confirm('Ë≠¶ÂëäÔºöÈÄôÂ∞áÂà™Èô§ÊâÄÊúâÊï∏ÊìöÔºÅÊÇ®Á¢∫ÂÆöË¶ÅÈáçÁΩÆÊáâÁî®Á®ãÂºèÂóéÔºü')) {
                    initDefaultData();
                    saveData();
                    
                    updateCurrencyDisplay();
                    updateUI();
                    searchTransactions();
                    generateFinancialAdvice();
                    
                    closeModal('settingsModal');
                    notify('üîÑ', 'ÊáâÁî®Â∑≤ÈáçÁΩÆ', 'ÊáâÁî®Á®ãÂºèÂ∑≤ÊÅ¢Âæ©Âà∞ÂàùÂßãÁãÄÊÖã');
                }
            });
            
            // Close sync reminder
            document.getElementById('closeSyncReminder').addEventListener('click', () => {
                syncReminder.style.display = 'none';
                // Update last reminder time so it doesn't show again too soon
                appSettings.lastSyncReminder = new Date().toISOString();
                saveData('appSettings');
            });
            
            // Close summary modal button
            document.getElementById('closeSummaryBtn').addEventListener('click', () => {
                closeModal('dailySummaryModal');
            });
            
            // Go to budget tab button
            document.getElementById('goBudgetBtn').addEventListener('click', () => switchTab('budget'));
            
            // View all transactions button
            document.getElementById('viewAllTransactionsBtn').addEventListener('click', () => switchTab('stats'));
            
            // View summary button
            document.getElementById('viewSummaryBtn').addEventListener('click', () => {
                const date = document.getElementById('summaryDate').value;
                if (!date) {
                    notify('‚ùå', 'Ë´ãÈÅ∏ÊìáÊó•Êúü', 'Ë´ãÈÅ∏ÊìáË¶ÅÊü•ÁúãÊëòË¶ÅÁöÑÊó•Êúü');
                    return;
                }
                
                showDailySummaryInPage(date);
            });
            
            // Transaction type buttons
            document.getElementById('incomeBtn').addEventListener('click', () => {
                transactionType = 'income';
                updateTransactionTypeUI();
                updateTransactionCategories();
            });
            
            document.getElementById('expenseBtn').addEventListener('click', () => {
                transactionType = 'expense';
                updateTransactionTypeUI();
                updateTransactionCategories();
            });
            
            // New category type buttons
            document.getElementById('newCategoryIncomeBtn').addEventListener('click', () => {
                selectedCategoryType = 'income';
                updateNewCategoryTypeUI();
            });
            
            document.getElementById('newCategoryExpenseBtn').addEventListener('click', () => {
                selectedCategoryType = 'expense';
                updateNewCategoryTypeUI();
            });
            
            // Add threshold button
            document.getElementById('addThresholdBtn').addEventListener('click', () => {
                budget.thresholds.push(50); // Default new threshold
                budget.thresholds.sort((a, b) => b - a); // Sort in descending order
                saveData('budget');
                updateBudgetThresholds();
            });
            
            // Add category budget button
            document.getElementById('addCategoryBudgetBtn').addEventListener('click', () => {
                const categorySelect = document.getElementById('categoryForBudget');
                const amountInput = document.getElementById('categoryBudgetAmount');
                
                const category = categorySelect.value;
                const amount = parseFloat(amountInput.value);
                
                if (!category) {
                    notify('‚ùå', 'Ë´ãÈÅ∏ÊìáÈ°ûÂà•', 'Ë´ãÈÅ∏ÊìáË¶ÅË®≠ÂÆöÈ†êÁÆóÁöÑÈ°ûÂà•');
                    return;
                }
                
                if (isNaN(amount) || amount <= 0) {
                    notify('‚ùå', 'ÁÑ°ÊïàÈáëÈ°ç', 'Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÈ†êÁÆóÈáëÈ°ç');
                    return;
                }
                
                // Check if category budget already exists
                const existingIndex = categoryBudgets.findIndex(b => b.category === category);
                if (existingIndex !== -1) {
                    // Update existing
                    categoryBudgets[existingIndex].amount = amount;
                    notify('‚úÖ', 'Â∑≤Êõ¥Êñ∞', `${category} ÁöÑÈ†êÁÆóÂ∑≤Êõ¥Êñ∞ÁÇ∫ ${appSettings.currencySymbol}${formatNumber(amount)}`);
                } else {
                    // Add new
                    categoryBudgets.push({ category, amount });
                    notify('‚úÖ', 'Â∑≤Ê∑ªÂä†', `Â∑≤ÁÇ∫ ${category} Ë®≠ÂÆöÈ†êÁÆó ${appSettings.currencySymbol}${formatNumber(amount)}`);
                }
                
                saveData('categoryBudgets');
                updateCategoryBudgetItems();
                updateCategoryBudgetsOnDashboard();
                // Êõ¥Êñ∞ÊÄªÈ¢ÑÁÆóÊòæÁ§∫
updateTotalBudgetDisplay();
                
                // Reset inputs
                categorySelect.value = '';
                amountInput.value = '';
            });
            
            // Save daily summary timing
            document.getElementById('dailySummaryTiming').addEventListener('change', function() {
                appSettings.dailySummaryTiming = this.value;
                saveData('appSettings');
            });
            
            // Add account button
            document.getElementById('addAccountBtn').addEventListener('click', addAccount);
            
            // Add category button
            document.getElementById('addCategoryBtn').addEventListener('click', () => {
                document.getElementById('newCategoryName').value = '';
                updateNewCategoryTypeUI();
                openModal('newCategoryModal');
            });
            
            // Add category confirm button
            document.getElementById('addCategoryConfirmBtn').addEventListener('click', addCategory);
            
            // Êñ∞Â¢ûÈ°ûÂà•È†ÅÈù¢ÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®
            document.getElementById('addIncomeCategoryBtn').addEventListener('click', () => {
                const categoryName = document.getElementById('newIncomeCategoryName').value.trim();
                if (categoryName) {
                    addCategoryByType('income', categoryName);
                    document.getElementById('newIncomeCategoryName').value = '';
                } else {
                    notify('‚ùå', 'Ë´ãËº∏ÂÖ•È°ûÂà•ÂêçÁ®±', 'È°ûÂà•ÂêçÁ®±‰∏çËÉΩÁÇ∫Á©∫');
                }
            });
            
            document.getElementById('addExpenseCategoryBtn').addEventListener('click', () => {
                const categoryName = document.getElementById('newExpenseCategoryName').value.trim();
                if (categoryName) {
                    addCategoryByType('expense', categoryName);
                    document.getElementById('newExpenseCategoryName').value = '';
                } else {
                    notify('‚ùå', 'Ë´ãËº∏ÂÖ•È°ûÂà•ÂêçÁ®±', 'È°ûÂà•ÂêçÁ®±‰∏çËÉΩÁÇ∫Á©∫');
                }
            });
            
            // Transfer money button
            document.getElementById('transferBtn').addEventListener('click', transferMoney);
            
            // Save transaction button
            document.getElementById('saveTransactionBtn').addEventListener('click', addTransaction);
            
            // Save budget button
            document.getElementById('saveBudgetBtn').addEventListener('click', saveBudget);
            
            // Search button
            document.getElementById('searchBtn').addEventListener('click', debounce(searchTransactions, 300));
            
            // Budget cycle change
            document.getElementById('budgetCycle').addEventListener('change', updateBudgetResetDayOptions);
            
            // Click outside modal to close
            window.addEventListener('click', event => {
                if (event.target.classList.contains('modal')) {
                    closeModal(event.target.id);
                }
            });
            
            // Add scroll event listener for virtual scrolling
            document.querySelector('.virtual-scroll-container').addEventListener('scroll', debounce(() => {
                if (!appSettings.enableVirtualization || appSettings.pageSize === -1) return;
                
                const container = document.querySelector('.virtual-scroll-container');
                if (container.scrollTop + container.clientHeight >= container.scrollHeight - 200) {
                    // Near bottom, load more results if available
                    if (paginationState.currentPage < paginationState.totalPages) {
                        loadMoreResults();
                    }
                }
            }, 200));
            
            document.getElementById('updateRatesBtn').addEventListener('click', fetchExchangeRates);
    
    // ÊòæÁ§∫/ÈöêËóèÊ±áÁéáÊåâÈíÆ
    document.getElementById('toggleRatesBtn').addEventListener('click', function() {
        const ratesList = document.getElementById('exchangeRatesList');
        ratesList.classList.toggle('hidden');
    });
    
    // Âü∫ÂáÜË¥ßÂ∏ÅÊõ¥Êîπ
    document.getElementById('baseCurrencySelect').addEventListener('change', function() {
        baseCurrency = this.value;
        // Êõ¥Êñ∞Ê±áÁéáÊï∞ÊçÆ
        fetchExchangeRates();
    });
        }
        
        // Add a category by type (from the categories tab)
        function addCategoryByType(type, name) {
    // Ê™¢Êü•È°ûÂà•ÊòØÂê¶Â∑≤Â≠òÂú®
    if (categories[type].includes(name)) {
        notify('‚ùå', 'È°ûÂà•Â∑≤Â≠òÂú®', `„Äå${name}„ÄçÈ°ûÂà•Â∑≤Á∂ìÂ≠òÂú®„ÄÇ`);
        return;
    }
    
    // Êñ∞Â¢ûÈ°ûÂà•
    categories[type].push(name);
    
    // Âè™ÊúâÂΩìÊ∑ªÂä†ÁöÑÊòØÊîØÂá∫Á±ªÂà´Êó∂ÔºåÊâçÂêåÊó∂Ê∑ªÂä†Âà∞Êî∂ÂÖ•Á±ªÂà´
    if (type === 'expense' && !categories['income'].includes(name)) {
        categories['income'].push(name);
        notify('‚ÑπÔ∏è', 'È°ûÂà•Â∑≤ÂêåÊ≠•', `„Äå${name}„ÄçÈ°ûÂà•Â∑≤ÂêåÊôÇÊñ∞Â¢ûËá≥Êî∂ÂÖ•È°ûÂà•‰∏≠„ÄÇ`);
    }
    
    saveData('categories');
    
    // Êõ¥Êñ∞ UI
    updateCategoriesManagement();
    updateTransactionCategories();
    updateStatisticsCategories();
    updateCategoryBudgetDropdown();
    
    notify('‚úÖ', 'È°ûÂà•Â∑≤Êñ∞Â¢û', `Â∑≤ÊàêÂäüÊñ∞Â¢û„Äå${name}„ÄçÈ°ûÂà•„ÄÇ`);
}
        
        // Delete a category
        function deleteCategory(type, name) {
            // Ê™¢Êü•ÊòØÂê¶Êúâ‰ΩøÁî®Ë©≤È°ûÂà•ÁöÑ‰∫§Êòì
            const hasCategoryTransactions = transactions.some(t => t.category === name);
            
            if (hasCategoryTransactions) {
                notify('‚ùå', 'ÁÑ°Ê≥ïÂà™Èô§È°ûÂà•', `„Äå${name}„ÄçÈ°ûÂà•ÊúâÁõ∏Èóú‰∫§ÊòìË®òÈåÑÔºåÁÑ°Ê≥ïÂà™Èô§„ÄÇ`);
                return;
            }
            
            // Ê™¢Êü•ÊòØÂê¶ÊúâË©≤È°ûÂà•ÁöÑÈ†êÁÆó
            const hasCategoryBudget = categoryBudgets.some(b => b.category === name);
            
            if (hasCategoryBudget) {
                notify('‚ùå', 'ÁÑ°Ê≥ïÂà™Èô§È°ûÂà•', `„Äå${name}„ÄçÈ°ûÂà•ÊúâÁõ∏ÈóúÈ†êÁÆóË®≠ÂÆöÔºåË´ãÂÖàÂà™Èô§È†êÁÆóË®≠ÂÆö„ÄÇ`);
                return;
            }
            
            // ÁßªÈô§È°ûÂà•
            categories[type] = categories[type].filter(c => c !== name);
            saveData('categories');
            
            // Êõ¥Êñ∞ UI
            updateCategoriesManagement();
            updateTransactionCategories();
            updateStatisticsCategories();
            updateCategoryBudgetDropdown();
            
            notify('üóëÔ∏è', 'È°ûÂà•Â∑≤Âà™Èô§', `Â∑≤ÊàêÂäüÂà™Èô§„Äå${name}„ÄçÈ°ûÂà•„ÄÇ`);
        }
        
        // Load more search results (for virtualization)
        function loadMoreResults() {
            if (paginationState.currentPage >= paginationState.totalPages) return;
            
            // Show loading indicator
            searchLoadingIndicator.style.display = 'block';
            
            // Use setTimeout to prevent UI blocking
            setTimeout(() => {
                paginationState.currentPage++;
                
                // Filter transactions (same as searchTransactions but using current filters)
                const startDateInput = document.getElementById('searchStartDate');
                const endDateInput = document.getElementById('searchEndDate');
                const typeSelect = document.getElementById('searchType');
                const categorySelect = document.getElementById('searchCategory');
                const noteInput = document.getElementById('searchNote'); // Êñ∞Â¢ûÔºöÂÇôË®ªÊêúÂ∞ãÊ¨Ñ‰Ωç
                
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                const type = typeSelect.value;
                const category = categorySelect.value;
                const noteKeyword = noteInput.value.trim().toLowerCase(); // Êñ∞Â¢ûÔºöÂÇôË®ªÈóúÈçµÂ≠ó
                
                let filtered = [...transactions];
                
                if (startDate) {
                    filtered = filtered.filter(t => t.date >= startDate);
                }
                
                if (endDate) {
                    const endDateObj = new Date(endDate);
                    endDateObj.setHours(23, 59, 59, 999);
                    const formattedEndDate = formatDateForInput(endDateObj);
                    filtered = filtered.filter(t => t.date <= formattedEndDate);
                }
                
                if (type) {
                    filtered = filtered.filter(t => t.type === type);
                }
                
                if (category) {
                    filtered = filtered.filter(t => t.category === category);
                }
                
                // Êñ∞Â¢ûÔºöÁØ©ÈÅ∏ÂÇôË®ªÂÖßÂÆπ
                if (noteKeyword) {
                    filtered = filtered.filter(t => 
                        t.note && t.note.toLowerCase().includes(noteKeyword)
                    );
                }
                
                filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Get next page items
                const startIndex = (paginationState.currentPage - 1) * paginationState.pageSize;
                const newItems = filtered.slice(startIndex, startIndex + paginationState.pageSize);
                
                // Append new items to results list
                appendSearchResults(newItems, filtered.length);
                
                // Hide loading indicator
                searchLoadingIndicator.style.display = 'none';
            }, 10);
        }
        
        // Append more search results without clearing the existing ones
        function appendSearchResults(results, totalCount) {
            if (results.length === 0) return;
            
            const resultsList = document.getElementById('searchResultsList');
            const resultsCountEl = document.getElementById('resultsCount');
            
            // Add each result
            results.forEach(transaction => {
                const row = document.createElement('tr');
                
                // Date
                const dateCell = document.createElement('td');
                dateCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
                dateCell.textContent = formatDate(transaction.date);
                row.appendChild(dateCell);
                
                // Type
                const typeCell = document.createElement('td');
                typeCell.className = 'px-6 py-4 whitespace-nowrap';
                typeCell.textContent = transaction.type === 'income' ? 'üìà Êî∂ÂÖ•' : (transaction.type === 'expense' ? 'üìâ ÊîØÂá∫' : 'üîÑ ËΩâË≥¨');
                row.appendChild(typeCell);
                
                // Account
                const accountCell = document.createElement('td');
                accountCell.className = 'px-6 py-4 whitespace-nowrap';
                
                const account = getAccount(transaction.account);
                const accountName = account ? account.name : 'Êú™Áü•Êà∂Âè£';
                const currencyCode = account ? account.currency : appSettings.currency;
                
                accountCell.innerHTML = `${accountName} <span class="currency-label">${currencyCode}</span>`;
                row.appendChild(accountCell);
                
                // Category
                const categoryCell = document.createElement('td');
                categoryCell.className = 'px-6 py-4 whitespace-nowrap';
                categoryCell.textContent = transaction.category;
                row.appendChild(categoryCell);
                
                // Amount
                const amountCell = document.createElement('td');
                amountCell.className = 'px-6 py-4 whitespace-nowrap';
                
                // Get currency symbol for this account
                const currencySymbol = getAccountCurrencySymbol(transaction.account);
                
                if (transaction.type === 'income') {
                    amountCell.classList.add('text-green-600');
                    amountCell.classList.add('font-medium');
                } else if (transaction.type === 'expense') {
                    amountCell.classList.add('text-red-600');
                    amountCell.classList.add('font-medium');
                } else {
                    amountCell.classList.add('text-blue-600');
                    amountCell.classList.add('font-medium');
                }
                amountCell.textContent = currencySymbol + formatNumber(transaction.amount);
                row.appendChild(amountCell);
                
                // Note
                const noteCell = document.createElement('td');
                noteCell.className = 'px-6 py-4 whitespace-nowrap text-gray-500';
                noteCell.textContent = transaction.note || '-';
                row.appendChild(noteCell);
                
                // Receipt
                const receiptCell = document.createElement('td');
                receiptCell.className = 'px-6 py-4 whitespace-nowrap text-center';
                if (transaction.receipt) {
                    const viewBtn = document.createElement('button');
                    viewBtn.className = 'text-primary hover:text-primary-dark';
                    viewBtn.innerHTML = '<i class="fas fa-image"></i>';
                    viewBtn.addEventListener('click', () => {
                        showReceiptImage(transaction.receipt);
                    });
                    receiptCell.appendChild(viewBtn);
                } else {
                    receiptCell.textContent = '-';
                }
                row.appendChild(receiptCell);
                
                // Action
                const actionCell = document.createElement('td');
                actionCell.className = 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-600 hover:text-red-900';
                deleteBtn.textContent = 'Âà™Èô§';
                deleteBtn.addEventListener('click', () => deleteTransaction(transaction.id));
                
                actionCell.appendChild(deleteBtn);
                row.appendChild(actionCell);
                
                resultsList.appendChild(row);
            });
            
            // Update results count
            const currentDisplayedCount = paginationState.currentPage * paginationState.pageSize;
            const displayCount = Math.min(currentDisplayedCount, totalCount);
            
            resultsCountEl.textContent = `È°ØÁ§∫ ${displayCount} Á≠Ü‰∫§ÊòìË®òÈåÑÔºàÂÖ± ${totalCount} Á≠ÜÔºâ`;
        }
        
        // Switch tabs
        function switchTab(tabId) {
            // Update tab buttons
            tabButtons.forEach(button => {
                const buttonTabId = button.getAttribute('data-tab');
                if (buttonTabId === tabId) {
                    button.classList.add('text-primary', 'border-primary');
                    button.classList.remove('text-gray-500', 'hover:text-gray-700', 'border-transparent');
                } else {
                    button.classList.remove('text-primary', 'border-primary');
                    button.classList.add('text-gray-500', 'hover:text-gray-700', 'border-transparent');
                }
            });
            
            // Update tab contents
            tabContents.forEach(content => {
                if (content.id === tabId) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            
            // Specific actions for certain tabs
            if (tabId === 'transactions') {
                // Reset new transaction form when switching to transactions tab
                document.getElementById('transactionAccount').value = '';
                document.getElementById('transactionCategory').value = '';
                document.getElementById('transactionAmount').value = '';
                document.getElementById('transactionDate').value = getTodayFormatted();
                document.getElementById('transactionNote').value = '';
                document.getElementById('enableReceiptUpload').checked = false;
                document.getElementById('receiptUploadContainer').style.display = 'none';
                document.getElementById('receiptImage').value = '';
                document.getElementById('receiptPreview').style.display = 'none';
                
                // Keep transaction type
                updateTransactionTypeUI();
                updateTransactionCategories();
            } else if (tabId === 'advice') {
                // Regenerate advice when switching to the advice tab
                generateFinancialAdvice();
                
                // Set summary date to today
                document.getElementById('summaryDate').value = getTodayFormatted();
                document.getElementById('dailySummaryContainer').style.display = 'none';
            } else if (tabId === 'stats') {
                // Reset pagination state when switching to stats tab
                paginationState.currentPage = 1;
                searchTransactions();
            }
        }
        
        // Open a modal
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'block';
        }
        
        // Close a modal
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
        }
        
        // Apply theme based on settings
        function applyTheme() {
            const theme = appSettings.theme;
            
            if (theme === 'system') {
                // Follow system preference
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                
                // Listen for changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    if (appSettings.theme === 'system') {
                        if (event.matches) {
                            document.documentElement.classList.add('dark');
                        } else {
                            document.documentElement.classList.remove('dark');
                        }
                    }
                });
            } else if (theme === 'dark') {
                // Force dark mode
                document.documentElement.classList.add('dark');
            } else {
                // Force light mode
                document.documentElement.classList.remove('dark');
            }
        }
        
        // Update transaction type UI
        function updateTransactionTypeUI() {
            const incomeBtn = document.getElementById('incomeBtn');
            const expenseBtn = document.getElementById('expenseBtn');
            
            if (transactionType === 'income') {
                incomeBtn.classList.remove('bg-gray-200', 'text-gray-700');
                incomeBtn.classList.add('bg-green-500', 'text-white');
                expenseBtn.classList.remove('bg-red-500', 'text-white');
                expenseBtn.classList.add('bg-gray-200', 'text-gray-700');
            } else {
                incomeBtn.classList.remove('bg-green-500', 'text-white');
                incomeBtn.classList.add('bg-gray-200', 'text-gray-700');
                expenseBtn.classList.remove('bg-gray-200', 'text-gray-700');
                expenseBtn.classList.add('bg-red-500', 'text-white');
            }
        }
        
        // Update new category type UI
        function updateNewCategoryTypeUI() {
            const incomeBtn = document.getElementById('newCategoryIncomeBtn');
            const expenseBtn = document.getElementById('newCategoryExpenseBtn');
            
            if (selectedCategoryType === 'income') {
                incomeBtn.classList.remove('bg-gray-200', 'text-gray-700');
                incomeBtn.classList.add('bg-green-500', 'text-white');
                expenseBtn.classList.remove('bg-red-500', 'text-white');
                expenseBtn.classList.add('bg-gray-200', 'text-gray-700');
            } else {
                incomeBtn.classList.remove('bg-green-500', 'text-white');
                incomeBtn.classList.add('bg-gray-200', 'text-gray-700');
                expenseBtn.classList.remove('bg-gray-200', 'text-gray-700');
                expenseBtn.classList.add('bg-red-500', 'text-white');
            }
        }
        
        // Add an account
        function addAccount() {
            const nameInput = document.getElementById('newAccountName');
            const balanceInput = document.getElementById('newAccountBalance');
            const currencySelect = document.getElementById('newAccountCurrency');
            
            const name = nameInput.value.trim();
            const balance = parseFloat(balanceInput.value);
            const currency = currencySelect.value;
            
            if (!name || isNaN(balance)) {
                notify('‚ùå', 'Êñ∞Â¢ûÊà∂Âè£Â§±Êïó', 'Ë´ãÂ°´ÂØ´ÂÆåÊï¥ÁöÑÊà∂Âè£Ë≥áÊñô„ÄÇ');
                return;
            }
            
            const newAccount = {
                id: generateId(),
                name: name,
                balance: balance,
                icon: selectedIcon,
                currency: currency // Add currency to account
            };
            
            accounts.push(newAccount);
            saveData('accounts');
            
            closeModal('newAccountModal');
            updateAccountsTab();
            updateAccountDropdowns();
            updateDashboard();
            
            notify('‚úÖ', 'Êà∂Âè£Â∑≤Êñ∞Â¢û', `„Äå${name}„ÄçÊà∂Âè£Â∑≤ÊàêÂäüÊñ∞Â¢û„ÄÇ`);
        }
        
        // Delete an account
        function deleteAccount(accountId) {
            const accountName = getAccountName(accountId);
            
            // Check if there are transactions using this account
            const hasTransactions = transactions.some(t => t.account === accountId);
            
            if (hasTransactions) {
                notify('‚ùå', 'ÁÑ°Ê≥ïÂà™Èô§Êà∂Âè£', `„Äå${accountName}„ÄçÊà∂Âè£ÊúâÁõ∏Èóú‰∫§ÊòìË®òÈåÑÔºåÁÑ°Ê≥ïÂà™Èô§„ÄÇ`);
                return;
            }
            
            accounts = accounts.filter(a => a.id !== accountId);
            saveData('accounts');
            
            updateAccountsTab();
            updateAccountDropdowns();
            updateDashboard();
            
            notify('üóëÔ∏è', 'Êà∂Âè£Â∑≤Âà™Èô§', `„Äå${accountName}„ÄçÊà∂Âè£Â∑≤ÊàêÂäüÂà™Èô§„ÄÇ`);
        }
        
        // Add a category
        function addCategory() {
            const nameInput = document.getElementById('newCategoryName');
            const name = nameInput.value.trim();
            
            if (!name) {
                notify('‚ùå', 'Êñ∞Â¢ûÈ°ûÂà•Â§±Êïó', 'Ë´ãËº∏ÂÖ•È°ûÂà•ÂêçÁ®±„ÄÇ');
                return;
            }
            
            // Check if category already exists
            if (categories[selectedCategoryType].includes(name)) {
                notify('‚ùå', 'È°ûÂà•Â∑≤Â≠òÂú®', `„Äå${name}„ÄçÈ°ûÂà•Â∑≤Á∂ìÂ≠òÂú®„ÄÇ`);
                return;
            }
            
            categories[selectedCategoryType].push(name);
            saveData('categories');
            
            closeModal('newCategoryModal');
            updateTransactionCategories();
            updateStatisticsCategories();
            updateCategoryBudgetDropdown();
            updateCategoriesManagement();
            
            // If adding a category while in transaction form, select it
            if (transactionType === selectedCategoryType) {
                const categorySelect = document.getElementById('transactionCategory');
                const newOption = document.createElement('option');
                newOption.value = name;
                newOption.textContent = name;
                categorySelect.appendChild(newOption);
                categorySelect.value = name;
            }
            
            notify('‚úÖ', 'È°ûÂà•Â∑≤Êñ∞Â¢û', 'Êñ∞È°ûÂà•Â∑≤ÊàêÂäüÊñ∞Â¢û„ÄÇ');
        }
        
        // Transfer money between accounts
        function transferMoney() {
            const fromSelect = document.getElementById('transferFrom');
            const toSelect = document.getElementById('transferTo');
            const amountInput = document.getElementById('transferAmount');
            
            const fromId = fromSelect.value;
            const toId = toSelect.value;
            const amount = parseFloat(amountInput.value);
            
            if (!fromId || !toId || isNaN(amount) || amount <= 0 || fromId === toId) {
                notify('‚ùå', 'ËΩâË≥¨Â§±Êïó', 'Ë´ãÂ°´ÂØ´ÊúâÊïàÁöÑËΩâË≥¨Ë≥áÊñô„ÄÇ');
                return;
            }
            
            // Find accounts
            const fromAccountIndex = accounts.findIndex(a => a.id === fromId);
            const toAccountIndex = accounts.findIndex(a => a.id === toId);
            
            if (fromAccountIndex === -1 || toAccountIndex === -1) {
                notify('‚ùå', 'ËΩâË≥¨Â§±Êïó', 'Êâæ‰∏çÂà∞ÊåáÂÆöÁöÑÊà∂Âè£„ÄÇ');
                return;
            }
            
            // Check if from account has enough balance
            if (accounts[fromAccountIndex].balance < amount) {
                notify('‚ùå', 'ËΩâË≥¨Â§±Êïó', 'È§òÈ°ç‰∏çË∂≥„ÄÇ');
                return;
            }
            
            // Check if currencies are different (for future currency conversion implementation)
            const fromCurrency = accounts[fromAccountIndex].currency;
            const toCurrency = accounts[toAccountIndex].currency;
            
            if (fromCurrency !== toCurrency) {
                // In future, could implement currency conversion here
                notify('‚ö†Ô∏è', '‰∏çÂêåË≤®Âπ£ËΩâË≥¨', `Âæû ${fromCurrency} ËΩâËá≥ ${toCurrency}ÔºåÁÑ°ÂåØÁéáËΩâÊèõ`);
            }
            
            // Update balances
            accounts[fromAccountIndex].balance -= amount;
            accounts[toAccountIndex].balance += amount;
            
            // Record transaction
            const now = new Date();
            const fromAccountName = accounts[fromAccountIndex].name;
            const toAccountName = accounts[toAccountIndex].name;
            
            transactions.push({
                id: generateId(),
                type: 'transfer',
                account: fromId,
                toAccount: toId,
                amount: amount,
                date: getTransactionDate(now),
                note: `Âæû„Äå${fromAccountName}„ÄçËΩâË≥¨Âà∞„Äå${toAccountName}„Äç`,
                category: 'Êà∂Âè£ËΩâË≥¨'
            });
            
            saveData('accounts');
            saveData('transactions');
            
            // Reset form
            fromSelect.value = '';
            toSelect.value = '';
            amountInput.value = '';
            
            updateAccountsTab();
            updateDashboard();
            searchTransactions();
            
            // Get currency symbol for "from" account
            const currencySymbol = fromCurrency ? 
                (currencySymbols[fromCurrency] || appSettings.currencySymbol) : 
                appSettings.currencySymbol;
            
            notify('‚úÖ', 'ËΩâË≥¨ÊàêÂäü', `Â∑≤ÊàêÂäüÂ∞á ${currencySymbol}${amount} Âæû„Äå${fromAccountName}„ÄçËΩâË≥¨Âà∞„Äå${toAccountName}„Äç„ÄÇ`);
        }
        
        // Add a transaction
        function addTransaction() {
            const accountSelect = document.getElementById('transactionAccount');
            const categorySelect = document.getElementById('transactionCategory');
            const amountInput = document.getElementById('transactionAmount');
            const dateInput = document.getElementById('transactionDate');
            const noteInput = document.getElementById('transactionNote');
            const enableReceiptUpload = document.getElementById('enableReceiptUpload');
            const receiptImage = document.getElementById('receiptImage');
            
            const accountId = accountSelect.value;
            const category = categorySelect.value;
            const amount = parseFloat(amountInput.value);
            const date = dateInput.value;
            const note = noteInput.value.trim();
            
            if (!accountId || !category || isNaN(amount) || amount <= 0 || !date) {
                notify('‚ùå', '‰∫§ÊòìÂ§±Êïó', 'Ë´ãÂ°´ÂØ´ÂÆåÊï¥ÁöÑ‰∫§ÊòìË≥áÊñô„ÄÇ');
                return;
            }
            
            const accountIndex = accounts.findIndex(a => a.id === accountId);
            
            if (accountIndex === -1) {
                notify('‚ùå', '‰∫§ÊòìÂ§±Êïó', 'Êâæ‰∏çÂà∞ÊåáÂÆöÁöÑÊà∂Âè£„ÄÇ');
                return;
            }
            
            // Handle receipt image
            let receipt = null;
            if (enableReceiptUpload.checked && receiptImage.files && receiptImage.files[0]) {
                const file = receiptImage.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    // Create transaction with receipt
                    createTransaction(accountIndex, category, amount, date, note, {
                        data: e.target.result,
                        type: file.type
                    });
                };
                
                reader.readAsDataURL(file);
            } else {
                // Create transaction without receipt
                createTransaction(accountIndex, category, amount, date, note, null);
            }
        }
        
        // Helper function to create a transaction (with or without receipt)
        function createTransaction(accountIndex, category, amount, date, note, receipt) {
            // Update account balance
            if (transactionType === 'income') {
                accounts[accountIndex].balance += amount;
            } else {
                // Check if account has enough balance for expense
                if (accounts[accountIndex].balance < amount) {
                    notify('‚ö†Ô∏è', 'È§òÈ°ç‰∏çË∂≥', `„Äå${accounts[accountIndex].name}„ÄçÊà∂Âè£È§òÈ°ç‰∏çË∂≥Ôºå‰ΩÜ‰∫§Êòì‰ªçÂ∑≤Ë®òÈåÑ„ÄÇ`);
                }
                accounts[accountIndex].balance -= amount;
            }
            
            // Add transaction
            transactions.push({
                id: generateId(),
                type: transactionType,
                account: accounts[accountIndex].id,
                category: category,
                amount: amount,
                date: date,
                note: note,
                receipt: receipt
            });
            
            saveData('accounts');
            saveData('transactions');
            
            // Check if budget alert needed
            checkBudgetAlert();
            
            // Reset form except for type and account
            const currentType = transactionType;
            const currentAccount = accounts[accountIndex].id;
            
            document.getElementById('transactionCategory').value = '';
            document.getElementById('transactionAmount').value = '';
            document.getElementById('transactionNote').value = '';
            
            // Reset receipt upload
            document.getElementById('enableReceiptUpload').checked = false;
            document.getElementById('receiptUploadContainer').style.display = 'none';
            document.getElementById('receiptImage').value = '';
            document.getElementById('receiptPreview').style.display = 'none';
            
            updateAccountsTab();
            updateDashboard();
            searchTransactions();
            generateFinancialAdvice();
            
            // Get currency symbol for this account
            const account = accounts[accountIndex];
            const currencySymbol = account.currency ? 
                (currencySymbols[account.currency] || appSettings.currencySymbol) : 
                appSettings.currencySymbol;
                
            notify('‚úÖ', '‰∫§ÊòìÂ∑≤Ë®òÈåÑ', `${transactionType === 'income' ? 'Êî∂ÂÖ•' : 'ÊîØÂá∫'}‰∫§ÊòìÂ∑≤ÊàêÂäüË®òÈåÑ: ${currencySymbol}${formatNumber(amount)}`);
        }
        
        /// ‰øÆÊîπ‰∏∫:
function saveBudget() {
    // ‰∏çÂÜç‰ªéËæìÂÖ•Ê°ÜËé∑ÂèñÈ¢ÑÁÆóÈáëÈ¢ùÔºåËÄåÊòØËá™Âä®ËÆ°ÁÆó
    const cycleSelect = document.getElementById('budgetCycle');
    const resetDaySelect = document.getElementById('budgetResetDay');
    
    const cycle = cycleSelect.value;
    const resetDay = resetDaySelect.value;
    
    // ËÆ°ÁÆóÊâÄÊúâÁ±ªÂà´È¢ÑÁÆóÁöÑÊÄªÂíå‰Ωú‰∏∫ÊÄªÈ¢ÑÁÆó
    const totalAmount = calculateTotalBudget();
    
    // Ëé∑ÂèñÈòàÂÄº
    const thresholdInputs = document.querySelectorAll('.threshold-value');
    const thresholds = Array.from(thresholdInputs).map(input => parseInt(input.value))
        .filter(val => !isNaN(val) && val > 0 && val <= 100);
    
    if (thresholds.length === 0) {
        thresholds.push(80); // Default threshold if none valid
    }
    
    // Sort thresholds in descending order
    thresholds.sort((a, b) => b - a);
    
    budget.amount = totalAmount;
    budget.cycle = cycle;
    budget.resetDay = resetDay;
    budget.thresholds = thresholds;
    
    // Get daily summary timing
    appSettings.dailySummaryTiming = document.getElementById('dailySummaryTiming').value;
    
    // Set last reset to today if not already set
    if (!budget.lastReset) {
        budget.lastReset = new Date().toISOString();
    }
    
    saveData('budget');
    saveData('appSettings');
    
    updateBudgetStatus();
    generateFinancialAdvice();
    
    notify('‚úÖ', 'È†êÁÆóÂ∑≤Ë®≠ÂÆö', 'ÊÇ®ÁöÑÈ†êÁÆóË®≠ÂÆöÂ∑≤ÊàêÂäü‰øùÂ≠ò„ÄÇ');
}
        
        // Delete a transaction
        function deleteTransaction(transactionId) {
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            // Update account balance
            const accountIndex = accounts.findIndex(a => a.id === transaction.account);
            if (accountIndex !== -1) {
                if (transaction.type === 'income') {
                    accounts[accountIndex].balance -= transaction.amount;
                } else if (transaction.type === 'expense') {
                    accounts[accountIndex].balance += transaction.amount;
                } else if (transaction.type === 'transfer') {
                    // Revert transfer
                    accounts[accountIndex].balance += transaction.amount;
                    const toAccountIndex = accounts.findIndex(a => a.id === transaction.toAccount);
                    if (toAccountIndex !== -1) {
                        accounts[toAccountIndex].balance -= transaction.amount;
                    }
                }
            }
            
            // Remove transaction
            transactions = transactions.filter(t => t.id !== transactionId);
            
            saveData('accounts');
            saveData('transactions');
            
            updateAccountsTab();
            updateDashboard();
            searchTransactions();
            generateFinancialAdvice();
            
            notify('üóëÔ∏è', '‰∫§ÊòìÂ∑≤Âà™Èô§', '‰∫§ÊòìË®òÈåÑÂ∑≤ÊàêÂäüÂà™Èô§„ÄÇ');
        }
        
        // Check budget thresholds and show alerts if needed
        function checkBudgetAlert() {
            if (!budget.amount || !budget.thresholds || budget.thresholds.length === 0) return;
            
            const budgetUsed = getBudgetUsed();
            const budgetPercentage = (budgetUsed / budget.amount) * 100;
            
            // Find the first threshold that is lower than or equal to the current percentage
            // Since thresholds are sorted in descending order, this finds the highest matching threshold
            const matchingThreshold = budget.thresholds.find(threshold => budgetPercentage >= threshold);
            
            if (matchingThreshold) {
                // Only show alert if we haven't shown one for this threshold in this session
                const sessionKey = `budget_alert_${matchingThreshold}`;
                const alertShown = sessionStorage.getItem(sessionKey);
                
                if (!alertShown) {
                    notify('‚ö†Ô∏è', 'È†êÁÆóË≠¶Âëä', `ÊÇ®Â∑≤‰ΩøÁî®‰∫Ü ${Math.round(budgetPercentage)}% ÁöÑÈ†êÁÆóÔºåË∂ÖÈÅé‰∫Ü ${matchingThreshold}% ÁöÑÈñæÂÄº„ÄÇ`);
                    sessionStorage.setItem(sessionKey, 'shown');
                }
            }
        }
        
        // Show notification
        function notify(icon, title, message) {
            const notificationEl = document.getElementById('notification');
            document.getElementById('notificationIcon').textContent = icon;
            document.getElementById('notificationTitle').textContent = title;
            document.getElementById('notificationMessage').textContent = message;
            
            notificationEl.style.display = 'block';
            
            // Auto-hide notification after 3 seconds
            setTimeout(() => {
                notificationEl.style.display = 'none';
            }, 3000);
        }
        
        // Helper functions
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }
        
        function getAccount(accountId) {
            return accounts.find(a => a.id === accountId);
        }
        
        function getAccountName(accountId) {
            const account = getAccount(accountId);
            return account ? account.name : 'Êú™Áü•Êà∂Âè£';
        }
        
        function getAccountCurrencySymbol(accountId) {
            const account = getAccount(accountId);
            if (!account) return appSettings.currencySymbol;
            
            const currency = account.currency;
            return currency ? (currencySymbols[currency] || appSettings.currencySymbol) : appSettings.currencySymbol;
        }
        
        function getTodayFormatted() {
            return formatDateForInput(new Date());
        }
        
        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function formatDateForFilename(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}/${month}/${day}`;
        }
        
        function formatNumber(number) {
            return parseFloat(number).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        function getTransactionDate(date) {
            // If new day is active, use today's date
            if (newDayStatus.active) {
                return formatDateForInput(date);
            }
            
            // If not active and it's after midnight but before 4am, use yesterday's date
            const hours = date.getHours();
            if (hours >= 0 && hours < 4) {
                const yesterday = new Date(date);
                yesterday.setDate(yesterday.getDate() - 1);
                return formatDateForInput(yesterday);
            }
            
            // Otherwise use today's date
            return formatDateForInput(date);
        }
        
        // ‰øÆÊîπgetTotalBalanceÂáΩÊï∞ÔºàÁ∫¶5898Ë°åÂ∑¶Âè≥Ôºâ
function getTotalBalance() {
    // ËΩ¨Êç¢ÊØè‰∏™Ë¥¶Êà∑ÁöÑ‰ΩôÈ¢ù‰∏∫Âü∫ÂáÜË¥ßÂ∏ÅÔºåÁÑ∂ÂêéÊ±ÇÂíå
    return accounts.reduce((sum, account) => {
        const convertedBalance = convertToBaseCurrency(account.balance, account.currency);
        return sum + convertedBalance;
    }, 0);
}
        
        function getTodayTransactions() {
            const today = getTodayFormatted();
            return transactions.filter(t => t.date === today)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
        }
        
        function getTodayIncome() {
            return getTodayTransactions()
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
        }
        
        function getTodayExpense() {
            return getTodayTransactions()
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
        }
        
        function getRecentTransactions(count) {
            return [...transactions]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, count);
        }
        
        function getBudgetCycleText() {
            switch (budget.cycle) {
                case 'daily':
                    return 'ÊØèÊó•';
                case 'weekly':
                    return `ÊØèÈÄ± (${budget.resetDay} ÈáçË®≠)`;
                case 'monthly':
                    return `ÊØèÊúà (${budget.resetDay}Êó• ÈáçË®≠)`;
                default:
                    return 'Êú™Ë®≠ÂÆö';
            }
        }
        
        function getBudgetUsed() {
    if (!budget.lastReset) return 0;
    
    const lastReset = new Date(budget.lastReset);
    
    // ËÆ°ÁÆóÊîØÂá∫ÊÄªÈ¢ù
    const expenses = transactions
        .filter(t => t.type === 'expense' && new Date(t.date) >= lastReset)
        .reduce((sum, t) => sum + parseFloat(t.amount), 0);
    
    // ËÆ°ÁÆóÊî∂ÂÖ•ÊÄªÈ¢ù
    const income = transactions
        .filter(t => t.type === 'income' && new Date(t.date) >= lastReset)
        .reduce((sum, t) => sum + parseFloat(t.amount), 0);
    
    // ÊîØÂá∫ÂáèÂéªÊî∂ÂÖ• = ÂáÄÊîØÂá∫
    const netExpenses = expenses - income;
    
    // Â¶ÇÊûúÂáÄÊîØÂá∫‰∏∫Ë¥üÔºàÂç≥Êî∂ÂÖ•Â§ß‰∫éÊîØÂá∫ÔºâÔºåÂàôËøîÂõû0
    return Math.max(0, netExpenses);
}
        
        function getBudgetRemaining() {
            return budget.amount - getBudgetUsed();
        }
        
        function getBudgetPercentage() {
            if (!budget.amount) return 0;
            return Math.round((getBudgetUsed() / budget.amount) * 100);
        }
        
        function getBudgetDaysInPeriod() {
            if (!budget.lastReset) return 30; // Default to 30 days
            
            const lastReset = new Date(budget.lastReset);
            const now = new Date();
            
            switch (budget.cycle) {
                case 'daily':
                    return 1;
                case 'weekly':
                    return 7;
                case 'monthly':
                    // Get number of days in the month
                    const nextMonthDay = new Date(lastReset.getFullYear(), lastReset.getMonth() + 1, budget.resetDay);
                    const diffTime = nextMonthDay - lastReset;
                    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                default:
                    return 30;
            }
        }
        
        function getBudgetDaysRemaining() {
            if (!budget.lastReset) return 0;
            
            const lastReset = new Date(budget.lastReset);
            const now = new Date();
            const resetDay = parseInt(budget.resetDay);
            
            let nextReset;
            
            switch (budget.cycle) {
                case 'daily':
                    // Next reset is tomorrow
                    nextReset = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
                    break;
                case 'weekly':
                    // Find next occurrence of the reset day
                    const dayIndex = ['ÈÄ±Êó•', 'ÈÄ±‰∏Ä', 'ÈÄ±‰∫å', 'ÈÄ±‰∏â', 'ÈÄ±Âõõ', 'ÈÄ±‰∫î', 'ÈÄ±ÂÖ≠'].indexOf(budget.resetDay);
                    const daysUntilNextDay = (dayIndex + 7 - now.getDay()) % 7;
                    nextReset = new Date(now.getFullYear(), now.getMonth(), now.getDate() + daysUntilNextDay);
                    
                    // If it's the reset day, but we already reset today, add 7 days
                    if (daysUntilNextDay === 0 && lastReset.toDateString() === now.toDateString()) {
                        nextReset.setDate(nextReset.getDate() + 7);
                    }
                    break;
                case 'monthly':
                    // Calculate next reset date
                    let nextMonth = now.getMonth();
                    let nextYear = now.getFullYear();
                    
                    // If current day is past reset day, move to next month
                    if (now.getDate() > resetDay) {
                        nextMonth++;
                    }
                    
                    // Handle year change
                    if (nextMonth > 11) {
                        nextMonth = 0;
                        nextYear++;
                    }
                    
                    // Create next reset date
                    nextReset = new Date(nextYear, nextMonth, resetDay);
                    
                    // Handle months with fewer days
                    if (nextReset.getDate() !== resetDay) {
                        // If the month doesn't have the reset day, use the last day of the month
                        nextReset = new Date(nextYear, nextMonth + 1, 0);
                    }
                    break;
                default:
                    return 0;
            }
            
            // Calculate days remaining
            const diffTime = nextReset - now;
            const daysRemaining = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return Math.max(0, daysRemaining);
        }
        
        // ËÆ°ÁÆóÊâÄÊúâÁ±ªÂà´È¢ÑÁÆóÁöÑÊÄªÂíå
function calculateTotalBudget() {
    return categoryBudgets.reduce((total, budget) => total + budget.amount, 0);
}

// Êõ¥Êñ∞ÊÄªÈ¢ÑÁÆóÊòæÁ§∫
function updateTotalBudgetDisplay() {
    const totalAmount = calculateTotalBudget();
    document.getElementById('totalBudgetAmount').textContent = formatNumber(totalAmount);
    // ÂêåÊó∂Êõ¥Êñ∞È¢ÑÁÆóÂØπË±°
    budget.amount = totalAmount;
    saveData('budget');
    // Êõ¥Êñ∞È¢ÑÁÆóÁä∂ÊÄÅÊòæÁ§∫
    updateBudgetStatus();
}
        
    </script>
</body>
</html>
